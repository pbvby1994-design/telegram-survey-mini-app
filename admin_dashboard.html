<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | v2.4 (–§–∏–∫—Å –ê–¥–º–∏–Ω–∞/–û–Ω–ª–∞–π–Ω)</title>

    <!-- Tailwind CSS (–¥–ª—è —Å—Ç–∏–ª–µ–π) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (–¥–ª—è –∏–∫–æ–Ω–æ–∫) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js (–¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <!-- –®—Ä–∏—Ñ—Ç Jost -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet (–¥–ª—è –∫–∞—Ä—Ç) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <!-- Leaflet Marker Cluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <style>
        :root {
            --primary-color: #0d9488; /* Teal-600 */
            --primary-light: #2dd4bf; /* Teal-400 */
            --secondary-color: #3b82f6; /* Blue-500 */
            --background-color: #f3f4f6; /* Gray-100 */
            --surface-color: #ffffff;
            --text-color: #1f2937; /* Gray-800 */
        }
        body {
            font-family: 'Jost', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 100%;
            padding: 16px;
        }
        .card {
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary:hover {
            background-color: #0f766e; /* Teal-700 */
        }
        .btn-secondary {
            background-color: #6b7280; /* Gray-500 */
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* Gray-600 */
        }
        input[type="text"], input[type="number"], select, textarea {
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 6px;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            background-color: #f9fafb; /* Gray-50 */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.2);
            outline: none;
        }
        .form-group label {
            font-weight: 500;
            color: #374151; /* Gray-700 */
            margin-bottom: 4px;
            display: block;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
        .tab-button {
            padding: 10px 16px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #e5e7eb;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--surface-color);
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s;
        }
        .modal-overlay.open .modal-content {
            transform: translateY(0);
        }
        .report-summary-card {
            grid-template-columns: 1fr;
        }
        @media (min-width: 640px) {
            .report-summary-card {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app-container" class="container mx-auto">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <h1 class="text-2xl font-bold text-center py-4 text-gray-800">–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞</h1>

        <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏/–≤–∫–ª–∞–¥–æ–∫ -->
        <div class="flex border-b border-gray-300 mb-4 bg-white rounded-t-lg shadow-sm">
            <button class="tab-button active flex-1" onclick="window.showSection('form')">
                <i data-lucide="send-horizontal" class="inline-block w-4 h-4 mr-2"></i> –û—Ç—á–µ—Ç
            </button>
            <button class="tab-button flex-1" onclick="window.showSection('latest')" id="latest-data-tab">
                <i data-lucide="clipboard-list" class="inline-block w-4 h-4 mr-2"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ
            </button>
            <button class="tab-button flex-1" onclick="window.showSection('map-view')">
                <i data-lucide="map" class="inline-block w-4 h-4 mr-2"></i> –ö–∞—Ä—Ç–∞
            </button>
            <button class="tab-button flex-1 hidden" id="admin-tab" onclick="window.showSection('admin')">
                <i data-lucide="shield" class="inline-block w-4 h-4 mr-2"></i> –ê–¥–º–∏–Ω
            </button>
        </div>

        <!-- --- –°–µ–∫—Ü–∏—è "–û—Ç—á–µ—Ç" (–§–æ—Ä–º–∞ –≤–≤–æ–¥–∞) --- -->
        <section id="form-section" class="active-section">
            <div class="card">
                <form id="report-form" onsubmit="window.saveReport(event)">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- –ü–æ—Å–µ–ª–µ–Ω–∏–µ -->
                        <div class="form-group">
                            <label for="settlement">–ü–æ—Å–µ–ª–µ–Ω–∏–µ:</label>
                            <select id="settlement" name="settlement" required>
                                <!-- –û–ø—Ü–∏–∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
                            </select>
                        </div>

                        <!-- –§–ò–û -->
                        <div class="form-group">
                            <label for="name">–§–ò–û –∂–∏—Ç–µ–ª—è:</label>
                            <input type="text" id="name" name="name" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò." required>
                        </div>

                        <!-- –ê–¥—Ä–µ—Å -->
                        <div class="form-group">
                            <label for="address">–ê–¥—Ä–µ—Å:</label>
                            <input type="text" id="address" name="address" placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 10" required>
                        </div>

                        <!-- –ü—Ä–∏–∑–Ω–∞–∫ -->
                        <div class="form-group">
                            <label for="category">–ü—Ä–∏–∑–Ω–∞–∫:</label>
                            <select id="category" name="category" required>
                                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                <option value="–ó–∞">–ó–∞</option>
                                <option value="–ü—Ä–æ—Ç–∏–≤">–ü—Ä–æ—Ç–∏–≤</option>
                                <option value="–ù–µ_–æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è">–ù–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è</option>
                                <option value="–ù–µ_–æ–±–Ω–∞—Ä—É–∂–µ–Ω">–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω</option>
                            </select>
                        </div>
                    </div>

                    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                    <div class="form-group mt-4">
                        <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                        <textarea id="comment" name="comment" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã, –∑–∞–ø—Ä–æ—Å–∞, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è..."></textarea>
                    </div>

                    <!-- –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è -->
                    <div class="form-group mt-4 flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg">
                        <div id="location-status" class="text-sm font-medium text-gray-700">
                            <i data-lucide="map-pin" class="inline-block w-4 h-4 mr-1 text-blue-500"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
                        </div>
                        <button type="button" onclick="window.getLocation()" class="flex items-center text-sm text-white bg-blue-500 hover:bg-blue-600 px-3 py-1.5 rounded-lg transition duration-150">
                            <i data-lucide="locate-fixed" class="w-4 h-4 mr-1"></i> –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å
                        </button>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                        <input type="hidden" id="accuracy" name="accuracy">
                    </div>

                    <!-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è -->
                    <div class="form-group mt-4">
                        <label for="photo">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞):</label>
                        <input type="file" id="photo" name="photo" accept="image/*" onchange="window.handlePhotoSelect(event)">
                        <div id="photo-preview" class="mt-2 text-sm text-gray-500"></div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <button type="submit" class="btn-primary w-full mt-6">
                        <i data-lucide="save" class="w-5 h-5 mr-2"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –û—Ç—á–µ—Ç
                    </button>
                </form>
            </div>
            <!-- –°—Ç–∞—Ç—É—Å –∫–µ—à–∞/–æ–Ω–ª–∞–π–Ω -->
            <div id="offline-status" class="card p-3 text-sm flex items-center justify-between mt-4">
                <span class="text-gray-600">
                    <i data-lucide="cloud-off" class="w-4 h-4 mr-1 inline-block text-red-500"></i>
                    –û—Ñ–ª–∞–π–Ω-–¥–∞–Ω–Ω—ã–µ: <span id="offline-count" class="font-semibold">0</span>
                </span>
                <button onclick="window.syncData()" class="text-xs text-white bg-green-500 hover:bg-green-600 px-3 py-1.5 rounded-full transition duration-150">
                    <i data-lucide="rotate-ccw" class="w-3 h-3 mr-1 inline-block"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>

            <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Å–∫—Ä—ã—Ç—å –≤ —Ä–µ–ª–∏–∑–µ) -->
            <div class="card p-3 text-xs text-gray-500 mt-4">
                <p>UserID: <span id="debugUserId"></span></p>
                <p>–ê–¥–º–∏–Ω: <span id="debugAdminStatus"></span></p>
            </div>

        </section>

        <!-- --- –°–µ–∫—Ü–∏—è "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ" --- -->
        <section id="latest-section" class="hidden">
            <div class="card p-0 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–î–∞—Ç–∞</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ê–¥—Ä–µ—Å</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü—Ä–∏–∑–Ω–∞–∫</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="latest-data-body" class="bg-white divide-y divide-gray-200">
                        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
                        <tr><td colspan="4" class="text-center py-4 text-gray-500">–ù–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- --- –°–µ–∫—Ü–∏—è "–ö–∞—Ä—Ç–∞" --- -->
        <section id="map-view-section" class="hidden">
            <div class="card">
                <div id="map" class="h-80 w-full mb-4"></div>
                <div class="flex space-x-2">
                    <button class="btn-primary flex-1 text-sm" onclick="window.generateMap('marker')">
                        <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i> –ú–∞—Ä–∫–µ—Ä—ã
                    </button>
                    <button class="btn-secondary flex-1 text-sm" onclick="window.generateMap('cluster')">
                        <i data-lucide="layers" class="w-4 h-4 mr-1"></i> –ö–ª–∞—Å—Ç–µ—Ä—ã
                    </button>
                    <button class="btn-secondary flex-1 text-sm" onclick="window.generateMap('heat')">
                        <i data-lucide="zap" class="w-4 h-4 mr-1"></i> –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞
                    </button>
                </div>
            </div>
        </section>


        <!-- --- –°–µ–∫—Ü–∏—è "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" (–°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) --- -->
        <section id="admin-section" class="hidden">
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                    <i data-lucide="shield-check" class="w-5 h-5 mr-2 text-primary-color"></i> –°–≤–æ–¥–Ω—ã–π –û—Ç—á–µ—Ç
                </h2>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div id="report-summary" class="grid report-summary-card gap-3 mb-6">
                    <!-- –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
                </div>

                <!-- –ì—Ä–∞—Ñ–∏–∫ -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-medium mb-3 text-gray-700">–û—Ç—á–µ—Ç –ø–æ –ü—Ä–∏–∑–Ω–∞–∫–∞–º</h3>
                    <div style="height: 250px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö —Å —Ñ–∏–ª—å—Ç—Ä–æ–º -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">–í—Å–µ –∑–∞–ø–∏—Å–∏</h3>
                    <div class="flex space-x-2 mb-3">
                        <select id="admin-settlement-filter" class="flex-1" onchange="window.fetchAndRenderReports()">
                            <option value="">–í—Å–µ –ø–æ—Å–µ–ª–µ–Ω–∏—è</option>
                        </select>
                        <select id="admin-category-filter" class="flex-1" onchange="window.fetchAndRenderReports()">
                            <option value="">–í—Å–µ –ø—Ä–∏–∑–Ω–∞–∫–∏</option>
                            <option value="–ó–∞">–ó–∞</option>
                            <option value="–ü—Ä–æ—Ç–∏–≤">–ü—Ä–æ—Ç–∏–≤</option>
                            <option value="–ù–µ_–æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è">–ù–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è</option>
                            <option value="–ù–µ_–æ–±–Ω–∞—Ä—É–∂–µ–Ω">–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω</option>
                        </select>
                    </div>
                    <div class="p-0 overflow-x-auto border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–î–∞—Ç–∞</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü–æ—Å–µ–ª–µ–Ω–∏–µ</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ê–¥—Ä–µ—Å</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü—Ä–∏–∑–Ω–∞–∫</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ö–æ–º–º.</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–§–ò–û</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–î–µ–π—Å—Ç–≤.</th>
                                </tr>
                            </thead>
                            <tbody id="admin-reports-body" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="7" class="text-center py-4 text-gray-500">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <button onclick="window.fetchAndRenderReports()" class="btn-secondary w-full mt-4">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i> –û–±–Ω–æ–≤–∏—Ç—å –û—Ç—á–µ—Ç
                    </button>
                    <button onclick="window.confirmDeleteAll()" class="btn-secondary w-full mt-2 bg-red-500 hover:bg-red-600">
                        <i data-lucide="trash" class="w-4 h-4 mr-2"></i> –£–¥–∞–ª–∏—Ç—å –í—Å–µ –î–∞–Ω–Ω—ã–µ
                    </button>
                </div>
            </div>
        </section>


        <!-- --- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ --- -->

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–°–æ–æ–±—â–µ–Ω–∏–µ" (Alert) -->
        <div id="alert-modal" class="modal-overlay" onclick="window.closeModal('alert')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <h3 id="alert-title" class="text-xl font-semibold mb-3 text-primary-color">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
                <p id="alert-message" class="text-gray-700 mb-4">–°–æ–æ–±—â–µ–Ω–∏–µ.</p>
                <div class="flex justify-end">
                    <button class="btn-primary px-4 py-2" onclick="window.closeModal('alert')">–û–ö</button>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ" (Confirm) -->
        <div id="confirm-modal" class="modal-overlay" onclick="window.closeModal('confirm')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <h3 id="confirm-title" class="text-xl font-semibold mb-3 text-red-500">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
                <p id="confirm-message" class="text-gray-700 mb-4">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
                <div class="flex justify-end space-x-3">
                    <button class="btn-secondary px-4 py-2" onclick="window.closeModal('confirm')">–û—Ç–º–µ–Ω–∞</button>
                    <button id="confirm-action-btn" class="btn-primary px-4 py-2 bg-red-500 hover:bg-red-600" data-action="">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–∏" (View Report) -->
        <div id="view-modal" class="modal-overlay" onclick="window.closeModal('view')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <h3 class="text-xl font-semibold mb-3 text-primary-color">–î–µ—Ç–∞–ª–∏ –û—Ç—á–µ—Ç–∞</h3>
                <div id="view-details" class="space-y-3 text-gray-700 text-sm">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
                </div>
                <div class="flex justify-end mt-4">
                    <button class="btn-primary px-4 py-2" onclick="window.closeModal('view')">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module">
        // üö® –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–∏—Ç–µ –∫–ª—é—á–∏ –Ω–∏–∂–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –≤–∞—à–µ–º—É –ø—Ä–æ–µ–∫—Ç—É Firebase!

        // üìù –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–ó–ê–ú–ï–ù–ï–ù–ê –ù–ê –ö–õ–Æ–ß–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø)
        const firebaseConfig = {
            apiKey: "AIzaSyDVeRXO16KtIwoJQb4uHQuCsEv3xTLBGhI",
            authDomain: "agitator-notebook.firebaseapp.com",
            projectId: "agitator-notebook",
            storageBucket: "agitator-notebook.firebasestorage.app",
            messagingSenderId: "518555352011",
            appId: "1:518555352011:web:2b18d460a6fa4acb66944e",
            measurementId: "" // –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º
        };

        // üì¶ –ò–º–ø–æ—Ä—Ç Firebase (–û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ –≤–µ—Ä—Å–∏–∏ 12.4.0)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, Timestamp, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        const COLLECTION_NAME = "agitator_reports";
        const ADMIN_COLLECTION_NAME = "admins";
        const STORAGE_BUCKET_URL = `gs://${firebaseConfig.storageBucket}`;
        const isTMA = typeof Telegram !== 'undefined' && Telegram.WebApp;

        let app;
        let db;
        let auth;
        let storage;
        let userTelegramId = isTMA ? (Telegram.WebApp.initDataUnsafe.user?.id || null) : 'test-user-id';
        let isAdmin = false; // –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ authenticateUser()
        let dataCache = JSON.parse(localStorage.getItem(COLLECTION_NAME) || '[]');
        let currentLatLng = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

        try {
            if (firebaseConfig.projectId) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                // –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Firestore –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                // setLogLevel('Debug');
            }
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        // --- –°–ü–ò–°–û–ö –ü–û–°–ï–õ–ï–ù–ò–ô ---
        const SETTLEMENTS = [
            "–ì–æ—Ä–æ–¥ –ê", "–°–µ–ª–æ –ë", "–î–µ—Ä–µ–≤–Ω—è –í", "–ü–æ—Å–µ–ª–æ–∫ –ì"
        ];

        // --- –£–¢–ò–õ–ò–¢–´ UI/MODAL ---

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
         * @param {string} title –ó–∞–≥–æ–ª–æ–≤–æ–∫
         * @param {string} message –°–æ–æ–±—â–µ–Ω–∏–µ
         */
        window.showAlert = (title, message) => {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-modal').classList.add('open');
            if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        };

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è.
         * @param {string} title –ó–∞–≥–æ–ª–æ–≤–æ–∫
         * @param {string} message –°–æ–æ–±—â–µ–Ω–∏–µ
         * @param {function} onConfirm –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏
         */
        window.showConfirm = (title, message, onConfirm) => {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-modal').classList.add('open');
            const confirmBtn = document.getElementById('confirm-action-btn');

            // –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = async () => {
                window.closeModal('confirm');
                await onConfirm();
            };
            if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
        };

        /**
         * –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ.
         * @param {'alert'|'confirm'|'view'} type –¢–∏–ø –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
         */
        window.closeModal = (type) => {
            document.getElementById(`${type}-modal`).classList.remove('open');
        };


        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é —Å–µ–∫—Ü–∏—é (–≤–∫–ª–∞–¥–∫—É).
         * @param {string} sectionId 'form', 'latest', 'map-view', 'admin'
         */
        window.showSection = (sectionId) => {
            const sections = ['form', 'latest', 'map-view', 'admin'];
            sections.forEach(id => {
                const section = document.getElementById(`${id}-section`);
                if (section) section.classList.add('hidden');
                document.querySelector(`.tab-button:nth-child(${sections.indexOf(id) + 1})`)?.classList.remove('active');
            });

            document.getElementById(`${sectionId}-section`)?.classList.remove('hidden');
            document.querySelector(`.tab-button:nth-child(${sections.indexOf(sectionId) + 1})`)?.classList.add('active');

            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∫–∞—Ä—Ç—ã
            if (sectionId === 'map-view') {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
                setTimeout(() => window.generateMap('marker'), 100);
            }
            if (sectionId === 'latest') {
                window.renderLatestData();
            }
            if (sectionId === 'admin') {
                window.fetchAndRenderReports();
            }
        };

        /**
         * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ—Å–µ–ª–µ–Ω–∏–π.
         */
        const populateSettlements = () => {
            const selectForm = document.getElementById('settlement');
            const selectAdmin = document.getElementById('admin-settlement-filter');

            [selectForm, selectAdmin].forEach(select => {
                // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
                while (select.children.length > 1 && select.id !== 'settlement') {
                    select.removeChild(select.lastChild);
                }
                while (select.children.length > 0 && select.id === 'settlement') {
                     select.removeChild(select.lastChild);
                }

                if (select.id === 'admin-settlement-filter') {
                    const allOption = document.createElement('option');
                    allOption.value = "";
                    allOption.textContent = "–í—Å–µ –ø–æ—Å–µ–ª–µ–Ω–∏—è";
                    select.appendChild(allOption);
                } else if (select.id === 'settlement') {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å–µ–ª–µ–Ω–∏–µ";
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    select.appendChild(defaultOption);
                }

                SETTLEMENTS.forEach(settlement => {
                    const option = document.createElement('option');
                    option.value = settlement;
                    option.textContent = settlement;
                    select.appendChild(option);
                });
            });
        };

        // --- –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø & –ê–î–ú–ò–ù –ü–†–û–í–ï–†–ö–ê ---

        /**
         * –í—ã–ø–æ–ª–Ω—è–µ—Ç –∞–Ω–æ–Ω–∏–º–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –≤ Firebase –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
         */
        const authenticateUser = async () => {
            if (!auth) return;

            if (isTMA) {
                // 1. –ü–æ–ø—ã—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç–æ–∫–µ–Ω, –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–º —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥)
                 // –í —Ä–µ–∞–ª—å–Ω–æ–º TMA, –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –±—ã–ª–æ –±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram ID –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.
                 // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã Canvas/iframe, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥.
            }

            try {
                // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                await signInAnonymously(auth);
                // –û–±–Ω–æ–≤–ª—è–µ–º userTelegramId –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π UID –∏–∑ Firebase, –µ—Å–ª–∏ TMA –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –µ–≥–æ
                userTelegramId = auth.currentUser?.uid || userTelegramId;

                // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                if (userTelegramId) {
                    const adminDocRef = doc(db, ADMIN_COLLECTION_NAME, String(userTelegramId));
                    const adminDoc = await getDoc(adminDocRef);
                    isAdmin = adminDoc.exists();

                    if (isAdmin) {
                        document.getElementById('admin-tab').classList.remove('hidden');
                    }
                }
                console.log(`User authenticated. ID: ${userTelegramId}. Admin: ${isAdmin}`);

            } catch (error) {
                console.error("Authentication failed:", error);
                window.showAlert('–û—à–∏–±–∫–∞ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –¥–æ—Å—Ç—É–ø.');
            }
        };

        // --- –†–ê–ë–û–¢–ê –° –ì–ï–û–õ–û–ö–ê–¶–ò–ï–ô –ò –§–û–¢–û ---

        /**
         * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.
         */
        window.getLocation = () => {
            const statusElement = document.getElementById('location-status');
            statusElement.innerHTML = '<i data-lucide="loader-circle" class="w-4 h-4 mr-1 inline-block animate-spin text-gray-500"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –û–ø—Ä–µ–¥–µ–ª—è–µ–º...';

            if (isTMA) Telegram.WebApp.HapticFeedback.impactOccurred('light');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLatLng = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        document.getElementById('latitude').value = position.coords.latitude;
                        document.getElementById('longitude').value = position.coords.longitude;
                        document.getElementById('accuracy').value = position.coords.accuracy;

                        statusElement.innerHTML = `<i data-lucide="map-pin" class="w-4 h-4 mr-1 inline-block text-green-500"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ (${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)})`;
                        lucide.createIcons();
                        if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        currentLatLng = null;
                        document.getElementById('latitude').value = '';
                        document.getElementById('longitude').value = '';
                        document.getElementById('accuracy').value = '';
                        statusElement.innerHTML = '<i data-lucide="x-circle" class="w-4 h-4 mr-1 inline-block text-red-500"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –û—à–∏–±–∫–∞/–û—Ç–∫–∞–∑–∞–Ω–æ';
                        lucide.createIcons();
                        if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                statusElement.innerHTML = '<i data-lucide="alert-triangle" class="w-4 h-4 mr-1 inline-block text-yellow-500"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                lucide.createIcons();
            }
        };

        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–≤—å—é.
         * @param {Event} event
         */
        window.handlePhotoSelect = (event) => {
            const file = event.target.files[0];
            const preview = document.getElementById('photo-preview');
            preview.innerHTML = '';
            if (file) {
                if (!file.type.startsWith('image/')) {
                    preview.textContent = '–û—à–∏–±–∫–∞: –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º.';
                    event.target.value = ''; // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
                    return;
                }
                if (file.size > 5 * 1024 * 1024) { // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 5MB
                    preview.textContent = '–û—à–∏–±–∫–∞: –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 5MB.';
                    event.target.value = ''; // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
                    return;
                }

                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'mt-2 max-h-40 rounded-lg object-cover border border-gray-200';
                preview.appendChild(img);
                preview.appendChild(document.createTextNode(` ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`));
            } else {
                preview.textContent = '';
            }
        };

        // --- –†–ê–ë–û–¢–ê –° –ö–≠–®–ï–ú / –û–§–§–õ–ê–ô–ù ---

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ –æ—Ñ–ª–∞–π–Ω-–¥–∞–Ω–Ω—ã—Ö –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
         */
        const updateOfflineStatus = () => {
            document.getElementById('offline-count').textContent = dataCache.length;
            const statusCard = document.getElementById('offline-status');
            if (dataCache.length > 0) {
                statusCard.classList.remove('bg-gray-50');
                statusCard.classList.add('bg-yellow-100', 'border-yellow-400');
            } else {
                statusCard.classList.remove('bg-yellow-100', 'border-yellow-400');
                statusCard.classList.add('bg-gray-50');
            }
        };

        /**
         * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç—á–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à.
         * @param {object} reportData –î–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞
         */
        const saveToCache = (reportData) => {
            dataCache.push(reportData);
            localStorage.setItem(COLLECTION_NAME, JSON.stringify(dataCache));
            updateOfflineStatus();
        };

        /**
         * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –æ—Ñ–ª–∞–π–Ω-–¥–∞–Ω–Ω—ã–µ —Å Firebase.
         */
        window.syncData = async () => {
            if (!db || dataCache.length === 0) {
                if (dataCache.length === 0) window.showAlert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.');
                return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            let successfulUploads = 0;
            const failedItems = [];
            const itemsToSync = [...dataCache]; // –ö–æ–ø–∏—Ä—É–µ–º –¥–ª—è –∏—Ç–µ—Ä–∞—Ü–∏–∏

            for (const item of itemsToSync) {
                try {
                    let photoUrl = '';
                    let photoRefPath = '';

                    // –ï—Å–ª–∏ –µ—Å—Ç—å base64 —Ñ–æ—Ç–æ, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –≤ Storage
                    if (item.photoBase64 && item.photoName) {
                        const photoBlob = await (await fetch(item.photoBase64)).blob();
                        const photoStorageRef = ref(storage, `${COLLECTION_NAME}/${item.photoName}`);
                        await uploadBytes(photoStorageRef, photoBlob);
                        photoUrl = await getDownloadURL(photoStorageRef);
                        photoRefPath = photoStorageRef.fullPath;
                    }

                    const docData = {
                        ...item,
                        photoUrl: photoUrl,
                        photoRef: photoRefPath,
                        // –£–¥–∞–ª—è–µ–º base64, —á—Ç–æ–±—ã –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å –µ–≥–æ –≤ Firestore
                        photoBase64: null,
                        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                        createdAt: Timestamp.fromDate(new Date(item.createdAt)), // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Timestamp
                        syncedAt: Timestamp.now(),
                        agitationUserId: userTelegramId
                    };

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –≤ Firestore
                    await setDoc(doc(collection(db, COLLECTION_NAME)), docData);
                    successfulUploads++;

                    // –£–¥–∞–ª—è–µ–º —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∞
                    dataCache = dataCache.filter(cachedItem => cachedItem !== item);
                } catch (e) {
                    console.error("Synchronization failed for an item:", e);
                    failedItems.push(item);
                }
            }

            localStorage.setItem(COLLECTION_NAME, JSON.stringify(dataCache));
            updateOfflineStatus();

            if (isTMA) Telegram.WebApp.MainButton.hideLoader();

            if (successfulUploads > 0) {
                window.showAlert('–£—Å–ø–µ—Ö!', `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${successfulUploads} –∑–∞–ø–∏—Å–µ–π.`);
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å–µ–∫—Ü–∏–∏
                if (document.getElementById('latest-section').classList.contains('active-section')) {
                     window.renderLatestData();
                }
            } else if (failedItems.length > 0) {
                window.showAlert('–û—à–∏–±–∫–∞ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å ${failedItems.length} –∑–∞–ø–∏—Å–µ–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.`);
            }
        };

        // --- –†–ê–ë–û–¢–ê –° –§–û–†–ú–û–ô –ò –û–¢–ß–ï–¢–ê–ú–ò ---

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã.
         * @param {Event} event
         */
        window.saveReport = async (event) => {
            event.preventDefault();
            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            const form = event.target;
            const data = new FormData(form);

            const reportData = {
                settlement: data.get('settlement'),
                name: data.get('name'),
                address: data.get('address'),
                category: data.get('category'),
                comment: data.get('comment'),
                latitude: parseFloat(data.get('latitude')) || null,
                longitude: parseFloat(data.get('longitude')) || null,
                accuracy: parseFloat(data.get('accuracy')) || null,
                createdAt: new Date().toISOString(), // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ ISO-—Å—Ç—Ä–æ–∫–µ –¥–ª—è –∫–µ—à–∞
                photoName: null,
                photoBase64: null
            };

            const photoFile = data.get('photo');

            if (photoFile && photoFile.size > 0) {
                const extension = photoFile.name.split('.').pop();
                const photoName = `${userTelegramId}_${Date.now()}.${extension}`;
                reportData.photoName = photoName;

                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –≤ base64 –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫–µ—à
                const reader = new FileReader();
                reader.onload = async (e) => {
                    reportData.photoBase64 = e.target.result;

                    // 1. –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Firebase
                    if (db) {
                         // –í–Ω–∞—á–∞–ª–µ –ø–æ–ø—ã—Ç–∞–µ–º—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –æ–Ω–ª–∞–π–Ω
                        const success = await attemptDirectUpload(reportData, photoFile);
                        if (!success) {
                            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
                            saveToCache(reportData);
                            window.showAlert('–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω', '–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ –∏ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ.');
                        }
                    } else {
                        // 2. –ï—Å–ª–∏ Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
                        saveToCache(reportData);
                        window.showAlert('–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω', '–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ –∏ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ.');
                    }

                    form.reset();
                    document.getElementById('location-status').innerHTML = '<i data-lucide="map-pin" class="w-4 h-4 mr-1 inline-block text-blue-500"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞';
                    document.getElementById('photo-preview').innerHTML = '';
                    lucide.createIcons();
                    if (isTMA) Telegram.WebApp.MainButton.hideLoader();
                };
                reader.readAsDataURL(photoFile);
            } else {
                // –û—Ç—á–µ—Ç –±–µ–∑ —Ñ–æ—Ç–æ
                // 1. –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Firebase
                if (db) {
                     const success = await attemptDirectUpload(reportData);
                     if (!success) {
                        saveToCache(reportData);
                        window.showAlert('–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω', '–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ –∏ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ.');
                     }
                } else {
                    // 2. –ï—Å–ª–∏ Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
                    saveToCache(reportData);
                    window.showAlert('–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω', '–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ –∏ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ.');
                }

                form.reset();
                document.getElementById('location-status').innerHTML = '<i data-lucide="map-pin" class="w-4 h-4 mr-1 inline-block text-blue-500"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞';
                document.getElementById('photo-preview').innerHTML = '';
                lucide.createIcons();
                if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        };

        /**
         * –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä—è–º–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞ –≤ Firebase.
         * @param {object} reportData –î–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞
         * @param {File} [photoFile] –§–∞–π–ª —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
         * @returns {boolean} true, –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ —É—Å–ø–µ—à–Ω–∞, –∏–Ω–∞—á–µ false.
         */
        const attemptDirectUpload = async (reportData, photoFile = null) => {
            if (!db) return false;

            try {
                let photoUrl = '';
                let photoRefPath = '';

                // 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (photoFile && reportData.photoName) {
                    const photoStorageRef = ref(storage, `${COLLECTION_NAME}/${reportData.photoName}`);
                    await uploadBytes(photoStorageRef, photoFile);
                    photoUrl = await getDownloadURL(photoStorageRef);
                    photoRefPath = photoStorageRef.fullPath;
                }

                // 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Firestore
                const docData = {
                    ...reportData,
                    photoUrl: photoUrl,
                    photoRef: photoRefPath,
                    photoBase64: null, // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore
                    createdAt: Timestamp.now(), // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞
                    syncedAt: Timestamp.now(),
                    agitationUserId: userTelegramId
                };

                // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                await setDoc(doc(collection(db, COLLECTION_NAME)), docData);

                window.showAlert('–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', '–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firebase.');
                window.renderLatestData(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö
                return true;

            } catch (e) {
                console.error("Direct upload failed:", e);
                return false;
            }
        };

        /**
         * –ü–æ–ª—É—á–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         */
        window.renderLatestData = async () => {
            const tbody = document.getElementById('latest-data-body');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500"><i data-lucide="loader-circle" class="w-5 h-5 mr-1 inline-block animate-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
            lucide.createIcons();

            if (!db) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500 font-semibold">Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.</td></tr>';
                return;
            }

            try {
                // –ó–∞–ø—Ä–æ—Å –∫ Firestore: 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –¥–∞—Ç–µ
                const q = query(
                    collection(db, COLLECTION_NAME),
                    where('agitationUserId', '==', userTelegramId),
                    // Firestore –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç orderBy –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤, –ø–æ—ç—Ç–æ–º—É —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤ JS.
                    // .orderBy('createdAt', 'desc'),
                    // .limit(10)
                );

                const querySnapshot = await getDocs(q);
                let reports = [];
                querySnapshot.forEach(doc => {
                    reports.push({ id: doc.id, ...doc.data() });
                });

                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –≤ JS
                reports.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : new Date(a.createdAt).getTime();
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : new Date(b.createdAt).getTime();
                    return dateB - dateA; // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
                });

                const latestReports = reports.slice(0, 10);

                if (latestReports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">–ù–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö.</td></tr>';
                    return;
                }

                tbody.innerHTML = latestReports.map(report => {
                    const dateStr = report.createdAt?.toDate ? report.createdAt.toDate().toLocaleString('ru-RU', { timeStyle: 'short', dateStyle: 'short' }) : new Date(report.createdAt).toLocaleString('ru-RU', { timeStyle: 'short', dateStyle: 'short' });
                    const categoryClass = getCategoryColor(report.category);

                    return `
                        <tr class="hover:bg-gray-50 transition duration-150">
                            <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-800">${dateStr}</td>
                            <td class="px-3 py-2 text-sm text-gray-800">${report.address}</td>
                            <td class="px-3 py-2 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${categoryClass}">
                                    ${report.category.replace(/_/g, ' ')}
                                </span>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="window.viewReport('${report.id}')" class="text-indigo-600 hover:text-indigo-900 mx-1">
                                    <i data-lucide="eye" class="w-4 h-4 inline-block"></i>
                                </button>
                                <button onclick="window.confirmDelete('${report.id}', 'single')" class="text-red-600 hover:text-red-900 mx-1">
                                    <i data-lucide="trash-2" class="w-4 h-4 inline-block"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                lucide.createIcons();

            } catch (e) {
                console.error("Error rendering latest data:", e);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</td></tr>';
            }
        };

        /**
         * –ü–æ–ª—É—á–∞–µ—Ç –∫–ª–∞—Å—Å —Ü–≤–µ—Ç–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
         * @param {string} category
         * @returns {string} Tailwind CSS –∫–ª–∞—Å—Å—ã
         */
        const getCategoryColor = (category) => {
            switch (category) {
                case '–ó–∞': return 'bg-green-100 text-green-800';
                case '–ü—Ä–æ—Ç–∏–≤': return 'bg-red-100 text-red-800';
                case '–ù–µ_–æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è': return 'bg-yellow-100 text-yellow-800';
                case '–ù–µ_–æ–±–Ω–∞—Ä—É–∂–µ–Ω': return 'bg-gray-100 text-gray-800';
                default: return 'bg-blue-100 text-blue-800';
            }
        };

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ—Ç—á–µ—Ç–∞.
         * @param {string} docId ID –¥–æ–∫—É–º–µ–Ω—Ç–∞
         */
        window.viewReport = async (docId) => {
            if (!db) return;

            try {
                const docRef = doc(db, COLLECTION_NAME, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const dateStr = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString('ru-RU', { dateStyle: 'full', timeStyle: 'short' }) : new Date(data.createdAt).toLocaleString('ru-RU', { dateStyle: 'full', timeStyle: 'short' });
                    const detailsDiv = document.getElementById('view-details');

                    let photoHtml = '';
                    if (data.photoUrl) {
                        photoHtml = `<img src="${data.photoUrl}" alt="–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è" class="mt-2 max-h-48 w-full object-contain rounded-lg border border-gray-200" onerror="this.onerror=null; this.src='https://placehold.co/200x150/f3f4f6/374151?text=–ù–µ—Ç+–§–æ—Ç–æ';" />`;
                    }

                    detailsDiv.innerHTML = `
                        <p><strong>–î–∞—Ç–∞/–í—Ä–µ–º—è:</strong> ${dateStr}</p>
                        <p><strong>–ü–æ—Å–µ–ª–µ–Ω–∏–µ:</strong> ${data.settlement}</p>
                        <p><strong>–§–ò–û:</strong> ${data.name}</p>
                        <p><strong>–ê–¥—Ä–µ—Å:</strong> ${data.address}</p>
                        <p><strong>–ü—Ä–∏–∑–Ω–∞–∫:</strong> <span class="px-2 inline-flex text-sm leading-5 font-semibold rounded-full ${getCategoryColor(data.category)}">${data.category.replace(/_/g, ' ')}</span></p>
                        <p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${data.comment || '‚Äî'}</p>
                        <p><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${data.latitude ? `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}` : '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}</p>
                        ${photoHtml}
                        <p class="text-xs text-gray-500 mt-2">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${data.agitationUserId}</p>
                        <p class="text-xs text-gray-500">ID –∑–∞–ø–∏—Å–∏: ${docId}</p>
                    `;
                    lucide.createIcons();
                    document.getElementById('view-modal').classList.add('open');
                } else {
                    window.showAlert('–û—à–∏–±–∫–∞', '–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
                }
            } catch (e) {
                console.error("Error viewing report:", e);
                window.showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—Ç—á–µ—Ç–∞.');
            }
        };

        /**
         * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.
         * @param {string} id ID –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–ª–∏ 'all'
         * @param {'single'|'all'} type –¢–∏–ø —É–¥–∞–ª–µ–Ω–∏—è
         */
        window.confirmDelete = (id, type) => {
            if (type === 'single') {
                window.showConfirm(
                    '–£–¥–∞–ª–µ–Ω–∏–µ –ó–∞–ø–∏—Å–∏',
                    '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?',
                    () => window.deleteReport(id)
                );
            }
        };

        /**
         * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏.
         */
        window.confirmDeleteAll = () => {
            window.showConfirm(
                '–£–î–ê–õ–ï–ù–ò–ï –í–°–ï–ô –ë–ê–ó–´ –î–ê–ù–ù–´–•',
                '–í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç –í–°–ï –∑–∞–ø–∏—Å–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –í—ã —É–≤–µ—Ä–µ–Ω—ã?',
                () => window.deleteAllReports()
            );
        };


        /**
         * –£–¥–∞–ª—è–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å –∏ —Ñ–æ—Ç–æ.
         * @param {string} docId ID –¥–æ–∫—É–º–µ–Ω—Ç–∞
         */
        window.deleteReport = async (docId) => {
            if (!db) return;
            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
                const docRef = doc(db, COLLECTION_NAME, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();

                    // 2. –£–¥–∞–ª—è–µ–º —Ñ–æ—Ç–æ –∏–∑ Storage (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    if (data.photoRef && storage) {
                        const photoRef = ref(storage, data.photoRef);
                        await deleteObject(photoRef).catch(e => {
                            // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                            console.warn("Could not delete photo from Storage:", e);
                        });
                    }

                    // 3. –£–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –∏–∑ Firestore
                    await deleteDoc(docRef);

                    window.showAlert('–£—Å–ø–µ—à–Ω–æ!', '–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞.');
                    window.renderLatestData(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    if (isAdmin) window.fetchAndRenderReports();
                } else {
                    window.showAlert('–û—à–∏–±–∫–∞', '–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.');
                }
            } catch (e) {
                console.error("Error deleting report:", e);
                window.showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + e.message);
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        };


        // --- –ê–î–ú–ò–ù–°–ö–ò–ï –§–£–ù–ö–¶–ò–ò ---

        /**
         * –ü–æ–ª—É—á–∞–µ—Ç –∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ç –≤—Å–µ –æ—Ç—á–µ—Ç—ã –¥–ª—è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏, –∞ —Ç–∞–∫–∂–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.
         */
        window.fetchAndRenderReports = async () => {
            if (!isAdmin || !db) return;

            const tbody = document.getElementById('admin-reports-body');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500"><i data-lucide="loader-circle" class="w-5 h-5 mr-1 inline-block animate-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö...</td></tr>';
            lucide.createIcons();

            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                const settlementFilter = document.getElementById('admin-settlement-filter').value;
                const categoryFilter = document.getElementById('admin-category-filter').value;

                let q = collection(db, COLLECTION_NAME);
                let queryConstraints = [];

                if (settlementFilter) {
                    queryConstraints.push(where('settlement', '==', settlementFilter));
                }
                if (categoryFilter) {
                    queryConstraints.push(where('category', '==', categoryFilter));
                }

                // –í–ê–ñ–ù–û: Firestore –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (AND) –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤,
                // –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –≤ JS, –µ—Å–ª–∏ –∏—Ö –±–æ–ª—å—à–µ 1.
                if (queryConstraints.length > 1) {
                    // –í—ã–ø–æ–ª–Ω—è–µ–º –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å, –∑–∞—Ç–µ–º —Ñ–∏–ª—å—Ç—Ä—É–µ–º –≤ JS
                    if (settlementFilter) {
                        q = query(collection(db, COLLECTION_NAME), where('settlement', '==', settlementFilter));
                    } else if (categoryFilter) {
                        q = query(collection(db, COLLECTION_NAME), where('category', '==', categoryFilter));
                    } else {
                        q = collection(db, COLLECTION_NAME);
                    }
                } else if (queryConstraints.length === 1) {
                    q = query(collection(db, COLLECTION_NAME), queryConstraints[0]);
                }


                const querySnapshot = await getDocs(q);
                let reports = [];
                let stats = { –ó–∞: 0, –ü—Ä–æ—Ç–∏–≤: 0, –ù–µ_–æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è: 0, –ù–µ_–æ–±–Ω–∞—Ä—É–∂–µ–Ω: 0, total: 0 };

                querySnapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };

                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ç–æ—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä (–µ—Å–ª–∏ –∏—Ö –±—ã–ª–æ –¥–≤–∞)
                    if (queryConstraints.length > 1) {
                        let shouldInclude = true;
                        if (settlementFilter && data.settlement !== settlementFilter) shouldInclude = false;
                        if (categoryFilter && data.category !== categoryFilter) shouldInclude = false;

                        if (!shouldInclude) return;
                    }


                    reports.push(data);
                    stats[data.category] = (stats[data.category] || 0) + 1;
                    stats.total++;
                });

                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –≤ JS
                reports.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : new Date(a.createdAt).getTime();
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : new Date(b.createdAt).getTime();
                    return dateB - dateA; // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
                });


                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                renderSummary(stats);

                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã
                if (reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</td></tr>';
                } else {
                    tbody.innerHTML = reports.map(report => {
                        const dateStr = report.createdAt?.toDate ? report.createdAt.toDate().toLocaleString('ru-RU', { timeStyle: 'short', dateStyle: 'short' }) : new Date(report.createdAt).toLocaleString('ru-RU', { timeStyle: 'short', dateStyle: 'short' });
                        const categoryClass = getCategoryColor(report.category);

                        return `
                            <tr class="hover:bg-gray-50 transition duration-150">
                                <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-800">${dateStr}</td>
                                <td class="px-3 py-2 text-sm text-gray-800">${report.settlement}</td>
                                <td class="px-3 py-2 text-sm text-gray-800">${report.address}</td>
                                <td class="px-3 py-2 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${categoryClass}">
                                        ${report.category.replace(/_/g, ' ')}
                                    </span>
                                </td>
                                <td class="px-3 py-2 text-xs text-gray-500 truncate max-w-xs">${report.comment || '‚Äî'}</td>
                                <td class="px-3 py-2 text-sm text-gray-800">${report.name}</td>
                                <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium">
                                    <button onclick="window.viewReport('${report.id}')" class="text-indigo-600 hover:text-indigo-900 mx-1">
                                        <i data-lucide="eye" class="w-4 h-4 inline-block"></i>
                                    </button>
                                    <button onclick="window.deleteReport('${report.id}')" class="text-red-600 hover:text-red-900 mx-1">
                                        <i data-lucide="trash-2" class="w-4 h-4 inline-block"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                lucide.createIcons();

            } catch (e) {
                console.error("Error fetching admin reports:", e);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</td></tr>';
            }
        };

        let categoryChartInstance = null;
        /**
         * –†–µ–Ω–¥–µ—Ä–∏—Ç —Å–≤–æ–¥–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –≥—Ä–∞—Ñ–∏–∫.
         * @param {object} stats –û–±—ä–µ–∫—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
         */
        const renderSummary = (stats) => {
            const summaryDiv = document.getElementById('report-summary');
            const total = stats.total;

            const summaryHtml = Object.keys(stats).filter(key => key !== 'total').map(key => {
                const count = stats[key];
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                const color = {
                    '–ó–∞': 'text-green-600',
                    '–ü—Ä–æ—Ç–∏–≤': 'text-red-600',
                    '–ù–µ_–æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è': 'text-yellow-600',
                    '–ù–µ_–æ–±–Ω–∞—Ä—É–∂–µ–Ω': 'text-gray-600'
                }[key] || 'text-blue-600';

                return `
                    <div class="card p-4 border border-gray-200">
                        <p class="text-sm font-medium text-gray-500">${key.replace(/_/g, ' ')}</p>
                        <p class="text-2xl font-bold ${color}">${count}</p>
                        <p class="text-xs text-gray-400">${percentage}%</p>
                    </div>
                `;
            }).join('');

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É "–í—Å–µ–≥–æ"
            const totalCard = `
                <div class="card p-4 border border-primary-light bg-primary-light/10">
                    <p class="text-sm font-medium text-gray-700">–í—Å–µ–≥–æ –ó–∞–ø–∏—Å–µ–π</p>
                    <p class="text-2xl font-bold text-primary-color">${total}</p>
                    <p class="text-xs text-transparent">.</p>
                </div>
            `;
            summaryDiv.innerHTML = totalCard + summaryHtml;

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≥—Ä–∞—Ñ–∏–∫–∞
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }

            const dataKeys = ['–ó–∞', '–ü—Ä–æ—Ç–∏–≤', '–ù–µ_–æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è', '–ù–µ_–æ–±–Ω–∞—Ä—É–∂–µ–Ω'];
            const dataValues = dataKeys.map(key => stats[key] || 0);

            categoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: dataKeys.map(k => k.replace(/_/g, ' ')),
                    datasets: [{
                        data: dataValues,
                        backgroundColor: ['#047857', '#dc2626', '#fbbf24', '#9ca3af'], // Green, Red, Yellow, Gray
                        hoverBackgroundColor: ['#059669', '#ef4444', '#f59e0b', '#d1d5db']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        };

        /**
         * –£–¥–∞–ª—è–µ—Ç –≤—Å—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –æ—Ç—á–µ—Ç–æ–≤.
         */
        window.deleteAllReports = async () => {
            if (!isAdmin || !db) return;
            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            try {
                const collectionRef = collection(db, COLLECTION_NAME);
                const querySnapshot = await getDocs(collectionRef);
                let deletedCount = 0;
                let photoRefs = [];
                const batch = writeBatch(db);

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.photoRef) {
                        photoRefs.push(data.photoRef);
                    }
                    batch.delete(doc.ref);
                    deletedCount++;
                });

                if (deletedCount > 0) {
                    await batch.commit();

                    // –£–¥–∞–ª—è–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏–∑ Storage
                    if (storage) {
                        for (const photoRefPath of photoRefs) {
                            const photoRef = ref(storage, photoRefPath);
                            await deleteObject(photoRef).catch(e => console.warn("Could not delete photo from Storage during cleanup:", e));
                        }
                    }
                }

                document.getElementById('admin-reports-body').innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500 font-semibold">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞.</td></tr>';

                // –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∞
                dataCache = [];
                localStorage.removeItem(COLLECTION_NAME);
                updateOfflineStatus();
                showAlert('–£—Å–ø–µ—à–Ω–æ!', `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} –∑–∞–ø–∏—Å–µ–π. –î–∞–Ω–Ω—ã–µ Firestore –æ—á–∏—â–µ–Ω—ã.`);

                if (isAdmin) fetchAndRenderReports();

                return true;

            } catch (e) {
                 console.error("Error deleting collection:", e);
                 showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + e.message);
                 return false;
            } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        };

        // --- –†–ê–ë–û–¢–ê –° –ö–ê–†–¢–û–ô ---

        let mapInstance = null;
        let markersGroup = null; // –î–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
        let heatLayerInstance = null; // –î–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–∞—Ä—Ç—É —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ç–∏–ø–æ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
         * @param {'marker'|'cluster'|'heat'} type –¢–∏–ø –∫–∞—Ä—Ç—ã
         */
        window.generateMap = async (type) => {
            if (!db) return;

            // –°–±–æ—Ä –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –∫–∞—Ä—Ç—ã
            let reports = [];
            try {
                const q = collection(db, COLLECTION_NAME);
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.latitude && data.longitude) {
                        reports.push(data);
                    }
                });
            } catch (e) {
                console.error("Error fetching map data:", e);
                return;
            }

            // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã ---
            if (!mapInstance) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –æ—Ç—á–µ—Ç–æ–≤, —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –†–æ—Å—Å–∏–∏
                const initialLat = reports.length > 0 ? reports[0].latitude : 55.7558;
                const initialLng = reports.length > 0 ? reports[0].longitude : 37.6176;

                mapInstance = L.map('map').setView([initialLat, initialLng], 7);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(mapInstance);
            }

            // --- –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–ª–æ–µ–≤ ---
            if (markersGroup) mapInstance.removeLayer(markersGroup);
            if (heatLayerInstance) mapInstance.removeLayer(heatLayerInstance);

            // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω–æ–≤–æ–≥–æ —Å–ª–æ—è ---
            if (type === 'marker' || type === 'cluster') {
                markersGroup = type === 'cluster' ? L.markerClusterGroup() : L.layerGroup();

                reports.forEach(report => {
                    const color = {
                        '–ó–∞': 'green',
                        '–ü—Ä–æ—Ç–∏–≤': 'red',
                        '–ù–µ_–æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è': 'orange',
                        '–ù–µ_–æ–±–Ω–∞—Ä—É–∂–µ–Ω': 'gray'
                    }[report.category] || 'blue';

                    const iconHtml = `<div style="background-color:${color}; width: 1.5rem; height: 1.5rem; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 2px black;"></div>`;
                    const customIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: iconHtml,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    const dateStr = report.createdAt?.toDate ? report.createdAt.toDate().toLocaleString('ru-RU', { timeStyle: 'short', dateStyle: 'short' }) : new Date(report.createdAt).toLocaleString('ru-RU', { timeStyle: 'short', dateStyle: 'short' });
                    const popupContent = `
                        <strong>${report.settlement}</strong><br>
                        ${report.address}<br>
                        –ü—Ä–∏–∑–Ω–∞–∫: <b>${report.category.replace(/_/g, ' ')}</b><br>
                        <small>${dateStr}</small>
                    `;

                    const marker = L.marker([report.latitude, report.longitude], { icon: customIcon })
                        .bindPopup(popupContent);

                    markersGroup.addLayer(marker);
                });

                mapInstance.addLayer(markersGroup);
                if (reports.length > 0) {
                     // –í—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
                    const bounds = reports.map(r => [r.latitude, r.longitude]);
                    mapInstance.fitBounds(bounds, { padding: [20, 20] });
                }

            } else if (type === 'heat') {
                const heatData = reports.map(report => [report.latitude, report.longitude, 1]); // 1 - –≤–µ—Å
                heatLayerInstance = L.heatLayer(heatData, { radius: 25, maxZoom: 14 }).addTo(mapInstance);
                if (reports.length > 0) {
                    const bounds = reports.map(r => [r.latitude, r.longitude]);
                    mapInstance.fitBounds(bounds, { padding: [20, 20] });
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('#map-view-section button').forEach(btn => btn.classList.remove('btn-primary'));
            const activeBtn = document.querySelector(`#map-view-section button[onclick="window.generateMap('${type}')"]`);
            if (activeBtn) activeBtn.classList.add('btn-primary');
        };

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // üîë –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–û–∂–∏–¥–∞–µ–º authenticateUser)
        window.onload = async () => {
            // 1. –°–Ω–∞—á–∞–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ isAdmin –∏ userTelegramId
            await authenticateUser();

            // 2. –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            populateSettlements();
            updateOfflineStatus();
            window.showSection('form');
            lucide.createIcons();

            // –û–¢–õ–ê–î–ö–ê: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
            document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';

            if (!firebaseConfig.projectId) {
                window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase –≤ –∫–æ–¥.');
            }
        };

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        window.authenticateUser = authenticateUser;
        window.fetchAndRenderReports = fetchAndRenderReports;
        window.renderLatestData = renderLatestData;
        window.generateMap = generateMap;
    </script>
</body>
</html>
