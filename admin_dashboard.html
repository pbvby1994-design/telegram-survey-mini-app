<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | –ü–∞–Ω–µ–ª—å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –ò–∫–æ–Ω–∫–∏ Font Awesome –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script> 
    <style>
        /* --- –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Telegram --- */
        body {
            background-color: var(--tg-theme-bg-color, #f4f4f5);
            color: var(--tg-theme-text-color, #1a1a1a);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            padding: 15px;
            max-width: 650px;
            margin: 0 auto;
        }
        h1 {
            color: var(--tg-theme-text-color, #1a1a1a);
            margin: 10px 0 20px;
            font-size: 1.4em;
            text-align: center;
        }

        /* --- –í–∫–ª–∞–¥–∫–∏ (Tabs) --- */
        .tabs {
            display: flex;
            width: 100%;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab-button {
            flex: 1;
            padding: 12px 10px;
            text-align: center;
            background-color: var(--tg-theme-secondary-bg-color, #fff);
            color: var(--tg-theme-hint-color, #888);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.9em;
        }
        .tab-button.active {
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #fff);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* --- –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã --- */
        .form-group {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--tg-theme-hint-color, #777);
            font-size: 0.85em;
        }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            box-sizing: border-box;
            background-color: var(--tg-theme-bg-color); 
            color: var(--tg-theme-text-color);
            transition: border-color 0.3s;
            appearance: none;
            font-size: 1em;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            border-color: var(--tg-theme-link-color, #007aff);
            background-color: var(--tg-theme-secondary-bg-color);
            outline: none;
        }
        
        /* --- –ì—Ä—É–ø–ø—ã –≤—ã–±–æ—Ä–∞ (—Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∏) --- */
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .radio-option {
            flex-grow: 1;
            flex-basis: calc(50% - 4px); 
            text-align: center;
            padding: 10px 5px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
        }
        .radio-option-selected {
            background-color: var(--tg-theme-link-color, #007aff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-color: var(--tg-theme-link-color);
            font-weight: 600;
        }

        /* --- –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è/–ß–µ–∫–±–æ–∫—Å --- */
        #get-location-btn {
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            padding: 10px;
            border: none;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #location-status {
            margin-top: 5px;
            font-size: 0.8em;
            color: var(--tg-theme-hint-color);
            text-align: center;
            transition: color 0.3s;
        }
        .status-success { color: var(--tg-theme-button-color) !important; }
        .status-error { color: var(--tg-theme-destructive-text-color, #ff3b30) !important; }

        .checkbox-container {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            margin-top: 10px;
        }
        #photo_requested {
            transform: scale(1.2);
            margin-right: 10px;
        }

        /* --- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å --- */
        .admin-button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
        }
        .admin-command-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 10px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: opacity 0.2s, transform 0.1s;
            text-align: center;
        }
        .admin-command-btn:active {
            transform: scale(0.98);
        }
        .admin-command-btn i {
            font-size: 1.5em;
            margin-bottom: 8px;
        }
        .admin-section-title {
            color: var(--tg-theme-link-color);
            font-weight: 700;
            font-size: 1.1em;
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>–ü–∞–Ω–µ–ª—å {role_label}</h1>

        <!-- –ë–õ–û–ö –í–∫–ª–∞–¥–æ–∫ -->
        <div class="tabs" id="main-tabs">
            <button class="tab-button active" data-tab="tab-agitation">
                <i class="fas fa-edit"></i> –ê–ì–ò–¢–ê–¢–û–†
            </button>
            <!-- –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ JS, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω -->
            <button class="tab-button" data-tab="tab-admin" id="admin-tab-btn" style="display:none;">
                <i class="fas fa-tools"></i> –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†
            </button>
        </div>

        <!-- 1. –ê–ì–ò–¢–ê–¢–û–† (–§–æ—Ä–º–∞) -->
        <div class="tab-content active" id="tab-agitation">
            <form id="survey-form">

                <!-- 1. –ê–î–†–ï–°: –ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç -->
                <div class="form-group">
                    <label for="settlement">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç <span style="color:red;">*</span></label>
                    <select id="settlement" required></select>
                </div>

                <!-- 2. –ê–î–†–ï–°: –£–ª–∏—Ü–∞ / –î–æ–º / –ö–≤–∞—Ä—Ç–∏—Ä–∞ -->
                <div class="form-group">
                    <label for="street">–£–ª–∏—Ü–∞ <span style="color:red;">*</span></label>
                    <input type="text" id="street" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è">
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <div style="flex: 1;">
                            <label for="house" style="font-size: 0.85em;">–î–æ–º <span style="color:red;">*</span></label>
                            <input type="text" id="house" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 15/–ê">
                        </div>
                        <div style="flex: 1;">
                            <label for="apartment" style="font-size: 0.85em;">–ö–≤–∞—Ä—Ç–∏—Ä–∞</label>
                            <input type="text" id="apartment" value="" placeholder="–ï—Å–ª–∏ –Ω–µ—Ç - –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º">
                        </div>
                    </div>
                </div>

                <!-- 3. –†–ï–ó–£–õ–¨–¢–ê–¢ –î–ï–ô–°–¢–í–ò–Ø -->
                <div class="form-group">
                    <label>–†–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–Ω—Ç–∞–∫—Ç–∞ <span style="color:red;">*</span></label>
                    <div class="radio-group" id="action-result-group">
                        <div class="radio-option" data-value="positive">‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∞–ª</div>
                        <div class="radio-option" data-value="negative">‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∞–ª</div>
                    </div>
                    <input type="hidden" id="action_result" required>
                </div>

                <!-- 4. –õ–û–Ø–õ–¨–ù–û–°–¢–¨ / –ü–†–ò–ß–ò–ù–ê -->
                <div class="form-group">
                    <label>–õ–æ—è–ª—å–Ω–æ—Å—Ç—å / –ü—Ä–∏—á–∏–Ω–∞</label>
                    <div class="radio-group" id="loyalty-group">
                        <div class="radio-option" data-value="loyal">üëç –õ–æ—è–ª–µ–Ω</div>
                        <div class="radio-option" data-value="doubtful">ü§î –°–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è</div>
                        <div class="radio-option" data-value="not_loyal">üëé –ù–µ –ª–æ—è–ª–µ–Ω</div>
                        <div class="radio-option" data-value="not_opened">üö™ –ù–µ –æ—Ç–∫—Ä—ã–ª–∏</div>
                    </div>
                    <input type="hidden" id="loyalty" required>
                </div>
                
                <!-- 5. –ì–ï–û–õ–û–ö–ê–¶–ò–Ø -->
                <div class="form-group">
                    <label>–ì–µ–æ–ø–æ–∑–∏—Ü–∏—è (–î–ª—è –∫–∞—Ä—Ç—ã)</label>
                    <button type="button" id="get-location-btn">
                        <span id="loc-icon">üìç</span> –ü–æ–ª—É—á–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                    </button>
                    <div id="location-status">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: 0.0, 0.0 (–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è...)</div>
                    <input type="hidden" id="latitude" value="0.0" required>
                    <input type="hidden" id="longitude" value="0.0" required>
                </div>

                <!-- 6. –§–û–¢–û–ì–†–ê–§–ò–Ø -->
                <div class="form-group">
                    <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è (–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)</label>
                    <div class="checkbox-container">
                        <input type="checkbox" id="photo_requested"> 
                        <label for="photo_requested" style="display: inline; font-weight: normal; color: var(--tg-theme-text-color);">
                            –•–æ—á—É –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ: –ë–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –µ–≥–æ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.
                        </label>
                    </div>
                </div>

                <!-- 7. –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô -->
                <div class="form-group">
                    <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)</label>
                    <textarea id="comment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏, –ø—Ä–∏—á–∏–Ω—ã –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–∞/–ø–æ–¥–¥–µ—Ä–∂–∫–∏"></textarea>
                </div>

            </form>
        </div>
        
        <!-- 2. –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–† (–ü–∞–Ω–µ–ª—å) -->
        <div class="tab-content" id="tab-admin">
            <div class="form-group">
                <p class="admin-section-title">üìä –ê–ù–ê–õ–ò–ó –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê</p>
                <div class="admin-button-grid">
                    <!-- –í—Å–µ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç JSON { "command": "/..." } –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç -->
                    <button class="admin-command-btn" data-command="/stats">
                        <i class="fas fa-chart-bar"></i> –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </button>
                    <button class="admin-command-btn" data-command="/map">
                        <i class="fas fa-map-marker-alt"></i> –ö–∞—Ä—Ç–∞ —Ç–æ—á–µ–∫
                    </button>
                    <button class="admin-command-btn" data-command="/export_all">
                        <i class="fas fa-file-excel"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ XLSX
                    </button>
                    <button class="admin-command-btn" data-command="/export_ppt">
                        <i class="fas fa-file-powerpoint"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ PPT
                    </button>
                </div>
            </div>

            <div class="form-group">
                <p class="admin-section-title">üíæ –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò</p>
                <div class="admin-button-grid">
                    <button class="admin-command-btn" data-command="/backup">
                        <i class="fas fa-database"></i> –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –ë–î
                    </button>
                    <button class="admin-command-btn" data-command="/delete_all" style="background-color: var(--tg-theme-destructive-text-color, #ff3b30);">
                        <i class="fas fa-trash-alt"></i> –£–î–ê–õ–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï
                    </button>
                </div>
            </div>
            <p style="text-align: center; font-size: 0.8em; color: var(--tg-theme-hint-color); margin-top: 20px;">
                * –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
            </p>
        </div>

    </div>

    <script>
        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp ---
        const settlements = [
            "–≥.–ø. –ë–∞—Ä—Å–æ–≤–æ", "—Å.–ø. –°–æ–ª–Ω–µ—á–Ω—ã–π", "—Å.–ø. –¢—É–Ω–¥—Ä–∏–Ω–æ", "—Å.–ø. –õ—è–º–∏–Ω–∞", 
            "–≥.–ø. –õ—è–Ω—Ç–æ—Ä", "–≥.–ø. –§–µ–¥–æ—Ä–æ–≤—Å–∫–∏–π", "–≥.–ø. –ë–µ–ª—ã–π –Ø—Ä", "—Å.–ø. –£–ª—å—Ç-–Ø–≥—É–Ω", 
            "—Å.–ø. –°—ã—Ç–æ–º–∏–Ω–æ", "—Å.–ø. –†—É—Å—Å–∫–∏–Ω—Å–∫–∞—è", "—Å.–ø. –ù–∏–∂–Ω–µ—Å–æ—Ä—Ç—ã–º—Å–∫–∏–π", "—Å.–ø. –£–≥—É—Ç", 
            "—Å.–ø. –õ–æ–∫–æ—Å–æ–≤–æ"
        ];
        
        const WebApp = window.Telegram.WebApp;
        WebApp.ready();
        WebApp.setHeaderColor('secondary_bg_color'); 
        WebApp.setBackgroundColor('bg_color'); 

        // –§–ª–∞–≥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: query_id –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ WebApp –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É/–º–µ–Ω—é
        // –≠—Ç–æ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–ª Mini App.
        const is_admin = !!WebApp.initDataUnsafe.query_id; 
        let currentTab = 'tab-agitation';
        
        document.querySelector('h1').textContent = is_admin ? "–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" : "–ü–∞–Ω–µ–ª—å –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞";

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –í–ö–õ–ê–î–û–ö ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            currentTab = tabId;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∫–ª–∞–¥–∫–∏
            if (tabId === 'tab-agitation') {
                WebApp.MainButton.setText('–°–û–•–†–ê–ù–ò–¢–¨ –î–ê–ù–ù–´–ï (–û–¢–ü–†–ê–í–ò–¢–¨)');
                WebApp.MainButton.show();
            } else {
                WebApp.MainButton.hide();
            }
        }

        // –ï—Å–ª–∏ –∞–¥–º–∏–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É –ê–¥–º–∏–Ω–∞ –∏ —Å—Ç–∞–≤–∏–º —Å–ª—É—à–∞—Ç–µ–ª—å
        if (is_admin) {
            const adminBtn = document.getElementById('admin-tab-btn');
            adminBtn.style.display = 'block';
            adminBtn.addEventListener('click', () => switchTab('tab-admin'));
        }
        
        document.querySelector('[data-tab="tab-agitation"]').addEventListener('click', () => switchTab('tab-agitation'));
        switchTab('tab-agitation'); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é


        // --- –§–£–ù–ö–¶–ò–ò –ì–ï–û–õ–û–ö–ê–¶–ò–ò ---
        const locationStatus = document.getElementById('location-status');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const locationBtn = document.getElementById('get-location-btn');
        const locIcon = document.getElementById('loc-icon');

        function updateLocationStatus(message, isError = false) {
            locationStatus.textContent = message;
            locationStatus.className = 'status-' + (isError ? 'error' : 'success');
            locIcon.textContent = isError ? '‚ùå' : (message.includes('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã') ? '‚úÖ' : '‚è≥');
        }

        function getLocation(isInitial = false) {
            if (!("geolocation" in navigator)) {
                updateLocationStatus('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º.', true);
                return;
            }
            
            if (!isInitial) WebApp.showProgress();

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    if (!isInitial) WebApp.hideProgress();
                    latitudeInput.value = position.coords.latitude.toFixed(6);
                    longitudeInput.value = position.coords.longitude.toFixed(6);
                    updateLocationStatus(`‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã: ${latitudeInput.value}, ${longitudeInput.value}`);
                    WebApp.HapticFeedback.notificationOccurred('success');
                },
                (error) => {
                    if (!isInitial) WebApp.hideProgress();
                    
                    let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏.';
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage += ' –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Mini App.';
                    } else if (error.code === error.TIMEOUT) {
                        errorMessage += ' –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.';
                    } else {
                        errorMessage += ' –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.';
                    }
                    
                    updateLocationStatus(errorMessage, true);
                    WebApp.HapticFeedback.notificationOccurred('error');
                    
                    latitudeInput.value = '0.0';
                    longitudeInput.value = '0.0';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        getLocation(true);
        locationBtn.addEventListener('click', (e) => {
            e.preventDefault();
            getLocation(false);
        });

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –§–û–†–ú–´ –ê–ì–ò–¢–ê–¢–û–†–ê (–°–µ–ª–µ–∫—Ç—ã –∏ –†–∞–¥–∏–æ-–≥—Ä—É–ø–ø—ã) ---
        const settlementSelect = document.getElementById('settlement');
        settlements.forEach(s => {
            const option = document.createElement('option');
            option.value = s;
            option.textContent = s;
            settlementSelect.appendChild(option);
        });

        function setupRadioGroup(groupId, inputId) {
            document.getElementById(groupId).addEventListener('click', (e) => {
                const target = e.target.closest('.radio-option');
                if (target) {
                    document.querySelectorAll(`#${groupId} .radio-option`).forEach(opt => {
                        opt.classList.remove('radio-option-selected');
                    });
                    target.classList.add('radio-option-selected');
                    document.getElementById(inputId).value = target.getAttribute('data-value');
                }
            });
        }
        setupRadioGroup('action-result-group', 'action_result');
        setupRadioGroup('loyalty-group', 'loyalty');


        // --- –û–ë–†–ê–ë–û–¢–ö–ê –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–ò–í–ù–´–• –ö–û–ú–ê–ù–î ---
        document.getElementById('tab-admin').addEventListener('click', (e) => {
            const target = e.target.closest('.admin-command-btn');
            if (target) {
                const command = target.getAttribute('data-command');
                
                if (command === '/delete_all') {
                    WebApp.showConfirm('–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ë–ï–ó–í–û–ó–í–†–ê–¢–ù–û —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?', (ok) => {
                        if (ok) {
                            sendAdminCommand(command);
                        }
                    });
                } else {
                    sendAdminCommand(command);
                }
            }
        });
        
        function sendAdminCommand(command) {
            const data = { command: command };
            WebApp.sendData(JSON.stringify(data));
            WebApp.showAlert(`–ö–æ–º–∞–Ω–¥–∞ ${command} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û—Ç–≤–µ—Ç –±—É–¥–µ—Ç –≤ —á–∞—Ç–µ —Å –±–æ—Ç–æ–º.`);
        }


        // --- –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –î–ê–ù–ù–´–• –ê–ì–ò–¢–ê–¢–û–†–ê (MainButton) ---
        WebApp.onEvent('mainButtonClicked', function(){
            if (currentTab !== 'tab-agitation') return; // –¢–æ–ª—å–∫–æ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞

            const form = document.getElementById('survey-form');
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
            if (!document.getElementById('settlement').value || 
                !document.getElementById('street').value || 
                !document.getElementById('house').value ||
                !document.getElementById('action_result').value) 
            {
                WebApp.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–æ—Ç–º–µ—á–µ–Ω—ã *).');
                WebApp.HapticFeedback.notificationOccurred('warning');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–∞)
            if (!document.getElementById('loyalty').value) {
                WebApp.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –õ–æ—è–ª—å–Ω–æ—Å—Ç—å / –ü—Ä–∏—á–∏–Ω—É.');
                WebApp.HapticFeedback.notificationOccurred('warning');
                return;
            }

            const data = {
                settlement: document.getElementById('settlement').value,
                street: document.getElementById('street').value,
                house: document.getElementById('house').value,
                apartment: document.getElementById('apartment').value || '0',
                action_result: document.getElementById('action_result').value,
                loyalty: document.getElementById('loyalty').value,
                comment: document.getElementById('comment').value,
                latitude: parseFloat(latitudeInput.value),
                longitude: parseFloat(longitudeInput.value),
                photo_requested: document.getElementById('photo_requested').checked ? '1' : '0'
            };
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ 0.0 (–≥–µ–æ–ø–æ–∑–∏—Ü–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞)
            if (data.latitude === 0.0 && data.longitude === 0.0) {
                 WebApp.showConfirm('–ì–µ–æ–ø–æ–∑–∏—Ü–∏—è –Ω–µ –±—ã–ª–∞ –ø–æ–ª—É—á–µ–Ω–∞. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –±–µ–∑ —Ç–æ—á–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç?', (ok) => {
                    if (ok) {
                        WebApp.sendData(JSON.stringify(data));
                        WebApp.close();
                    }
                 });
                 return;
            }

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            WebApp.sendData(JSON.stringify(data));
            WebApp.close();
        });
        
    </script>
</body>
</html>
