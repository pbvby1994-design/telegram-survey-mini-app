<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | v2.7 (–§–ò–ù–ê–õ–¨–ù–´–ô –§–ò–ö–° –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ID)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script> 
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏ Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, query, getDocs, limit, orderBy, startAfter, deleteDoc, writeBatch, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –æ–±—ã—á–Ω—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
        window.firebaseDependencies = { initializeApp, getFirestore, collection, doc, setDoc, query, getDocs, limit, orderBy, startAfter, deleteDoc, writeBatch, where, updateDoc, getAuth, signInAnonymously, getStorage, ref, uploadBytes, getDownloadURL };
    </script>

    <style>
        /* üé® –°—Ç–∏–ª–∏ –¥–ª—è Telegram Mini App */
        body {
            font-family: 'Jost', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: background-color 0.3s, color 0.3s;
        }

        .tg-input {
            border-color: var(--tg-theme-hint-color, #999999);
            color: var(--tg-theme-text-color, #000000);
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            transition: border-color 0.3s, background-color 0.3s;
        }

        .tg-button {
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            transition: background-color 0.3s;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è (Footer) */
        #main-footer {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-top: 1px solid var(--tg-theme-secondary-bg-color, #e0e0e0);
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            color: var(--tg-theme-hint-color, #999999);
        }

        .nav-item.active {
            color: var(--tg-theme-link-color, #2481cc);
        }
        
        /* –°–∫—Ä—ã—Ç–∏–µ —Å–µ–∫—Ü–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        .page-section {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDVeRXO16KtIwoJQb4uHQuCsEv3xTLBGhI", // –í–ê–® –ö–õ–Æ–ß
            authDomain: "agitator-notebook.firebaseapp.com",
            projectId: "agitator-notebook",
            storageBucket: "agitator-notebook.firebasestorage.app",
            messagingSenderId: "518555352011",
            appId: "1:518555352011:web:2b1f868d4a65c4011e405a"
        };
    </script>

    <div id="app" class="p-4 sm:p-6 mx-auto">
        <div id="debugCard" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-2 mb-4 text-xs rounded-lg flex justify-between items-center transition-all">
            <div class="flex flex-col">
                <p>–û—Ç–ª–∞–¥–∫–∞:</p>
                <p>–í–∞—à ID: <span id="debugUserId" class="font-semibold">...</span></p>
                <p>–°—Ç–∞—Ç—É—Å –ê–¥–º–∏–Ω–∞: <span id="debugAdminStatus" class="font-semibold">...</span> | –û—Ñ–ª–∞–π–Ω-–ö—ç—à: <span id="debugOfflineCount" class="font-semibold">0</span></p>
            </div>
            <button onclick="document.getElementById('debugCard').classList.add('hidden')" class="text-yellow-700 hover:text-yellow-900 ml-4">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>

        <section id="form" class="page-section active">
            <h1 class="text-2xl font-bold mb-4">–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞</h1>
            <div id="form-content">
                <div class="space-y-4">
                    <input type="text" id="fullName" placeholder="–§–ò–û –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" class="tg-input w-full p-3 rounded-lg border focus:ring focus:ring-opacity-50">
                    <select id="settlement" class="tg-input w-full p-3 rounded-lg border focus:ring focus:ring-opacity-50"></select>
                    <input type="text" id="street" placeholder="–£–ª–∏—Ü–∞" class="tg-input w-full p-3 rounded-lg border focus:ring focus:ring-opacity-50">
                    <input type="text" id="house" placeholder="–ù–æ–º–µ—Ä –¥–æ–º–∞" class="tg-input w-full p-3 rounded-lg border focus:ring focus:ring-opacity-50">
                    <input type="text" id="apartment" placeholder="–ö–≤–∞—Ä—Ç–∏—Ä–∞/–ü–æ–º–µ—â–µ–Ω–∏–µ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" class="tg-input w-full p-3 rounded-lg border focus:ring focus:ring-opacity-50">
                    
                    <select id="action" class="tg-input w-full p-3 rounded-lg border focus:ring focus:ring-opacity-50">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ *</option>
                        <option value="–û–±—Ö–æ–¥">–û–±—Ö–æ–¥</option>
                        <option value="–°–æ–±—Ä–∞–Ω–∏–µ">–°–æ–±—Ä–∞–Ω–∏–µ</option>
                        <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                    </select>

                    <select id="loyalty" class="tg-input w-full p-3 rounded-lg border focus:ring focus:ring-opacity-50">
                        <option value="">–£—Ä–æ–≤–µ–Ω—å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ *</option>
                        <option value="–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç</option>
                        <option value="–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ">–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ</option>
                        <option value="–ü—Ä–æ—Ç–∏–≤">–ü—Ä–æ—Ç–∏–≤</option>
                        <option value="–ù–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è">–ù–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è</option>
                    </select>
                    
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="requiresFollowup" class="form-checkbox h-5 w-5 rounded tg-input">
                        <span class="text-sm">–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –æ–±—Ö–æ–¥ / follow-up</span>
                    </label>

                    <textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" rows="3" class="tg-input w-full p-3 rounded-lg border focus:ring focus:ring-opacity-50"></textarea>

                    <button onclick="saveData()" class="tg-button w-full p-3 rounded-lg font-semibold text-lg hover:opacity-90">
                        <i data-lucide="save" class="w-5 h-5 inline-block mr-2"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                    <button onclick="syncOfflineData()" id="syncButton" class="tg-input w-full p-3 rounded-lg font-semibold text-lg opacity-70 hover:opacity-100 hidden">
                        <i data-lucide="cloud-upload" class="w-5 h-5 inline-block mr-2"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å (<span id="syncCount">0</span>)
                    </button>
                </div>
            </div>
            <h2 class="text-xl font-bold mt-8 mb-3">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∑–∞–ø–∏—Å–µ–π:</h2>
            <div id="latest-data" class="space-y-2 text-sm">
                <p class="text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π...</p>
            </div>
        </section>

        <section id="reports" class="page-section">
            <h1 class="text-2xl font-bold mb-4">–û—Ç—á–µ—Ç—ã</h1>
            
            <button onclick="fetchAndRenderReports()" class="tg-button w-full p-3 rounded-lg font-semibold mb-4 hover:opacity-90">
                <i data-lucide="rotate-ccw" class="w-5 h-5 inline-block mr-2"></i> –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç—á–µ—Ç—ã
            </button>
            <button onclick="exportToXLSX()" class="tg-input w-full p-3 rounded-lg font-semibold mb-4 hover:opacity-100">
                <i data-lucide="download" class="w-5 h-5 inline-block mr-2"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ XLSX
            </button>

            <div id="stats-section" class="space-y-6">
                <h2 class="text-xl font-semibold">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="p-4 rounded-lg shadow-md bg-white text-gray-800">
                    <p class="text-sm text-gray-500">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:</p>
                    <p id="totalRecords" class="text-2xl font-bold">0</p>
                </div>

                <h2 class="text-xl font-semibold">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</h2>
                <div class="h-64"><canvas id="loyaltyChart"></canvas></div>

                <h2 class="text-xl font-semibold mt-6">–ö–∞—Ä—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π</h2>
                <div id="map-container" class="h-96 rounded-lg shadow-md mb-6">
                    <div id="map" class="h-full w-full rounded-lg"></div>
                </div>

                <h2 class="text-xl font-semibold">–ü–æ—Å–µ–ª–µ–Ω–∏—è –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
                <div class="h-96"><canvas id="settlementChart"></canvas></div>

                <h2 class="text-xl font-semibold mt-6">–¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
                <div class="overflow-x-auto">
                    <table id="reports-table" class="min-w-full divide-y divide-gray-200">
                        <thead></thead>
                        <tbody class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="pagination-buttons" class="flex justify-between mt-4">
                    <button onclick="loadMoreData(true)" class="tg-input px-4 py-2 rounded-lg font-semibold hover:opacity-90 disabled:opacity-50" id="prevPageBtn" disabled>
                        –ù–∞–∑–∞–¥
                    </button>
                    <button onclick="loadMoreData(false)" class="tg-input px-4 py-2 rounded-lg font-semibold hover:opacity-90 disabled:opacity-50" id="nextPageBtn" disabled>
                        –î–∞–ª–µ–µ
                    </button>
                </div>
            </div>
        </section>

        <section id="admin" class="page-section">
            <h1 class="text-2xl font-bold mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h1>
            <div class="space-y-4">
                <p class="text-sm text-gray-500">–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ **–±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ–º—É —É–¥–∞–ª–µ–Ω–∏—é –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Firestore, –∫—Ä–æ–º–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å–µ–ª–µ–Ω–∏—è—Ö. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é.</p>
                <button onclick="window.confirmDelete()" class="bg-red-500 text-white w-full p-3 rounded-lg font-semibold hover:bg-red-600">
                    <i data-lucide="trash-2" class="w-5 h-5 inline-block mr-2"></i> –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Firestore
                </button>
            </div>
        </section>
    </div>

    <footer id="main-footer" class="fixed bottom-0 left-0 right-0 h-16 flex justify-around items-center z-10">
        <a id="navForm" href="#" onclick="showSection('form'); return false;" class="nav-item flex flex-col items-center text-xs active">
            <i data-lucide="clipboard-list" class="w-5 h-5"></i>
            <span>–í–≤–æ–¥</span>
        </a>
        <a id="navReports" href="#" onclick="showSection('reports'); return false;" class="nav-item flex flex-col items-center text-xs hidden">
            <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
            <span>–û—Ç—á–µ—Ç—ã</span>
        </a>
        <a id="navAdmin" href="#" onclick="showSection('admin'); return false;" class="nav-item flex flex-col items-center text-xs hidden">
            <i data-lucide="settings" class="w-5 h-5"></i>
            <span>–ê–¥–º–∏–Ω</span>
        </a>
    </footer>


    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        // üîë –í–ê–ñ–ù–û: –í–ê–® –†–ï–ê–õ–¨–ù–´–ô TELEGRAM ID
        const ADMIN_TELEGRAM_ID = '541459471'; 
        const DB_COLLECTION = 'agitator_data';
        const SETTLEMENTS_COLLECTION = 'settlements';
        const OFFLINE_STORAGE_KEY = 'offline_data';

        const isTMA = window.Telegram && window.Telegram.WebApp;
        
        let firebaseApp;
        let db;
        let auth;
        let storage;
        let lastDoc;
        let currentPage = 1;
        const itemsPerPage = 10;
        let dataCache = [];

        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram –∏–ª–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        let userTelegramId = isTMA && Telegram.WebApp.initDataUnsafe.user ? String(Telegram.WebApp.initDataUnsafe.user.id) : 'web-test-user-' + (Math.floor(Math.random() * 10000) + 1);
        let isAdmin = false;

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

        function showAlert(title, message, isError = false) {
            if (isTMA) {
                Telegram.WebApp.showAlert(`${title}: ${message}`);
            } else {
                alert(`${title}: ${message}`);
            }
        }

        async function authenticateUser() {
            try {
                if (window.firebaseDependencies) {
                    const { initializeApp, getFirestore, getAuth, signInAnonymously, getStorage } = window.firebaseDependencies;
                    
                    firebaseApp = initializeApp(firebaseConfig);
                    db = getFirestore(firebaseApp);
                    auth = getAuth(firebaseApp);
                    storage = getStorage(firebaseApp);

                    // 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ isAdmin (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ)
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                    isAdmin = (String(userTelegramId) === String(ADMIN_TELEGRAM_ID));

                    // 2. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è Firebase (–∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥)
                    await signInAnonymously(auth);

                    // 3. –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∞
                    if (isAdmin) {
                        document.getElementById('navReports').classList.remove('hidden');
                        document.getElementById('navAdmin').classList.remove('hidden');
                    }
                    
                    // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
                    if (isAdmin) {
                        // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É, –∑–∞–ø—É—Å–∫–∞–µ–º –≤ window.onload
                        // fetchAndRenderReports(); 
                    }
                    
                    // 5. –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –∑–∞–ø–∏—Å–µ–π –¥–ª—è –≤—Å–µ—Ö
                    renderLatestData();
                    
                    return true;
                } else {
                    showAlert('–û—à–∏–±–∫–∞', '–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–≥–∏ <script type="module">.');
                    return false;
                }
            } catch (e) {
                console.error("Authentication or Firebase init error:", e);
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º isAdmin = false –∏ –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É
                showAlert('–û—à–∏–±–∫–∞ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏', e.message);
                return false;
            }
        }
        
        // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–≠–®–ï–ú ---

        function getOfflineData() {
            const data = localStorage.getItem(OFFLINE_STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveToCache(data) {
            const offlineData = getOfflineData();
            offlineData.push(data);
            localStorage.setItem(OFFLINE_STORAGE_KEY, JSON.stringify(offlineData));
            updateOfflineStatus();
        }

        function updateOfflineStatus() {
            const count = getOfflineData().length;
            const syncButton = document.getElementById('syncButton');
            document.getElementById('debugOfflineCount').textContent = count;

            if (count > 0) {
                document.getElementById('syncCount').textContent = count;
                syncButton.classList.remove('hidden');
            } else {
                syncButton.classList.add('hidden');
            }
        }

        async function syncOfflineData() {
            if (!db) {
                showAlert('–û—à–∏–±–∫–∞', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Firebase.');
                return;
            }
            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            const offlineData = getOfflineData();
            if (offlineData.length === 0) {
                showAlert('–ì–æ—Ç–æ–≤–æ', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.');
                if (isTMA) Telegram.WebApp.MainButton.hideLoader();
                return;
            }

            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º window.firebaseDependencies, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –±—ã–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã
                const { writeBatch, doc } = window.firebaseDependencies;
                let batch = writeBatch(db);
                const batchSize = 500;
                let syncedCount = 0;

                for (let i = 0; i < offlineData.length; i += batchSize) {
                    const currentBatch = offlineData.slice(i, i + batchSize);
                    
                    currentBatch.forEach(data => {
                        const docRef = doc(db, DB_COLLECTION, data.id);
                        batch.set(docRef, data);
                    });
                    
                    await batch.commit();
                    syncedCount += currentBatch.length;
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π batch –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                    batch = writeBatch(db);
                }

                // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                localStorage.removeItem(OFFLINE_STORAGE_KEY);
                showAlert('–£—Å–ø–µ—à–Ω–æ', `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${syncedCount} –∑–∞–ø–∏—Å–µ–π.`);

                if (isAdmin) fetchAndRenderReports();
                renderLatestData();

            } catch (e) {
                console.error("Error syncing data:", e);
                showAlert('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ: ${e.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`);
            } finally {
                updateOfflineStatus();
                if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        }


        // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –§–û–†–ú–û–ô ---

        function showSection(sectionId) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –∏ —É–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.querySelectorAll('.page-section').forEach(section => {
                section.style.display = 'none';
            });
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é
            document.getElementById(sectionId).style.display = 'block';

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.getElementById('nav' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1)).classList.add('active');
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ "–û—Ç—á–µ—Ç—ã", —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–∞—Ä—Ç–∞ –≤–∏–¥–Ω–∞
            if (sectionId === 'reports' && isAdmin) {
                if (window.reportMap) {
                    setTimeout(() => {
                        window.reportMap.invalidateSize();
                    }, 10);
                }
            }
        }

        async function populateSettlements() {
            if (!db) return;
            try {
                const selectElement = document.getElementById('settlement');
                selectElement.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç *</option>'; // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç
                
                const { collection, query, orderBy, getDocs } = window.firebaseDependencies;

                const settlementsRef = collection(db, SETTLEMENTS_COLLECTION);
                const q = query(settlementsRef, orderBy('name'));
                const snapshot = await getDocs(q);

                snapshot.forEach(doc => {
                    const settlement = doc.data();
                    const option = document.createElement('option');
                    option.value = settlement.name;
                    option.textContent = settlement.name;
                    selectElement.appendChild(option);
                });

            } catch (e) {
                console.error("Error loading settlements:", e);
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å–µ–ª–µ–Ω–∏–π. ' + e.message);
            }
        }

        function clearForm() {
            document.getElementById('fullName').value = '';
            document.getElementById('settlement').value = '';
            document.getElementById('street').value = '';
            document.getElementById('house').value = '';
            document.getElementById('apartment').value = '';
            document.getElementById('action').value = '';
            document.getElementById('loyalty').value = '';
            document.getElementById('requiresFollowup').checked = false;
            document.getElementById('comment').value = '';
        }

        async function saveData() {
            const data = {
                id: (auth.currentUser ? auth.currentUser.uid : 'offline') + '-' + Date.now(),
                user_id: userTelegramId,
                full_name: document.getElementById('fullName').value.trim(),
                settlement: document.getElementById('settlement').value,
                street: document.getElementById('street').value.trim(),
                house: document.getElementById('house').value.trim(),
                apartment: document.getElementById('apartment').value.trim(),
                action: document.getElementById('action').value,
                loyalty: document.getElementById('loyalty').value,
                requires_followup: document.getElementById('requiresFollowup').checked,
                comment: document.getElementById('comment').value.trim(),
                timestamp: Date.now(),
                username: isTMA && Telegram.WebApp.initDataUnsafe.user ? Telegram.WebApp.initDataUnsafe.user.username : 'N/A'
            };

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            if (!data.settlement || !data.street || !data.house || !data.action || !data.loyalty) {
                showAlert('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è, –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ *.');
                return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            try {
                // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–Ω–ª–∞–π–Ω
                const { doc, setDoc } = window.firebaseDependencies;
                const docRef = doc(db, DB_COLLECTION, data.id);
                await setDoc(docRef, data);
                showAlert('–£—Å–ø–µ—à–Ω–æ', '–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firestore!');
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ñ–ª–∞–π–Ω-–¥–∞–Ω–Ω—ã–µ, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∏—Ö
                if (getOfflineData().length > 0) {
                    await syncOfflineData();
                }
                
                if (isAdmin) fetchAndRenderReports();
                renderLatestData();

            } catch (e) {
                console.error("Error saving data:", e);
                
                // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
                if (e.code === 'unavailable' || e.code === 'internal' || e.code === 'network-error' || e.message.includes('A network error')) {
                     // –£–±–∏—Ä–∞–µ–º id-–ø—Ä–µ—Ñ–∏–∫—Å 'offline' –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤ –∫—ç—à–µ
                    data.id = Date.now().toString(); // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫—ç—à–∞
                    saveToCache(data);
                    showAlert('–í–Ω–∏–º–∞–Ω–∏–µ', '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ç–∏. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ—Ñ–ª–∞–π–Ω-–∫—ç—à.');
                } else {
                    showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ' + e.message);
                }

            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideLoader();
                clearForm();
            }
        }

        async function renderLatestData() {
            if (!db) return;
            const latestDataContainer = document.getElementById('latest-data');
            latestDataContainer.innerHTML = '<p class="text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π...</p>';

            try {
                const { collection, query, orderBy, limit, where, getDocs } = window.firebaseDependencies;

                const recordsRef = collection(db, DB_COLLECTION);
                let q = query(recordsRef, orderBy('timestamp', 'desc'), limit(5));
                
                // –ï—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏
                if (!isAdmin) {
                    q = query(
                        recordsRef, 
                        where('user_id', '==', userTelegramId),
                        orderBy('timestamp', 'desc'), 
                        limit(5)
                    );
                }

                const snapshot = await getDocs(q);
                let html = '';

                if (snapshot.empty) {
                    html = '<p class="text-center text-gray-500">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const timestamp = new Date(data.timestamp).toLocaleString();
                        const loyaltyColor = data.loyalty === '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç' ? 'text-green-600' :
                                             data.loyalty === '–ü—Ä–æ—Ç–∏–≤' ? 'text-red-600' : 'text-gray-600';
                        
                        html += `
                            <div class="p-3 rounded-lg shadow-sm tg-input border-opacity-50">
                                <p class="font-medium">
                                    ${data.settlement}, ${data.street} –¥.${data.house} 
                                    ${data.apartment ? `–∫–≤.${data.apartment}` : ''}
                                </p>
                                <p class="${loyaltyColor} text-sm">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å: ${data.loyalty} | –î–µ–π—Å—Ç–≤–∏–µ: ${data.action}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    ${data.comment ? `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${data.comment}` : '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤'}
                                </p>
                                <p class="text-xs text-gray-400 mt-1">
                                    ${data.full_name || data.username || '–ê–Ω–æ–Ω–∏–º'} | ${timestamp}
                                </p>
                            </div>
                        `;
                    });
                }
                latestDataContainer.innerHTML = html;

            } catch (e) {
                console.error("Error fetching latest data:", e);
                latestDataContainer.innerHTML = `<p class="text-center text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</p>`;
            }
        }


        // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–¢–ß–ï–¢–û–í ---

        async function fetchAndRenderReports() {
            if (!db || !isAdmin) return;
            
            // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–¥–∞–ª—è–µ–º –µ–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
            if (window.reportMap) {
                window.reportMap.remove();
            }

            if (isTMA) Telegram.WebApp.MainButton.showLoader();
            
            const reportsTableBody = document.getElementById('reports-table').querySelector('tbody');
            reportsTableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>';
            
            dataCache = [];
            lastDoc = null;
            currentPage = 1;
            
            try {
                const { collection, getDocs, query, orderBy } = window.firebaseDependencies;

                // –û–±—â–∏–π –ø–æ–¥—Å—á–µ—Ç –∑–∞–ø–∏—Å–µ–π
                const countSnapshot = await getDocs(collection(db, DB_COLLECTION));
                document.getElementById('totalRecords').textContent = countSnapshot.size;

                // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞—Ä—Ç—ã/—á–∞—Ä—Ç–æ–≤ –∏ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const allDataQuery = query(collection(db, DB_COLLECTION), orderBy('timestamp', 'desc'));
                const allDataSnapshot = await getDocs(allDataQuery);

                dataCache = allDataSnapshot.docs.map(doc => doc.data());
                
                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤
                renderCharts();
                renderMap(dataCache); 
                
                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                renderTable(dataCache.slice(0, itemsPerPage));
                
                document.getElementById('prevPageBtn').disabled = true;
                document.getElementById('nextPageBtn').disabled = dataCache.length <= itemsPerPage;


            } catch (e) {
                console.error("Error fetching reports:", e);
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç—ã: ' + e.message);
                reportsTableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</td></tr>';
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        }

        function loadMoreData(isPrev) {
            
            if (isPrev) {
                 currentPage = Math.max(1, currentPage - 1);
            } else {
                currentPage++;
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ –∫—ç—à–∞
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const currentData = dataCache.slice(start, end);
            
            renderTable(currentData);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = end >= dataCache.length; 
        }

        function renderTable(data) {
            const table = document.getElementById('reports-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
            thead.innerHTML = `
                <tr class="text-xs font-medium text-gray-500 uppercase tracking-wider tg-input border-opacity-50">
                    <th class="px-3 py-2 text-left">–í—Ä–µ–º—è</th>
                    <th class="px-3 py-2 text-left">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</th>
                    <th class="px-3 py-2 text-left">–£–ª–∏—Ü–∞, –î–æ–º</th>
                    <th class="px-3 py-2 text-left">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</th>
                    <th class="px-3 py-2 text-left">–î–µ–π—Å—Ç–≤–∏–µ</th>
                    <th class="px-3 py-2 text-left">–ü–æ–≤—Ç–æ—Ä</th>
                    <th class="px-3 py-2 text-left">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                    <th class="px-3 py-2 text-left">–ê–≥–∏—Ç–∞—Ç–æ—Ä</th>
                </tr>
            `;

            // –¢–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã
            let html = '';
            if (data.length === 0) {
                html = '<tr><td colspan="8" class="text-center py-4 text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</td></tr>';
            } else {
                data.forEach(doc => {
                    const loyaltyColor = doc.loyalty === '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç' ? 'text-green-600' :
                                         doc.loyalty === '–ü—Ä–æ—Ç–∏–≤' ? 'text-red-600' : 'text-gray-600';

                    html += `
                        <tr class="tg-input border-opacity-50">
                            <td class="px-3 py-2 whitespace-nowrap text-xs">${new Date(doc.timestamp).toLocaleString()}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${doc.settlement}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${doc.street} –¥.${doc.house}${doc.apartment ? ` –∫–≤.${doc.apartment}` : ''}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm ${loyaltyColor}">${doc.loyalty}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${doc.action}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${doc.requires_followup ? '–î–ê' : '–ù–ï–¢'}</td>
                            <td class="px-3 py-2 text-xs">${doc.comment ? doc.comment.substring(0, 30) + (doc.comment.length > 30 ? '...' : '') : '-'}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-500">${doc.full_name || doc.username || 'N/A'}</td>
                        </tr>
                    `;
                });
            }
            tbody.innerHTML = html;
        }

        function renderMap(data) {
            const mapContainer = document.getElementById('map');
            
            // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–¥–∞–ª—è–µ–º –µ–µ
            if (window.reportMap) {
                window.reportMap.remove();
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É
            window.reportMap = L.map(mapContainer, {
                center: [55.7558, 37.6173], // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                zoom: 10,
                scrollWheelZoom: false 
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–ª—ã OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(window.reportMap);

            const markers = L.markerClusterGroup();
            let hasValidLocation = false;

            // –í –≤–∞—à–µ–º —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ –Ω–µ—Ç –ª–æ–≥–∏–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —à–∏—Ä–æ—Ç—ã/–¥–æ–ª–≥–æ—Ç—ã,
            // –ø–æ—ç—Ç–æ–º—É —Ç–æ—á–∫–∏ –Ω–µ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ, –ø–æ–∫–∞ —ç—Ç–∞ –ª–æ–≥–∏–∫–∞ –Ω–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞
            // –≤ —Ñ—É–Ω–∫—Ü–∏—é saveData. –ú—ã –ø–æ–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å.

            data.forEach(doc => {
                // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å
                if (doc.location && doc.location.latitude && doc.location.longitude) {
                    hasValidLocation = true;
                    const lat = doc.location.latitude;
                    const lng = doc.location.longitude;
                    
                    const marker = L.marker([lat, lng]);
                    
                    const popupContent = `
                        <b>${doc.settlement}</b><br>
                        ${doc.street} –¥.${doc.house}<br>
                        –õ–æ—è–ª—å–Ω–æ—Å—Ç—å: <b>${doc.loyalty}</b><br>
                        –î–µ–π—Å—Ç–≤–∏–µ: ${doc.action}<br>
                        –ê–≥–∏—Ç–∞—Ç–æ—Ä: ${doc.full_name || doc.username || 'N/A'}
                    `;
                    marker.bindPopup(popupContent);
                    markers.addLayer(marker);
                }
            });

            window.reportMap.addLayer(markers);

            // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∞–ª–∏–¥–Ω—ã–µ —Ç–æ—á–∫–∏, –ø–æ–¥–≥–æ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã –ø–æ–¥ –Ω–∏—Ö
            if (hasValidLocation && markers.getLayers().length > 0) {
                 window.reportMap.fitBounds(markers.getBounds());
            } else {
                 // –ï—Å–ª–∏ —Ç–æ—á–µ–∫ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –ú–æ—Å–∫–≤—É
                 window.reportMap.setView([55.7558, 37.6173], 10); 
            }
        }


        function renderCharts() {
            // –õ–æ—è–ª—å–Ω–æ—Å—Ç—å
            const loyaltyData = dataCache.reduce((acc, doc) => {
                acc[doc.loyalty] = (acc[doc.loyalty] || 0) + 1;
                return acc;
            }, {});

            const loyaltyLabels = Object.keys(loyaltyData);
            const loyaltyCounts = Object.values(loyaltyData);
            const loyaltyColors = loyaltyLabels.map(label => {
                if (label === '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç') return '#4CAF50';
                if (label === '–ü—Ä–æ—Ç–∏–≤') return '#F44336';
                if (label === '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ') return '#FFEB3B';
                return '#9E9E9E';
            });

            if (window.loyaltyChartInstance) {
                window.loyaltyChartInstance.destroy();
            }
            const loyaltyCtx = document.getElementById('loyaltyChart').getContext('2d');
            window.loyaltyChartInstance = new Chart(loyaltyCtx, {
                type: 'pie',
                data: {
                    labels: loyaltyLabels,
                    datasets: [{
                        data: loyaltyCounts,
                        backgroundColor: loyaltyColors,
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // –ü–æ—Å–µ–ª–µ–Ω–∏—è
            const settlementData = dataCache.reduce((acc, doc) => {
                acc[doc.settlement] = (acc[doc.settlement] || 0) + 1;
                return acc;
            }, {});

            const settlementLabels = Object.keys(settlementData);
            const settlementCounts = Object.values(settlementData);
            
            if (window.settlementChartInstance) {
                window.settlementChartInstance.destroy();
            }
            const settlementCtx = document.getElementById('settlementChart').getContext('2d');
            window.settlementChartInstance = new Chart(settlementCtx, {
                type: 'bar',
                data: {
                    labels: settlementLabels,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π',
                        data: settlementCounts,
                        backgroundColor: '#2196F3',
                        borderColor: '#1565C0',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }


        function exportToXLSX() {
            if (dataCache.length === 0) {
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –æ—Ç—á–µ—Ç—ã.');
                return;
            }
            const exportData = dataCache.map(doc => ({
                '–í—Ä–µ–º—è': new Date(doc.timestamp).toLocaleString(), 'ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è': doc.user_id, '–ê–≥–∏—Ç–∞—Ç–æ—Ä (–§–ò–û)': doc.full_name || doc.username,
                '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç': doc.settlement, '–£–ª–∏—Ü–∞': doc.street, '–î–æ–º': doc.house, '–ö–≤–∞—Ä—Ç–∏—Ä–∞': doc.apartment, '–î–µ–π—Å—Ç–≤–∏–µ': doc.action,
                '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å': doc.loyalty, '–¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä': doc.requires_followup ? '–î–ê' : '–ù–ï–¢', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': doc.comment,
                '–®–∏—Ä–æ—Ç–∞': doc.location ? doc.location.latitude : 'N/A', '–î–æ–ª–≥–æ—Ç–∞': doc.location ? doc.location.longitude : 'N/A',
            }));
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "–î–∞–Ω–Ω—ã–µ");
            XLSX.writeFile(workbook, "agitator_data_" + new Date().toISOString().slice(0, 10) + ".xlsx");
        }


        // --- –ê–î–ú–ò–ù–ò–°–¢–†–ò–†–û–í–ê–ù–ò–ï ---

        function confirmDelete() {
            if (!isAdmin) {
                showAlert('–û—à–∏–±–∫–∞', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
                return;
            }
            
            if (isTMA) {
                Telegram.WebApp.showConfirm(
                    '–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?',
                    (isConfirmed) => {
                        if (isConfirmed) {
                            deleteCollection(DB_COLLECTION);
                        }
                    }
                );
            } else {
                if (confirm('–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?')) {
                    deleteCollection(DB_COLLECTION);
                }
            }
        }

        async function deleteCollection(collectionPath) {
            if (!db || !isAdmin) return;

            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            try {
                const { writeBatch, collection, query, limit, getDocs } = window.firebaseDependencies;

                const batchSize = 500;
                const collectionRef = collection(db, collectionPath);
                let deletedCount = 0;

                while (true) {
                    const q = query(collectionRef, limit(batchSize));
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.size === 0) break;

                    let batch = writeBatch(db); // –ù–æ–≤—ã–π batch –≤ —Ü–∏–∫–ª–µ
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    deletedCount += snapshot.size;

                    if (snapshot.size < batchSize) break;
                }

                // –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
                localStorage.removeItem(OFFLINE_STORAGE_KEY);
                dataCache = []; 
                updateOfflineStatus();
                showAlert('–£—Å–ø–µ—à–Ω–æ!', `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} –∑–∞–ø–∏—Å–µ–π. –î–∞–Ω–Ω—ã–µ Firestore –æ—á–∏—â–µ–Ω—ã.`);

                if (isAdmin) fetchAndRenderReports();
                renderLatestData();

                return true;

            } catch (e) {
                 console.error("Error deleting collection:", e);
                 showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + e.message);
                 return false;
            } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // üîë –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–û–∂–∏–¥–∞–µ–º authenticateUser) - –§–ò–ù–ê–õ–¨–ù–´–ô –§–ò–ö–°!
        window.onload = async () => { // <--- –î–û–ë–ê–í–õ–ï–ù–û 'async'
            // 1. –°–Ω–∞—á–∞–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å userTelegramId –∏ isAdmin
            await authenticateUser(); // <--- –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ô 'await'

            // 2. –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            populateSettlements();
            updateOfflineStatus();
            window.showSection('form');
            lucide.createIcons();

            // –û–¢–õ–ê–î–ö–ê: –¢–µ–ø–µ—Ä—å –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è ID
            document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';
            
            // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç—ã, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
            if (isAdmin) {
                fetchAndRenderReports();
            }

            if (!firebaseConfig.projectId) {
                window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase –≤ –∫–æ–¥.');
            }
        };

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        window.authenticateUser = authenticateUser;
        window.fetchAndRenderReports = fetchAndRenderReports;
        window.renderLatestData = renderLatestData;
        window.saveData = saveData;
        window.syncOfflineData = syncOfflineData;
        window.showSection = showSection;
        window.confirmDelete = confirmDelete;
        window.exportToXLSX = exportToXLSX;
        window.loadMoreData = loadMoreData;
        window.showAlert = showAlert;

    </script>
</body>
</html>
