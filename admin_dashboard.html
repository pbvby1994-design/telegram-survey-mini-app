<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Блокнот Агитатора — Premium</title>

    <!-- Tailwind (CDN quick dev) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = {theme: {extend: {fontFamily: {jost: ['Jost', 'system-ui', 'Segoe UI', 'Roboto', 'Arial']}}}}</script>

    <!-- Icons & Charts & Maps -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg: #f6f7fb; /* soft background */
            --card: #ffffff;
            --muted: #6b7280;
            --primary: #0ea5a4; /* teal-ish for Premium Soft */
            --accent: #7c3aed; /* complementary accent */
            --shadow-strong: 0 10px 30px rgba(15, 23, 42, 0.08);
            --shadow-soft: 0 6px 18px rgba(15, 23, 42, 0.06);
            --radius: 14px;
        }

        html,body{height:100%;}
        body{
            font-family: 'Jost', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(180deg, var(--bg), #ffffff);
            color: #0f172a;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            margin:0;
            padding:24px 16px 110px; /* room for bottom nav */
            transition:background-color .25s;
        }

        /* Card style — consistent premium look */
        .card{
            background:var(--card);
            border-radius:var(--radius);
            box-shadow:var(--shadow-strong);
            border:1px solid rgba(15,23,42,0.04);
        }

        .soft-card{
            background:var(--card);
            border-radius:12px;
            box-shadow:var(--shadow-soft);
            border:1px solid rgba(15,23,42,0.03);
        }

        h1,h2,h3{font-weight:600;color:#0f172a}

        /* Form inputs — subtle, spacious */
        input[type="text"], textarea, select{
            background: linear-gradient(180deg,#ffffff,#fbfdff);
            border:1px solid rgba(15,23,42,0.06);
            border-radius:10px;
            padding:12px 14px;
            width:100%;
            transition:box-shadow .15s,transform .12s,border-color .12s;
            box-shadow:inset 0 1px 2px rgba(15,23,42,0.02);
            font-size:14px;
        }
        input:focus, textarea:focus, select:focus{outline:none; border-color: rgba(124,58,237,0.9); box-shadow:0 6px 18px rgba(124,58,237,0.08); transform:translateY(-1px);}

        /* Buttons */
        .btn-primary{background:linear-gradient(90deg,var(--primary),#06b6d4); color:white; padding:12px 16px; border-radius:12px; font-weight:600; display:inline-flex; gap:8px; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(14,165,164,0.18); transition:transform .12s,opacity .12s}
        .btn-primary:active{transform:scale(.985)}
        .btn-secondary{background:transparent; border:1px solid rgba(15,23,42,0.06); padding:10px 14px; border-radius:10px}

        /* Bottom nav — elevated */
        .nav-bar{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; width:calc(100% - 48px); max-width:720px; background:linear-gradient(180deg,rgba(255,255,255,0.9),#ffffff); border-radius:20px; box-shadow:0 8px 30px rgba(15,23,42,0.08); padding:8px; display:flex; justify-content:center; z-index:60; border:1px solid rgba(15,23,42,0.04)}
        .nav-item{display:flex;flex-direction:column;align-items:center;padding:8px 12px;color:var(--muted);font-size:12px;border-radius:10px;transition:all .12s}
        .nav-item.active{background:rgba(124,58,237,0.08); color:var(--accent); box-shadow:inset 0 1px 0 rgba(255,255,255,0.4)}
        .nav-item:hover{transform:translateY(-4px)}

        /* Utility small styles */
        .muted{color:var(--muted)}
        .pill{background:#f1f5f9;padding:6px 10px;border-radius:999px;font-size:13px}

        /* table improvements */
        table{width:100%;border-collapse:collapse}
        thead th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.6px}
        tbody tr{background:linear-gradient(180deg,#ffffff,#fbfbff)}
        tbody tr + tr{border-top:1px solid rgba(15,23,42,0.03)}

        /* Map */
        #map-container{height:420px;border-radius:12px;overflow:hidden}

        /* Responsive tweaks */
        @media (min-width: 768px){ body{padding:36px 0 120px} main{max-width:720px;margin:0 auto} }

    </style>
</head>
<body>

    <!-- Bottom navigation (premium centered) -->
    <div class="nav-bar">
        <a href="#" onclick="showSection('form'); return false;" class="nav-item active" id="nav-form">
            <i data-lucide="edit-2" class="w-5 h-5"></i>
            <span>Форма</span>
        </a>
        <a href="#" onclick="showSection('reports'); return false;" class="nav-item" id="nav-reports">
            <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
            <span>Отчеты</span>
        </a>
        <a href="#" onclick="showSection('admin'); return false;" class="nav-item" id="nav-admin">
            <i data-lucide="shield-check" class="w-5 h-5"></i>
            <span>Админ</span>
        </a>
    </div>

    <main class="max-w-3xl mx-auto px-4">

        <!-- HEADER -->
        <header class="mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl">Блокнот Агитатора</h1>
                    <p class="muted text-sm mt-1">Премиум-интерфейс — аккуратно, быстро, приятно</p>
                </div>
                <div class="text-right">
                    <div class="pill">ID: <span id="debugUserId" class="font-medium ml-2">...</span></div>
                    <div class="muted text-sm mt-1">Админ: <span id="debugAdminStatus">...</span></div>
                </div>
            </div>
        </header>

        <!-- FORM -->
        <section id="form" class="section">
            <div class="card p-5 mb-5">
                <form id="surveyForm" onsubmit="saveSurveyData(event)">
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div>
                            <label class="text-sm font-medium mb-1 block">Населенный пункт</label>
                            <select id="settlement" required></select>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-1 block">Улица</label>
                            <input type="text" id="street" required placeholder="Название улицы">
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-1 block">Дом</label>
                            <input type="text" id="house" required placeholder="№ дома">
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-1 block">Квартира (опц.)</label>
                            <input type="text" id="apartment" placeholder="№ квартиры">
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-1 block">Действие</label>
                            <select id="action" required>
                                <option value="">Выберите...</option>
                                <option value="positive">Позитивное</option>
                                <option value="negative">Негативное</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-1 block">Лояльность</label>
                            <select id="loyalty" required>
                                <option value="">Выберите...</option>
                                <option value="loyal">Лояльный</option>
                                <option value="not_loyal">Не лояльный</option>
                                <option value="doubtful">Сомневающийся</option>
                                <option value="not_opened">Не открыли</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="text-sm font-medium mb-1 block">Комментарий</label>
                            <textarea id="comment" rows="3" placeholder="Короткий заметка или наблюдение"></textarea>
                        </div>
                    </div>

                    <div class="mt-4 flex items-center gap-3">
                        <div class="flex-1">
                            <div class="muted text-sm mb-1">Геолокация</div>
                            <div id="locationStatus" class="text-sm muted">Ожидание...</div>
                        </div>
                        <div class="flex-shrink-0">
                            <button type="button" onclick="getLocation()" class="btn-secondary flex items-center gap-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Получить GPS</span>
                            </button>
                        </div>
                    </div>

                    <div class="mt-5">
                        <button type="submit" class="btn-primary w-full">Сохранить запись</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- REPORTS -->
        <section id="reports" class="section hidden">
            <div class="mb-5">
                <div class="soft-card p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg">Отчеты</h2>
                            <p class="muted text-sm">Фильтруй, экспортируй, визуализируй</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <select id="dateRangeFilter" onchange="fetchAndRenderReports()" class="text-sm p-2 border rounded-md">
                                <option value="30d" selected>Последние 30 дней</option>
                                <option value="7d">Последние 7 дней</option>
                                <option value="today">Сегодня</option>
                                <option value="all">За все время</option>
                            </select>
                            <button onclick="exportToXLSX()" class="btn-primary text-sm flex items-center gap-2 px-3 py-2">
                                <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                                Экспорт XLSX
                            </button>
                        </div>
                    </div>
                </div>

                <div id="admin-reports-content">
                    <div class="grid grid-cols-1 gap-4">
                        <div class="card p-4">
                            <h3 class="text-md font-semibold mb-3">Сводка</h3>
                            <div id="summary-metrics" class="grid grid-cols-2 gap-3"></div>
                        </div>

                        <div class="card p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h3 class="font-semibold mb-2">Лояльность</h3>
                                <canvas id="loyaltyChart" style="max-height:220px"></canvas>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-2">Действия</h3>
                                <canvas id="actionChart" style="max-height:220px"></canvas>
                            </div>
                        </div>

                        <div class="card p-4">
                            <h3 class="font-semibold mb-2">Карта геолокаций</h3>
                            <div id="map-container"></div>
                        </div>

                        <div class="card p-4">
                            <h3 class="font-semibold mb-2">Последние записи</h3>
                            <div class="overflow-x-auto">
                                <table id="latestDataTbl" class="min-w-full text-sm">
                                    <thead>
                                        <tr>
                                            <th class="px-3 py-2">Время</th>
                                            <th class="px-3 py-2">Адрес</th>
                                            <th class="px-3 py-2">Лояльность</th>
                                            <th class="px-3 py-2">Комментарий</th>
                                        </tr>
                                    </thead>
                                    <tbody id="latestDataBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="no-reports-data" class="card p-8 text-center hidden">
                    <i data-lucide="frown" class="w-12 h-12 mx-auto mb-3 muted"></i>
                    <h3 class="text-lg font-semibold muted">Нет данных за выбранный период</h3>
                    <p class="muted text-sm">Попробуйте выбрать другой диапазон дат или проверьте ввод.</p>
                </div>

                <div id="admin-reports-login" class="card p-4 text-center hidden">
                    <p class="mb-4">Для просмотра отчетов требуется авторизация администратора.</p>
                </div>

            </div>
        </section>

        <!-- ADMIN -->
        <section id="admin" class="section hidden">
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-2 text-red-600">Опасная зона</h2>
                <p class="muted text-sm mb-4">Нажмите, чтобы удалить ВСЕ данные (записи) из Firestore.</p>
                <button onclick="confirmAndDeleteData()" class="btn-secondary w-full border-red-200 text-red-600 bg-red-50">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                    Удалить Все Данные
                </button>
            </div>
            <div id="admin-panel-login" class="card p-4 text-center hidden">
                <p class="mb-4 muted">Для доступа требуется авторизация администратора (Telegram ID не совпадает).</p>
            </div>
        </section>

    </main>

    <!-- Firebase + Utilities (preserve existing logic) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sheetjs@0.19.0/dist/xlsx.full.min.js"></script>

    <script>
        // === CONFIGURATION (copy your firebase config here) ===
        const firebaseConfig = {
            // apiKey: "...",
            // projectId: "...",
        };

        const ADMIN_TELEGRAM_ID = 541459471; // оставил как в оригинале — проверьте

        const SETTLEMENTS = [
            'г.п. Барсово','с.п. Солнечный','с.п. Тундрино','с.п. Лямина','г.п. Лянтор','г.п. Федоровский','г.п. Белый Яр','с.п. Ульт-Ягун','с.п. Сытомино','с.п. Русскинская','с.п. Нижнесортымский','с.п. Угут','с.п. Локосово'
        ];

        const isTMA = window.Telegram && window.Telegram.WebApp;
        let userTelegramId = isTMA && Telegram.WebApp.initDataUnsafe.user ? Telegram.WebApp.initDataUnsafe.user.id : null;
        let isAdmin = userTelegramId === ADMIN_TELEGRAM_ID;
        let userLocation = null;

        let db = null;
        let surveysCollection = null;

        if (firebaseConfig.projectId) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            surveysCollection = db.collection('surveys');
            firebase.auth().signInAnonymously().catch(e=>console.error(e));
        }

        function showAlert(title,message){ if (isTMA) Telegram.WebApp.showAlert(`${title}: ${message}`); else alert(`${title}: ${message}`); }

        function showSection(sectionId){
            document.querySelectorAll('.section').forEach(s=>s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            document.getElementById('nav-'+sectionId).classList.add('active');

            if ((sectionId==='reports' || sectionId==='admin')){
                const content = document.getElementById(`admin-${sectionId}-content`);
                const login = document.getElementById(`admin-${sectionId}-login`);
                if (isAdmin){ if (content) content.style.display='block'; if (login) login.style.display='none'; if (sectionId==='reports') fetchAndRenderReports(); }
                else{ if (content) content.style.display='none'; if (login) login.style.display='block'; }
            }

            lucide.createIcons();
            if (isTMA) Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }

        function populateSettlements(){
            const select = document.getElementById('settlement'); select.innerHTML='';
            SETTLEMENTS.forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; select.appendChild(opt); });
        }

        window.getLocation = ()=>{
            const status = document.getElementById('locationStatus'); status.textContent='Запрос геолокации...'; userLocation=null;
            if (!navigator.geolocation) { status.textContent='Геолокация не поддерживается'; return; }
            navigator.geolocation.getCurrentPosition(pos=>{
                userLocation = new firebase.firestore.GeoPoint(pos.coords.latitude,pos.coords.longitude);
                status.textContent = `${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }, err=>{
                status.textContent='Ошибка при получении геолокации';
                showAlert('Ошибка GPS', err.message || 'Не удалось получить координаты');
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            }, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
        };

        window.saveSurveyData = async (e)=>{
            e.preventDefault();
            if (!firebaseConfig.projectId || !surveysCollection) return showAlert('Ошибка','Firebase не настроен.');
            try{
                const data={
                    settlement: document.getElementById('settlement').value,
                    street: document.getElementById('street').value,
                    house: document.getElementById('house').value,
                    apartment: document.getElementById('apartment').value || '',
                    action: document.getElementById('action').value,
                    loyalty: document.getElementById('loyalty').value,
                    comment: document.getElementById('comment').value || '',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    user_id: userTelegramId,
                    username: isTMA && Telegram.WebApp.initDataUnsafe.user ? (Telegram.WebApp.initDataUnsafe.user.username || 'n/a') : 'web-test',
                    location: userLocation
                };
                await surveysCollection.add(data);

                document.getElementById('surveyForm').reset();
                document.getElementById('locationStatus').textContent='Ожидание...';
                userLocation=null; populateSettlements();
                showAlert('Успешно','Данные сохранены');
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }catch(e){ console.error(e); showAlert('Ошибка','Не удалось сохранить: '+(e.message||e)); if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('error'); }
        };

        // Reports logic (preserve behaviour but improved UX)
        let mapInstance=null; let dataCache=[]; let loyaltyChart=null; let actionChart=null;

        function generateMap(data){
            const container = document.getElementById('map-container'); if (mapInstance){ mapInstance.remove(); mapInstance=null; }
            container.innerHTML='';
            const locations = data.filter(d=>d.location && d.location.latitude && d.location.longitude).map(d=>({lat:d.location.latitude, lon:d.location.longitude, loyalty:d.loyalty}));
            if (!locations.length){ container.innerHTML='<div class="text-center py-10 muted">Нет данных о геолокации для отображения на карте.</div>'; return; }

            const avgLat = locations.reduce((s,p)=>s+p.lat,0)/locations.length; const avgLon = locations.reduce((s,p)=>s+p.lon,0)/locations.length;
            mapInstance = L.map(container).setView([avgLat, avgLon], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(mapInstance);

            locations.forEach(pt=>{
                let color='#10B981'; if (pt.loyalty==='not_loyal') color='#F87171'; else if (pt.loyalty==='doubtful') color='#FBBF24';
                const iconHtml = `<div style="background:${color}; width:12px; height:12px; border-radius:999px; border:2px solid white; box-shadow:0 2px 6px rgba(2,6,23,0.12);"></div>`;
                const customIcon = L.divIcon({className:'custom-div-icon', html:iconHtml, iconSize:[16,16], iconAnchor:[8,8]});
                L.marker([pt.lat, pt.lon], {icon: customIcon}).addTo(mapInstance).bindPopup(`Лояльность: ${pt.loyalty}`);
            });
            mapInstance.invalidateSize();
        }

        function renderLatestData(data){
            const tbody=document.getElementById('latestDataBody'); tbody.innerHTML='';
            const latest = data.slice(0,20);
            latest.forEach(doc=>{
                const tr = document.createElement('tr'); tr.className='';
                const timeCell = document.createElement('td'); timeCell.className='px-3 py-2 text-xs'; timeCell.textContent = doc.timestamp ? new Date(doc.timestamp).toLocaleString() : 'N/A'; tr.appendChild(timeCell);
                const addrCell = document.createElement('td'); addrCell.className='px-3 py-2 text-xs'; addrCell.textContent = `${doc.settlement||''}, ${doc.street||''}, ${doc.house||''}`; tr.appendChild(addrCell);
                const loyCell = document.createElement('td'); loyCell.className='px-3 py-2 text-xs'; loyCell.textContent = doc.loyalty || 'N/A'; tr.appendChild(loyCell);
                const commCell = document.createElement('td'); commCell.className='px-3 py-2 text-xs muted'; commCell.textContent = doc.comment ? (doc.comment.length>80?doc.comment.slice(0,80)+'...':doc.comment) : ''; tr.appendChild(commCell);
                tbody.appendChild(tr);
            });
        }

        async function fetchAndRenderReports(){
            if (!isAdmin) return;
            if (!firebaseConfig.projectId || !surveysCollection) return showAlert('Ошибка','Firebase не настроен');
            try{
                const filterValue = document.getElementById('dateRangeFilter').value; const now = new Date(); let startDate=null;
                if (filterValue==='30d') startDate = new Date(now.getTime() - 30*24*3600*1000).getTime();
                else if (filterValue==='7d') startDate = new Date(now.getTime() - 7*24*3600*1000).getTime();
                else if (filterValue==='today') startDate = new Date(now.setHours(0,0,0,0)).getTime();

                const snapshot = await surveysCollection.orderBy('timestamp','desc').get();
                const raw = snapshot.docs.map(d=>{ const data=d.data(); const ts=data.timestamp?data.timestamp.toDate().getTime():0; return {...data, timestamp:ts}; });
                const filtered = raw.filter(r=>{ if (!startDate) return true; return r.timestamp>=startDate; });
                dataCache = filtered;
                if (!filtered.length){ document.getElementById('admin-reports-content').style.display='none'; document.getElementById('no-reports-data').classList.remove('hidden'); return; }
                document.getElementById('no-reports-data').classList.add('hidden'); document.getElementById('admin-reports-content').style.display='block';

                const loyaltyCounts = {}; const actionCounts = {};
                filtered.forEach(d=>{ loyaltyCounts[d.loyalty] = (loyaltyCounts[d.loyalty]||0)+1; actionCounts[d.action]=(actionCounts[d.action]||0)+1; });

                document.getElementById('summary-metrics').innerHTML = `\n                    <div class="p-3 bg-gray-50 rounded-md text-center">\n                        <div class="muted text-sm">Всего записей</div>\n                        <div class="text-xl font-bold">${filtered.length}</div>\n                    </div>\n                    <div class="p-3 bg-green-50 rounded-md text-center">\n                        <div class="muted text-sm">Лояльных</div>\n                        <div class="text-xl font-bold">${loyaltyCounts['loyal']||0}</div>\n                    </div>\n                    <div class="p-3 bg-red-50 rounded-md text-center">\n                        <div class="muted text-sm">Не лояльных</div>\n                        <div class="text-xl font-bold">${loyaltyCounts['not_loyal']||0}</div>\n                    </div>\n                    <div class="p-3 bg-yellow-50 rounded-md text-center">\n                        <div class="muted text-sm">Сомневающихся</div>\n                        <div class="text-xl font-bold">${loyaltyCounts['doubtful']||0}</div>\n                    </div>`;

                // Charts
                const loyaltyLabels = ['Лояльный','Не лояльный','Сомневающийся','Не открыли'];
                const loyaltyData = [loyaltyCounts['loyal']||0, loyaltyCounts['not_loyal']||0, loyaltyCounts['doubtful']||0, loyaltyCounts['not_opened']||0];
                loyaltyChart = renderChart('loyaltyChart','doughnut',loyaltyLabels,loyaltyData);
                const actionLabels = ['Позитивное','Негативное'];
                const actionData = [actionCounts['positive']||0, actionCounts['negative']||0];
                actionChart = renderChart('actionChart','bar',actionLabels,actionData);

                generateMap(filtered);
                renderLatestData(filtered);

            }catch(e){ console.error(e); showAlert('Ошибка','Не удалось загрузить отчеты: '+(e.message||e)); }
        }

        function renderChart(canvasId,type,labels,data){
            const ctx = document.getElementById(canvasId).getContext('2d');
            try{ if (window._charts && window._charts[canvasId]) window._charts[canvasId].destroy(); } catch(e){}
            window._charts = window._charts||{};
            window._charts[canvasId] = new Chart(ctx, { type:type, data:{ labels:labels, datasets:[{ data:data, backgroundColor: ['#10B981','#F87171','#FBBF24','#6B7280'], borderWidth:0 }] }, options:{ responsive:true, plugins:{legend:{position:'bottom', labels:{color:'#334155', font:{family:'Jost'} } } } } });
            return window._charts[canvasId];
        }

        function exportToXLSX(){ if (!dataCache.length) return showAlert('Ошибка','Нет данных для экспорта'); const exportData = dataCache.map(d=>({ 'Время': d.timestamp?new Date(d.timestamp).toLocaleString():'N/A', 'ID': d.user_id, 'Username': d.username, 'Поселение': d.settlement, 'Улица': d.street, 'Дом': d.house, 'Кв': d.apartment, 'Действие': d.action, 'Лояльность': d.loyalty, 'Комментарий': d.comment, 'Широта': d.location?d.location.latitude:'N/A', 'Долгота': d.location?d.location.longitude:'N/A' })); const ws = XLSX.utils.json_to_sheet(exportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Data'); XLSX.writeFile(wb,'agitator_'+new Date().toISOString().slice(0,10)+'.xlsx'); showAlert('Успешно','Экспорт завершён'); }

        window.confirmAndDeleteData = ()=>{ if (!isAdmin) return showAlert('Ошибка','Нет прав администратора'); if (!firebaseConfig.projectId||!surveysCollection) return showAlert('Ошибка','Firebase не настроен'); if (confirm('Вы уверены? Это действие удалит все записи.')) deleteCollection(); };
        async function deleteCollection(){ try{ const batchSize=50; let deleted=0; let q = surveysCollection.limit(batchSize); while(true){ const snap = await q.get(); if (!snap.size) break; const batch = db.batch(); snap.docs.forEach(d=>batch.delete(d.ref)); await batch.commit(); deleted += snap.size; if (snap.size < batchSize) break; } showAlert('Успешно','Удалено '+deleted+' записей'); fetchAndRenderReports(); return true; } catch(e){ console.error(e); showAlert('Ошибка','Не удалось удалить: '+(e.message||e)); return false; } }

        if (isTMA){ Telegram.WebApp.ready(); Telegram.WebApp.expand(); }

        window.onload = ()=>{ populateSettlements(); showSection('form'); lucide.createIcons(); document.getElementById('debugUserId').textContent = userTelegramId || 'Нет ID'; document.getElementById('debugAdminStatus').textContent = isAdmin ? 'ДА' : 'НЕТ'; if (!firebaseConfig.projectId) showAlert('ВНИМАНИЕ','Вставьте Firebase конфигурацию'); };
    </script>
</body>
</html>
