<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | v2.5 (–§–∏–∫—Å Auth)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#007bff',
                        'secondary': '#6c757d',
                        'tma-bg': 'var(--tg-theme-bg-color, #ffffff)',
                        'tma-text': 'var(--tg-theme-text-color, #000000)',
                        'tma-hint': 'var(--tg-theme-hint-color, #999999)',
                        'tma-link': 'var(--tg-theme-link-color, #007bff)',
                        'tma-button': 'var(--tg-theme-button-color, #007bff)',
                        'tma-button-text': 'var(--tg-theme-button-text-color, #ffffff)',
                    },
                    fontFamily: {
                        sans: ['Jost', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #007bff;
            --tg-theme-button-color: #007bff;
            --tg-theme-button-text-color: #ffffff;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: 'Jost', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .input-field {
            background-color: var(--tg-theme-secondary-bg-color, #f4f4f5);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-hint-color);
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            transition: background-color 0.3s;
        }
        
        .btn-primary:hover {
            background-color: color-mix(in srgb, var(--tg-theme-button-color) 80%, black);
        }

        .tab-btn {
            color: var(--tg-theme-hint-color);
            border-bottom: 2px solid transparent;
            transition: color 0.3s, border-bottom-color 0.3s;
        }

        .tab-btn.active {
            color: var(--tg-theme-link-color);
            border-bottom-color: var(--tg-theme-link-color);
        }

        .card {
            background-color: var(--tg-theme-secondary-bg-color, #f4f4f5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        
        #map-container {
            height: 400px; 
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            z-index: 10;
        }

        .leaflet-container {
            background-color: var(--tg-theme-secondary-bg-color, #f4f4f5) !important;
        }

        .tooltip-text {
            color: var(--tg-theme-text-color);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω */
        @media (min-width: 768px) {
            .container {
                max-width: 800px;
            }
        }
    </style>
</head>
<body class="p-4 md:p-6 min-h-screen">
    <div class="container mx-auto">
        <h1 class="text-xl font-bold mb-4 text-center">–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ <span id="auth-status" class="text-xs font-normal text-red-500">(Offline)</span></h1>

        <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏/—Å—Ç–∞—Ç—É—Å–∞ -->
        <div class="card p-3 mb-4 text-xs rounded-lg shadow-md">
            <div class="flex flex-wrap justify-between">
                <p>Telegram ID: <span id="debugUserId" class="font-medium">...</span></p>
                <p>–ê–¥–º–∏–Ω: <span id="debugAdminStatus" class="font-medium">...</span></p>
                <p>–ö—ç—à: <span id="debugCacheStatus" class="font-medium">...</span></p>
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="flex justify-around mb-6 border-b border-gray-300">
            <button class="tab-btn p-2 flex-1 text-center font-medium active" data-section="form" onclick="showSection('form')">
                <i data-lucide="edit-3" class="w-5 h-5 inline-block mr-1 align-middle"></i> –û—Ç—á–µ—Ç
            </button>
            <button class="tab-btn p-2 flex-1 text-center font-medium" data-section="data" onclick="showSection('data')">
                <i data-lucide="database" class="w-5 h-5 inline-block mr-1 align-middle"></i> –î–∞–Ω–Ω—ã–µ
            </button>
            <button class="tab-btn p-2 flex-1 text-center font-medium" data-section="map" onclick="showSection('map')">
                <i data-lucide="map" class="w-5 h-5 inline-block mr-1 align-middle"></i> –ö–∞—Ä—Ç–∞
            </button>
        </div>

        <!-- 1. –°–µ–∫—Ü–∏—è –§–û–†–ú–ê –û–¢–ß–ï–¢–ê -->
        <section id="form-section" class="mb-8">
            <form id="reportForm" class="space-y-4 card p-4 rounded-xl">
                <div>
                    <label for="settlement" class="block text-sm font-medium mb-1">–ü–æ—Å–µ–ª–µ–Ω–∏–µ (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <select id="settlement" name="settlement" required class="input-field w-full p-2 rounded-lg">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="address" class="block text-sm font-medium mb-1">–£–ª–∏—Ü–∞, –∞–¥—Ä–µ—Å</label>
                    <input type="text" id="address" name="address" class="input-field w-full p-2 rounded-lg" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ–µ–Ω–∏–Ω–∞ 10">
                </div>
                <div>
                    <label for="sentiment" class="block text-sm font-medium mb-1">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∂–∏–ª—å—Ü–æ–≤ (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <select id="sentiment" name="sentiment" required class="input-field w-full p-2 rounded-lg">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</option>
                        <option value="positive">–ü–æ–∑–∏—Ç–∏–≤–Ω–æ–µ (–∑–∞)</option>
                        <option value="neutral">–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ (–±–µ–∑—Ä–∞–∑–ª–∏—á–Ω–æ)</option>
                        <option value="negative">–ù–µ–≥–∞—Ç–∏–≤–Ω–æ–µ (–ø—Ä–æ—Ç–∏–≤)</option>
                        <option value="unknown">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ (–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å)</option>
                    </select>
                </div>
                <div>
                    <label for="comment" class="block text-sm font-medium mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <textarea id="comment" name="comment" rows="3" class="input-field w-full p-2 rounded-lg" placeholder="–ö—Ä–∞—Ç–∫–æ –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö, –ø—Ä–æ—Å—å–±–∞—Ö, –∏–ª–∏ –æ —á–µ–º –≥–æ–≤–æ—Ä–∏–ª–∏..."></textarea>
                </div>
                <button type="submit" class="btn-primary w-full p-3 font-semibold rounded-xl flex items-center justify-center">
                    <i data-lucide="send" class="w-5 h-5 mr-2"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –û—Ç—á–µ—Ç
                </button>
            </form>
        </section>

        <!-- 2. –°–µ–∫—Ü–∏—è –î–ê–ù–ù–´–ï (—Ç–æ–ª—å–∫–æ –¥–ª—è –ê–¥–º–∏–Ω–∞) -->
        <section id="data-section" class="hidden">
            <div id="admin-data-view" class="space-y-4">
                <h2 class="text-lg font-semibold border-b pb-2 mb-4">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –û—Ç—á–µ—Ç–æ–≤</h2>
                
                <div class="flex space-x-2 mb-4">
                    <button id="loadReportsBtn" onclick="fetchAndRenderReports()" class="btn-primary p-2 text-sm rounded-lg flex-1">
                        <i data-lucide="download" class="w-4 h-4 inline-block mr-1 align-middle"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –û–Ω–ª–∞–π–Ω
                    </button>
                    <button id="clearDataBtn" onclick="window.showAlert('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã Firestore?', () => clearAllData(), true)" class="bg-red-500 text-white p-2 text-sm rounded-lg flex-1 hover:bg-red-600">
                        <i data-lucide="trash-2" class="w-4 h-4 inline-block mr-1 align-middle"></i> –û—á–∏—Å—Ç–∏—Ç—å –ë–∞–∑—É
                    </button>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div id="report-stats" class="grid grid-cols-2 gap-2 text-sm mb-4">
                    <div class="card p-3 rounded-lg text-center">
                        <p class="font-bold text-xl text-tma-link" id="totalReports">0</p>
                        <p class="text-tma-hint">–û—Ç—á–µ—Ç–æ–≤ –≤—Å–µ–≥–æ</p>
                    </div>
                    <div class="card p-3 rounded-lg text-center">
                        <p class="font-bold text-xl text-green-500" id="positiveReports">0</p>
                        <p class="text-tma-hint">–ü–æ–∑–∏—Ç–∏–≤</p>
                    </div>
                    <div class="card p-3 rounded-lg text-center col-span-2">
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –æ—Ç—á–µ—Ç–æ–≤ -->
                <div class="card p-4 rounded-xl">
                    <h3 class="font-semibold mb-3">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –û—Ç—á–µ—Ç–æ–≤</h3>
                    <div id="reportsList" class="space-y-3">
                        <p class="text-tma-hint" id="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                        <!-- Reports will be inserted here -->
                    </div>
                </div>
            </div>
            <div id="non-admin-view" class="card p-6 text-center text-red-500 font-semibold rounded-xl hidden">
                –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω. –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.
            </div>
        </section>
        
        <!-- 3. –°–µ–∫—Ü–∏—è –ö–ê–†–¢–ê (—Ç–æ–ª—å–∫–æ –¥–ª—è –ê–¥–º–∏–Ω–∞) -->
        <section id="map-section" class="hidden">
            <h2 class="text-lg font-semibold border-b pb-2 mb-4">–ö–∞—Ä—Ç–∞ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
            <div id="map-container">
                <!-- –ö–∞—Ä—Ç–∞ Leaflet –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            <div class="mt-4 card p-3 rounded-lg">
                <p class="text-sm text-tma-hint">–ù–∞ –∫–∞—Ä—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–ª–∞—Å—Ç–µ—Ä—ã –æ—Ç—á–µ—Ç–æ–≤ (—Å–∏–Ω–∏–µ/–∫—Ä–∞—Å–Ω—ã–µ) –∏ —Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.</p>
            </div>
        </section>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (Alert/Confirm) -->
        <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 id="alert-title" class="text-xl font-bold mb-3 text-tma-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h3>
                <p id="alert-message" class="mb-4 text-tma-text"></p>
                <div class="flex justify-end space-x-3">
                    <button id="alert-cancel-btn" class="px-4 py-2 text-sm rounded-lg bg-secondary text-white hidden">–û—Ç–º–µ–Ω–∞</button>
                    <button id="alert-ok-btn" class="px-4 py-2 text-sm rounded-lg btn-primary">–û–ö</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; // üëà –ò–ú–ü–û–†–¢ AUTH
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, setDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –ö–õ–Æ–ß–ò) ---
        const firebaseConfig = {
             // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∞—à–∏ –∫–ª—é—á–∏!
        };

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        const isTMA = typeof Telegram !== 'undefined' && Telegram.WebApp.initData;
        const app = firebaseConfig.projectId ? initializeApp(firebaseConfig) : null;
        const db = app ? getFirestore(app) : null;
        const auth = app ? getAuth(app) : null; // üëà –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø AUTH

        let userTelegramId = isTMA ? (new URLSearchParams(Telegram.WebApp.initData).get('user') ? JSON.parse(new URLSearchParams(Telegram.WebApp.initData).get('user')).id : null) : null;
        let isAdmin = false;
        let dataCache = JSON.parse(localStorage.getItem('reports_cache') || '[]');
        let chartInstance = null;
        let mapInstance = null;
        let markerClusterLayer = null;

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò UI ---
        
        window.showAlert = (title, message, callback = null, isConfirm = false) => {
            const modal = document.getElementById('alert-modal');
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            const okBtn = document.getElementById('alert-ok-btn');
            const cancelBtn = document.getElementById('alert-cancel-btn');

            okBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                if (callback) callback(true);
            };

            if (isConfirm) {
                cancelBtn.classList.remove('hidden');
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    if (callback) callback(false);
                };
            } else {
                cancelBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.showSection = (sectionName) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn[data-section="${sectionName}"]`).classList.add('active');

            if (sectionName === 'data' || sectionName === 'map') {
                if (isAdmin) {
                    document.getElementById('non-admin-view').classList.add('hidden');
                    document.getElementById('admin-data-view').classList.remove('hidden');
                    // –ï—Å–ª–∏ —ç—Ç–æ –≤–∫–ª–∞–¥–∫–∞ –ê–¥–º–∏–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                    if (dataCache.length === 0) {
                        fetchAndRenderReports(true); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
                    } else {
                        renderLatestData(dataCache);
                        if (sectionName === 'map') generateMap(dataCache);
                    }
                } else {
                    document.getElementById('non-admin-view').classList.remove('hidden');
                    document.getElementById('admin-data-view').classList.add('hidden');
                }
            }
            if (sectionName === 'map' && isAdmin) {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞
                 if (!mapInstance) generateMap(dataCache);
                 else if (mapInstance) mapInstance.invalidateSize(); // –í–∞–∂–Ω–æ –¥–ª—è Leaflet –≤ —Å–∫—Ä—ã—Ç–æ–º –±–ª–æ–∫–µ
            }
        };

        const updateOfflineStatus = (isOnline = false) => {
            const statusElement = document.getElementById('auth-status');
            const cacheStatusElement = document.getElementById('debugCacheStatus');

            if (isOnline) {
                statusElement.textContent = '(–û–Ω–ª–∞–π–Ω, Auth OK)';
                statusElement.classList.remove('text-red-500', 'text-orange-500');
                statusElement.classList.add('text-green-500');
            } else if (app) {
                // –ï—Å–ª–∏ Auth null, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
                statusElement.textContent = '(Offline, Auth Fail)';
                statusElement.classList.remove('text-green-500');
                statusElement.classList.add('text-red-500');
            } else {
                 statusElement.textContent = '(Firebase Missing)';
                 statusElement.classList.remove('text-green-500');
                 statusElement.classList.add('text-orange-500');
            }

            cacheStatusElement.textContent = `${dataCache.length} –∑–∞–ø–∏—Å–µ–π`;
        };

        const populateSettlements = async () => {
            const select = document.getElementById('settlement');
            select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–µ–ª–µ–Ω–∏–π...</option>';

            // –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç reports, settlements –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —á—Ç–µ–Ω–∏—è –≤—Å–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            if (db && auth.currentUser) {
                try {
                    const settlementsRef = collection(db, "settlements");
                    const snapshot = await getDocs(settlementsRef);
                    
                    const settlements = snapshot.docs.map(doc => doc.data().name).sort();

                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å–µ–ª–µ–Ω–∏–µ</option>';
                    settlements.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        select.appendChild(option);
                    });

                } catch (e) {
                    console.error("Error loading settlements:", e);
                    select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞/Auth)</option>';
                }
            } else {
                select.innerHTML = '<option value="">Auth –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞ –∏–ª–∏ Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</option>';
            }
        };
        
        // --- –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø FIREBASE (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û) ---
        
        const authenticateUser = async () => {
            if (!isTMA || !app || !userTelegramId) {
                console.warn('TMA –∏–ª–∏ Firebase –Ω–µ –≥–æ—Ç–æ–≤—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.');
                updateOfflineStatus();
                return;
            }

            // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ Custom Token –æ—Ç –≤–∞—à–µ–≥–æ Python-–±–æ—Ç–∞
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π AJAX-–∑–∞–ø—Ä–æ—Å –∫ –≤–∞—à–µ–º—É –±—ç–∫–µ–Ω–¥—É.
            // –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –≤—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ initData —á–µ—Ä–µ–∑ fetch.
            
            const authData = Telegram.WebApp.initData;
            
            // –ó–∞–≥–ª—É—à–∫–∞: –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –±—ç–∫–µ–Ω–¥—É!
            // –ü—Ä–∏–º–µ—Ä: const response = await fetch('YOUR_BOT_API_ENDPOINT/auth', { method: 'POST', body: authData });
            // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤ Canvas –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
            // –ó–¥–µ—Å—å –º—ã –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ —Ç–æ, —á—Ç–æ –±–æ—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
            
            let customToken = '';
            
            // –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –í —Ä–µ–∞–ª—å–Ω–æ–º TMA, —Ç–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –±–æ—Ç–æ–º –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
            // —á–µ—Ä–µ–∑ URL –∏–ª–∏ –¥—Ä—É–≥–∏–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º. –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É,
            // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è, —á—Ç–æ –≤—ã –∑–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º.
            // –î–ª—è —Ü–µ–ª–µ–π Canvas –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –µ—Å–ª–∏ –æ–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞.
            if (typeof __initial_auth_token !== 'undefined') {
                 customToken = __initial_auth_token;
            } else {
                 // –í–ù–ò–ú–ê–ù–ò–ï: –ë–µ–∑ —Ç–æ–∫–µ–Ω–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –∞–Ω–æ–Ω–∏–º–Ω—ã–º, –∏ –≤—Å–µ 
                 // –ø—Ä–∞–≤–∏–ª–∞, —Ç—Ä–µ–±—É—é—â–∏–µ Custom Claims, –ø—Ä–æ–≤–∞–ª—è—Ç—Å—è.
                 console.warn("Custom Auth Token –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –ü–æ–ø—ã—Ç–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –≤—Ö–æ–¥–∞.");
            }

            try {
                if (customToken) {
                     // –í—Ö–æ–¥ —Å —Ç–æ–∫–µ–Ω–æ–º, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å claims (admin: true)
                    const userCredential = await signInWithCustomToken(auth, customToken);
                    
                    // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥. –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω —Å claims.
                    const tokenResult = await userCredential.user.getIdTokenResult();
                    isAdmin = tokenResult.claims.admin === true;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º userTelegramId (—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è Firebase UID)
                    userTelegramId = userCredential.user.uid;
                    
                    console.log('Firebase Auth Success. Is Admin:', isAdmin);
                }
            } catch (error) {
                console.error("Firebase Authentication Error:", error);
                window.showAlert('–û—à–∏–±–∫–∞ Auth', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ Firebase. ' + error.message);
            }
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è Auth –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    updateOfflineStatus(true); // –û–Ω–ª–∞–π–Ω, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
                    // –ï—Å–ª–∏ –∞–¥–º–∏–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö
                    if (isAdmin) fetchAndRenderReports(false);
                } else {
                    updateOfflineStatus(false); // –û—Ñ—Ñ–ª–∞–π–Ω / –ù–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ø–æ–ª—è –ø–æ—Å–ª–µ Auth
                document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
                document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';
                
                // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ Auth, –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–µ–ª–µ–Ω–∏—è
                populateSettlements();
            });

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ–±—ã window.onload –º–æ–≥ –¥–æ–∂–¥–∞—Ç—å—Å—è
            return auth.currentUser !== null;
        };

        // --- –û–ë–†–ê–ë–û–¢–ö–ê –§–û–†–ú–´ –ò –û–¢–ü–†–ê–í–ö–ê ---

        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth.currentUser) {
                showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–í—ã –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã. –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∫–∞ Auth –Ω–µ —Å—Ç–∞–Ω–µ—Ç "Online", –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase/–ë–æ—Ç–∞.');
                return;
            }
            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            const form = e.target;
            const data = {
                settlement: form.settlement.value,
                address: form.address.value,
                sentiment: form.sentiment.value,
                comment: form.comment.value || '',
                timestamp: new Date(),
                reporterId: userTelegramId, // –ò—Å–ø–æ–ª—å–∑—É–µ–º Firebase UID (–∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ID Telegram)
            };

            try {
                if (db) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é 'reports'
                    const docRef = await addDoc(collection(db, "reports"), data);
                    showAlert('–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', `–í–∞—à –æ—Ç—á–µ—Ç –¥–ª—è ${data.settlement} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –æ–±–ª–∞–∫–µ.`);
                    form.reset();
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∞, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω
                    if (isAdmin) fetchAndRenderReports();
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firestore, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
                    dataCache.push(data);
                    localStorage.setItem('reports_cache', JSON.stringify(dataCache));
                    showAlert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ', `–û—Ç—á–µ—Ç –¥–ª—è ${data.settlement} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ, –∫–æ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.`);
                    form.reset();
                    updateOfflineStatus();
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á–µ—Ç–∞:", e);
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏, —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º
                if (e.code === 'permission-denied') {
                     showAlert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firebase –∏ Auth —Å—Ç–∞—Ç—É—Å.');
                } else {
                     showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + e.message);
                }
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        });

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò (–ê–î–ú–ò–ù) ---

        const fetchAndRenderReports = async (forceReload = false) => {
            if (!db || !isAdmin) return;

            document.getElementById('loading-indicator').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';

            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            try {
                // –ï—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à
                if (!forceReload && dataCache.length > 0) {
                     renderLatestData(dataCache);
                     return;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –æ—Ç—á–µ—Ç—ã (–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
                const reportsRef = collection(db, "reports");
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ timestamp –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å
                const q = query(reportsRef, orderBy("timestamp", "desc"), limit(1000)); 
                const snapshot = await getDocs(q);
                
                const reports = snapshot.docs.map(doc => ({ 
                    id: doc.id,
                    ...doc.data(), 
                    timestamp: doc.data().timestamp.toDate() // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Firestore Timestamp
                }));

                dataCache = reports;
                localStorage.setItem('reports_cache', JSON.stringify(dataCache));
                updateOfflineStatus();
                renderLatestData(reports);
                generateMap(reports);

            } catch (e) {
                console.error("Error fetching reports:", e);
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç—ã: ' + e.message + '. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞.');
                document.getElementById('loading-indicator').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.';
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        };

        window.renderLatestData = (reports) => {
            const reportsList = document.getElementById('reportsList');
            reportsList.innerHTML = '';
            
            // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const total = reports.length;
            const positive = reports.filter(r => r.sentiment === 'positive').length;
            const negative = reports.filter(r => r.sentiment === 'negative').length;
            const neutral = reports.filter(r => r.sentiment === 'neutral').length;
            const unknown = reports.filter(r => r.sentiment === 'unknown').length;
            
            document.getElementById('totalReports').textContent = total;
            document.getElementById('positiveReports').textContent = positive;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–ü–æ–∑–∏—Ç–∏–≤', '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ', '–ù–µ–≥–∞—Ç–∏–≤', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'],
                    datasets: [{
                        data: [positive, neutral, negative, unknown],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6b7280'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'var(--tg-theme-text-color)'
                            }
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });


            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)
            const latest10 = reports.slice(0, 10);

            if (latest10.length === 0) {
                 reportsList.innerHTML = '<p class="text-tma-hint">–ù–µ—Ç –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>';
                 return;
            }

            latest10.forEach(report => {
                const date = report.timestamp ? report.timestamp.toLocaleDateString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '–ù–µ—Ç –¥–∞—Ç—ã';
                let colorClass = '';
                switch (report.sentiment) {
                    case 'positive': colorClass = 'bg-green-100 text-green-700'; break;
                    case 'negative': colorClass = 'bg-red-100 text-red-700'; break;
                    case 'neutral': colorClass = 'bg-yellow-100 text-yellow-700'; break;
                    default: colorClass = 'bg-gray-100 text-gray-700';
                }

                const reportDiv = document.createElement('div');
                reportDiv.className = `p-3 rounded-lg border border-gray-200 ${colorClass}`;
                reportDiv.innerHTML = `
                    <p class="font-semibold">${report.settlement} (${report.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'})</p>
                    <p class="text-xs text-tma-hint">–û—Ç: ${report.reporterId} &bull; ${date}</p>
                    <p class="mt-1 text-sm">${report.comment || '–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}</p>
                `;
                reportsList.appendChild(reportDiv);
            });
        };

        window.generateMap = (reports) => {
            if (!document.getElementById('map-section').classList.contains('hidden')) {
                const geoData = reports.filter(r => r.lat && r.lng).map(r => [r.lat, r.lng, r.sentiment === 'positive' ? 0.8 : (r.sentiment === 'negative' ? 1.0 : 0.4)]);
                const markerData = reports.filter(r => r.lat && r.lng);

                if (mapInstance) {
                    mapInstance.remove();
                    mapInstance = null;
                }

                const initialLat = markerData.length > 0 ? markerData[0].lat : 55.751244; // –ú–æ—Å–∫–≤–∞
                const initialLng = markerData.length > 0 ? markerData[0].lng : 37.618423;

                mapInstance = L.map('map-container').setView([initialLat, initialLng], 6);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(mapInstance);

                // –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞
                L.heatLayer(geoData, { 
                    radius: 25, 
                    blur: 15, 
                    maxZoom: 17,
                    gradient: {0.0: 'blue', 0.5: 'lime', 1.0: 'red'}
                }).addTo(mapInstance);
                
                // –ú–∞—Ä–∫–µ—Ä—ã —Å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–µ–π
                markerClusterLayer = L.markerClusterGroup();

                markerData.forEach(r => {
                    let color = 'gray';
                    if (r.sentiment === 'positive') color = 'green';
                    else if (r.sentiment === 'negative') color = 'red';
                    else if (r.sentiment === 'neutral') color = 'blue';

                    const markerHtmlStyles = `
                        background-color: ${color};
                        width: 1.5rem;
                        height: 1.5rem;
                        display: block;
                        left: -0.75rem;
                        top: -0.75rem;
                        position: relative;
                        border-radius: 3rem 3rem 0;
                        transform: rotate(45deg);
                        border: 1px solid #FFFFFF
                    `;

                    const icon = L.divIcon({
                        className: "my-custom-pin",
                        iconAnchor: [0, 24],
                        popupAnchor: [0, -36],
                        html: `<span style="${markerHtmlStyles}" />`
                    });

                    const popupContent = `
                        <h4 class="font-bold text-tma-text">${r.settlement}</h4>
                        <p class="text-tma-text">–ê–¥—Ä–µ—Å: ${r.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p class="text-tma-text">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${r.sentiment}</p>
                        <p class="text-tma-text">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${r.comment || '–ù–µ—Ç'}</p>
                        <p class="text-xs text-tma-hint">–û—Ç—á–µ—Ç: ${r.timestamp.toLocaleDateString()}</p>
                    `;

                    const marker = L.marker([r.lat, r.lng], { icon: icon })
                        .bindPopup(popupContent);
                    
                    markerClusterLayer.addLayer(marker);
                });

                mapInstance.addLayer(markerClusterLayer);

                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∑—É–º–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä—ã
                if (markerData.length > 0) {
                    mapInstance.fitBounds(markerClusterLayer.getBounds(), { padding: [50, 50] });
                }
            }
        };


        const clearAllData = async () => {
             if (!db || !isAdmin) {
                 showAlert('–û—à–∏–±–∫–∞', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.');
                 return false;
             }

             if (isTMA) Telegram.WebApp.MainButton.showLoader();

             const batchSize = 100;
             let deletedCount = 0;

             try {
                const reportsRef = collection(db, "reports");
                let q = query(reportsRef, limit(batchSize));
                
                let snapshot;
                do {
                    snapshot = await getDocs(q);
                    
                    if (snapshot.size === 0) break;

                    const batch = writeBatch(db); // –ò—Å–ø–æ–ª—å–∑—É–µ–º writeBatch
                    
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    deletedCount += snapshot.size;

                    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –ø–∞—Ä—Ç–∏–∏
                    q = query(reportsRef, limit(batchSize));

                } while (snapshot.size > 0);


                dataCache = []; // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                updateOfflineStatus();
                showAlert('–£—Å–ø–µ—à–Ω–æ!', `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} –∑–∞–ø–∏—Å–µ–π. –î–∞–Ω–Ω—ã–µ Firestore –æ—á–∏—â–µ–Ω—ã.`);

                if (isAdmin) fetchAndRenderReports();

                return true;

            } catch (e) {
                 console.error("Error deleting collection:", e);
                 showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + e.message);
                 return false;
            } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        };


        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // üîë –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–û–∂–∏–¥–∞–µ–º authenticateUser) - –ò–°–ü–†–ê–í–õ–ï–ù–û
        window.onload = async () => {
            // 1. –°–Ω–∞—á–∞–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ isAdmin –∏ userTelegramId
            await authenticateUser(); // üëà –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï
            
            // 2. –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            populateSettlements(); 
            updateOfflineStatus();
            window.showSection('form');
            lucide.createIcons();

            // –û–¢–õ–ê–î–ö–ê: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
            document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';

            if (!firebaseConfig.projectId) {
                window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase –≤ –∫–æ–¥.');
            }
        };

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        window.authenticateUser = authenticateUser;
        window.fetchAndRenderReports = fetchAndRenderReports;
        window.renderLatestData = renderLatestData;
        window.generateMap = generateMap;
    </script>
</body>
</html>
