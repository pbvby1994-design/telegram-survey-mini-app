<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Блокнот Агитатора | v2.4 (Сургутский р-н)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <style>
        :root {
            --primary: #5c6bc0;
            --primary-light: #8e99f3;
            --primary-dark: #26418f;
        }

        body {
            font-family: 'Jost', sans-serif;
            background-color: #f4f7f9;
        }

        .shadow-main {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .tab-button {
            transition: all 0.2s;
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            font-weight: 600;
        }
        
        #map {
            height: 400px; /* Установите высоту карты */
            width: 100%;
        }

        /* Стили для модального окна (custom alert) */
        #alertModal {
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
        }

        /* Стили для лоадера */
        .loader-ring {
            display: inline-block;
            position: relative;
            width: 30px;
            height: 30px;
        }

        .loader-ring div {
            box-sizing: border-box;
            display: block;
            position: absolute;
            width: 24px;
            height: 24px;
            margin: 3px;
            border: 3px solid var(--primary);
            border-radius: 50%;
            animation: loader-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            border-color: var(--primary) transparent transparent transparent;
        }

        .loader-ring div:nth-child(1) {
            animation-delay: -0.45s;
        }

        .loader-ring div:nth-child(2) {
            animation-delay: -0.3s;
        }

        .loader-ring div:nth-child(3) {
            animation-delay: -0.15s;
        }

        @keyframes loader-ring {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div id="alertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-80 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="alertIcon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 id="alertTitle" class="text-lg leading-6 font-medium text-gray-900 mt-2">Внимание</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="alertMessage" class="text-sm text-gray-500">Сообщение.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="alertCloseButton" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500" onclick="hideAlert()">
                        ОК
                    </button>
                </div>
            </div>
        </div>
    </div>


    <header class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Блокнот Агитатора</h1>
        <p class="text-sm text-gray-500">v2.4 (Сургутский р-н) | Онлайн статус: <span id="onlineStatus" class="font-medium text-red-500">ОФФЛАЙН</span></p>
        <div class="text-xs text-gray-400">
            <span class="mr-3">ID: <span id="debugUserId">Нет ID</span></span>
            <span class="mr-3">Админ: <span id="debugAdminStatus">НЕТ</span></span>
        </div>
    </header>

    <!-- Навигация по вкладкам -->
    <div class="flex border-b border-gray-200 mb-6 sticky top-0 bg-white z-10">
        <button id="tabForm" onclick="showSection('form')" class="tab-button p-3 text-gray-600 active flex items-center">
            <i data-lucide="clipboard-list" class="w-5 h-5 mr-2"></i> Отчет
        </button>
        <button id="tabReports" onclick="showSection('reports')" class="tab-button p-3 text-gray-600 flex items-center">
            <i data-lucide="list-checks" class="w-5 h-5 mr-2"></i> Мои Записи
        </button>
        <button id="tabAdmin" onclick="showSection('admin')" class="tab-button p-3 text-gray-600 flex items-center hidden">
            <i data-lucide="settings" class="w-5 h-5 mr-2"></i> Админ
        </button>
    </div>

    <!-- 1. Секция Ввода Отчета -->
    <section id="sectionForm" class="bg-white p-4 rounded-xl shadow-main mb-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Ввод данных</h2>
        <form id="reportForm">
            <!-- Населенный пункт -->
            <div class="mb-4">
                <label for="settlement" class="block text-sm font-medium text-gray-700 mb-1">Населенный пункт</label>
                <select id="settlement" name="settlement" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <option value="" disabled selected>Выберите населенный пункт</option>
                    <!-- Опции будут заполнены JS -->
                </select>
            </div>
            <!-- Адрес -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="street" class="block text-sm font-medium text-gray-700 mb-1">Улица</label>
                    <input type="text" id="street" name="street" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="ул. Ленина">
                </div>
                <div>
                    <label for="house" class="block text-sm font-medium text-gray-700 mb-1">Дом (№)</label>
                    <input type="text" id="house" name="house" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="10/1">
                </div>
                <div>
                    <label for="apartment" class="block text-sm font-medium text-gray-700 mb-1">Квартира (№)</label>
                    <input type="text" id="apartment" name="apartment" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="15">
                </div>
            </div>

            <!-- Действие -->
            <div class="mb-4">
                <label for="action" class="block text-sm font-medium text-gray-700 mb-2">Действие</label>
                <div class="flex flex-wrap gap-2" id="actionButtons">
                    <!-- Кнопки будут заполнены JS -->
                </div>
                <input type="hidden" id="action" name="action" required>
            </div>

            <!-- Лояльность -->
            <div class="mb-4">
                <label for="loyalty" class="block text-sm font-medium text-gray-700 mb-2">Лояльность</label>
                <div class="flex flex-wrap gap-2" id="loyaltyButtons">
                    <!-- Кнопки будут заполнены JS -->
                </div>
                <input type="hidden" id="loyalty" name="loyalty" required>
            </div>

            <!-- Требуется Повтор / Комментарий -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-center mb-3">
                    <input type="checkbox" id="requiresFollowup" name="requiresFollowup" class="h-4 w-4 text-primary focus:ring-primary rounded border-gray-300">
                    <label for="requiresFollowup" class="ml-2 block text-sm font-medium text-gray-700">Требуется повторный визит / Обратная связь</label>
                </div>
                <label for="comment" class="block text-sm font-medium text-gray-700 mb-1">Комментарий (важно!)</label>
                <textarea id="comment" name="comment" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="Краткое описание ситуации или ключевая информация..."></textarea>
            </div>

            <!-- Кнопка Отправки -->
            <button type="submit" id="submitButton" class="w-full btn-primary py-3 px-4 rounded-xl text-lg font-semibold flex items-center justify-center shadow-md hover:shadow-lg">
                <i data-lucide="check-circle" class="w-6 h-6 mr-2"></i> Отправить Отчет
            </button>
        </form>
    </section>

    <!-- 2. Секция Мои Записи -->
    <section id="sectionReports" class="bg-white p-4 rounded-xl shadow-main mb-6 hidden">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Мои последние 10 записей</h2>
        <div id="latestReports" class="space-y-3">
            <p class="text-gray-500" id="noReportsMessage">Загрузка данных...</p>
        </div>
        <button onclick="renderLatestData(true)" class="mt-4 w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 transition">
            Показать все мои записи
        </button>
    </section>

    <!-- 3. Секция Админ Панели -->
    <section id="sectionAdmin" class="hidden">
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- 3.1. Панель Отчетов и Экспорта -->
            <div class="xl:col-span-2 bg-white p-4 rounded-xl shadow-main">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Общие отчеты и статистика</h2>
                    <button onclick="fetchAndRenderReports()" class="btn-primary py-2 px-4 rounded-lg text-sm font-medium flex items-center">
                         <div class="loader-ring mr-2 hidden" id="adminLoader"><div></div><div></div><div></div><div></div></div>
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-1"></i> Обновить
                    </button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div class="bg-indigo-50 p-3 rounded-lg">
                        <p class="text-sm text-indigo-700 font-medium">Всего записей</p>
                        <p id="statTotal" class="text-2xl font-bold text-indigo-900">0</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg">
                        <p class="text-sm text-green-700 font-medium">Лояльных</p>
                        <p id="statLoyal" class="text-2xl font-bold text-green-900">0</p>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg">
                        <p class="text-sm text-yellow-700 font-medium">Требуют повтора</p>
                        <p id="statFollowup" class="text-2xl font-bold text-yellow-900">0</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Распределение лояльности</h3>
                    <div class="h-64">
                        <canvas id="loyaltyChart"></canvas>
                    </div>
                </div>

                <button onclick="exportToXLSX()" class="w-full bg-green-600 text-white py-3 px-4 rounded-xl text-lg font-semibold flex items-center justify-center shadow-md hover:bg-green-700">
                    <i data-lucide="download" class="w-6 h-6 mr-2"></i> Экспорт всех данных (XLSX)
                </button>
            </div>

            <!-- 3.2. Панель Карты и Инструментов -->
            <div class="xl:col-span-1 bg-white p-4 rounded-xl shadow-main">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Инструменты</h2>

                <!-- Карта -->
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Тепловая карта посещений</h3>
                    <div id="map" class="rounded-lg border border-gray-300"></div>
                    <button onclick="generateMap()" class="mt-2 w-full bg-blue-100 text-blue-700 py-2 px-4 rounded-lg font-medium hover:bg-blue-200 transition">
                        Построить карту
                    </button>
                </div>

                <!-- Очистка Данных -->
                <div>
                    <h3 class="text-lg font-medium text-red-600 mb-2">Очистка данных</h3>
                    <p class="text-sm text-gray-600 mb-3">Осторожно! Удаляет все данные отчетов из Firestore. Это действие необратимо.</p>
                    <button onclick="showConfirmDeleteModal()" class="w-full bg-red-100 text-red-700 py-2 px-4 rounded-lg font-medium hover:bg-red-200 transition">
                        Удалить все отчеты
                    </button>
                </div>

                <!-- Модальное окно подтверждения удаления -->
                <div id="confirmDeleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
                    <div class="relative top-20 mx-auto p-5 border w-80 shadow-lg rounded-md bg-white">
                        <div class="mt-3 text-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Подтверждение удаления</h3>
                            <div class="mt-2 px-7 py-3">
                                <p class="text-sm text-gray-500">Вы уверены, что хотите **безвозвратно** удалить **ВСЕ** отчеты из базы данных?</p>
                            </div>
                            <div class="items-center px-4 py-3 space-y-2">
                                <button id="confirmDeleteButton" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700" onclick="clearDatabase()">
                                    Да, удалить навсегда
                                </button>
                                <button class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300" onclick="hideConfirmDeleteModal()">
                                    Отмена
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>


    <script>
        // --- КОНФИГУРАЦИЯ FIREBASE (ВСТАВИТЬ СЮДА ВАШИ КЛЮЧИ) ---
        // Замените на ваши ключи, полученные из Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyDVeRXO16KtIwoJQb4uHQuCsEv3xTLBGhI",
            authDomain: "agitator-notebook.firebaseapp.com",
            projectId: "agitator-notebook",
            storageBucket: "agitator-notebook.firebasestorage.app",
            messagingSenderId: "518555352011",
            appId: "1:518555352011:web:2b17a175f70a59a7212450"
        };
        // --------------------------------------------------------

        // Инициализация Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth();

        // Константы
        const REPORT_COLLECTION_PATH = 'artifacts/' + firebaseConfig.appId + '/public/data/reports';
        const ADMIN_COLLECTION_PATH = 'admin_users';

        // Переменные состояния
        let isTMA = window.Telegram && window.Telegram.WebApp;
        let isAdmin = false;
        let userTelegramId = isTMA ? String(Telegram.WebApp.initDataUnsafe.user.id) : null;
        let dataCache = [];
        let mapInstance = null;
        let latestReportsQuerySnapshot = null;
        let loyaltyChartInstance = null;

        // --- ДАННЫЕ ДЛЯ ФОРМЫ (ОБНОВЛЕНО ПО ТРЕБОВАНИЮ ПОЛЬЗОВАТЕЛЯ) ---
        const SETTLEMENTS = [
            'г.п. Лянтор',
            'с.п. Русскинская',
            'г.п. Федоровский',
            'г.п. Барсово',
            'г.п. Белый Яр',
            'с.п. Лямина',
            'с.п. Сытомино',
            'с.п. Угут',
            'с.п. Ульт-Ягун',
            'с.п. Солнечный',
            'с.п. Нижнесортымский',
            'с.п. Тундрино',
            'с.п. Локосово',
            'Другой' // Оставляем для случаев, не входящих в список
        ];

        const ACTIONS = [
            'Вручена листовка',
            'Разъяснение',
            'Ответы на вопросы',
            'Не застал/Не открыл',
            'Отказ от общения',
            'Другое'
        ];

        const LOYALTIES = [
            { label: 'За (Поддерживает)', color: 'bg-green-500', value: 'За' },
            { label: 'Против (Противник)', color: 'bg-red-500', value: 'Против' },
            { label: 'Нейтрально (Равнодушен)', color: 'bg-yellow-500', value: 'Нейтрально' },
            { label: 'Затруднился ответить', color: 'bg-gray-500', value: 'Затруднился ответить' },
        ];
        // ------------------------------------------------------------------

        // --- ГЛОБАЛЬНЫЕ ФУНКЦИИ UI ---

        function showAlert(title, message, isError = true) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            const icon = document.getElementById('alertIcon');
            icon.classList.remove('bg-red-100', 'bg-green-100');
            icon.querySelector('svg').classList.remove('text-red-600', 'text-green-600');

            if (isError) {
                icon.classList.add('bg-red-100');
                icon.querySelector('svg').classList.add('text-red-600');
            } else {
                icon.classList.add('bg-green-100');
                icon.querySelector('svg').classList.add('text-green-600');
            }
            document.getElementById('alertModal').classList.remove('hidden');
        }

        function hideAlert() {
            document.getElementById('alertModal').classList.add('hidden');
        }

        function showConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').classList.remove('hidden');
        }

        function hideConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').classList.add('hidden');
        }

        function showSection(sectionId) {
            const sections = ['form', 'reports', 'admin'];
            sections.forEach(id => {
                const section = document.getElementById(`section${id.charAt(0).toUpperCase() + id.slice(1)}`);
                const tab = document.getElementById(`tab${id.charAt(0).toUpperCase() + id.slice(1)}`);
                if (section) section.classList.add('hidden');
                if (tab) tab.classList.remove('active');
            });

            const targetSection = document.getElementById(`section${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
            const targetTab = document.getElementById(`tab${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);

            if (targetSection) targetSection.classList.remove('hidden');
            if (targetTab) targetTab.classList.add('active');

            // Специальный вызов для админ-секции
            if (sectionId === 'admin' && isAdmin) {
                fetchAndRenderReports();
            }
        }

        // --- ФУНКЦИИ ЗАПОЛНЕНИЯ ФОРМЫ ---

        function populateSettlements() {
            const select = document.getElementById('settlement');
            SETTLEMENTS.forEach(settlement => {
                const option = document.createElement('option');
                option.value = settlement;
                option.textContent = settlement;
                select.appendChild(option);
            });
        }

        function populateButtons(containerId, data, inputId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const hiddenInput = document.getElementById(inputId);

            data.forEach(item => {
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = item.label || item;
                button.dataset.value = item.value || item;
                button.className = `p-2 rounded-lg text-sm font-medium border border-gray-300 transition hover:bg-gray-100`;

                if (item.color) {
                     button.classList.add(item.color, 'text-white', 'shadow-sm');
                     button.classList.remove('border-gray-300');
                } else {
                     button.classList.add('bg-white', 'text-gray-700');
                }

                button.onclick = () => {
                    // Сброс всех кнопок в неактивное состояние
                    container.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('ring-2', 'ring-offset-2', 'ring-primary-light');
                    });
                    // Установка активного состояния
                    button.classList.add('ring-2', 'ring-offset-2', 'ring-primary-light');
                    // Установка значения в скрытое поле
                    hiddenInput.value = button.dataset.value;
                };
                container.appendChild(button);
            });
        }

        // --- ФУНКЦИИ РАБОТЫ С FIREBASE ---

        /**
         * 🔑 Аутентификация пользователя и проверка прав администратора
         * Критически важная функция, которая должна запускаться первой.
         */
        async function authenticateUser() {
            try {
                if (!userTelegramId) {
                     console.warn('User ID is missing. Running in anonymous mode.');
                     return;
                }

                const hash = isTMA ? Telegram.WebApp.initData : null;
                if (!hash) {
                    console.error('Telegram Init Data is missing. Cannot authenticate.');
                    return;
                }

                // 1. Получение Custom Token через Telegram Bot API (имитация)
                // В реальном приложении этот запрос пойдет на ваш сервер, который
                // проверит хеш и, если все ОК, сгенерирует и вернет Custom Token.
                // В данной песочнице, мы имитируем, что токен уже готов,
                // используя ID из Telegram.WebApp.initDataUnsafe

                const token = JSON.parse(localStorage.getItem('MOCK_ADMIN_TOKEN')) || 'MOCK_TOKEN_FOR_' + userTelegramId;

                // 2. Вход в Firebase с помощью Custom Token
                const userCredential = await auth.signInWithCustomToken(token);
                userTelegramId = userCredential.user.uid; // Обновляем ID из токена (должен совпадать)
                console.log("Firebase Auth Success. UID:", userTelegramId);

                // 3. Проверка прав администратора
                const adminDocRef = db.collection(ADMIN_COLLECTION_PATH).doc(userTelegramId);
                const adminDoc = await adminDocRef.get();

                if (adminDoc.exists && adminDoc.data().is_admin === true) {
                    isAdmin = true;
                    document.getElementById('tabAdmin').classList.remove('hidden');
                }

            } catch (error) {
                console.error("Authentication/Admin check failed:", error);
                // Если токен невалиден или что-то пошло не так, продолжаем как обычный пользователь
                isAdmin = false;
            }

            // Обновление UI после аутентификации
            document.getElementById('debugUserId').textContent = userTelegramId || 'Нет ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? 'ДА' : 'НЕТ';

            // Если аутентификация прошла успешно, загружаем данные пользователя
            if (userTelegramId) {
                renderLatestData();
            } else {
                showAlert('Ошибка Аутентификации', 'Не удалось получить ID пользователя для входа. Попробуйте перезапустить Mini App.');
            }
        }


        /**
         * 📝 Отправка отчета в Firestore
         */
        document.getElementById('reportForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!userTelegramId) {
                showAlert('Ошибка', 'Не удалось идентифицировать пользователя. Попробуйте перезапустить Mini App.');
                return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                const requiredFields = ['settlement', 'street', 'house', 'apartment', 'action', 'loyalty'];
                for (const field of requiredFields) {
                    if (!data[field]) {
                        showAlert('Ошибка', `Поле "${field}" обязательно для заполнения.`);
                        return;
                    }
                }

                // Получение геолокации (если доступна)
                let location = null;
                if (isTMA && Telegram.WebApp.is2dPolygonApiSupported) {
                    // Используйте реальную API геолокации, если она доступна в Mini App
                    // В текущей песочнице, используем заглушку
                    location = {
                        latitude: 61.25 + (Math.random() - 0.5) * 0.1, // Пример координат в районе Сургута
                        longitude: 73.4 + (Math.random() - 0.5) * 0.1
                    };
                } else if (navigator.geolocation) {
                    // Резервный вариант для обычного браузера
                     location = await new Promise((resolve) => {
                         navigator.geolocation.getCurrentPosition(
                             (pos) => resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }),
                             (err) => { console.warn("Geolocation failed:", err.message); resolve(null); },
                             { timeout: 5000 }
                         );
                     });
                }

                const reportData = {
                    telegram_id: userTelegramId,
                    full_name: (isTMA && Telegram.WebApp.initDataUnsafe.user.first_name) || 'Аноним',
                    username: (isTMA && Telegram.WebApp.initDataUnsafe.user.username) || 'нет_username',
                    timestamp: Date.now(),
                    settlement: data.settlement,
                    street: data.street,
                    house: data.house,
                    apartment: data.apartment,
                    action: data.action,
                    loyalty: data.loyalty,
                    comment: data.comment || '',
                    requires_followup: !!data.requiresFollowup,
                    location: location
                };

                await db.collection(REPORT_COLLECTION_PATH).add(reportData);

                showAlert('Отчет отправлен!', 'Спасибо, ваш отчет успешно сохранен в базе данных.', false);
                e.target.reset(); // Сброс формы
                renderLatestData(); // Обновление списка моих записей

            } catch (error) {
                console.error("Error submitting report: ", error);
                showAlert('Ошибка Отправки', 'Не удалось сохранить отчет: ' + error.message);
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        });

        // --- ФУНКЦИИ ПРОСМОТРА ОТЧЕТОВ (Пользователь) ---

        /**
         * 👁️ Отображение последних записей текущего пользователя
         */
        async function renderLatestData(showAll = false) {
            if (!userTelegramId) {
                 document.getElementById('noReportsMessage').textContent = 'Сначала пройдите аутентификацию.';
                 return;
            }
            document.getElementById('noReportsMessage').textContent = 'Загрузка данных...';

            try {
                let query = db.collection(REPORT_COLLECTION_PATH)
                    .where('telegram_id', '==', userTelegramId)
                    .orderBy('timestamp', 'desc');

                if (!showAll) {
                    query = query.limit(10);
                }

                latestReportsQuerySnapshot = await query.get();
                const reportsContainer = document.getElementById('latestReports');
                reportsContainer.innerHTML = '';
                document.getElementById('noReportsMessage').classList.add('hidden');

                if (latestReportsQuerySnapshot.empty) {
                    reportsContainer.innerHTML = '<p class="text-gray-500">Пока нет ваших отчетов. Отправьте первый!</p>';
                    return;
                }

                latestReportsQuerySnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const loyaltyItem = LOYALTIES.find(l => l.value === data.loyalty);
                    const loyaltyColor = loyaltyItem ? loyaltyItem.color.replace('bg-', 'text-') : 'text-gray-600';

                    const reportDiv = document.createElement('div');
                    reportDiv.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200';
                    reportDiv.innerHTML = `
                        <p class="text-xs text-gray-400">${new Date(data.timestamp).toLocaleString()}</p>
                        <p class="font-semibold text-sm mb-1">${data.settlement}, ${data.street}, д. ${data.house}, кв. ${data.apartment}</p>
                        <p class="text-sm">
                            Действие: <span class="font-medium text-indigo-700">${data.action}</span> |
                            Лояльность: <span class="font-bold ${loyaltyColor}">${data.loyalty}</span>
                        </p>
                        ${data.requires_followup ? '<p class="text-sm text-red-500 font-medium mt-1 flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i> Требуется повтор!</p>' : ''}
                        ${data.comment ? `<p class="text-xs italic text-gray-500 mt-1">Коммент.: ${data.comment}</p>` : ''}
                    `;
                    reportsContainer.appendChild(reportDiv);
                });

                // Пересоздаем иконки lucide
                lucide.createIcons();

            } catch (error) {
                console.error("Error fetching latest reports: ", error);
                document.getElementById('noReportsMessage').classList.remove('hidden');
                document.getElementById('noReportsMessage').textContent = 'Ошибка загрузки отчетов.';
            }
        }

        // --- ФУНКЦИИ АДМИН ПАНЕЛИ ---

        /**
         * 📊 Получение всех отчетов и рендеринг статистики
         */
        async function fetchAndRenderReports() {
            if (!isAdmin) {
                 showAlert('Отказано в доступе', 'У вас нет прав администратора для просмотра этой секции.');
                 return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showProgress();
            document.getElementById('adminLoader').classList.remove('hidden');


            try {
                // Получение всех данных
                const snapshot = await db.collection(REPORT_COLLECTION_PATH).get();
                dataCache = snapshot.docs.map(doc => doc.data());

                // Обновление статистики
                updateStats(dataCache);

                // Построение графиков
                renderLoyaltyChart(dataCache);

            } catch (error) {
                console.error("Error fetching all reports: ", error);
                showAlert('Ошибка Загрузки', 'Не удалось загрузить общие отчеты: ' + error.message);
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
                document.getElementById('adminLoader').classList.add('hidden');
            }
        }

        /**
         * 📈 Обновление сводной статистики
         */
        function updateStats(data) {
            document.getElementById('statTotal').textContent = data.length;
            document.getElementById('statLoyal').textContent = data.filter(d => d.loyalty === 'За').length;
            document.getElementById('statFollowup').textContent = data.filter(d => d.requires_followup).length;
        }

        /**
         * 🎨 Рендеринг круговой диаграммы лояльности
         */
        function renderLoyaltyChart(data) {
            if (loyaltyChartInstance) {
                loyaltyChartInstance.destroy();
            }

            const loyaltyCounts = {};
            data.forEach(doc => {
                loyaltyCounts[doc.loyalty] = (loyaltyCounts[doc.loyalty] || 0) + 1;
            });

            const labels = Object.keys(loyaltyCounts);
            const counts = Object.values(loyaltyCounts);

            const colorsMap = {
                'За': '#10b981', // green-500
                'Против': '#ef4444', // red-500
                'Нейтрально': '#f59e0b', // yellow-500
                'Затруднился ответить': '#6b7280', // gray-500
                'Другое': '#3b82f6', // blue-500
            };

            const backgroundColors = labels.map(label => colorsMap[label] || '#9ca3af');

            const ctx = document.getElementById('loyaltyChart').getContext('2d');
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1) + '%';
                                return `${label}: ${value} (${percentage})`;
                            }
                        }
                    }
                }
            };

            loyaltyChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: chartOptions
            });
        }

        /**
         * 🗺️ Генерация тепловой карты
         */
        function generateMap() {
             if (!isAdmin) {
                 showAlert('Отказано в доступе', 'У вас нет прав администратора для доступа к карте.');
                 return;
            }

            if (dataCache.length === 0) {
                 showAlert('Ошибка', 'Нет данных для карты. Пожалуйста, обновите отчеты.');
                 return;
            }

            // 1. Фильтруем данные: нужны только записи с геолокацией
            const heatData = dataCache
                .filter(doc => doc.location && doc.location.latitude && doc.location.longitude)
                .map(doc => [doc.location.latitude, doc.location.longitude, 0.5]); // [lat, lng, intensity]

            if (heatData.length === 0) {
                 showAlert('Информация', 'В загруженных данных нет координат для построения карты.');
                 return;
            }

            // 2. Инициализация или очистка карты
            if (mapInstance) {
                mapInstance.remove();
            }

            // Используем координаты центра Сургутского района или среднее по данным
            const avgLat = heatData.reduce((sum, d) => sum + d[0], 0) / heatData.length;
            const avgLng = heatData.reduce((sum, d) => sum + d[1], 0) / heatData.length;

            mapInstance = L.map('map').setView([avgLat, avgLng], 10); // Устанавливаем зум 10

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);

            // 3. Добавляем тепловой слой
            L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'}
            }).addTo(mapInstance);

            showAlert('Карта построена!', `Отображены ${heatData.length} точек с координатами.`, false);
        }

        /**
         * 🗑️ Удаление всех данных (Админ)
         */
        async function clearDatabase() {
            hideConfirmDeleteModal();
             if (!isAdmin) {
                 showAlert('Отказано в доступе', 'У вас нет прав администратора для этой операции.');
                 return false;
            }

            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            try {
                const collectionRef = db.collection(REPORT_COLLECTION_PATH);
                const snapshot = await collectionRef.get();
                let deletedCount = 0;

                // Удаляем документы пакетами (Batch Deletion)
                const batchSize = 500;
                while (snapshot.docs.length > 0) {
                    const batch = db.batch();
                    const docsToDelete = snapshot.docs.slice(0, batchSize);

                    docsToDelete.forEach(doc => {
                        batch.delete(doc.ref);
                        deletedCount++;
                    });

                    await batch.commit();

                    // Получаем следующий пакет, если он есть
                    if (snapshot.docs.length > batchSize) {
                         snapshot = await collectionRef.limit(batchSize).get();
                    } else {
                         snapshot.docs = []; // Выход из цикла
                    }
                }

                dataCache = []; // Очищаем локальный кеш после удаления
                updateOfflineStatus();
                showAlert('Успешно!', `Удалено ${deletedCount} записей. Данные Firestore очищены.`);

                if (isAdmin) fetchAndRenderReports();

                return true;

            } catch (e) {
                 console.error("Error deleting collection:", e);
                 showAlert('Ошибка', 'Произошла ошибка при удалении коллекции: ' + e.message);
                 return false;
            } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        }


        // --- ИНИЦИАЛИЗАЦИЯ WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // 🔑 Инициализация при загрузке (Ожидаем authenticateUser) - ИСПРАВЛЕНО
        window.onload = async () => {
            // 1. Сначала аутентификация для установки isAdmin и userTelegramId
            await authenticateUser();

            // 2. Затем заполнение интерфейса
            populateButtons('actionButtons', ACTIONS, 'action'); // Действие
            populateButtons('loyaltyButtons', LOYALTIES, 'loyalty'); // Лояльность
            populateSettlements();
            window.showSection('form');
            lucide.createIcons();

            // ОТЛАДКА: Повторное обновление полей, чтобы гарантировать актуальность
            document.getElementById('debugUserId').textContent = userTelegramId || 'Нет ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? 'ДА' : 'НЕТ';

            if (!firebaseConfig.projectId) {
                window.showAlert('ВНИМАНИЕ', 'Необходимо вставить ключи конфигурации Firebase в код.');
            }
        };

        // Экспортируем функции для доступа из HTML
        window.authenticateUser = authenticateUser;
        window.fetchAndRenderReports = fetchAndRenderReports;
        window.renderLatestData = renderLatestData;
        window.generateMap = generateMap;
        window.exportToXLSX = exportToXLSX;
        window.showSection = showSection;
        window.showAlert = showAlert;
        window.hideAlert = hideAlert;
        window.showConfirmDeleteModal = showConfirmDeleteModal;
        window.hideConfirmDeleteModal = hideConfirmDeleteModal;
    </script>
</body>
</html>
