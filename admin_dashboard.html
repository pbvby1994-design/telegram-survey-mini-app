<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Блокнот Агитатора | v2.5 (Фикс Админа/Firestore)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.4/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />

    <style>
        body { font-family: 'Jost', sans-serif; }
        /* Стили для карты, чтобы она была видна */
        #mapContainer { height: 60vh; width: 100%; border-radius: 0.5rem; }
        .tab-button.active { @apply border-b-2 border-indigo-600 font-semibold; }
        .data-table th, .data-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .data-table th { background-color: #f3f4f6; }
        .data-table-container { max-height: 80vh; overflow-y: auto; }
        /* Кастомный стиль для сообщений */
        .custom-alert { position: fixed; top: 1rem; right: 1rem; z-index: 50; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
    </style>

    <!-- Firebase SDK (Compatibility mode for easy access) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-4">

    <!-- Заголовок -->
    <header class="mb-6">
        <h1 class="text-3xl font-bold text-indigo-600 flex items-center">
            <i data-lucide="notebook-text" class="w-8 h-8 mr-3"></i>
            Блокнот Агитатора
        </h1>
        <p class="text-sm text-gray-500">v2.5 (Firestore Admin Check)</p>
    </header>

    <!-- Модальное окно для сообщений -->
    <div id="custom-alert" class="custom-alert hidden"></div>

    <!-- Область отладки (Видна только для справки) -->
    <div class="bg-indigo-100 p-3 rounded-lg mb-6 text-sm">
        <p>Ваш ID Telegram: <span id="debugUserId" class="font-mono font-semibold">...</span></p>
        <p>Статус Админа: <span id="debugAdminStatus" class="font-bold">...</span></p>
        <p>Статус Кэша: <span id="debugCacheStatus" class="font-bold">...</span></p>
    </div>

    <!-- Навигация по секциям -->
    <div class="flex border-b border-gray-200 mb-6">
        <button onclick="showSection('form')" class="tab-button p-3 text-lg text-gray-600 transition duration-150 active">Форма</button>
        <button onclick="showSection('reports')" id="reports-tab" class="tab-button p-3 text-lg text-gray-600 transition duration-150 hidden">Отчеты</button>
        <button onclick="showSection('map')" id="map-tab" class="tab-button p-3 text-lg text-gray-600 transition duration-150 hidden">Карта</button>
    </div>

    <!-- Секция 1: Форма ввода данных -->
    <section id="form-section" class="mb-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Ввод данных</h2>
            <form id="data-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- ФИО/Username -->
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700">ФИО / Username</label>
                        <input type="text" id="fullName" name="fullName" placeholder="Иван Иванов" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>

                    <!-- Населенный пункт -->
                    <div>
                        <label for="settlement" class="block text-sm font-medium text-gray-700">Населенный пункт</label>
                        <select id="settlement" name="settlement" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                            <!-- Опции будут заполнены JS -->
                        </select>
                    </div>

                    <!-- Улица -->
                    <div>
                        <label for="street" class="block text-sm font-medium text-gray-700">Улица</label>
                        <input type="text" id="street" name="street" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>

                    <!-- Дом -->
                    <div>
                        <label for="house" class="block text-sm font-medium text-gray-700">Дом</label>
                        <input type="text" id="house" name="house" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>

                    <!-- Квартира (необязательно) -->
                    <div>
                        <label for="apartment" class="block text-sm font-medium text-gray-700">Квартира (необязательно)</label>
                        <input type="text" id="apartment" name="apartment" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>

                    <!-- Лояльность -->
                    <div>
                        <label for="loyalty" class="block text-sm font-medium text-gray-700">Лояльность</label>
                        <select id="loyalty" name="loyalty" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="Высокая">Высокая (ЗА)</option>
                            <option value="Средняя">Средняя (НЕ ЗНАЕТ)</option>
                            <option value="Низкая">Низкая (ПРОТИВ)</option>
                        </select>
                    </div>

                    <!-- Действие -->
                    <div class="md:col-span-2">
                        <label for="action" class="block text-sm font-medium text-gray-700">Тип контакта/Действие</label>
                        <select id="action" name="action" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="Визит (успешный)">Визит (успешный контакт)</option>
                            <option value="Визит (нет дома)">Визит (нет дома)</option>
                            <option value="Визит (отказ)">Визит (отказ от контакта)</option>
                            <option value="Телефонный звонок">Телефонный звонок</option>
                            <option value="Другое">Другое</option>
                        </select>
                    </div>

                    <!-- Комментарий -->
                    <div class="md:col-span-2">
                        <label for="comment" class="block text-sm font-medium text-gray-700">Комментарий</label>
                        <textarea id="comment" name="comment" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    </div>

                    <!-- Требуется повтор -->
                    <div class="md:col-span-2 flex items-center">
                        <input type="checkbox" id="requiresFollowup" name="requiresFollowup" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="requiresFollowup" class="ml-2 block text-sm font-medium text-gray-700">Требуется повторный контакт / визит</label>
                    </div>

                    <!-- Координаты -->
                    <div class="md:col-span-2 border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">Текущее местоположение:</span>
                            <button type="button" onclick="getLocation()" class="text-xs bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full hover:bg-indigo-200 transition">
                                <i data-lucide="map-pin" class="w-4 h-4 inline-block mr-1"></i>
                                Определить GPS
                            </button>
                        </div>
                        <p id="location-display" class="text-sm text-gray-600">Координаты: Не определены</p>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                    </div>
                </div>

                <!-- Кнопка сохранения -->
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 flex items-center justify-center">
                    <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                    Сохранить данные
                </button>
                <button type="button" onclick="syncData(true)" id="sync-button" class="mt-2 w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition duration-200 flex items-center justify-center hidden">
                    <i data-lucide="cloud-upload" class="w-5 h-5 mr-2"></i>
                    Синхронизировать (<span id="offline-count">0</span>)
                </button>
            </form>

            <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-700 border-t pt-4">Локально сохраненные данные</h3>
            <div id="latest-data-container" class="space-y-3">
                <p class="text-sm text-gray-500">Нет данных, сохраненных в браузере.</p>
            </div>
        </div>
    </section>

    <!-- Секция 2: Отчеты (Видна только админам) -->
    <section id="reports-section" class="mb-8 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Отчеты и Аналитика</h2>

            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-3 sm:space-y-0 sm:space-x-3">
                <button onclick="fetchAndRenderReports()" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                    <i data-lucide="rotate-cw" class="w-5 h-5 mr-2"></i>
                    Обновить Отчеты (Firestore)
                </button>
                <button onclick="exportToXLSX()" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-200 flex items-center justify-center">
                    <i data-lucide="file-spreadsheet" class="w-5 h-5 mr-2"></i>
                    Экспорт в XLSX
                </button>
            </div>

            <div id="report-summary" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Карточки суммарных данных -->
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- График 1: Лояльность -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold mb-2">Распределение Лояльности</h3>
                    <canvas id="loyaltyChart"></canvas>
                </div>
                <!-- График 2: Действия -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold mb-2">Типы Контактов</h3>
                    <canvas id="actionChart"></canvas>
                </div>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-gray-700">Подробные данные</h3>
            <div class="data-table-container bg-gray-50 rounded-lg shadow-inner">
                <table id="reports-table" class="min-w-full divide-y divide-gray-200 data-table">
                    <thead>
                        <tr>
                            <th>Время</th>
                            <th>ID</th>
                            <th>Агитатор (ФИО)</th>
                            <th>НП</th>
                            <th>Улица</th>
                            <th>Дом</th>
                            <th>Действие</th>
                            <th>Лояльность</th>
                            <th>Повтор</th>
                            <th>Комментарий</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Данные будут вставлены JS -->
                    </tbody>
                </table>
                <p id="reports-status" class="text-center p-4 text-gray-500">Нажмите "Обновить Отчеты", чтобы загрузить данные.</p>
            </div>

            <button onclick="confirmClearDatabase()" class="mt-6 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-200 flex items-center justify-center w-full">
                <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i>
                Очистить ВСЮ Базу Данных (ВНИМАНИЕ!)
            </button>
        </div>
    </section>

    <!-- Секция 3: Карта (Видна только админам) -->
    <section id="map-section" class="mb-8 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Геолокация контактов</h2>
            <div id="mapContainer"></div>
            <p class="mt-4 text-sm text-gray-600">На карте отображаются контакты, для которых были указаны координаты.</p>
            <div class="flex items-center space-x-4 mt-4">
                 <button onclick="toggleMapType('marker')" id="marker-btn" class="bg-indigo-500 text-white py-2 px-4 rounded-lg text-sm transition">Маркеры</button>
                 <button onclick="toggleMapType('heat')" id="heat-btn" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-lg text-sm transition">Тепловая Карта</button>
            </div>
        </div>
    </section>

    <!-- Модальное окно подтверждения (для очистки базы) -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-red-600 mb-4">Подтверждение удаления</h3>
            <p class="mb-4">Вы уверены, что хотите **безвозвратно** удалить ВСЕ данные из базы Firestore?</p>
            <p class="mb-6 font-semibold">Введите слово "<span class="text-red-500">УДАЛИТЬ</span>" для подтверждения:</p>
            <input type="text" id="delete-confirm-input" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="Введите УДАЛИТЬ">
            <div class="flex justify-end space-x-3">
                <button onclick="hideConfirmModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400 transition">Отмена</button>
                <button onclick="clearDatabase()" id="clear-db-button" disabled class="bg-red-500 text-white py-2 px-4 rounded-lg opacity-50 cursor-not-allowed transition">Подтвердить Удаление</button>
            </div>
        </div>
    </div>


    <script>
        // --- КОНФИГУРАЦИЯ FIREBASE (ВСТАВИТЬ СЮДА ВАШИ КЛЮЧИ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVeRXO16KtIwoJQb4uHQuCsEv3xTLBGhI",
            authDomain: "agitator-notebook.firebaseapp.com",
            projectId: "agitator-notebook",
            storageBucket: "agitator-notebook.firebasestorage.app",
            messagingSenderId: "518555352011",
            appId: "1:518555352011:web:2b11ffed6d85918a202e86"
        };
        // -----------------------------------------------------------

        let firebaseApp, db;
        let isAdmin = false;
        let userTelegramId = null;
        let dataCache = []; // Локальный кэш данных
        let mapInstance = null;
        let currentMapType = 'marker'; // 'marker' или 'heat'

        const COLLECTION_NAME = "agitator_data";
        const ADMIN_COLLECTION_NAME = "admin_users"; // 🔥 НОВАЯ КОЛЛЕКЦИЯ ДЛЯ АДМИНОВ
        const isTMA = typeof Telegram !== 'undefined' && Telegram.WebApp;
        const OFFLINE_STORAGE_KEY = 'offline_reports';
        const SETTLEMENTS = [
            'Город 1', 'Город 2', 'Город 3', 'Деревня А', 'Поселок Б'
        ]; // Ваш список населенных пунктов

        // --- ИНИЦИАЛИЗАЦИЯ FIREBASE ---
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebaseApp.firestore();
            db.settings({
                 // Временно отключаем кэширование, если нужно для отладки
                 // cache: 'disabled'
            });
        } catch (e) {
            console.error("Ошибка инициализации Firebase:", e);
        }

        // --- ГЛОБАЛЬНЫЕ ФУНКЦИИ И УТИЛИТЫ ---

        function showAlert(title, message, type = 'info', duration = 5000) {
            const alertBox = document.getElementById('custom-alert');
            alertBox.innerHTML = `<strong>${title}:</strong> ${message}`;
            alertBox.className = `custom-alert bg-${type === 'error' ? 'red' : type === 'success' ? 'green' : 'indigo'}-500 text-white`;
            alertBox.classList.remove('hidden');

            setTimeout(() => {
                alertBox.classList.add('hidden');
            }, duration);
        }

        function showSection(id) {
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`${id}-section`).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-button[onclick="showSection('${id}')"]`)?.classList.add('active');
            
            // Если переходим на карту, убедимся, что она отрисована
            if (id === 'map' && isAdmin) {
                generateMap(currentMapType);
            }
        }

        function populateSettlements() {
            const select = document.getElementById('settlement');
            select.innerHTML = ''; // Очищаем
            SETTLEMENTS.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                select.appendChild(option);
            });
            // Устанавливаем значение по умолчанию, если оно есть
            if (SETTLEMENTS.length > 0) {
                select.value = SETTLEMENTS[0];
            }
        }

        // --- АВТОРИЗАЦИЯ И ПРОВЕРКА АДМИНА (КЛЮЧЕВОЙ МОМЕНТ) ---

        /**
         * 🔥 НОВЫЙ МЕХАНИЗМ: Проверяет статус администратора по ID в коллекции Firestore.
         * Пользователь должен вручную создать документ в коллекции 'admin_users' с его Telegram ID.
         */
        async function checkFirestoreAdminStatus(uid) {
            if (!db || !uid) return false;
            try {
                // Преобразуем ID в строку, т.к. в Firestore ID документа - строка
                const adminDocRef = db.collection(ADMIN_COLLECTION_NAME).doc(String(uid));
                const adminDoc = await adminDocRef.get();
                
                if (adminDoc.exists) {
                    console.log(`Firestore: Пользователь ${uid} найден в коллекции админов.`);
                }
                
                return adminDoc.exists;
            } catch (e) {
                console.error("Ошибка проверки статуса администратора в Firestore:", e);
                return false;
            }
        }

        /**
         * Инициализация пользователя и проверка статуса администратора.
         */
        async function authenticateUser() {
            // 1. Попытка получить ID из Telegram WebApp
            if (isTMA && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                userTelegramId = Telegram.WebApp.initDataUnsafe.user.id;
            } else {
                // Если не в TMA (для отладки в браузере), можно установить заглушку.
                // В РЕАЛЬНОМ ПРОИЗВОДСТВЕ ЭТО НУЖНО УДАЛИТЬ!
                // userTelegramId = 541459471; // <-- Вставьте ваш Telegram ID для локального тестирования
            }

            // 2. Проверка статуса администратора
            if (userTelegramId) {
                // 🔥 КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: Проверка через Firestore
                const isFirestoreAdmin = await checkFirestoreAdminStatus(userTelegramId);
                isAdmin = isFirestoreAdmin;
            } else {
                 console.warn("Не удалось получить userTelegramId.");
            }

            // 3. Обновление интерфейса
            document.getElementById('debugUserId').textContent = userTelegramId || 'Нет ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? 'ДА' : 'НЕТ';

            if (isAdmin) {
                document.getElementById('reports-tab').classList.remove('hidden');
                document.getElementById('map-tab').classList.remove('hidden');
                // Загружаем данные сразу для админа
                await fetchAndRenderReports(); 
                showAlert('Успешно!', 'Вы вошли как Администратор.', 'success');
            }
        }

        // --- ОФФЛАЙН/ОНЛАЙН СИНХРОНИЗАЦИЯ ---

        function getOfflineData() {
            try {
                const data = localStorage.getItem(OFFLINE_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Ошибка чтения локального хранилища:", e);
                return [];
            }
        }

        function saveOfflineData(data) {
            try {
                localStorage.setItem(OFFLINE_STORAGE_KEY, JSON.stringify(data));
                updateOfflineStatus();
            } catch (e) {
                console.error("Ошибка записи в локальное хранилище:", e);
            }
        }

        function updateOfflineStatus() {
            const offlineData = getOfflineData();
            const count = offlineData.length;
            document.getElementById('offline-count').textContent = count;
            const syncButton = document.getElementById('sync-button');

            if (count > 0) {
                syncButton.classList.remove('hidden');
                syncButton.textContent = `Синхронизировать (${count})`;
            } else {
                syncButton.classList.add('hidden');
            }
            document.getElementById('debugCacheStatus').textContent = count > 0 ? `ДА (${count})` : 'НЕТ';
            renderLatestData(offlineData);
        }

        function renderLatestData(data) {
            const container = document.getElementById('latest-data-container');
            container.innerHTML = '';
            
            if (data.length === 0) {
                 container.innerHTML = '<p class="text-sm text-gray-500">Нет данных, сохраненных в браузере.</p>';
                 return;
            }

            // Показываем только последние 5 записей
            data.slice(-5).reverse().forEach((doc, index) => {
                const item = document.createElement('div');
                item.className = 'bg-indigo-50 p-3 rounded-lg border border-indigo-200 shadow-sm';
                item.innerHTML = `
                    <p class="text-sm font-semibold">${doc.settlement}, ${doc.street}, ${doc.house}${doc.apartment ? ', кв. ' + doc.apartment : ''}</p>
                    <p class="text-xs text-gray-600">Лояльность: <span class="font-medium">${doc.loyalty}</span> | Действие: <span class="font-medium">${doc.action}</span></p>
                    ${doc.requires_followup ? '<p class="text-xs text-red-500 font-semibold flex items-center mt-1"><i data-lucide="bell" class="w-3 h-3 mr-1"></i>Требуется повтор</p>' : ''}
                    <p class="text-xs text-gray-500 mt-1">Отправлено: ${new Date(doc.timestamp).toLocaleTimeString()}</p>
                `;
                container.appendChild(item);
            });
            lucide.createIcons(); // Перерисовать иконки
        }

        // Обработка отправки формы
        document.getElementById('data-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userTelegramId) {
                showAlert('Ошибка', 'Не удалось определить ваш ID Telegram. Попробуйте перезапустить приложение в Telegram.', 'error');
                return;
            }

            const form = e.target;
            const data = {
                user_id: userTelegramId,
                full_name: form.fullName.value || 'N/A', // Добавлено ФИО
                settlement: form.settlement.value,
                street: form.street.value.trim(),
                house: form.house.value.trim(),
                apartment: form.apartment.value.trim(),
                loyalty: form.loyalty.value,
                action: form.action.value,
                comment: form.comment.value.trim(),
                requires_followup: form.requiresFollowup.checked,
                timestamp: Date.now(),
                location: {
                    latitude: form.latitude.value,
                    longitude: form.longitude.value
                }
            };

            const isOnline = navigator.onLine && db;

            if (isOnline) {
                await uploadData(data);
            } else {
                saveOfflineData([...getOfflineData(), data]);
                showAlert('Оффлайн', 'Данные сохранены локально. Синхронизация произойдет позже.', 'info');
            }

            form.reset(); // Очищаем форму
            populateSettlements(); // Восстанавливаем список
            document.getElementById('location-display').textContent = 'Координаты: Не определены';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
        });

        async function uploadData(data) {
             if (!db) {
                 showAlert('Ошибка', 'Firebase не инициализирован.', 'error');
                 return false;
             }
             if (isTMA) Telegram.WebApp.MainButton.showLoader();

             try {
                 await db.collection(COLLECTION_NAME).add(data);
                 showAlert('Успешно', 'Данные отправлены на сервер.', 'success');
                 return true;
             } catch (e) {
                 console.error("Ошибка при отправке данных:", e);
                 showAlert('Ошибка', 'Не удалось отправить данные на сервер. Сохраняю локально.', 'error');
                 saveOfflineData([...getOfflineData(), data]); // Сохраняем локально, если онлайн-отправка не удалась
                 return false;
             } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideLoader();
             }
        }

        async function syncData(showProgress = false) {
            const offlineData = getOfflineData();
            if (offlineData.length === 0) {
                 showAlert('Успешно', 'Локальных данных для синхронизации нет.', 'info');
                 return;
            }

            if (!db) {
                 showAlert('Ошибка', 'Firebase не инициализирован. Невозможно синхронизировать.', 'error');
                 return;
            }

            if (isTMA && showProgress) Telegram.WebApp.MainButton.showProgress();

            const successfullySynced = [];
            const failedToSync = [];

            for (const data of offlineData) {
                const success = await uploadData(data);
                if (success) {
                    successfullySynced.push(data);
                } else {
                    failedToSync.push(data);
                }
            }

            // Обновляем локальный кэш, оставляя только неудавшиеся
            saveOfflineData(failedToSync);
            
            if (isTMA && showProgress) Telegram.WebApp.MainButton.hideProgress();

            if (successfullySynced.length > 0) {
                 showAlert('Синхронизация', `Успешно отправлено ${successfullySynced.length} записей.`, 'success');
            }
            if (failedToSync.length > 0) {
                 showAlert('Внимание', `Не удалось отправить ${failedToSync.length} записей. Они остались в кэше.`, 'error');
            }

            // Если администратор, обновляем отчеты
            if (isAdmin) fetchAndRenderReports();
        }


        // --- ОТЧЕТЫ И АНАЛИТИКА (ТОЛЬКО ДЛЯ АДМИНА) ---

        async function fetchAndRenderReports() {
            if (!isAdmin || !db) return;

            document.getElementById('reports-status').textContent = 'Загрузка данных...';

            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            try {
                const snapshot = await db.collection(COLLECTION_NAME).get();
                dataCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderReportsTable(dataCache);
                renderCharts(dataCache);
                renderSummary(dataCache);
                generateMap(currentMapType, dataCache);
                
                document.getElementById('reports-status').textContent = `Загружено ${dataCache.length} записей.`;

            } catch (e) {
                console.error("Ошибка загрузки отчетов:", e);
                document.getElementById('reports-status').textContent = 'Ошибка загрузки данных.';
                showAlert('Ошибка', 'Не удалось загрузить отчеты из Firebase.', 'error');
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        }

        function renderReportsTable(data) {
            const tbody = document.getElementById('reports-table').querySelector('tbody');
            tbody.innerHTML = '';

            data.sort((a, b) => b.timestamp - a.timestamp); // Сортировка по времени (новые сверху)

            data.forEach(doc => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-100 transition';
                tr.innerHTML = `
                    <td class="whitespace-nowrap text-xs">${new Date(doc.timestamp).toLocaleString()}</td>
                    <td class="text-xs">${doc.user_id}</td>
                    <td class="text-xs font-medium">${doc.full_name || doc.user_id}</td>
                    <td class="text-xs">${doc.settlement}</td>
                    <td class="text-xs">${doc.street}, ${doc.house}${doc.apartment ? `/${doc.apartment}` : ''}</td>
                    <td class="text-xs">${doc.action}</td>
                    <td class="text-xs font-semibold">${doc.loyalty}</td>
                    <td class="text-xs text-${doc.requires_followup ? 'red' : 'green'}-600">${doc.requires_followup ? 'ДА' : 'НЕТ'}</td>
                    <td class="text-xs max-w-xs truncate">${doc.comment}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderSummary(data) {
            const summaryContainer = document.getElementById('report-summary');
            summaryContainer.innerHTML = '';
            
            const total = data.length;
            const loyaltyCounts = data.reduce((acc, doc) => {
                acc[doc.loyalty] = (acc[doc.loyalty] || 0) + 1;
                return acc;
            }, {});
            const followupCount = data.filter(doc => doc.requires_followup).length;

            const summaries = [
                { title: 'Всего Контактов', value: total, icon: 'users', color: 'indigo' },
                { title: 'Высокая Лояльность', value: loyaltyCounts['Высокая'] || 0, icon: 'trending-up', color: 'green' },
                { title: 'Низкая Лояльность', value: loyaltyCounts['Низкая'] || 0, icon: 'trending-down', color: 'red' },
                { title: 'Требуется Повтор', value: followupCount, icon: 'bell', color: 'orange' },
            ];

            summaries.forEach(s => {
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-xl shadow-lg border-l-4 border-${s.color}-500`;
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-500">${s.title}</p>
                        <i data-lucide="${s.icon}" class="w-5 h-5 text-${s.color}-500"></i>
                    </div>
                    <p class="text-2xl font-bold text-gray-900 mt-1">${s.value}</p>
                `;
                summaryContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        let loyaltyChartInstance, actionChartInstance;

        function renderCharts(data) {
            const loyaltyCtx = document.getElementById('loyaltyChart').getContext('2d');
            const actionCtx = document.getElementById('actionChart').getContext('2d');

            if (loyaltyChartInstance) loyaltyChartInstance.destroy();
            if (actionChartInstance) actionChartInstance.destroy();

            // Данные для графика лояльности
            const loyaltyData = data.reduce((acc, doc) => {
                acc[doc.loyalty] = (acc[doc.loyalty] || 0) + 1;
                return acc;
            }, {});
            const loyaltyLabels = ['Высокая', 'Средняя', 'Низкая'];
            const loyaltyCounts = loyaltyLabels.map(label => loyaltyData[label] || 0);
            const loyaltyColors = ['#10b981', '#fbbf24', '#ef4444']; // green, yellow, red

            // Данные для графика действий
            const actionData = data.reduce((acc, doc) => {
                acc[doc.action] = (acc[doc.action] || 0) + 1;
                return acc;
            }, {});
            const actionLabels = Object.keys(actionData);
            const actionCounts = Object.values(actionData);
            
            const chartOptions = {
                responsive: true,
                plugins: {
                    legend: { position: 'right' },
                    title: { display: false }
                }
            };

            loyaltyChartInstance = new Chart(loyaltyCtx, {
                type: 'doughnut',
                data: { labels: loyaltyLabels, datasets: [{ data: loyaltyCounts, backgroundColor: loyaltyColors, borderColor: '#ffffff', borderWidth: 1 }] },
                options: chartOptions
            });

            actionChartInstance = new Chart(actionCtx, {
                type: 'bar',
                data: { labels: actionLabels, datasets: [{ label: 'Количество', data: actionCounts, backgroundColor: '#6366f1', borderColor: '#ffffff', borderWidth: 1 }] },
                options: { ...chartOptions, scales: { y: { beginAtZero: true } } }
            });
        }

        function exportToXLSX() {
            if (dataCache.length === 0) {
                showAlert('Ошибка', 'Нет данных для экспорта. Пожалуйста, обновите отчеты.', 'error');
                return;
            }
            const exportData = dataCache.map(doc => ({
                'Время': new Date(doc.timestamp).toLocaleString(), 
                'ID Пользователя': doc.user_id, 
                'Агитатор (ФИО)': doc.full_name || 'N/A',
                'Населенный пункт': doc.settlement, 
                'Улица': doc.street, 
                'Дом': doc.house, 
                'Квартира': doc.apartment, 
                'Действие': doc.action,
                'Лояльность': doc.loyalty, 
                'Требуется Повтор': doc.requires_followup ? 'ДА' : 'НЕТ', 
                'Комментарий': doc.comment,
                'Широта': doc.location ? doc.location.latitude : 'N/A', 
                'Долгота': doc.location ? doc.location.longitude : 'N/A',
            }));
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Данные");
            XLSX.writeFile(workbook, "agitator_data_" + new Date().toISOString().slice(0, 10) + ".xlsx");
        }

        // --- ГЕОЛОКАЦИЯ ---

        function getLocation() {
            if (navigator.geolocation) {
                const display = document.getElementById('location-display');
                display.textContent = 'Определение координат...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lon = position.coords.longitude.toFixed(6);
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lon;
                        display.textContent = `Координаты: ${lat}, ${lon}`;
                        showAlert('Успешно', 'Координаты определены.', 'success', 2000);
                    },
                    (error) => {
                        console.error("Ошибка геолокации:", error);
                        display.textContent = 'Координаты: Ошибка определения.';
                        showAlert('Ошибка', 'Не удалось определить геолокацию.', 'error', 3000);
                        document.getElementById('latitude').value = '';
                        document.getElementById('longitude').value = '';
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showAlert('Ошибка', 'Ваш браузер не поддерживает геолокацию.', 'error');
            }
        }

        function generateMap(type = 'marker', data = dataCache) {
            if (!isAdmin) return;

            const mapDiv = document.getElementById('mapContainer');
            if (!mapDiv.offsetParent) return; // Не отрисовываем, если секция скрыта

            const coordinates = data
                .filter(doc => doc.location && doc.location.latitude && doc.location.longitude)
                .map(doc => ({
                    lat: parseFloat(doc.location.latitude), 
                    lon: parseFloat(doc.location.longitude), 
                    doc: doc 
                }));

            if (coordinates.length === 0) {
                mapDiv.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">Нет данных о геолокации для отображения.</div>';
                return;
            }

            // Инициализация или переиспользование карты
            if (mapInstance) {
                mapInstance.off();
                mapInstance.remove();
            }
            
            const centerLat = coordinates.reduce((sum, c) => sum + c.lat, 0) / coordinates.length;
            const centerLon = coordinates.reduce((sum, c) => sum + c.lon, 0) / coordinates.length;
            
            mapInstance = L.map('mapContainer').setView([centerLat, centerLon], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18,
            }).addTo(mapInstance);

            currentMapType = type;
            document.getElementById('marker-btn').className = `py-2 px-4 rounded-lg text-sm transition ${type === 'marker' ? 'bg-indigo-500 text-white' : 'bg-gray-300 text-gray-700'}`;
            document.getElementById('heat-btn').className = `py-2 px-4 rounded-lg text-sm transition ${type === 'heat' ? 'bg-indigo-500 text-white' : 'bg-gray-300 text-gray-700'}`;


            if (type === 'marker') {
                const markerCluster = L.markerClusterGroup();
                coordinates.forEach(coord => {
                    const popupContent = `
                        <strong class="text-indigo-600">${coord.doc.settlement}, ${coord.doc.street}, ${coord.doc.house}</strong><br>
                        Лояльность: <b>${coord.doc.loyalty}</b><br>
                        Действие: ${coord.doc.action}<br>
                        Комментарий: ${coord.doc.comment.substring(0, 50)}...<br>
                        Агитатор: ${coord.doc.full_name || coord.doc.user_id}<br>
                        Время: ${new Date(coord.doc.timestamp).toLocaleString()}
                    `;
                    const marker = L.marker([coord.lat, coord.lon]).bindPopup(popupContent);
                    markerCluster.addLayer(marker);
                });
                mapInstance.addLayer(markerCluster);
            } else if (type === 'heat') {
                const heatPoints = coordinates.map(coord => [coord.lat, coord.lon, 0.5]); // 0.5 - вес
                L.heatLayer(heatPoints, { radius: 25 }).addTo(mapInstance);
            }
        }

        function toggleMapType(type) {
             generateMap(type, dataCache);
        }

        // --- УДАЛЕНИЕ БАЗЫ ДАННЫХ (ТОЛЬКО ДЛЯ АДМИНА) ---
        
        function confirmClearDatabase() {
            if (!isAdmin) {
                showAlert('Ошибка', 'У вас нет прав администратора для этого действия.', 'error');
                return;
            }
            document.getElementById('delete-confirm-input').value = '';
            document.getElementById('clear-db-button').disabled = true;
            document.getElementById('clear-db-button').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('confirm-modal').classList.add('flex');

            document.getElementById('delete-confirm-input').oninput = (e) => {
                const isMatch = e.target.value.trim().toUpperCase() === 'УДАЛИТЬ';
                document.getElementById('clear-db-button').disabled = !isMatch;
                if (isMatch) {
                    document.getElementById('clear-db-button').classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    document.getElementById('clear-db-button').classList.add('opacity-50', 'cursor-not-allowed');
                }
            };
        }

        function hideConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('confirm-modal').classList.remove('flex');
        }

        async function clearDatabase() {
            hideConfirmModal();
            if (!isAdmin || !db) {
                 showAlert('Ошибка', 'Нет прав или Firebase не готов.', 'error');
                 return;
            }

            const inputVal = document.getElementById('delete-confirm-input').value.trim().toUpperCase();
            if (inputVal !== 'УДАЛИТЬ') {
                 showAlert('Ошибка', 'Неверное подтверждение.', 'error');
                 return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            try {
                const collectionRef = db.collection(COLLECTION_NAME);
                const snapshot = await collectionRef.get();
                
                if (snapshot.docs.length === 0) {
                     showAlert('Успешно!', 'База данных уже пуста.', 'success');
                     return true;
                }

                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();

                // Очистка локального хранилища
                localStorage.removeItem(OFFLINE_STORAGE_KEY);
                dataCache = []; // Очищаем локальный кеш после удаления
                updateOfflineStatus();
                showAlert('Успешно!', `Удалено ${snapshot.docs.length} записей. Данные Firestore очищены.`);

                if (isAdmin) fetchAndRenderReports();

                return true;

            } catch (e) {
                 console.error("Error deleting collection:", e);
                 showAlert('Ошибка', 'Произошла ошибка при удалении коллекции: ' + e.message, 'error');
                 return false;
            } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        }

        // --- ИНИЦИАЛИЗАЦИЯ WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // 🔑 Инициализация при загрузке (Ожидаем authenticateUser) - ИСПРАВЛЕНО
        window.onload = async () => {
            // 1. Сначала аутентификация для установки isAdmin и userTelegramId
            await authenticateUser(); // 👈 КРИТИЧЕСКОЕ ИЗМЕНЕНИЕ: ЖДЕМ ПРОВЕРКИ АДМИНА

            // 2. Затем заполнение интерфейса
            populateSettlements();
            updateOfflineStatus();
            window.showSection('form');
            lucide.createIcons();

            // ОТЛАДКА: Повторное обновление полей, чтобы гарантировать актуальность
            document.getElementById('debugUserId').textContent = userTelegramId || 'Нет ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? 'ДА' : 'НЕТ';

            if (!firebaseConfig.projectId) {
                window.showAlert('ВНИМАНИЕ', 'Необходимо вставить ключи конфигурации Firebase в код.', 'error');
            }
        };

        // Экспортируем функции для доступа из HTML
        window.showSection = showSection;
        window.authenticateUser = authenticateUser;
        window.fetchAndRenderReports = fetchAndRenderReports;
        window.renderLatestData = renderLatestData;
        window.generateMap = generateMap;
        window.toggleMapType = toggleMapType;
        window.getLocation = getLocation;
        window.syncData = syncData;
        window.exportToXLSX = exportToXLSX;
        window.confirmClearDatabase = confirmClearDatabase;
        window.clearDatabase = clearDatabase;
        window.hideConfirmModal = hideConfirmModal;
    </script>
</body>
</html>
