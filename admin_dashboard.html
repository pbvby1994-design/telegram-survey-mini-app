<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | v2.5 (PIN-–∫–æ–¥ Admin)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <!-- –ò–∫–æ–Ω–∫–∞ Loading -->
    <style>
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <style>
        :root {
            --primary: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg: #f3f4f6; /* gray-100 */
            --card-bg: #ffffff;
            --text-color: #1f2937; /* gray-900 */
        }
        body {
            font-family: 'Jost', sans-serif;
            background-color: var(--bg);
            color: var(--text-color);
            padding-bottom: 70px; /* –£—á–∏—Ç—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É nav-bar */
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        .btn-secondary {
            background-color: #9ca3af; /* gray-400 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #6b7280; /* gray-500 */
        }
        input[type="text"], input[type="number"], input[type="password"], textarea, select {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 8px;
            padding: 0.75rem;
            width: 100%;
            margin-top: 0.5rem;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border-top: 1px solid #e5e7eb;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #6b7280; /* gray-500 */
            font-size: 0.75rem;
            font-weight: 500;
            transition: color 0.2s;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
        }
        .nav-item.active {
            color: var(--primary-dark);
        }
        .nav-item:hover {
            color: var(--primary);
        }
        .alert-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            min-width: 300px;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>

<div class="container">
    <header class="text-center py-4 border-b border-gray-200 mb-4">
        <h1 class="text-2xl font-bold">–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞</h1>
    </header>

    <!-- –°–ï–ö–¶–ò–Ø 1: –§–û–†–ú–ê –í–í–û–î–ê –î–ê–ù–ù–´–• -->
    <section id="form" class="section">
        <h1 class="text-2xl font-bold mb-4">–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</h1>

        <!-- –§–æ—Ä–º–∞ -->
        <div id="data-form" class="card p-4 space-y-4">
            <h2 class="text-lg font-semibold border-b pb-2 mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–∑–∏—Ç–µ</h2>

            <!-- –§–ò–û –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ (–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ) -->
            <div>
                <label for="fullName" class="block text-sm font-medium text-gray-700">–§–ò–û –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞</label>
                <input type="text" id="fullName" class="bg-gray-100 cursor-not-allowed" readonly placeholder="–ó–∞–≥—Ä—É–∑–∫–∞...">
                <p class="text-xs text-gray-500 mt-1">–§–ò–û –±–µ—Ä–µ—Ç—Å—è –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è Telegram.</p>
            </div>

            <!-- –ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç -->
            <div>
                <label for="settlement" class="block text-sm font-medium text-gray-700">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç <span class="text-red-500">*</span></label>
                <select id="settlement" required>
                    <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã JS -->
                </select>
            </div>

            <!-- –£–ª–∏—Ü–∞ –∏ –î–æ–º -->
            <div class="flex space-x-4">
                <div class="flex-1">
                    <label for="street" class="block text-sm font-medium text-gray-700">–£–ª–∏—Ü–∞ <span class="text-red-500">*</span></label>
                    <input type="text" id="street" required>
                </div>
                <div class="w-1/4">
                    <label for="house" class="block text-sm font-medium text-gray-700">–î–æ–º <span class="text-red-500">*</span></label>
                    <input type="text" id="house" required>
                </div>
            </div>

            <!-- –ö–≤–∞—Ä—Ç–∏—Ä–∞ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
            <div>
                <label for="apartment" class="block text-sm font-medium text-gray-700">–ö–≤–∞—Ä—Ç–∏—Ä–∞ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" id="apartment">
            </div>

            <!-- –î–µ–π—Å—Ç–≤–∏–µ -->
            <div>
                <label for="action" class="block text-sm font-medium text-gray-700">–î–µ–π—Å—Ç–≤–∏–µ <span class="text-red-500">*</span></label>
                <select id="action" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</option>
                    <option value="–í–∏–∑–∏—Ç">–í–∏–∑–∏—Ç (–æ—Ç–∫—Ä—ã—Ç–∞ –¥–≤–µ—Ä—å)</option>
                    <option value="–ù–µ –æ—Ç–∫—Ä—ã–ª–∏">–ù–µ –æ—Ç–∫—Ä—ã–ª–∏</option>
                    <option value="–û—Ç–∫–∞–∑">–û—Ç–∫–∞–∑ –æ—Ç –æ–±—â–µ–Ω–∏—è</option>
                    <option value="–û—Ç–º–µ—Ç–∫–∞ –∞–¥—Ä–µ—Å–∞">–û—Ç–º–µ—Ç–∫–∞ –∞–¥—Ä–µ—Å–∞ (–ø—Ä–æ—Ö–æ–¥)</option>
                    <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>

            <!-- –õ–æ—è–ª—å–Ω–æ—Å—Ç—å (–¢–æ–ª—å–∫–æ –¥–ª—è "–í–∏–∑–∏—Ç") -->
            <div id="loyalty-group" class="hidden">
                <label for="loyalty" class="block text-sm font-medium text-gray-700">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å <span class="text-red-500">*</span></label>
                <select id="loyalty" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å</option>
                    <option value="–ó–ê">–ó–ê</option>
                    <option value="–ù–ï–ô–¢–†–ê–õ">–ù–ï–ô–¢–†–ê–õ</option>
                    <option value="–ü–†–û–¢–ò–í">–ü–†–û–¢–ò–í</option>
                </select>
            </div>

            <!-- –¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –í–∏–∑–∏—Ç -->
            <div class="flex items-center space-x-2">
                <input type="checkbox" id="requiresFollowup" class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary">
                <label for="requiresFollowup" class="text-sm font-medium text-gray-700">–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–∏–∑–∏—Ç</label>
            </div>

            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
            <div>
                <label for="comment" class="block text-sm font-medium text-gray-700">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="comment" rows="3" placeholder="–ó–∞–º–µ—Ç–∫–∏ –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ, –ø—Ä–∏—á–∏–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤–∏–∑–∏—Ç–∞ –∏ —Ç.–¥."></textarea>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è -->
            <button id="getLocationBtn" class="btn-secondary w-full flex items-center justify-center space-x-2" type="button">
                <i data-lucide="map-pin" class="w-4 h-4"></i>
                <span id="locationStatus">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</span>
            </button>
            <input type="hidden" id="latitude">
            <input type="hidden" id="longitude">

            <!-- –ö–Ω–æ–ø–∫–∞ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
            <button id="saveDataBtn" class="btn-primary w-full" type="button" disabled>
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            </button>

            <p id="saveStatus" class="text-center text-sm mt-2 hidden"></p>
        </div>
        <!-- –ö–æ–Ω–µ—Ü —Ñ–æ—Ä–º—ã -->

        <!-- –û–¢–õ–ê–î–ö–ê –ò –û–§–§–õ–ê–ô–ù -->
        <div class="card p-4 text-sm mt-4 text-gray-600">
            <h2 class="text-lg font-semibold border-b pb-2 mb-2">–°—Ç–∞—Ç—É—Å</h2>
            <p>–û–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å: <span id="onlineStatus" class="font-bold text-red-500">–û–§–§–õ–ê–ô–ù</span></p>
            <p>–ö—ç—à –æ—Ñ—Ñ–ª–∞–π–Ω-–∑–∞–ø–∏—Å–µ–π: <span id="offlineCount" class="font-bold">0</span></p>
            <p>ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <span id="debugUserId" class="font-mono">...</span></p>
            <p>–°—Ç–∞—Ç—É—Å –ê–¥–º–∏–Ω–∞: <span id="debugAdminStatus" class="font-mono text-red-500">–ù–ï–¢</span></p>
            <button id="syncDataBtn" class="btn-secondary w-full mt-2 hidden" type="button">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
    </section>

    <!-- –°–ï–ö–¶–ò–Ø 2: –°–ü–ò–°–û–ö –ê–î–†–ï–°–û–í (Walklist) -->
    <section id="walklist" class="section hidden">
        <h1 class="text-2xl font-bold mb-4">–°–ø–∏—Å–æ–∫ –û–±—Ö–æ–¥–∞</h1>

        <div class="card p-4">
            <p class="text-sm text-gray-600 mb-3">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–∞—à —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –æ–±—Ö–æ–¥–∞ (—Å–ø–∏—Å–æ–∫ –±–µ—Ä–µ—Ç—Å—è –∏–∑ Firestore, –∫–æ–ª–ª–µ–∫—Ü–∏—è `walklists`).</p>
            <div id="walklist-filter" class="mb-3">
                <label for="walklist-settlement" class="block text-sm font-medium text-gray-700">–§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞—Å. –ø—É–Ω–∫—Ç—É</label>
                <select id="walklist-settlement">
                    <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã JS -->
                </select>
            </div>
            <div id="walklist-container" class="space-y-3">
                <p class="text-gray-500 text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥—Ä–µ—Å–æ–≤...</p>
            </div>
        </div>
    </section>

    <!-- –°–ï–ö–¶–ò–Ø 3: –û–¢–ß–ï–¢–´ (–¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–ê) -->
    <section id="reports" class="section hidden">
        <h1 class="text-2xl font-bold mb-4">–û—Ç—á–µ—Ç—ã</h1>

        <!-- –§–û–†–ú–ê –í–•–û–î–ê –ü–û PIN-–ö–û–î–£ –î–õ–Ø –û–¢–ß–ï–¢–û–í -->
        <div id="pin-login-reports" class="card p-4 text-center" style="max-width: 320px; margin: 0 auto;">
            <h2 class="text-lg font-semibold mb-3 text-red-600">üîê –¢—Ä–µ–±—É–µ—Ç—Å—è PIN-–∫–æ–¥</h2>
            <p class="text-sm text-gray-600 mb-4">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –æ—Ç—á–µ—Ç–∞–º –≤–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥.</p>
            <input type="password" id="reportsPinInput" class="w-full text-center text-xl font-mono tracking-widest" maxlength="8" placeholder="****" required>
            <button onclick="checkAdminPIN()" class="btn-primary w-full mt-4">–í–æ–π—Ç–∏</button>
            <p id="pin-error-reports" class="text-xs text-red-500 mt-2 hidden">–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥.</p>
        </div>
        <!-- –ö–û–ù–ï–¶ –§–û–†–ú–´ -->

        <div id="admin-reports-content" class="hidden">
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">–û–±–∑–æ—Ä –î–∞–Ω–Ω—ã—Ö</h2>

                <!-- –§–∏–ª—å—Ç—Ä—ã -->
                <div class="space-y-3 mb-4">
                    <div>
                        <label for="reportSettlement" class="block text-sm font-medium text-gray-700">–§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞—Å. –ø—É–Ω–∫—Ç—É</label>
                        <select id="reportSettlement" onchange="fetchAndRenderReports()">
                            <option value="–í—Å–µ">–í—Å–µ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã</option>
                        </select>
                    </div>
                    <div>
                        <label for="reportPeriod" class="block text-sm font-medium text-gray-700">–ü–µ—Ä–∏–æ–¥</label>
                        <select id="reportPeriod" onchange="fetchAndRenderReports()">
                            <option value="3">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è</option>
                            <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                            <option value="30">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                            <option value="all">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</option>
                        </select>
                    </div>
                </div>

                <div id="report-summary" class="grid grid-cols-2 gap-3 text-center mb-4">
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-xs text-gray-500">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p>
                        <p id="totalRecords" class="text-xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                        <p class="text-xs text-gray-500">–£–Ω–∏–∫. –ê–≥–∏—Ç–∞—Ç–æ—Ä–æ–≤</p>
                        <p id="uniqueUsers" class="text-xl font-bold text-green-600">0</p>
                    </div>
                </div>

                <h3 class="text-md font-semibold mt-4 mb-2">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</h3>
                <canvas id="loyaltyChart"></canvas>

                <h3 class="text-md font-semibold mt-4 mb-2">–î–µ–π—Å—Ç–≤–∏—è</h3>
                <canvas id="actionChart"></canvas>

                <h3 class="text-md font-semibold mt-4 mb-2">–ì–µ–æ-–∫–∞—Ä—Ç–∞ (–¢–µ–ø–ª–æ–≤–∞—è)</h3>
                <div id="map"></div>

                <div class="mt-4 flex space-x-2">
                    <button onclick="exportToXLSX()" class="btn-secondary flex-1">
                        <i data-lucide="file-text" class="w-4 h-4 inline-block mr-1"></i>
                        –≠–∫—Å–ø–æ—Ä—Ç –≤ XLSX
                    </button>
                </div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-2 border-b pb-2">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ó–∞–ø–∏—Å–µ–π</h2>
                <div id="latest-data-container" class="text-sm space-y-3">
                    <p class="text-gray-500 text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏...</p>
                </div>
                <button onclick="fetchAndRenderReports()" class="btn-secondary w-full mt-4">–û–±–Ω–æ–≤–∏—Ç—å –û—Ç—á–µ—Ç—ã</button>
            </div>
        </div>
    </section>


    <!-- –°–ï–ö–¶–ò–Ø 4: –ê–î–ú–ò–ù–ò–°–¢–†–ò–†–û–í–ê–ù–ò–ï (–¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–ê) -->
    <section id="admin" class="section hidden">
        <h1 class="text-2xl font-bold mb-4">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>

        <!-- –§–û–†–ú–ê –í–•–û–î–ê –ü–û PIN-–ö–û–î–£ –î–õ–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ò–†–û–í–ê–ù–ò–Ø -->
        <div id="pin-login-admin" class="card p-4 text-center" style="max-width: 320px; margin: 0 auto;">
            <h2 class="text-lg font-semibold mb-3 text-red-600">üîê –¢—Ä–µ–±—É–µ—Ç—Å—è PIN-–∫–æ–¥</h2>
            <p class="text-sm text-gray-600 mb-4">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –≤–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥.</p>
            <input type="password" id="adminPinInput" class="w-full text-center text-xl font-mono tracking-widest" maxlength="8" placeholder="****" required>
            <button onclick="checkAdminPIN()" class="btn-primary w-full mt-4">–í–æ–π—Ç–∏</button>
            <p id="pin-error-admin" class="text-xs text-red-500 mt-2 hidden">–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥.</p>
        </div>
        <!-- –ö–û–ù–ï–¶ –§–û–†–ú–´ -->

        <div id="admin-panel-content" class="hidden">
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–ò–º–∏—Ç–∞—Ü–∏—è)</h2>
                <p class="text-sm text-gray-600 mb-3">–í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ MiniApp —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–±–∞–Ω/—Ä–∞–∑–±–∞–Ω) –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/admin_ban` –≤ –±–æ—Ç–µ. –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª ‚Äî –∑–∞–≥–ª—É—à–∫–∞.</p>
                <button class="btn-secondary w-full cursor-not-allowed">–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ß–µ—Ä–µ–∑ –±–æ—Ç–∞)</button>
            </div>

            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-2 text-red-600">–û–ø–∞—Å–Ω–∞—è –ó–æ–Ω–∞</h2>
                <p class="text-sm text-gray-600 mb-3">–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ **–±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ–º—É —É–¥–∞–ª–µ–Ω–∏—é –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π** (–∫—Ä–æ–º–µ —Ñ–æ—Ç–æ) –∏–∑ Firestore. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Å–¥–µ–ª–∞–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç.</p>
                <button id="clearDataBtn" class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-lg w-full font-semibold" onclick="promptClearDatabase()">
                    <i data-lucide="alert-triangle" class="w-4 h-4 inline-block mr-1"></i>
                    –û–ß–ò–°–¢–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï
                </button>
            </div>
        </div>
    </section>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (Alert/Prompt) -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 justify-center items-center">
        <div id="alert-modal" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-3">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
            <p id="modal-message" class="text-gray-700 mb-4">–°–æ–æ–±—â–µ–Ω–∏–µ</p>
            <div id="modal-buttons" class="flex justify-end space-x-2">
                <!-- –ö–Ω–æ–ø–∫–∏ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è JS -->
            </div>
        </div>
    </div>

</div>

<!-- –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ -->
<div class="nav-bar">
    <a class="nav-item active" onclick="showSection('form')">
        <i data-lucide="clipboard-list" class="w-5 h-5"></i>
        <span>–§–æ—Ä–º–∞</span>
    </a>
    <a id="navWalklist" class="nav-item" onclick="showSection('walklist')">
        <i data-lucide="list-checks" class="w-5 h-5"></i>
        <span>–û–±—Ö–æ–¥</span>
    </a>
    <a id="navReports" class="nav-item hidden" onclick="showSection('reports')">
        <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
        <span>–û—Ç—á–µ—Ç—ã</span>
    </a>
    <a id="navAdmin" class="nav-item hidden" onclick="showSection('admin')">
        <i data-lucide="cog" class="w-5 h-5"></i>
        <span>–ê–¥–º–∏–Ω</span>
    </a>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í–°–¢–ê–í–ò–¢–¨ –°–Æ–î–ê –í–ê–®–ò –ö–õ–Æ–ß–ò) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDVeRXO16KtIwoJQb4uHQuCsEv3xTLBGhI",
        authDomain: "agitator-notebook.firebaseapp.com",
        projectId: "agitator-notebook",
        storageBucket: "agitator-notebook.firebasestorage.app",
        messagingSenderId: "518555352011",
        appId: "1:518555352011:web:2b1f0e4b86f8a25c156f70"
    };
</script>

<script type="module">
    // –ò–º–ø–æ—Ä—Ç –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
    // –ó–¥–µ—Å—å –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º—É—é –≤–µ—Ä—Å–∏—é Firebase (compat) –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
    // –∏ –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—ã—à–µ

    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
    let app, db;
    let userTelegramId = null;
    let userFullName = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    let isTMA = typeof Telegram !== 'undefined' && Telegram.WebApp;
    let dataCache = [];
    let mapInstance = null;
    let heatmapLayer = null;

    // --- –ê–î–ú–ò–ù –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
    const ADMIN_PIN = '19941994Ki)'; // üîë –í–ê–® PIN-–ö–û–î, –î–û–õ–ñ–ï–ù –°–û–í–ü–ê–î–ê–¢–¨ –° BOT_ADMIN_PASSWORD
    let isAdmin = localStorage.getItem('isAdminLoggedIn') === 'true'; // –°—Ç–∞—Ç—É—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é)


    // --- –°–ü–ò–°–ö–ò –î–ê–ù–ù–´–• ---
    const settlements = [
        '–≥. –ö–æ–Ω–æ—Ç–æ–ø',
        '—Å. –ë–æ—á–µ—á–∫–∏',
        '—Å. –ú–∞–ª—ã–π –°–∞–º–±–æ—Ä',
        '—Å. –î—É–±–æ–≤—å—è–∑–æ–≤–∫–∞',
        '–î—Ä—É–≥–æ–π'
    ];


    // --- –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ (ALERT/MODAL) ---

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (ALERT)
    function showAlert(title, message) {
        const backdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');

        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalButtons.innerHTML = `<button onclick="hideModal()" class="btn-primary">OK</button>`;

        backdrop.classList.remove('hidden');
        backdrop.classList.add('flex');
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º (PROMPT)
    function promptModal(title, message, callback) {
        const backdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');

        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalButtons.innerHTML = `
            <button onclick="hideModal()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="hideModal(); ${callback}" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg font-semibold">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        `;

        backdrop.classList.remove('hidden');
        backdrop.classList.add('flex');
    }

    // –°–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    function hideModal() {
        document.getElementById('modal-backdrop').classList.remove('flex');
        document.getElementById('modal-backdrop').classList.add('hidden');
    }

    // –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ –ë–î
    window.promptClearDatabase = function() {
        promptModal(
            '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ',
            '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ë–ï–ó–í–û–ó–í–†–ê–¢–ù–û —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ (–∫—Ä–æ–º–µ —Ñ–æ—Ç–æ) –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Firestore? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.',
            'clearDatabase()'
        );
    };


    // --- –§–£–ù–ö–¶–ò–ò –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê (PIN-–ö–û–î) ---

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ PIN-–∫–æ–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    window.checkAdminPIN = function() {
        const pinInputAdmin = document.getElementById('adminPinInput');
        const pinErrorAdmin = document.getElementById('pin-error-admin');

        const pinInputReports = document.getElementById('reportsPinInput');
        const pinErrorReports = document.getElementById('pin-error-reports');

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ—Ç–∫—É–¥–∞ –±—ã–ª –≤—ã–∑–≤–∞–Ω –≤—Ö–æ–¥
        const isReportsSection = document.getElementById('reportsPinInput') && document.getElementById('reportsPinInput').value.trim() === ADMIN_PIN;

        const pin = isReportsSection ? pinInputReports.value.trim() : pinInputAdmin.value.trim();
        const pinInput = isReportsSection ? pinInputReports : pinInputAdmin;
        const pinError = isReportsSection ? pinErrorReports : pinErrorAdmin;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É –¥–ª—è –æ–±–æ–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–≤–∏–¥–∏–º—ã, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –º–æ–≥—É—Ç –±—ã—Ç—å —Ü–µ–ª–µ–≤—ã–º–∏
        const pinLoginAdmin = document.getElementById('pin-login-admin');
        const adminContent = document.getElementById('admin-panel-content');
        const pinLoginReports = document.getElementById('pin-login-reports');
        const reportsContent = document.getElementById('admin-reports-content');


        if (pin === ADMIN_PIN) {
            isAdmin = true;
            localStorage.setItem('isAdminLoggedIn', 'true'); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é –≤ LocalStorage
            localStorage.setItem('lastPinAttempt', pin); // –°–æ—Ö—Ä–∞–Ω—è–µ–º PIN –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.getElementById('navReports').classList.remove('hidden');
            document.getElementById('navAdmin').classList.remove('hidden');

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–ª–∞–¥–∫–∏
            document.getElementById('debugAdminStatus').textContent = '–î–ê (PIN)';

            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
            if (pinLoginAdmin) pinLoginAdmin.classList.add('hidden');
            if (adminContent) adminContent.classList.remove('hidden');
            if (pinLoginReports) pinLoginReports.classList.add('hidden');
            if (reportsContent) reportsContent.classList.remove('hidden');

            if (pinError) pinError.classList.add('hidden');
            if (pinInput) pinInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ PIN

            // –ï—Å–ª–∏ –º—ã –≤ —Ä–∞–∑–¥–µ–ª–µ 'reports', –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö
            const currentSection = document.querySelector('.section:not(.hidden)').id;
            if (currentSection === 'reports') {
                fetchAndRenderReports();
            }

            showAlert('–£—Å–ø–µ—à–Ω–æ', '–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
            return true;
        } else {
            isAdmin = false;
            if (pinError) pinError.classList.remove('hidden');
            if (pinInput) pinInput.value = '';
            showAlert('–û—à–∏–±–∫–∞', '–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥.');
            return false;
        }
    }


    // --- –§–£–ù–ö–¶–ò–ò FIREBASE/CORE ---

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function authenticateUser() {
        try {
            if (!app) {
                app = firebase.initializeApp(firebaseConfig);
                db = app.firestore();
            }

            // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è Telegram User ID –∏ Full Name
            if (isTMA) {
                try {
                    const initData = Telegram.WebApp.initDataUnsafe;
                    if (initData.user) {
                        userTelegramId = String(initData.user.id);
                        userFullName = initData.user.first_name || '–ê–Ω–æ–Ω–∏–º';
                        if (initData.user.last_name) userFullName += ' ' + initData.user.last_name;
                        if (initData.user.username) userFullName += ` (@${initData.user.username})`;
                    } else if (initData.auth_date) {
                        // –ï—Å–ª–∏ –Ω–µ—Ç user, –Ω–æ –µ—Å—Ç—å auth_date - —ç—Ç–æ MiniApp. –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É ID.
                        userTelegramId = 'TMA_GUEST_' + Date.now();
                        userFullName = 'TMA –ì–æ—Å—Ç—å';
                    }
                } catch (e) {
                    // –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ initData
                    userTelegramId = 'ERROR_TMA_ID_' + Date.now();
                    userFullName = '–û—à–∏–±–∫–∞ TMA';
                }
            } else {
                // –ï—Å–ª–∏ –Ω–µ TMA, –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∏–∑ localStorage
                userTelegramId = localStorage.getItem('guestId');
                if (!userTelegramId) {
                    userTelegramId = 'WEB_GUEST_' + crypto.randomUUID();
                    localStorage.setItem('guestId', userTelegramId);
                }
                userFullName = 'WEB –ì–æ—Å—Ç—å';
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ PIN –≤ localStorage
            isAdmin = localStorage.getItem('isAdminLoggedIn') === 'true';

            // –ï—Å–ª–∏ –∞–¥–º–∏–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            if (isAdmin) {
                document.getElementById('navReports').classList.remove('hidden');
                document.getElementById('navAdmin').classList.remove('hidden');
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
            document.getElementById('fullName').value = userFullName;

        } catch (e) {
            console.error("Firebase/Auth Error:", e);
            showAlert('–û—à–∏–±–∫–∞ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Firebase: ' + e.message);
        }
    }


    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Firestore –∏–ª–∏ LocalStorage
    async function saveData() {
        if (!userTelegramId) {
            showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
            return;
        }

        const data = {
            user_id: userTelegramId,
            full_name: userFullName,
            timestamp: new Date().getTime(),
            settlement: document.getElementById('settlement').value,
            street: document.getElementById('street').value.trim(),
            house: document.getElementById('house').value.trim(),
            apartment: document.getElementById('apartment').value.trim() || null,
            action: document.getElementById('action').value,
            loyalty: document.getElementById('loyalty').value || null,
            requires_followup: document.getElementById('requiresFollowup').checked,
            comment: document.getElementById('comment').value.trim() || null,
            location: {
                latitude: parseFloat(document.getElementById('latitude').value) || null,
                longitude: parseFloat(document.getElementById('longitude').value) || null,
            }
        };

        if (!data.settlement || !data.street || !data.house || !data.action ||
            (data.action === '–í–∏–∑–∏—Ç' && !data.loyalty)) {
            showAlert('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (*).');
            return;
        }

        const saveStatusEl = document.getElementById('saveStatus');
        saveStatusEl.classList.remove('hidden', 'text-green-500', 'text-red-500');
        saveStatusEl.classList.add('text-blue-500');
        saveStatusEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        document.getElementById('saveDataBtn').disabled = true;


        // 1. –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firestore
        if (navigator.onLine) {
            try {
                const docRef = await db.collection('surveys').add(data);
                saveStatusEl.textContent = `–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –æ–Ω–ª–∞–π–Ω. ID: ${docRef.id}`;
                saveStatusEl.classList.replace('text-blue-500', 'text-green-500');

                // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                clearForm();
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ Mini App, –µ—Å–ª–∏ –≤ TMA
                if (isTMA) {
                    Telegram.WebApp.close();
                }

            } catch (e) {
                console.error("Error writing document to Firestore:", e);
                saveStatusEl.textContent = '–û—à–∏–±–∫–∞ –æ–Ω–ª–∞–π–Ω. –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∫—ç—à.';
                saveStatusEl.classList.replace('text-blue-500', 'text-red-500');
                saveToOfflineCache(data); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ—Ñ—Ñ–ª–∞–π–Ω
            }
        } else {
            // 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ LocalStorage (–û—Ñ—Ñ–ª–∞–π–Ω)
            saveStatusEl.textContent = '–û—Ñ—Ñ–ª–∞–π–Ω. –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∫—ç—à.';
            saveStatusEl.classList.replace('text-blue-500', 'text-red-500');
            saveToOfflineCache(data);
        }

        document.getElementById('saveDataBtn').disabled = false;
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => saveStatusEl.classList.add('hidden'), 5000);
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ—Ñ—Ñ–ª–∞–π–Ω-–∫—ç—à
    function saveToOfflineCache(data) {
        let cache = JSON.parse(localStorage.getItem('offlineCache') || '[]');
        cache.push(data);
        localStorage.setItem('offlineCache', JSON.stringify(cache));
        clearForm();
        updateOfflineStatus();
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ—Ñ—Ñ–ª–∞–π–Ω-–∫—ç—à–∞
    async function syncData() {
        if (!navigator.onLine) {
            showAlert('–û—à–∏–±–∫–∞', '–í—ã –Ω–µ –≤ —Å–µ—Ç–∏. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å.');
            return;
        }

        let cache = JSON.parse(localStorage.getItem('offlineCache') || '[]');
        if (cache.length === 0) {
            showAlert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–û—Ñ—Ñ–ª–∞–π–Ω-–∫—ç—à –ø—É—Å—Ç. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.');
            return;
        }

        if (isTMA) Telegram.WebApp.MainButton.showLoader();
        let successCount = 0;

        for (const data of cache) {
            try {
                await db.collection('surveys').add(data);
                successCount++;
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏:", data, e);
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–ø–∏—Å–∏ –≤ –∫—ç—à–µ
                showAlert('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', `–°–±–æ–π –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ${successCount + 1}-–π –∑–∞–ø–∏—Å–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.`);
                break;
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
        const remainingCache = cache.slice(successCount);
        localStorage.setItem('offlineCache', JSON.stringify(remainingCache));

        if (isTMA) Telegram.WebApp.MainButton.hideLoader();
        updateOfflineStatus();

        if (successCount > 0) {
            showAlert('–£—Å–ø–µ—à–Ω–æ', `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${successCount} –∑–∞–ø–∏—Å–µ–π.`);
        } else if (remainingCache.length === 0) {
             showAlert('–£—Å–ø–µ—à–Ω–æ', '–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!');
        }
    }


    // --- –í–´–ó–û–í–´ –ì–ï–û–õ–û–ö–ê–¶–ò–ò ---

    window.getLocation = function() {
        const locationStatus = document.getElementById('locationStatus');
        locationStatus.textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...';
        document.getElementById('getLocationBtn').disabled = true;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lon = position.coords.longitude.toFixed(6);
                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lon;
                    locationStatus.textContent = `–û–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: ${lat}, ${lon}`;
                    document.getElementById('getLocationBtn').disabled = false;
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    locationStatus.textContent = '–û—à–∏–±–∫–∞ –≥–µ–æ: ' + error.message;
                    document.getElementById('latitude').value = '';
                    document.getElementById('longitude').value = '';
                    document.getElementById('getLocationBtn').disabled = false;
                    showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        } else {
            locationStatus.textContent = '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.';
            document.getElementById('getLocationBtn').disabled = false;
            showAlert('–û—à–∏–±–∫–∞', '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.');
        }
    }
    document.getElementById('getLocationBtn').onclick = getLocation;


    // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤
    function populateSettlements() {
        const selectForm = document.getElementById('settlement');
        const selectWalklist = document.getElementById('walklist-settlement');
        const selectReport = document.getElementById('reportSettlement');

        selectForm.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å. –ø—É–Ω–∫—Ç</option>';
        selectWalklist.innerHTML = '<option value="–í—Å–µ">–í—Å–µ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã</option>';
        // reportSettlement —É–∂–µ –∏–º–µ–µ—Ç –æ–ø—Ü–∏—é '–í—Å–µ'

        settlements.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent = s;
            selectForm.appendChild(opt);

            const optW = opt.cloneNode(true);
            selectWalklist.appendChild(optW);

            const optR = opt.cloneNode(true);
            selectReport.appendChild(optR);
        });
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    function clearForm() {
        document.getElementById('settlement').value = '';
        document.getElementById('street').value = '';
        document.getElementById('house').value = '';
        document.getElementById('apartment').value = '';
        document.getElementById('action').value = '';
        document.getElementById('loyalty').value = '';
        document.getElementById('loyalty-group').classList.add('hidden');
        document.getElementById('requiresFollowup').checked = false;
        document.getElementById('comment').value = '';
        document.getElementById('latitude').value = '';
        document.getElementById('longitude').value = '';
        document.getElementById('locationStatus').textContent = '–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
        document.getElementById('saveDataBtn').disabled = true; // –°–Ω–æ–≤–∞ –æ—Ç–∫–ª—é—á–∞–µ–º
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ñ—Ñ–ª–∞–π–Ω-–∫—ç—à–∞
    function updateOfflineStatus() {
        const cache = JSON.parse(localStorage.getItem('offlineCache') || '[]');
        const count = cache.length;
        document.getElementById('offlineCount').textContent = count;
        const syncBtn = document.getElementById('syncDataBtn');

        if (count > 0 && navigator.onLine) {
            syncBtn.classList.remove('hidden');
        } else {
            syncBtn.classList.add('hidden');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞
        document.getElementById('onlineStatus').textContent = navigator.onLine ? '–û–ù–õ–ê–ô–ù' : '–û–§–§–õ–ê–ô–ù';
        document.getElementById('onlineStatus').classList.toggle('text-green-500', navigator.onLine);
        document.getElementById('onlineStatus').classList.toggle('text-red-500', !navigator.onLine);
    }
    window.addEventListener('online', updateOfflineStatus);
    window.addEventListener('offline', updateOfflineStatus);
    document.getElementById('syncDataBtn').onclick = syncData;


    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–ª—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
    document.getElementById('action').addEventListener('change', (e) => {
        const loyaltyGroup = document.getElementById('loyalty-group');
        const loyaltySelect = document.getElementById('loyalty');
        if (e.target.value === '–í–∏–∑–∏—Ç') {
            loyaltyGroup.classList.remove('hidden');
            loyaltySelect.required = true;
        } else {
            loyaltyGroup.classList.add('hidden');
            loyaltySelect.required = false;
            loyaltySelect.value = '';
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º—ã –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    document.querySelectorAll('#data-form input, #data-form select, #data-form textarea').forEach(el => {
        el.addEventListener('input', () => {
            const form = document.getElementById('data-form');
            const requiredElements = form.querySelectorAll('[required]');
            let isFormValid = true;

            requiredElements.forEach(reqEl => {
                if (!reqEl.value.trim()) {
                    isFormValid = false;
                }
            });

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ø–æ–ª—è "–õ–æ—è–ª—å–Ω–æ—Å—Ç—å"
            const action = document.getElementById('action').value;
            const loyalty = document.getElementById('loyalty').value;

            if (action === '–í–∏–∑–∏—Ç' && !loyalty) {
                isFormValid = false;
            }

            document.getElementById('saveDataBtn').disabled = !isFormValid;
        });
    });

    document.getElementById('saveDataBtn').onclick = saveData;


    // --- –§–£–ù–ö–¶–ò–ò –ù–ê–í–ò–ì–ê–¶–ò–ò ---

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–∏
    window.showSection = function(sectionId) {
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
        document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));

        // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        document.getElementById(sectionId).classList.remove('hidden');
        document.querySelector(`.nav-bar a[onclick*="${sectionId}"]`).classList.add('active');

        // –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ PIN-–∫–æ–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω-—Å–µ–∫—Ü–∏–π
        if (['reports', 'admin'].includes(sectionId)) {
            if (isAdmin) {
                // –ï—Å–ª–∏ –∞–¥–º–∏–Ω —É–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω (–ø–æ PIN), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                document.getElementById('pin-login-admin').classList.add('hidden');
                document.getElementById('admin-panel-content').classList.remove('hidden');
                document.getElementById('pin-login-reports').classList.add('hidden');
                document.getElementById('admin-reports-content').classList.remove('hidden');

                if (sectionId === 'reports') {
                    fetchAndRenderReports();
                }
            } else {
                // –ï—Å–ª–∏ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É PIN
                const pinSectionId = sectionId === 'admin' ? 'pin-login-admin' : 'pin-login-reports';
                const contentSectionId = sectionId === 'admin' ? 'admin-panel-content' : 'admin-reports-content';

                document.getElementById(pinSectionId).classList.remove('hidden');
                document.getElementById(contentSectionId).classList.add('hidden');

                // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PIN –∏–∑ localStorage –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
                const lastPin = localStorage.getItem('lastPinAttempt') || '';
                document.getElementById('adminPinInput').value = lastPin;
                document.getElementById('reportsPinInput').value = lastPin;

                document.getElementById('pin-error-admin').classList.add('hidden');
                document.getElementById('pin-error-reports').classList.add('hidden');

            }
        } else {
            // –î–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–µ–∫—Ü–∏–π
            if (sectionId === 'walklist') {
                fetchAssignedAddresses();
            }
        }
    }


    // --- –§–£–ù–ö–¶–ò–ò –†–ê–ó–î–ï–õ–ê "–°–ü–ò–°–û–ö –û–ë–•–û–î–ê" (Walklist) ---

    let walklistDataCache = [];

    async function fetchAssignedAddresses() {
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –∑–∞–≥–ª—É—à–∫—É, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥—Ä–µ—Å–æ–≤
        document.getElementById('walklist-container').innerHTML = '<p class="text-gray-500 text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥—Ä–µ—Å–æ–≤...</p>';

        try {
            // –ò–º–∏—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firestore (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—è walklists/{settlement}/addresses)
            const addresses = [
                { id: '1', settlement: '–≥. –ö–æ–Ω–æ—Ç–æ–ø', street: '–ú–∏—Ä–∞', house: '15', apartment: '3', status: '–ù–æ–≤—ã–π' },
                { id: '2', settlement: '–≥. –ö–æ–Ω–æ—Ç–æ–ø', street: '–ú–∏—Ä–∞', house: '15', apartment: '8', status: '–í–∏–∑–∏—Ç (–ó–ê)' },
                { id: '3', settlement: '–≥. –ö–æ–Ω–æ—Ç–æ–ø', street: '–ö–∏–µ–≤—Å–∫–∞—è', house: '2', apartment: '', status: '–ù–µ –æ—Ç–∫—Ä—ã–ª–∏' },
                { id: '4', settlement: '—Å. –ë–æ—á–µ—á–∫–∏', street: '–®–µ–≤—á–µ–Ω–∫–æ', house: '5', apartment: '1', status: '–ù–æ–≤—ã–π' },
                // ... —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            ];
            walklistDataCache = addresses;
            renderWalklist();

        } catch (e) {
            console.error("Error fetching walklist:", e);
            document.getElementById('walklist-container').innerHTML = '<p class="text-red-500 text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –æ–±—Ö–æ–¥–∞.</p>';
        }
    }

    function renderWalklist() {
        const filterSettlement = document.getElementById('walklist-settlement').value;
        const container = document.getElementById('walklist-container');
        container.innerHTML = '';

        const filteredList = filterSettlement === '–í—Å–µ'
            ? walklistDataCache
            : walklistDataCache.filter(item => item.settlement === filterSettlement);

        if (filteredList.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center">–°–ø–∏—Å–æ–∫ –æ–±—Ö–æ–¥–∞ –ø—É—Å—Ç –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É.</p>';
            return;
        }

        filteredList.forEach(item => {
            let statusClass = 'bg-gray-100 text-gray-700';
            if (item.status.includes('–ó–ê')) statusClass = 'bg-green-100 text-green-700';
            else if (item.status.includes('–ü–†–û–¢–ò–í') || item.status.includes('–û—Ç–∫–∞–∑')) statusClass = 'bg-red-100 text-red-700';
            else if (item.status.includes('–í–∏–∑–∏—Ç') || item.status.includes('–ù–µ –æ—Ç–∫—Ä—ã–ª–∏')) statusClass = 'bg-yellow-100 text-yellow-700';

            const apartmentText = item.apartment ? `, –∫–≤. ${item.apartment}` : '';

            const itemHtml = `
                <div class="p-3 border rounded-lg hover:shadow-md transition-shadow cursor-pointer bg-white" onclick="selectAddressForForm('${item.settlement}', '${item.street}', '${item.house}', '${item.apartment || ''}')">
                    <p class="font-semibold text-base">${item.street}, –¥. ${item.house}${apartmentText}</p>
                    <p class="text-xs text-gray-500 mb-1">${item.settlement}</p>
                    <span class="text-xs font-medium ${statusClass} px-2 py-1 rounded-full">${item.status}</span>
                </div>
            `;
            container.innerHTML += itemHtml;
        });
        lucide.createIcons();
    }

    // –í—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã
    window.selectAddressForForm = function(settlement, street, house, apartment) {
        document.getElementById('settlement').value = settlement;
        document.getElementById('street').value = street;
        document.getElementById('house').value = house;
        document.getElementById('apartment').value = apartment;

        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ñ–æ—Ä–º—É
        showSection('form');
        document.getElementById('saveDataBtn').disabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É, —Ç.–∫. –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã

        // –°–∫—Ä–æ–ª–ª–∏–º –∫ –Ω–∞—á–∞–ª—É —Ñ–æ—Ä–º—ã, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ
        window.scrollTo(0, 0);
    }

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –∫ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
    document.getElementById('walklist-settlement').onchange = renderWalklist;


    // --- –§–£–ù–ö–¶–ò–ò –†–ê–ó–î–ï–õ–ê "–û–¢–ß–ï–¢–´" (Reports) ---

    let loyaltyChartInstance = null;
    let actionChartInstance = null;

    async function fetchAndRenderReports() {
        if (!isAdmin) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞

        const reportSettlement = document.getElementById('reportSettlement').value;
        const reportPeriod = document.getElementById('reportPeriod').value;

        if (isTMA) Telegram.WebApp.MainButton.showLoader();

        try {
            let query = db.collection('surveys').orderBy('timestamp', 'desc');

            // 1. –§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞—Å–µ–ª–µ–Ω–Ω–æ–º—É –ø—É–Ω–∫—Ç—É
            if (reportSettlement !== '–í—Å–µ') {
                query = query.where('settlement', '==', reportSettlement);
            }

            // 2. –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É
            const now = new Date().getTime();
            let startTime = 0;
            if (reportPeriod !== 'all') {
                const days = parseInt(reportPeriod, 10);
                startTime = now - (days * 24 * 60 * 60 * 1000);
            }
            if (startTime > 0) {
                 query = query.where('timestamp', '>=', startTime);
            }

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const snapshot = await query.get();
            dataCache = snapshot.docs.map(doc => doc.data());
            
            if (dataCache.length === 0) {
                 // –û—á–∏—Å—Ç–∫–∞ –∏ –ø–æ–∫–∞–∑ "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
                 document.getElementById('totalRecords').textContent = '0';
                 document.getElementById('uniqueUsers').textContent = '0';
                 document.getElementById('latest-data-container').innerHTML = '<p class="text-gray-500 text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</p>';
                 renderCharts([], []);
                 generateMap([]);
                 return;
            }

            // –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
            const { loyaltyData, actionData, mapPoints, userSet } = aggregateData(dataCache);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏
            document.getElementById('totalRecords').textContent = dataCache.length;
            document.getElementById('uniqueUsers').textContent = userSet.size;

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
            renderCharts(loyaltyData, actionData);
            renderLatestData(dataCache.slice(0, 20)); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–∞–ø–∏—Å–µ–π
            generateMap(mapPoints);

        } catch (e) {
            console.error("Error fetching reports:", e);
            showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç—ã: ' + e.message);
        } finally {
            if (isTMA) Telegram.WebApp.MainButton.hideLoader();
        }
    }
    window.fetchAndRenderReports = fetchAndRenderReports;


    function aggregateData(data) {
        const loyaltyCounts = { '–ó–ê': 0, '–ù–ï–ô–¢–†–ê–õ': 0, '–ü–†–û–¢–ò–í': 0, '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ': 0 };
        const actionCounts = {};
        const mapPoints = [];
        const userSet = new Set();

        data.forEach(doc => {
            userSet.add(doc.user_id);

            // –õ–æ—è–ª—å–Ω–æ—Å—Ç—å
            if (doc.action === '–í–∏–∑–∏—Ç' && doc.loyalty) {
                loyaltyCounts[doc.loyalty] = (loyaltyCounts[doc.loyalty] || 0) + 1;
            } else if (doc.action === '–í–∏–∑–∏—Ç' && !doc.loyalty) {
                loyaltyCounts['–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ']++;
            }

            // –î–µ–π—Å—Ç–≤–∏—è
            actionCounts[doc.action] = (actionCounts[doc.action] || 0) + 1;

            // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
            if (doc.location && doc.location.latitude && doc.location.longitude) {
                // [lat, lng, intensity (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)]
                mapPoints.push([doc.location.latitude, doc.location.longitude, 1]);
            }
        });

        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è Chart.js
        const loyaltyData = {
            labels: Object.keys(loyaltyCounts),
            data: Object.values(loyaltyCounts),
            colors: ['#34d399', '#facc15', '#ef4444', '#9ca3af'] // green, yellow, red, gray
        };

        const actionData = {
            labels: Object.keys(actionCounts),
            data: Object.values(actionCounts),
            colors: Object.keys(actionCounts).map(() => `hsl(${Math.random() * 360}, 70%, 50%)`)
        };

        return { loyaltyData, actionData, mapPoints, userSet };
    }


    function renderCharts(loyaltyData, actionData) {
        // –õ–æ—è–ª—å–Ω–æ—Å—Ç—å
        const loyaltyCtx = document.getElementById('loyaltyChart').getContext('2d');
        if (loyaltyChartInstance) loyaltyChartInstance.destroy();

        if (loyaltyData.data && loyaltyData.data.some(d => d > 0)) {
            loyaltyChartInstance = new Chart(loyaltyCtx, {
                type: 'pie',
                data: {
                    labels: loyaltyData.labels,
                    datasets: [{
                        data: loyaltyData.data,
                        backgroundColor: loyaltyData.colors,
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'right' } }
                }
            });
        } else {
            // –ó–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
            loyaltyCtx.clearRect(0, 0, loyaltyCtx.canvas.width, loyaltyCtx.canvas.height);
            loyaltyCtx.textAlign = 'center';
            loyaltyCtx.fillStyle = '#9ca3af';
            loyaltyCtx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è', loyaltyCtx.canvas.width / 2, loyaltyCtx.canvas.height / 2);
        }

        // –î–µ–π—Å—Ç–≤–∏—è
        const actionCtx = document.getElementById('actionChart').getContext('2d');
        if (actionChartInstance) actionChartInstance.destroy();

        if (actionData.data && actionData.data.some(d => d > 0)) {
            actionChartInstance = new Chart(actionCtx, {
                type: 'bar',
                data: {
                    labels: actionData.labels,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                        data: actionData.data,
                        backgroundColor: actionData.colors,
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        } else {
            actionCtx.clearRect(0, 0, actionCtx.canvas.width, actionCtx.canvas.height);
            actionCtx.textAlign = 'center';
            actionCtx.fillStyle = '#9ca3af';
            actionCtx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ–π—Å—Ç–≤–∏—è—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è', actionCtx.canvas.width / 2, actionCtx.canvas.height / 2);
        }
    }


    function renderLatestData(data) {
        const container = document.getElementById('latest-data-container');
        container.innerHTML = '';
        if (data.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center">–ù–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π.</p>';
            return;
        }

        data.forEach(doc => {
            const timestamp = new Date(doc.timestamp).toLocaleString();
            const loyaltyBadge = doc.loyalty ? `<span class="text-xs font-medium px-2 py-0.5 rounded-full ${doc.loyalty === '–ó–ê' ? 'bg-green-100 text-green-700' : doc.loyalty === '–ü–†–û–¢–ò–í' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${doc.loyalty}</span>` : '';
            const locationText = doc.location && doc.location.latitude ? ` (${doc.location.latitude.toFixed(2)}, ${doc.location.longitude.toFixed(2)})` : '';
            const address = `${doc.settlement}, ${doc.street}, –¥. ${doc.house}` + (doc.apartment ? `, –∫–≤. ${doc.apartment}` : '');

            container.innerHTML += `
                <div class="border-b pb-2">
                    <div class="flex justify-between items-start">
                        <p class="font-semibold text-gray-800">${address}</p>
                        ${loyaltyBadge}
                    </div>
                    <p class="text-xs text-gray-500">${timestamp} - ${doc.full_name || doc.user_id}</p>
                    <p class="text-sm mt-1">–î–µ–π—Å—Ç–≤–∏–µ: ${doc.action}</p>
                    ${doc.comment ? `<p class="text-sm italic text-gray-600 truncate">${doc.comment}</p>` : ''}
                </div>
            `;
        });
    }


    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (–ì–µ–æ)
    let markerClusterGroup = null;

    function generateMap(mapPoints) {
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
        if (!mapInstance) {
            mapInstance = L.map('map').setView([47.9333, 33.3667], 6); // –¶–µ–Ω—Ç—Ä –£–∫—Ä–∞–∏–Ω—ã
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);
        }

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ç–µ–ø–ª–æ–≤–æ–π —Å–ª–æ–π, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (heatmapLayer) {
            mapInstance.removeLayer(heatmapLayer);
        }

        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ—á–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–µ–ø–ª–æ–≤–æ–π —Å–ª–æ–π
        if (mapPoints.length > 0) {
            heatmapLayer = L.heatLayer(mapPoints, { radius: 25 }).addTo(mapInstance);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –∑—É–º–∏—Ä–æ–≤–∞–Ω–∏—è
            const latLngs = mapPoints.map(p => [p[0], p[1]]);
            const bounds = L.latLngBounds(latLngs);

            // –ï—Å–ª–∏ –≥—Ä–∞–Ω–∏—Ü—ã –≤–∞–ª–∏–¥–Ω—ã, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Ö
            if (bounds.isValid()) {
                mapInstance.fitBounds(bounds, { padding: [20, 20] });
            }
        }
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞: –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ (–¥–ª—è —Ç–æ—á–µ—á–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ Heatmap, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏ –∫–ª–∞—Å—Ç–µ—Ä—ã:
        /*
        if (markerClusterGroup) {
            mapInstance.removeLayer(markerClusterGroup);
        }
        markerClusterGroup = L.markerClusterGroup();
        mapPoints.forEach(p => {
            markerClusterGroup.addLayer(L.marker([p[0], p[1]]));
        });
        mapInstance.addLayer(markerClusterGroup);
        */
    }


    // --- –§–£–ù–ö–¶–ò–ò –û–ü–ê–°–ù–û–ô –ó–û–ù–´ ---

    // –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ 'surveys')
    async function clearDatabase() {
        if (!isAdmin) {
            showAlert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
            return;
        }

        if (isTMA) Telegram.WebApp.MainButton.showLoader();

        try {
            const collectionRef = db.collection('surveys');
            const snapshot = await collectionRef.limit(500).get(); // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
            
            let deletedCount = 0;
            const batch = db.batch();

            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
                deletedCount++;
            });

            await batch.commit();

            // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤, –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            if (deletedCount === 500) {
                // –ï—Å–ª–∏ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ 500, –≤–æ–∑–º–æ–∂–Ω–æ, –æ—Å—Ç–∞–ª–∏—Å—å –µ—â–µ. –í—ã–∑—ã–≤–∞–µ–º —Å–Ω–æ–≤–∞.
                await clearDatabase(); 
                return;
            }

            // –û—á–∏—Å—Ç–∫–∞ –æ—Ñ—Ñ–ª–∞–π–Ω-–∫—ç—à–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            localStorage.removeItem('offlineCache');
            dataCache = []; // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
            updateOfflineStatus();
            showAlert('–£—Å–ø–µ—à–Ω–æ!', `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} –∑–∞–ø–∏—Å–µ–π. –î–∞–Ω–Ω—ã–µ Firestore –æ—á–∏—â–µ–Ω—ã.`);

            if (isAdmin) fetchAndRenderReports();

            return true;

        } catch (e) {
             console.error("Error deleting collection:", e);
             showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + e.message);
             return false;
        } finally {
             if (isTMA) Telegram.WebApp.MainButton.hideLoader();
        }
    };
    window.clearDatabase = clearDatabase;


    // --- –≠–ö–°–ü–û–†–¢ ---

    function exportToXLSX() {
        if (dataCache.length === 0) {
            showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –æ—Ç—á–µ—Ç—ã.');
            return;
        }
        const exportData = dataCache.map(doc => ({
            '–í—Ä–µ–º—è': new Date(doc.timestamp).toLocaleString(), 'ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è': doc.user_id, '–ê–≥–∏—Ç–∞—Ç–æ—Ä (–§–ò–û)': doc.full_name || doc.username,
            '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç': doc.settlement, '–£–ª–∏—Ü–∞': doc.street, '–î–æ–º': doc.house, '–ö–≤–∞—Ä—Ç–∏—Ä–∞': doc.apartment, '–î–µ–π—Å—Ç–≤–∏–µ': doc.action,
            '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å': doc.loyalty, '–¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä': doc.requires_followup ? '–î–ê' : '–ù–ï–¢', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': doc.comment,
            '–®–∏—Ä–æ—Ç–∞': doc.location ? doc.location.latitude : 'N/A', '–î–æ–ª–≥–æ—Ç–∞': doc.location ? doc.location.longitude : 'N/A',
        }));
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "–î–∞–Ω–Ω—ã–µ");
        XLSX.writeFile(workbook, "agitator_data_" + new Date().toISOString().slice(0, 10) + ".xlsx");
    }
    window.exportToXLSX = exportToXLSX;


    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
    if (isTMA) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
    }

    // üîë –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = async () => {
        // 1. –°–Ω–∞—á–∞–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ isAdmin –∏ userTelegramId
        await authenticateUser();

        // 2. –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        populateSettlements();
        updateOfflineStatus();
        window.showSection('form');
        lucide.createIcons();

        // –û–¢–õ–ê–î–ö–ê: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
        document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
        document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê (PIN)' : '–ù–ï–¢';

        if (!firebaseConfig.projectId) {
            window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase –≤ –∫–æ–¥.');
        }
    };

</script>
</body>
</html>
