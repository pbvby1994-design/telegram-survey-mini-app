<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Блокнот Агитатора | Панель</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="https://api-maps.yandex.ru/2.1/?apikey=35d34bfb-514d-42c1-b37d-cb751ea4793e&lang=ru_RU&onload=initMap" type="text/javascript" async></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="manifest" href="./manifest.json">

    <style>
        body { 
            font-family: 'Jost', sans-serif; 
            background-color: #f4f6f9;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .tab-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        .tab-button.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }
        .tab-button:not(.active):hover {
            background-color: #e5e7eb;
        }
        #mapContainer { 
            height: 600px; 
            width: 100%; 
            border-radius: 12px;
            /* Placeholder background */
            background-color: #e5e7eb; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #4b5563;
            position: relative; /* Для позиционирования спиннера */
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="mb-6 flex justify-between items-center bg-white p-6 rounded-xl shadow">
            <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                <span data-lucide="bar-chart-3" class="w-8 h-8 mr-3 text-indigo-600"></span>
                Панель Администратора
            </h1>
            <div class="text-right">
                <p class="text-sm font-medium text-gray-700">Статус Админа:</p>
                <p id="debugAdminStatus" class="text-lg font-bold text-red-500">⏳</p>
            </div>
        </header>

        <nav class="mb-8 p-3 bg-white rounded-xl shadow flex space-x-4">
            <div id="btn-map-view" class="tab-button active" onclick="showSection('map-view')">
                <span data-lucide="map-pin" class="w-5 h-5 mr-2"></span> Карта
            </div>
            <div id="btn-stats" class="tab-button" onclick="showSection('stats')">
                <span data-lucide="line-chart" class="w-5 h-5 mr-2"></span> Статистика
            </div>
            <div id="btn-raw-data" class="tab-button" onclick="showSection('raw-data')">
                <span data-lucide="table-2" class="w-5 h-5 mr-2"></span> Сырые данные
            </div>
        </nav>

        <section id="map-view" class="content-section">
            <div class="bg-white p-6 rounded-xl shadow mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-gray-800">Карта опросов</h2>
                <div class="flex items-center space-x-3">
                    <label for="settlementFilter" class="text-gray-700">Фильтр по НП:</label>
                    <select id="settlementFilter" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Все населенные пункты</option>
                        </select>
                </div>
            </div>
            <div id="mapContainer">
                 <div id="mapLoading" class="absolute inset-0 bg-gray-200/80 flex items-center justify-center rounded-xl z-10 transition-opacity duration-300">
                    <div class="flex flex-col items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-indigo-700">Загрузка карты и данных...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="stats" class="content-section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow">
                    <canvas id="loyaltyChart" class="w-full h-80"></canvas>
                </div>
                <div class="bg-white p-6 rounded-xl shadow">
                    <canvas id="actionChart" class="w-full h-80"></canvas>
                </div>
            </div>
        </section>

        <section id="raw-data" class="content-section hidden">
            <div class="bg-white p-6 rounded-xl shadow">
                <div class="flex justify-between items-center mb-4">
                    <p id="reportStatus" class="text-sm font-medium text-gray-600">Ожидание загрузки данных...</p>
                    <button id="exportCsvButton" onclick="window.exportToCsv()" disabled class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition duration-150">
                        <span data-lucide="download" class="w-5 h-5 mr-2"></span> Экспорт в CSV
                    </button>
                </div>
                <div class="mt-4 text-gray-500">
                    <p>Для просмотра полных данных используйте кнопку "Экспорт в CSV".</p>
                </div>
            </div>
        </section>
    </div>

    <div id="alertModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 transition-opacity duration-300" onclick="closeAlert()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4" onclick="event.stopPropagation()">
            <h3 id="alertTitle" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <p id="alertMessage" class="text-gray-600 mb-6"></p>
            <button onclick="closeAlert()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                Закрыть
            </button>
        </div>
    </div>

    <script type="module" src="./config.js"></script>
    <script src="./firebase-auth.js"></script>
    <script src="./reports.js"></script>
    <script src="./main.js"></script>

    <script>
        // Инициализация Lucide Icons
        lucide.createIcons();
        
        // --- ГЛОБАЛЬНЫЕ ФУНКЦИИ UI ---
        
        window.showSection = function(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const sectionButton = document.getElementById(`btn-${sectionId}`);
            if (sectionButton) {
                sectionButton.classList.add('active');
            }

            // Инициализация карты
            if (sectionId === 'map-view') {
                // Показываем спиннер, пока карта загружает данные
                document.getElementById('mapLoading').classList.remove('hidden'); 
                 if (typeof ymaps !== 'undefined' && typeof window.initMap === 'function') {
                    // Если API загрузилось, но карта еще не инициализирована - запускаем.
                    // Если уже инициализирована, reports.js вызовет fetchReports, который обновит маркеры.
                    window.initMap(); 
                 }
                 // Если карта уже была, но её нужно обновить/перерисовать 
                 if (window.mapInstance) window.mapInstance.container.fitToViewport();
            } else {
                 document.getElementById('mapLoading').classList.add('hidden');
            }
        }
        
        // Общая функция для вывода модальных сообщений
        window.showAlert = function(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').classList.remove('hidden');
            document.getElementById('alertModal').classList.add('flex');
            
            // УЛУЧШЕНИЕ: Уведомление Telegram
            if (window.Telegram.WebApp && window.Telegram.WebApp.showAlert) {
                 window.Telegram.WebApp.showAlert(`${title}: ${message}`);
            }
        }

        window.closeAlert = function() {
            document.getElementById('alertModal').classList.add('hidden');
            document.getElementById('alertModal').classList.remove('flex');
        }
        
        // --- ИНИЦИАЛИЗАЦИЯ ---
        
        document.addEventListener('DOMContentLoaded', () => {
             // Инициализация Telegram WebApp
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp.ready) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.setHeaderColor('bg_color'); 
                window.Telegram.WebApp.setBackgroundColor('bg_color');
            }
            
            // Запуск аутентификации (из main.js)
            if (window.loadDashboard) {
                window.loadDashboard();
            }
        });
    </script>
</body>
</html>
