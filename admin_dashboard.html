<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Блокнот Агитатора | v2.5 (PIN-код Admin)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <!-- Иконка Loading -->
    <style>
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <style>
        :root {
            --primary: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg: #f3f4f6; /* gray-100 */
            --card-bg: #ffffff;
            --text-color: #1f2937; /* gray-900 */
        }
        body {
            font-family: 'Jost', sans-serif;
            background-color: var(--bg);
            color: var(--text-color);
            padding-bottom: 70px; /* Учитываем высоту nav-bar */
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        .btn-secondary {
            background-color: #9ca3af; /* gray-400 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #6b7280; /* gray-500 */
        }
        input[type="text"], input[type="number"], input[type="password"], textarea, select {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 8px;
            padding: 0.75rem;
            width: 100%;
            margin-top: 0.5rem;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border-top: 1px solid #e5e7eb;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #6b7280; /* gray-500 */
            font-size: 0.75rem;
            font-weight: 500;
            transition: color 0.2s;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
        }
        .nav-item.active {
            color: var(--primary-dark);
        }
        .nav-item:hover {
            color: var(--primary);
        }
        .alert-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            min-width: 300px;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>

<div class="container">
    <header class="text-center py-4 border-b border-gray-200 mb-4">
        <h1 class="text-2xl font-bold">Блокнот Агитатора</h1>
    </header>

    <!-- СЕКЦИЯ 1: ФОРМА ВВОДА ДАННЫХ -->
    <section id="form" class="section">
        <h1 class="text-2xl font-bold mb-4">Ввод данных</h1>

        <!-- Форма -->
        <div id="data-form" class="card p-4 space-y-4">
            <h2 class="text-lg font-semibold border-b pb-2 mb-3">Информация о визите</h2>

            <!-- ФИО Агитатора (Автозаполнение) -->
            <div>
                <label for="fullName" class="block text-sm font-medium text-gray-700">ФИО Агитатора</label>
                <input type="text" id="fullName" class="bg-gray-100 cursor-not-allowed" readonly placeholder="Загрузка...">
                <p class="text-xs text-gray-500 mt-1">ФИО берется из вашего профиля Telegram.</p>
            </div>

            <!-- Населенный пункт -->
            <div>
                <label for="settlement" class="block text-sm font-medium text-gray-700">Населенный пункт <span class="text-red-500">*</span></label>
                <select id="settlement" required>
                    <!-- Опции будут заполнены JS -->
                </select>
            </div>

            <!-- Улица и Дом -->
            <div class="flex space-x-4">
                <div class="flex-1">
                    <label for="street" class="block text-sm font-medium text-gray-700">Улица <span class="text-red-500">*</span></label>
                    <input type="text" id="street" required>
                </div>
                <div class="w-1/4">
                    <label for="house" class="block text-sm font-medium text-gray-700">Дом <span class="text-red-500">*</span></label>
                    <input type="text" id="house" required>
                </div>
            </div>

            <!-- Квартира (Опционально) -->
            <div>
                <label for="apartment" class="block text-sm font-medium text-gray-700">Квартира (Опционально)</label>
                <input type="text" id="apartment">
            </div>

            <!-- Действие -->
            <div>
                <label for="action" class="block text-sm font-medium text-gray-700">Действие <span class="text-red-500">*</span></label>
                <select id="action" required>
                    <option value="">Выберите действие</option>
                    <option value="Визит">Визит (открыта дверь)</option>
                    <option value="Не открыли">Не открыли</option>
                    <option value="Отказ">Отказ от общения</option>
                    <option value="Отметка адреса">Отметка адреса (проход)</option>
                    <option value="Другое">Другое</option>
                </select>
            </div>

            <!-- Лояльность (Только для "Визит") -->
            <div id="loyalty-group" class="hidden">
                <label for="loyalty" class="block text-sm font-medium text-gray-700">Лояльность <span class="text-red-500">*</span></label>
                <select id="loyalty" required>
                    <option value="">Выберите лояльность</option>
                    <option value="ЗА">ЗА</option>
                    <option value="НЕЙТРАЛ">НЕЙТРАЛ</option>
                    <option value="ПРОТИВ">ПРОТИВ</option>
                </select>
            </div>

            <!-- Требуется Повторный Визит -->
            <div class="flex items-center space-x-2">
                <input type="checkbox" id="requiresFollowup" class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary">
                <label for="requiresFollowup" class="text-sm font-medium text-gray-700">Требуется повторный визит</label>
            </div>

            <!-- Комментарий -->
            <div>
                <label for="comment" class="block text-sm font-medium text-gray-700">Комментарий</label>
                <textarea id="comment" rows="3" placeholder="Заметки о разговоре, причина повторного визита и т.д."></textarea>
            </div>

            <!-- Кнопка определения местоположения -->
            <button id="getLocationBtn" class="btn-secondary w-full flex items-center justify-center space-x-2" type="button">
                <i data-lucide="map-pin" class="w-4 h-4"></i>
                <span id="locationStatus">Определить местоположение</span>
            </button>
            <input type="hidden" id="latitude">
            <input type="hidden" id="longitude">

            <!-- Кнопка Сохранения -->
            <button id="saveDataBtn" class="btn-primary w-full" type="button" disabled>
                Сохранить данные
            </button>

            <p id="saveStatus" class="text-center text-sm mt-2 hidden"></p>
        </div>
        <!-- Конец формы -->

        <!-- ОТЛАДКА И ОФФЛАЙН -->
        <div class="card p-4 text-sm mt-4 text-gray-600">
            <h2 class="text-lg font-semibold border-b pb-2 mb-2">Статус</h2>
            <p>Онлайн-статус: <span id="onlineStatus" class="font-bold text-red-500">ОФФЛАЙН</span></p>
            <p>Кэш оффлайн-записей: <span id="offlineCount" class="font-bold">0</span></p>
            <p>ID Пользователя: <span id="debugUserId" class="font-mono">...</span></p>
            <p>Статус Админа: <span id="debugAdminStatus" class="font-mono text-red-500">НЕТ</span></p>
            <button id="syncDataBtn" class="btn-secondary w-full mt-2 hidden" type="button">Синхронизировать данные</button>
        </div>
    </section>

    <!-- СЕКЦИЯ 2: СПИСОК АДРЕСОВ (Walklist) -->
    <section id="walklist" class="section hidden">
        <h1 class="text-2xl font-bold mb-4">Список Обхода</h1>

        <div class="card p-4">
            <p class="text-sm text-gray-600 mb-3">Здесь будет отображаться ваш список адресов для обхода (список берется из Firestore, коллекция `walklists`).</p>
            <div id="walklist-filter" class="mb-3">
                <label for="walklist-settlement" class="block text-sm font-medium text-gray-700">Фильтр по нас. пункту</label>
                <select id="walklist-settlement">
                    <!-- Опции будут заполнены JS -->
                </select>
            </div>
            <div id="walklist-container" class="space-y-3">
                <p class="text-gray-500 text-center">Загрузка адресов...</p>
            </div>
        </div>
    </section>

    <!-- СЕКЦИЯ 3: ОТЧЕТЫ (ТОЛЬКО ДЛЯ АДМИНА) -->
    <section id="reports" class="section hidden">
        <h1 class="text-2xl font-bold mb-4">Отчеты</h1>

        <!-- ФОРМА ВХОДА ПО PIN-КОДУ ДЛЯ ОТЧЕТОВ -->
        <div id="pin-login-reports" class="card p-4 text-center" style="max-width: 320px; margin: 0 auto;">
            <h2 class="text-lg font-semibold mb-3 text-red-600">🔐 Требуется PIN-код</h2>
            <p class="text-sm text-gray-600 mb-4">Для доступа к отчетам введите PIN-код.</p>
            <input type="password" id="reportsPinInput" class="w-full text-center text-xl font-mono tracking-widest" maxlength="8" placeholder="****" required>
            <button onclick="checkAdminPIN()" class="btn-primary w-full mt-4">Войти</button>
            <p id="pin-error-reports" class="text-xs text-red-500 mt-2 hidden">Неверный PIN-код.</p>
        </div>
        <!-- КОНЕЦ ФОРМЫ -->

        <div id="admin-reports-content" class="hidden">
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">Обзор Данных</h2>

                <!-- Фильтры -->
                <div class="space-y-3 mb-4">
                    <div>
                        <label for="reportSettlement" class="block text-sm font-medium text-gray-700">Фильтр по нас. пункту</label>
                        <select id="reportSettlement" onchange="fetchAndRenderReports()">
                            <option value="Все">Все населенные пункты</option>
                        </select>
                    </div>
                    <div>
                        <label for="reportPeriod" class="block text-sm font-medium text-gray-700">Период</label>
                        <select id="reportPeriod" onchange="fetchAndRenderReports()">
                            <option value="3">Последние 3 дня</option>
                            <option value="7">Последние 7 дней</option>
                            <option value="30">Последние 30 дней</option>
                            <option value="all">За все время</option>
                        </select>
                    </div>
                </div>

                <div id="report-summary" class="grid grid-cols-2 gap-3 text-center mb-4">
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-xs text-gray-500">Всего записей</p>
                        <p id="totalRecords" class="text-xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                        <p class="text-xs text-gray-500">Уник. Агитаторов</p>
                        <p id="uniqueUsers" class="text-xl font-bold text-green-600">0</p>
                    </div>
                </div>

                <h3 class="text-md font-semibold mt-4 mb-2">Лояльность</h3>
                <canvas id="loyaltyChart"></canvas>

                <h3 class="text-md font-semibold mt-4 mb-2">Действия</h3>
                <canvas id="actionChart"></canvas>

                <h3 class="text-md font-semibold mt-4 mb-2">Гео-карта (Тепловая)</h3>
                <div id="map"></div>

                <div class="mt-4 flex space-x-2">
                    <button onclick="exportToXLSX()" class="btn-secondary flex-1">
                        <i data-lucide="file-text" class="w-4 h-4 inline-block mr-1"></i>
                        Экспорт в XLSX
                    </button>
                </div>
            </div>

            <!-- Последние записи -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-2 border-b pb-2">Последние 20 Записей</h2>
                <div id="latest-data-container" class="text-sm space-y-3">
                    <p class="text-gray-500 text-center">Нет данных или ожидание загрузки...</p>
                </div>
                <button onclick="fetchAndRenderReports()" class="btn-secondary w-full mt-4">Обновить Отчеты</button>
            </div>
        </div>
    </section>


    <!-- СЕКЦИЯ 4: АДМИНИСТРИРОВАНИЕ (ТОЛЬКО ДЛЯ АДМИНА) -->
    <section id="admin" class="section hidden">
        <h1 class="text-2xl font-bold mb-4">Администрирование</h1>

        <!-- ФОРМА ВХОДА ПО PIN-КОДУ ДЛЯ АДМИНИСТРИРОВАНИЯ -->
        <div id="pin-login-admin" class="card p-4 text-center" style="max-width: 320px; margin: 0 auto;">
            <h2 class="text-lg font-semibold mb-3 text-red-600">🔐 Требуется PIN-код</h2>
            <p class="text-sm text-gray-600 mb-4">Для доступа к админ-панели введите PIN-код.</p>
            <input type="password" id="adminPinInput" class="w-full text-center text-xl font-mono tracking-widest" maxlength="8" placeholder="****" required>
            <button onclick="checkAdminPIN()" class="btn-primary w-full mt-4">Войти</button>
            <p id="pin-error-admin" class="text-xs text-red-500 mt-2 hidden">Неверный PIN-код.</p>
        </div>
        <!-- КОНЕЦ ФОРМЫ -->

        <div id="admin-panel-content" class="hidden">
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-2">Управление Пользователями (Имитация)</h2>
                <p class="text-sm text-gray-600 mb-3">В этой версии MiniApp управление пользователями (бан/разбан) осуществляется только через команду `/admin_ban` в боте. Этот раздел — заглушка.</p>
                <button class="btn-secondary w-full cursor-not-allowed">Показать список пользователей (Через бота)</button>
            </div>

            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-2 text-red-600">Опасная Зона</h2>
                <p class="text-sm text-gray-600 mb-3">Очистка данных приведет к **безвозвратному удалению всех записей** (кроме фото) из Firestore. Убедитесь, что вы сделали экспорт.</p>
                <button id="clearDataBtn" class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-lg w-full font-semibold" onclick="promptClearDatabase()">
                    <i data-lucide="alert-triangle" class="w-4 h-4 inline-block mr-1"></i>
                    ОЧИСТИТЬ ВСЕ ДАННЫЕ
                </button>
            </div>
        </div>
    </section>

    <!-- Модальное окно (Alert/Prompt) -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 justify-center items-center">
        <div id="alert-modal" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-3">Заголовок</h3>
            <p id="modal-message" class="text-gray-700 mb-4">Сообщение</p>
            <div id="modal-buttons" class="flex justify-end space-x-2">
                <!-- Кнопки вставляются JS -->
            </div>
        </div>
    </div>

</div>

<!-- НАВИГАЦИОННАЯ ПАНЕЛЬ -->
<div class="nav-bar">
    <a class="nav-item active" onclick="showSection('form')">
        <i data-lucide="clipboard-list" class="w-5 h-5"></i>
        <span>Форма</span>
    </a>
    <a id="navWalklist" class="nav-item" onclick="showSection('walklist')">
        <i data-lucide="list-checks" class="w-5 h-5"></i>
        <span>Обход</span>
    </a>
    <a id="navReports" class="nav-item hidden" onclick="showSection('reports')">
        <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
        <span>Отчеты</span>
    </a>
    <a id="navAdmin" class="nav-item hidden" onclick="showSection('admin')">
        <i data-lucide="cog" class="w-5 h-5"></i>
        <span>Админ</span>
    </a>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // --- КОНФИГУРАЦИЯ FIREBASE (ВСТАВИТЬ СЮДА ВАШИ КЛЮЧИ) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDVeRXO16KtIwoJQb4uHQuCsEv3xTLBGhI",
        authDomain: "agitator-notebook.firebaseapp.com",
        projectId: "agitator-notebook",
        storageBucket: "agitator-notebook.firebasestorage.app",
        messagingSenderId: "518555352011",
        appId: "1:518555352011:web:2b1f0e4b86f8a25c156f70"
    };
</script>

<script type="module">
    // Импорт из глобальных библиотек
    // Здесь мы используем совместимую версию Firebase (compat) для простоты
    // и полагаемся на глобальные переменные, инициализированные выше

    // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
    let app, db;
    let userTelegramId = null;
    let userFullName = 'Неизвестный Пользователь';
    let isTMA = typeof Telegram !== 'undefined' && Telegram.WebApp;
    let dataCache = [];
    let mapInstance = null;
    let heatmapLayer = null;

    // --- АДМИН КОНФИГУРАЦИЯ ---
    const ADMIN_PIN = '19941994Ki)'; // 🔑 ВАШ PIN-КОД, ДОЛЖЕН СОВПАДАТЬ С BOT_ADMIN_PASSWORD
    let isAdmin = localStorage.getItem('isAdminLoggedIn') === 'true'; // Статус по умолчанию (пытаемся восстановить сессию)


    // --- СПИСКИ ДАННЫХ ---
    const settlements = [
        'г. Конотоп',
        'с. Бочечки',
        'с. Малый Самбор',
        'с. Дубовьязовка',
        'Другой'
    ];


    // --- ИНСТРУМЕНТЫ (ALERT/MODAL) ---

    // Показывает настраиваемое модальное окно (ALERT)
    function showAlert(title, message) {
        const backdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');

        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalButtons.innerHTML = `<button onclick="hideModal()" class="btn-primary">OK</button>`;

        backdrop.classList.remove('hidden');
        backdrop.classList.add('flex');
    }

    // Показывает настраиваемое модальное окно с подтверждением (PROMPT)
    function promptModal(title, message, callback) {
        const backdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');

        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalButtons.innerHTML = `
            <button onclick="hideModal()" class="btn-secondary">Отмена</button>
            <button onclick="hideModal(); ${callback}" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg font-semibold">Подтвердить</button>
        `;

        backdrop.classList.remove('hidden');
        backdrop.classList.add('flex');
    }

    // Скрывает модальное окно
    function hideModal() {
        document.getElementById('modal-backdrop').classList.remove('flex');
        document.getElementById('modal-backdrop').classList.add('hidden');
    }

    // Запускает подтверждение очистки БД
    window.promptClearDatabase = function() {
        promptModal(
            'Подтвердите удаление',
            'Вы уверены, что хотите БЕЗВОЗВРАТНО удалить ВСЕ данные (кроме фото) из базы данных Firestore? Это действие нельзя отменить.',
            'clearDatabase()'
        );
    };


    // --- ФУНКЦИИ АДМИНИСТРАТОРА (PIN-КОД) ---

    // Функция проверки PIN-кода администратора
    window.checkAdminPIN = function() {
        const pinInputAdmin = document.getElementById('adminPinInput');
        const pinErrorAdmin = document.getElementById('pin-error-admin');

        const pinInputReports = document.getElementById('reportsPinInput');
        const pinErrorReports = document.getElementById('pin-error-reports');

        // Определяем, откуда был вызван вход
        const isReportsSection = document.getElementById('reportsPinInput') && document.getElementById('reportsPinInput').value.trim() === ADMIN_PIN;

        const pin = isReportsSection ? pinInputReports.value.trim() : pinInputAdmin.value.trim();
        const pinInput = isReportsSection ? pinInputReports : pinInputAdmin;
        const pinError = isReportsSection ? pinErrorReports : pinErrorAdmin;
        
        // Добавляем логику для обоих элементов, так как они могут быть невидимы, но при этом могут быть целевыми
        const pinLoginAdmin = document.getElementById('pin-login-admin');
        const adminContent = document.getElementById('admin-panel-content');
        const pinLoginReports = document.getElementById('pin-login-reports');
        const reportsContent = document.getElementById('admin-reports-content');


        if (pin === ADMIN_PIN) {
            isAdmin = true;
            localStorage.setItem('isAdminLoggedIn', 'true'); // Сохраняем сессию в LocalStorage
            localStorage.setItem('lastPinAttempt', pin); // Сохраняем PIN для удобства

            // Показываем навигационные кнопки
            document.getElementById('navReports').classList.remove('hidden');
            document.getElementById('navAdmin').classList.remove('hidden');

            // Обновляем статус отладки
            document.getElementById('debugAdminStatus').textContent = 'ДА (PIN)';

            // Скрываем формы входа и показываем контент
            if (pinLoginAdmin) pinLoginAdmin.classList.add('hidden');
            if (adminContent) adminContent.classList.remove('hidden');
            if (pinLoginReports) pinLoginReports.classList.add('hidden');
            if (reportsContent) reportsContent.classList.remove('hidden');

            if (pinError) pinError.classList.add('hidden');
            if (pinInput) pinInput.value = ''; // Очищаем поле ввода PIN

            // Если мы в разделе 'reports', запускаем загрузку данных
            const currentSection = document.querySelector('.section:not(.hidden)').id;
            if (currentSection === 'reports') {
                fetchAndRenderReports();
            }

            showAlert('Успешно', 'Вход в панель администратора выполнен!');
            return true;
        } else {
            isAdmin = false;
            if (pinError) pinError.classList.remove('hidden');
            if (pinInput) pinInput.value = '';
            showAlert('Ошибка', 'Неверный PIN-код.');
            return false;
        }
    }


    // --- ФУНКЦИИ FIREBASE/CORE ---

    // Инициализация Firebase и получение данных пользователя
    async function authenticateUser() {
        try {
            if (!app) {
                app = firebase.initializeApp(firebaseConfig);
                db = app.firestore();
            }

            // Имитация получения Telegram User ID и Full Name
            if (isTMA) {
                try {
                    const initData = Telegram.WebApp.initDataUnsafe;
                    if (initData.user) {
                        userTelegramId = String(initData.user.id);
                        userFullName = initData.user.first_name || 'Аноним';
                        if (initData.user.last_name) userFullName += ' ' + initData.user.last_name;
                        if (initData.user.username) userFullName += ` (@${initData.user.username})`;
                    } else if (initData.auth_date) {
                        // Если нет user, но есть auth_date - это MiniApp. Используем заглушку ID.
                        userTelegramId = 'TMA_GUEST_' + Date.now();
                        userFullName = 'TMA Гость';
                    }
                } catch (e) {
                    // Ошибка парсинга initData
                    userTelegramId = 'ERROR_TMA_ID_' + Date.now();
                    userFullName = 'Ошибка TMA';
                }
            } else {
                // Если не TMA, используем уникальный ID из localStorage
                userTelegramId = localStorage.getItem('guestId');
                if (!userTelegramId) {
                    userTelegramId = 'WEB_GUEST_' + crypto.randomUUID();
                    localStorage.setItem('guestId', userTelegramId);
                }
                userFullName = 'WEB Гость';
            }

            // Обновляем статус админа на основе PIN в localStorage
            isAdmin = localStorage.getItem('isAdminLoggedIn') === 'true';

            // Если админ, показываем кнопки навигации
            if (isAdmin) {
                document.getElementById('navReports').classList.remove('hidden');
                document.getElementById('navAdmin').classList.remove('hidden');
            }

            // Обновляем поля формы
            document.getElementById('fullName').value = userFullName;

        } catch (e) {
            console.error("Firebase/Auth Error:", e);
            showAlert('Ошибка Инициализации', 'Не удалось подключиться к Firebase: ' + e.message);
        }
    }


    // Сохранение данных в Firestore или LocalStorage
    async function saveData() {
        if (!userTelegramId) {
            showAlert('Ошибка', 'Не удалось определить ID пользователя. Попробуйте перезапустить приложение.');
            return;
        }

        const data = {
            user_id: userTelegramId,
            full_name: userFullName,
            timestamp: new Date().getTime(),
            settlement: document.getElementById('settlement').value,
            street: document.getElementById('street').value.trim(),
            house: document.getElementById('house').value.trim(),
            apartment: document.getElementById('apartment').value.trim() || null,
            action: document.getElementById('action').value,
            loyalty: document.getElementById('loyalty').value || null,
            requires_followup: document.getElementById('requiresFollowup').checked,
            comment: document.getElementById('comment').value.trim() || null,
            location: {
                latitude: parseFloat(document.getElementById('latitude').value) || null,
                longitude: parseFloat(document.getElementById('longitude').value) || null,
            }
        };

        if (!data.settlement || !data.street || !data.house || !data.action ||
            (data.action === 'Визит' && !data.loyalty)) {
            showAlert('Ошибка', 'Пожалуйста, заполните все обязательные поля (*).');
            return;
        }

        const saveStatusEl = document.getElementById('saveStatus');
        saveStatusEl.classList.remove('hidden', 'text-green-500', 'text-red-500');
        saveStatusEl.classList.add('text-blue-500');
        saveStatusEl.textContent = 'Сохранение...';
        document.getElementById('saveDataBtn').disabled = true;


        // 1. Попытка сохранения в Firestore
        if (navigator.onLine) {
            try {
                const docRef = await db.collection('surveys').add(data);
                saveStatusEl.textContent = `Успешно сохранено онлайн. ID: ${docRef.id}`;
                saveStatusEl.classList.replace('text-blue-500', 'text-green-500');

                // Очистка формы
                clearForm();
                
                // Закрытие Mini App, если в TMA
                if (isTMA) {
                    Telegram.WebApp.close();
                }

            } catch (e) {
                console.error("Error writing document to Firestore:", e);
                saveStatusEl.textContent = 'Ошибка онлайн. Сохранено в кэш.';
                saveStatusEl.classList.replace('text-blue-500', 'text-red-500');
                saveToOfflineCache(data); // Переходим к оффлайн
            }
        } else {
            // 2. Сохранение в LocalStorage (Оффлайн)
            saveStatusEl.textContent = 'Оффлайн. Сохранено в кэш.';
            saveStatusEl.classList.replace('text-blue-500', 'text-red-500');
            saveToOfflineCache(data);
        }

        document.getElementById('saveDataBtn').disabled = false;
        
        // Скрываем статус через 5 секунд
        setTimeout(() => saveStatusEl.classList.add('hidden'), 5000);
    }

    // Сохранение в оффлайн-кэш
    function saveToOfflineCache(data) {
        let cache = JSON.parse(localStorage.getItem('offlineCache') || '[]');
        cache.push(data);
        localStorage.setItem('offlineCache', JSON.stringify(cache));
        clearForm();
        updateOfflineStatus();
    }

    // Синхронизация данных из оффлайн-кэша
    async function syncData() {
        if (!navigator.onLine) {
            showAlert('Ошибка', 'Вы не в сети. Невозможно синхронизировать.');
            return;
        }

        let cache = JSON.parse(localStorage.getItem('offlineCache') || '[]');
        if (cache.length === 0) {
            showAlert('Информация', 'Оффлайн-кэш пуст. Синхронизация не требуется.');
            return;
        }

        if (isTMA) Telegram.WebApp.MainButton.showLoader();
        let successCount = 0;

        for (const data of cache) {
            try {
                await db.collection('surveys').add(data);
                successCount++;
            } catch (e) {
                console.error("Ошибка синхронизации записи:", data, e);
                // Если ошибка, останавливаем синхронизацию и оставляем оставшиеся записи в кэше
                showAlert('Ошибка синхронизации', `Сбой при синхронизации ${successCount + 1}-й записи. Пожалуйста, проверьте подключение.`);
                break;
            }
        }

        // Обновляем кэш: оставляем только те, что не удалось отправить
        const remainingCache = cache.slice(successCount);
        localStorage.setItem('offlineCache', JSON.stringify(remainingCache));

        if (isTMA) Telegram.WebApp.MainButton.hideLoader();
        updateOfflineStatus();

        if (successCount > 0) {
            showAlert('Успешно', `Синхронизировано ${successCount} записей.`);
        } else if (remainingCache.length === 0) {
             showAlert('Успешно', 'Все данные синхронизированы!');
        }
    }


    // --- ВЫЗОВЫ ГЕОЛОКАЦИИ ---

    window.getLocation = function() {
        const locationStatus = document.getElementById('locationStatus');
        locationStatus.textContent = 'Определение...';
        document.getElementById('getLocationBtn').disabled = true;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lon = position.coords.longitude.toFixed(6);
                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lon;
                    locationStatus.textContent = `Определено: ${lat}, ${lon}`;
                    document.getElementById('getLocationBtn').disabled = false;
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    locationStatus.textContent = 'Ошибка гео: ' + error.message;
                    document.getElementById('latitude').value = '';
                    document.getElementById('longitude').value = '';
                    document.getElementById('getLocationBtn').disabled = false;
                    showAlert('Ошибка', 'Не удалось определить местоположение. Проверьте разрешения.');
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        } else {
            locationStatus.textContent = 'Геолокация не поддерживается.';
            document.getElementById('getLocationBtn').disabled = false;
            showAlert('Ошибка', 'Геолокация не поддерживается вашим браузером.');
        }
    }
    document.getElementById('getLocationBtn').onclick = getLocation;


    // --- ФУНКЦИИ ИНТЕРФЕЙСА ---

    // Заполнение выпадающих списков населенных пунктов
    function populateSettlements() {
        const selectForm = document.getElementById('settlement');
        const selectWalklist = document.getElementById('walklist-settlement');
        const selectReport = document.getElementById('reportSettlement');

        selectForm.innerHTML = '<option value="">Выберите нас. пункт</option>';
        selectWalklist.innerHTML = '<option value="Все">Все населенные пункты</option>';
        // reportSettlement уже имеет опцию 'Все'

        settlements.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent = s;
            selectForm.appendChild(opt);

            const optW = opt.cloneNode(true);
            selectWalklist.appendChild(optW);

            const optR = opt.cloneNode(true);
            selectReport.appendChild(optR);
        });
    }

    // Очистка формы
    function clearForm() {
        document.getElementById('settlement').value = '';
        document.getElementById('street').value = '';
        document.getElementById('house').value = '';
        document.getElementById('apartment').value = '';
        document.getElementById('action').value = '';
        document.getElementById('loyalty').value = '';
        document.getElementById('loyalty-group').classList.add('hidden');
        document.getElementById('requiresFollowup').checked = false;
        document.getElementById('comment').value = '';
        document.getElementById('latitude').value = '';
        document.getElementById('longitude').value = '';
        document.getElementById('locationStatus').textContent = 'Определить местоположение';
        document.getElementById('saveDataBtn').disabled = true; // Снова отключаем
    }

    // Обновление статуса оффлайн-кэша
    function updateOfflineStatus() {
        const cache = JSON.parse(localStorage.getItem('offlineCache') || '[]');
        const count = cache.length;
        document.getElementById('offlineCount').textContent = count;
        const syncBtn = document.getElementById('syncDataBtn');

        if (count > 0 && navigator.onLine) {
            syncBtn.classList.remove('hidden');
        } else {
            syncBtn.classList.add('hidden');
        }

        // Обновление онлайн-статуса
        document.getElementById('onlineStatus').textContent = navigator.onLine ? 'ОНЛАЙН' : 'ОФФЛАЙН';
        document.getElementById('onlineStatus').classList.toggle('text-green-500', navigator.onLine);
        document.getElementById('onlineStatus').classList.toggle('text-red-500', !navigator.onLine);
    }
    window.addEventListener('online', updateOfflineStatus);
    window.addEventListener('offline', updateOfflineStatus);
    document.getElementById('syncDataBtn').onclick = syncData;


    // Обработчик изменения действия для показа поля лояльности
    document.getElementById('action').addEventListener('change', (e) => {
        const loyaltyGroup = document.getElementById('loyalty-group');
        const loyaltySelect = document.getElementById('loyalty');
        if (e.target.value === 'Визит') {
            loyaltyGroup.classList.remove('hidden');
            loyaltySelect.required = true;
        } else {
            loyaltyGroup.classList.add('hidden');
            loyaltySelect.required = false;
            loyaltySelect.value = '';
        }
    });

    // Обработчик проверки формы для активации кнопки сохранения
    document.querySelectorAll('#data-form input, #data-form select, #data-form textarea').forEach(el => {
        el.addEventListener('input', () => {
            const form = document.getElementById('data-form');
            const requiredElements = form.querySelectorAll('[required]');
            let isFormValid = true;

            requiredElements.forEach(reqEl => {
                if (!reqEl.value.trim()) {
                    isFormValid = false;
                }
            });

            // Дополнительная проверка для поля "Лояльность"
            const action = document.getElementById('action').value;
            const loyalty = document.getElementById('loyalty').value;

            if (action === 'Визит' && !loyalty) {
                isFormValid = false;
            }

            document.getElementById('saveDataBtn').disabled = !isFormValid;
        });
    });

    document.getElementById('saveDataBtn').onclick = saveData;


    // --- ФУНКЦИИ НАВИГАЦИИ ---

    // Отображение секции
    window.showSection = function(sectionId) {
        // Скрываем все секции
        document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));

        // Деактивируем все навигационные элементы
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

        // Показываем запрошенную секцию и активируем навигационный элемент
        document.getElementById(sectionId).classList.remove('hidden');
        document.querySelector(`.nav-bar a[onclick*="${sectionId}"]`).classList.add('active');

        // Логика проверки PIN-кода для админ-секций
        if (['reports', 'admin'].includes(sectionId)) {
            if (isAdmin) {
                // Если админ уже залогинен (по PIN), показываем контент
                document.getElementById('pin-login-admin').classList.add('hidden');
                document.getElementById('admin-panel-content').classList.remove('hidden');
                document.getElementById('pin-login-reports').classList.add('hidden');
                document.getElementById('admin-reports-content').classList.remove('hidden');

                if (sectionId === 'reports') {
                    fetchAndRenderReports();
                }
            } else {
                // Если не залогинен, показываем форму PIN
                const pinSectionId = sectionId === 'admin' ? 'pin-login-admin' : 'pin-login-reports';
                const contentSectionId = sectionId === 'admin' ? 'admin-panel-content' : 'admin-reports-content';

                document.getElementById(pinSectionId).classList.remove('hidden');
                document.getElementById(contentSectionId).classList.add('hidden');

                // Пытаемся восстановить PIN из localStorage для удобства
                const lastPin = localStorage.getItem('lastPinAttempt') || '';
                document.getElementById('adminPinInput').value = lastPin;
                document.getElementById('reportsPinInput').value = lastPin;

                document.getElementById('pin-error-admin').classList.add('hidden');
                document.getElementById('pin-error-reports').classList.add('hidden');

            }
        } else {
            // Для обычных секций
            if (sectionId === 'walklist') {
                fetchAssignedAddresses();
            }
        }
    }


    // --- ФУНКЦИИ РАЗДЕЛА "СПИСОК ОБХОДА" (Walklist) ---

    let walklistDataCache = [];

    async function fetchAssignedAddresses() {
        // Назначаем заглушку, так как нет реального механизма назначения адресов
        document.getElementById('walklist-container').innerHTML = '<p class="text-gray-500 text-center">Загрузка адресов...</p>';

        try {
            // Имитация данных из Firestore (должна быть коллекция walklists/{settlement}/addresses)
            const addresses = [
                { id: '1', settlement: 'г. Конотоп', street: 'Мира', house: '15', apartment: '3', status: 'Новый' },
                { id: '2', settlement: 'г. Конотоп', street: 'Мира', house: '15', apartment: '8', status: 'Визит (ЗА)' },
                { id: '3', settlement: 'г. Конотоп', street: 'Киевская', house: '2', apartment: '', status: 'Не открыли' },
                { id: '4', settlement: 'с. Бочечки', street: 'Шевченко', house: '5', apartment: '1', status: 'Новый' },
                // ... реальные данные
            ];
            walklistDataCache = addresses;
            renderWalklist();

        } catch (e) {
            console.error("Error fetching walklist:", e);
            document.getElementById('walklist-container').innerHTML = '<p class="text-red-500 text-center">Ошибка загрузки списка обхода.</p>';
        }
    }

    function renderWalklist() {
        const filterSettlement = document.getElementById('walklist-settlement').value;
        const container = document.getElementById('walklist-container');
        container.innerHTML = '';

        const filteredList = filterSettlement === 'Все'
            ? walklistDataCache
            : walklistDataCache.filter(item => item.settlement === filterSettlement);

        if (filteredList.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center">Список обхода пуст или нет данных по выбранному фильтру.</p>';
            return;
        }

        filteredList.forEach(item => {
            let statusClass = 'bg-gray-100 text-gray-700';
            if (item.status.includes('ЗА')) statusClass = 'bg-green-100 text-green-700';
            else if (item.status.includes('ПРОТИВ') || item.status.includes('Отказ')) statusClass = 'bg-red-100 text-red-700';
            else if (item.status.includes('Визит') || item.status.includes('Не открыли')) statusClass = 'bg-yellow-100 text-yellow-700';

            const apartmentText = item.apartment ? `, кв. ${item.apartment}` : '';

            const itemHtml = `
                <div class="p-3 border rounded-lg hover:shadow-md transition-shadow cursor-pointer bg-white" onclick="selectAddressForForm('${item.settlement}', '${item.street}', '${item.house}', '${item.apartment || ''}')">
                    <p class="font-semibold text-base">${item.street}, д. ${item.house}${apartmentText}</p>
                    <p class="text-xs text-gray-500 mb-1">${item.settlement}</p>
                    <span class="text-xs font-medium ${statusClass} px-2 py-1 rounded-full">${item.status}</span>
                </div>
            `;
            container.innerHTML += itemHtml;
        });
        lucide.createIcons();
    }

    // Выбор адреса для заполнения основной формы
    window.selectAddressForForm = function(settlement, street, house, apartment) {
        document.getElementById('settlement').value = settlement;
        document.getElementById('street').value = street;
        document.getElementById('house').value = house;
        document.getElementById('apartment').value = apartment;

        // Переключаемся на форму
        showSection('form');
        document.getElementById('saveDataBtn').disabled = false; // Разблокируем кнопку, т.к. поля заполнены

        // Скроллим к началу формы, чтобы было видно
        window.scrollTo(0, 0);
    }

    // Привязываем фильтр к рендерингу
    document.getElementById('walklist-settlement').onchange = renderWalklist;


    // --- ФУНКЦИИ РАЗДЕЛА "ОТЧЕТЫ" (Reports) ---

    let loyaltyChartInstance = null;
    let actionChartInstance = null;

    async function fetchAndRenderReports() {
        if (!isAdmin) return; // Проверка на админа

        const reportSettlement = document.getElementById('reportSettlement').value;
        const reportPeriod = document.getElementById('reportPeriod').value;

        if (isTMA) Telegram.WebApp.MainButton.showLoader();

        try {
            let query = db.collection('surveys').orderBy('timestamp', 'desc');

            // 1. Фильтр по населенному пункту
            if (reportSettlement !== 'Все') {
                query = query.where('settlement', '==', reportSettlement);
            }

            // 2. Фильтр по периоду
            const now = new Date().getTime();
            let startTime = 0;
            if (reportPeriod !== 'all') {
                const days = parseInt(reportPeriod, 10);
                startTime = now - (days * 24 * 60 * 60 * 1000);
            }
            if (startTime > 0) {
                 query = query.where('timestamp', '>=', startTime);
            }

            // Получаем данные
            const snapshot = await query.get();
            dataCache = snapshot.docs.map(doc => doc.data());
            
            if (dataCache.length === 0) {
                 // Очистка и показ "Нет данных"
                 document.getElementById('totalRecords').textContent = '0';
                 document.getElementById('uniqueUsers').textContent = '0';
                 document.getElementById('latest-data-container').innerHTML = '<p class="text-gray-500 text-center">Нет данных по заданным фильтрам.</p>';
                 renderCharts([], []);
                 generateMap([]);
                 return;
            }

            // Агрегация данных
            const { loyaltyData, actionData, mapPoints, userSet } = aggregateData(dataCache);

            // Обновление сводки
            document.getElementById('totalRecords').textContent = dataCache.length;
            document.getElementById('uniqueUsers').textContent = userSet.size;

            // Рендеринг
            renderCharts(loyaltyData, actionData);
            renderLatestData(dataCache.slice(0, 20)); // Последние 20 записей
            generateMap(mapPoints);

        } catch (e) {
            console.error("Error fetching reports:", e);
            showAlert('Ошибка', 'Не удалось загрузить отчеты: ' + e.message);
        } finally {
            if (isTMA) Telegram.WebApp.MainButton.hideLoader();
        }
    }
    window.fetchAndRenderReports = fetchAndRenderReports;


    function aggregateData(data) {
        const loyaltyCounts = { 'ЗА': 0, 'НЕЙТРАЛ': 0, 'ПРОТИВ': 0, 'Не определено': 0 };
        const actionCounts = {};
        const mapPoints = [];
        const userSet = new Set();

        data.forEach(doc => {
            userSet.add(doc.user_id);

            // Лояльность
            if (doc.action === 'Визит' && doc.loyalty) {
                loyaltyCounts[doc.loyalty] = (loyaltyCounts[doc.loyalty] || 0) + 1;
            } else if (doc.action === 'Визит' && !doc.loyalty) {
                loyaltyCounts['Не определено']++;
            }

            // Действия
            actionCounts[doc.action] = (actionCounts[doc.action] || 0) + 1;

            // Геолокация
            if (doc.location && doc.location.latitude && doc.location.longitude) {
                // [lat, lng, intensity (по умолчанию 1)]
                mapPoints.push([doc.location.latitude, doc.location.longitude, 1]);
            }
        });

        // Преобразование для Chart.js
        const loyaltyData = {
            labels: Object.keys(loyaltyCounts),
            data: Object.values(loyaltyCounts),
            colors: ['#34d399', '#facc15', '#ef4444', '#9ca3af'] // green, yellow, red, gray
        };

        const actionData = {
            labels: Object.keys(actionCounts),
            data: Object.values(actionCounts),
            colors: Object.keys(actionCounts).map(() => `hsl(${Math.random() * 360}, 70%, 50%)`)
        };

        return { loyaltyData, actionData, mapPoints, userSet };
    }


    function renderCharts(loyaltyData, actionData) {
        // Лояльность
        const loyaltyCtx = document.getElementById('loyaltyChart').getContext('2d');
        if (loyaltyChartInstance) loyaltyChartInstance.destroy();

        if (loyaltyData.data && loyaltyData.data.some(d => d > 0)) {
            loyaltyChartInstance = new Chart(loyaltyCtx, {
                type: 'pie',
                data: {
                    labels: loyaltyData.labels,
                    datasets: [{
                        data: loyaltyData.data,
                        backgroundColor: loyaltyData.colors,
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'right' } }
                }
            });
        } else {
            // Заглушка, если нет данных
            loyaltyCtx.clearRect(0, 0, loyaltyCtx.canvas.width, loyaltyCtx.canvas.height);
            loyaltyCtx.textAlign = 'center';
            loyaltyCtx.fillStyle = '#9ca3af';
            loyaltyCtx.fillText('Нет данных о лояльности для отображения', loyaltyCtx.canvas.width / 2, loyaltyCtx.canvas.height / 2);
        }

        // Действия
        const actionCtx = document.getElementById('actionChart').getContext('2d');
        if (actionChartInstance) actionChartInstance.destroy();

        if (actionData.data && actionData.data.some(d => d > 0)) {
            actionChartInstance = new Chart(actionCtx, {
                type: 'bar',
                data: {
                    labels: actionData.labels,
                    datasets: [{
                        label: 'Количество',
                        data: actionData.data,
                        backgroundColor: actionData.colors,
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        } else {
            actionCtx.clearRect(0, 0, actionCtx.canvas.width, actionCtx.canvas.height);
            actionCtx.textAlign = 'center';
            actionCtx.fillStyle = '#9ca3af';
            actionCtx.fillText('Нет данных о действиях для отображения', actionCtx.canvas.width / 2, actionCtx.canvas.height / 2);
        }
    }


    function renderLatestData(data) {
        const container = document.getElementById('latest-data-container');
        container.innerHTML = '';
        if (data.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center">Нет последних записей.</p>';
            return;
        }

        data.forEach(doc => {
            const timestamp = new Date(doc.timestamp).toLocaleString();
            const loyaltyBadge = doc.loyalty ? `<span class="text-xs font-medium px-2 py-0.5 rounded-full ${doc.loyalty === 'ЗА' ? 'bg-green-100 text-green-700' : doc.loyalty === 'ПРОТИВ' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${doc.loyalty}</span>` : '';
            const locationText = doc.location && doc.location.latitude ? ` (${doc.location.latitude.toFixed(2)}, ${doc.location.longitude.toFixed(2)})` : '';
            const address = `${doc.settlement}, ${doc.street}, д. ${doc.house}` + (doc.apartment ? `, кв. ${doc.apartment}` : '');

            container.innerHTML += `
                <div class="border-b pb-2">
                    <div class="flex justify-between items-start">
                        <p class="font-semibold text-gray-800">${address}</p>
                        ${loyaltyBadge}
                    </div>
                    <p class="text-xs text-gray-500">${timestamp} - ${doc.full_name || doc.user_id}</p>
                    <p class="text-sm mt-1">Действие: ${doc.action}</p>
                    ${doc.comment ? `<p class="text-sm italic text-gray-600 truncate">${doc.comment}</p>` : ''}
                </div>
            `;
        });
    }


    // Инициализация карты (Гео)
    let markerClusterGroup = null;

    function generateMap(mapPoints) {
        // Убедимся, что карта инициализирована только один раз
        if (!mapInstance) {
            mapInstance = L.map('map').setView([47.9333, 33.3667], 6); // Центр Украины
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);
        }

        // Удаляем старый тепловой слой, если он есть
        if (heatmapLayer) {
            mapInstance.removeLayer(heatmapLayer);
        }

        // Если есть точки, добавляем новый тепловой слой
        if (mapPoints.length > 0) {
            heatmapLayer = L.heatLayer(mapPoints, { radius: 25 }).addTo(mapInstance);
            
            // Определяем границы для зумирования
            const latLngs = mapPoints.map(p => [p[0], p[1]]);
            const bounds = L.latLngBounds(latLngs);

            // Если границы валидны, устанавливаем их
            if (bounds.isValid()) {
                mapInstance.fitBounds(bounds, { padding: [20, 20] });
            }
        }
        
        // Дополнительная логика: кластеризация маркеров (для точечного отображения)
        // Для простоты оставим только Heatmap, но можно добавить и кластеры:
        /*
        if (markerClusterGroup) {
            mapInstance.removeLayer(markerClusterGroup);
        }
        markerClusterGroup = L.markerClusterGroup();
        mapPoints.forEach(p => {
            markerClusterGroup.addLayer(L.marker([p[0], p[1]]));
        });
        mapInstance.addLayer(markerClusterGroup);
        */
    }


    // --- ФУНКЦИИ ОПАСНОЙ ЗОНЫ ---

    // Очистка базы данных (Удаление коллекции 'surveys')
    async function clearDatabase() {
        if (!isAdmin) {
            showAlert('Ошибка доступа', 'У вас нет прав администратора.');
            return;
        }

        if (isTMA) Telegram.WebApp.MainButton.showLoader();

        try {
            const collectionRef = db.collection('surveys');
            const snapshot = await collectionRef.limit(500).get(); // Ограничение на удаление
            
            let deletedCount = 0;
            const batch = db.batch();

            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
                deletedCount++;
            });

            await batch.commit();

            // Рекурсивный вызов, если удалено максимальное количество
            if (deletedCount === 500) {
                // Если было удалено 500, возможно, остались еще. Вызываем снова.
                await clearDatabase(); 
                return;
            }

            // Очистка оффлайн-кэша и обновление
            localStorage.removeItem('offlineCache');
            dataCache = []; // Очищаем локальный кеш после удаления
            updateOfflineStatus();
            showAlert('Успешно!', `Удалено ${deletedCount} записей. Данные Firestore очищены.`);

            if (isAdmin) fetchAndRenderReports();

            return true;

        } catch (e) {
             console.error("Error deleting collection:", e);
             showAlert('Ошибка', 'Произошла ошибка при удалении коллекции: ' + e.message);
             return false;
        } finally {
             if (isTMA) Telegram.WebApp.MainButton.hideLoader();
        }
    };
    window.clearDatabase = clearDatabase;


    // --- ЭКСПОРТ ---

    function exportToXLSX() {
        if (dataCache.length === 0) {
            showAlert('Ошибка', 'Нет данных для экспорта. Пожалуйста, обновите отчеты.');
            return;
        }
        const exportData = dataCache.map(doc => ({
            'Время': new Date(doc.timestamp).toLocaleString(), 'ID Пользователя': doc.user_id, 'Агитатор (ФИО)': doc.full_name || doc.username,
            'Населенный пункт': doc.settlement, 'Улица': doc.street, 'Дом': doc.house, 'Квартира': doc.apartment, 'Действие': doc.action,
            'Лояльность': doc.loyalty, 'Требуется Повтор': doc.requires_followup ? 'ДА' : 'НЕТ', 'Комментарий': doc.comment,
            'Широта': doc.location ? doc.location.latitude : 'N/A', 'Долгота': doc.location ? doc.location.longitude : 'N/A',
        }));
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Данные");
        XLSX.writeFile(workbook, "agitator_data_" + new Date().toISOString().slice(0, 10) + ".xlsx");
    }
    window.exportToXLSX = exportToXLSX;


    // --- ИНИЦИАЛИЗАЦИЯ WEBAPP ---
    if (isTMA) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
    }

    // 🔑 Инициализация при загрузке
    window.onload = async () => {
        // 1. Сначала аутентификация для установки isAdmin и userTelegramId
        await authenticateUser();

        // 2. Затем заполнение интерфейса
        populateSettlements();
        updateOfflineStatus();
        window.showSection('form');
        lucide.createIcons();

        // ОТЛАДКА: Повторное обновление полей, чтобы гарантировать актуальность
        document.getElementById('debugUserId').textContent = userTelegramId || 'Нет ID';
        document.getElementById('debugAdminStatus').textContent = isAdmin ? 'ДА (PIN)' : 'НЕТ';

        if (!firebaseConfig.projectId) {
            window.showAlert('ВНИМАНИЕ', 'Необходимо вставить ключи конфигурации Firebase в код.');
        }
    };

</script>
</body>
</html>
