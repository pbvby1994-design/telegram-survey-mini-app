<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥ iOS: –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω, –º—è–≥–∫–∏–µ —Ç–µ–Ω–∏, —Å–∏—Å—Ç–µ–º–Ω—ã–π —à—Ä–∏—Ñ—Ç */
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f2f2f7; /* iOS Light Gray */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-bottom: 80px; /* –î–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏ */
        }
        /* –ö—Ä—É–ø–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ —Å—Ç–∏–ª–µ iOS */
        #main-title {
            font-size: 28px; /* –ù–µ–º–Ω–æ–≥–æ –º–µ–Ω—å—à–µ, —á–µ–º –Ω–∞—Ç–∏–≤–Ω–æ–µ iOS */
            font-weight: 700;
        }
        .ios-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.02);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .ios-button {
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }
        /* –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å */
        .ios-nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 64px;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 -1px 0 rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #8e8e93; /* iOS Secondary Label */
            transition: color 0.2s;
            cursor: pointer;
            padding: 4px;
        }
        .nav-item.active {
            color: #007aff; /* iOS Blue */
        }
        .nav-item svg {
            width: 24px;
            height: 24px;
        }
        .nav-item-label {
            font-size: 10px;
            margin-top: 2px;
            font-weight: 500;
        }
        input[type="text"], input[type="number"], select, textarea, input[type="date"] {
            border: 1px solid #d1d1d6; /* iOS Separator */
            border-radius: 8px;
            padding: 10px;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus, input[type="date"]:focus {
            border-color: #007aff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –¥–ª—è Telegram WebApp */
        #main-container {
            max-width: 600px;
            margin: 0 auto;
        }
    </style>
</head>
<body>

<div id="main-container" class="p-4">
    <header class="mb-6">
        <h1 class="text-3xl font-bold tracking-tight mb-1 text-gray-900" id="main-title">–ü–∞–Ω–µ–ª—å</h1>
        <p class="text-base text-gray-500 font-medium" id="user-status"></p>
    </header>

    <div id="content-container">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —Å—é–¥–∞ -->
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-30 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div class="ios-card p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-xl font-semibold mb-3">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end">
                <button onclick="closeModal()" class="ios-button bg-blue-500 hover:bg-blue-600 text-white py-2 px-4">OK</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–£–¥–∞–ª–µ–Ω–∏–µ) -->
    <div id="admin-modal" class="fixed inset-0 bg-gray-900 bg-opacity-30 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div class="ios-card p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-3 text-red-600">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</h3>
            <p class="text-gray-600 mb-6">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ë–ï–ó–í–û–ó–í–†–ê–¢–ù–û —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã Firestore? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. (–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –±–æ—Ç–∞).</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeAdminModal()" class="ios-button bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-4">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="confirmDeleteAll()" class="ios-button bg-red-500 hover:bg-red-600 text-white py-2 px-4">–£–¥–∞–ª–∏—Ç—å –í—Å–µ</button>
            </div>
        </div>
    </div>
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –≤ —Å—Ç–∏–ª–µ iOS -->
<div class="ios-nav-bar">
    <div id="nav-form" class="nav-item active" onclick="navigate('form')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m10 8 4 4-4 4"/></svg>
        <span class="nav-item-label">–ó–∞–ø–∏—Å—å</span>
    </div>
    <div id="nav-reports" class="nav-item" onclick="navigate('reports')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/><path d="M12 10a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"/><path d="M12 2v2"/><path d="M22 12h-2"/><path d="M4 12H2"/><path d="M12 22v-2"/></svg>
        <span class="nav-item-label">–û—Ç—á–µ—Ç—ã</span>
    </div>
    <div id="nav-settings" class="nav-item" onclick="navigate('settings')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44C9.76 2 8 3.76 8 5.86c0 1.25.7 2.37 1.83 2.94L12 10l2.17-1.2C15.3 8.23 16 7.11 16 5.86C16 3.76 14.24 2 12.22 2z"/><path d="M15 14h1"/><path d="M8 14H7"/><path d="M15 17h1"/><path d="M8 17H7"/><path d="M15 20h1"/><path d="M8 20H7"/><path d="M12 14v6"/></svg>
        <span class="nav-item-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
    </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
    // @ts-nocheck
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDocs, collection, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";
    
    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (–ó–ê–î–ê–Æ–¢–°–Ø –û–ö–†–£–ñ–ï–ù–ò–ï–ú CANVAS) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-agitation-app';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // ID –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å ADMIN_ID –≤ –±–æ—Ç–µ)
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∑—è—Ç–æ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
    const ADMIN_TELEGRAM_ID = 541459471; 

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ---
    if (Object.keys(firebaseConfig).length === 0) {
        console.error("Firebase config is missing!");
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    setLogLevel('Debug');
    
    let currentUserId = null;
    let isAdmin = false;
    let initialAuthChecked = false;
    let telegramUser = null;


    // –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
    const SETTLEMENTS = ["–≥.–ø. –ë–∞—Ä—Å–æ–≤–æ", "—Å.–ø. –°–æ–ª–Ω–µ—á–Ω—ã–π", "—Å.–ø. –¢—É–Ω–¥—Ä–∏–Ω–æ", "—Å.–ø. –õ—è–º–∏–Ω–∞", "–≥.–ø. –õ—è–Ω—Ç–æ—Ä", "–≥.–ø. –§–µ–¥–æ—Ä–æ–≤—Å–∫–∏–π", "–≥.–ø. –ë–µ–ª—ã–π –Ø—Ä", "—Å.–ø. –£–ª—å—Ç-–Ø–≥—É–Ω", "—Å.–ø. –°—ã—Ç–æ–º–∏–Ω–æ", "—Å.–ø. –†—É—Å—Å–∫–∏–Ω—Å–∫–∞—è", "—Å.–ø. –ù–∏–∂–Ω–µ—Å–æ—Ä—Ç—ã–º—Å–∫–∏–π", "—Å.–ø. –£–≥—É—Ç", "—Å.–ø. –õ–æ–∫–æ—Å–æ–≤–æ"];
    const ACTION_RESULTS = {
        'positive': '–ü–æ–¥–¥–µ—Ä–∂–∞–ª',
        'negative': '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∞–ª'
    };
    const LOYALTY_OPTIONS = {
        'loyal': '–õ–æ—è–ª–µ–Ω',
        'doubtful': '–°–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è',
        'not_loyal': '–ù–µ –ª–æ—è–ª–µ–Ω',
        'not_opened': '–ù–µ –æ—Ç–∫—Ä—ã–ª–∏'
    };

    // --- –£–¢–ò–õ–ò–¢–´ ---
    
    function getTelegramUser() {
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
            return window.Telegram.WebApp.initDataUnsafe.user;
        }
        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram
        return { id: ADMIN_TELEGRAM_ID, first_name: '–¢–µ—Å—Ç', username: 'tester' };
    }
    
    function showModal(title, message) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-message').innerText = message;
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal').classList.add('flex');
    }

    function closeModal() {
        document.getElementById('modal').classList.add('hidden');
        document.getElementById('modal').classList.remove('flex');
    }
    
    function getCollectionPath() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é, —á—Ç–æ–±—ã –≤—Å–µ –∑–∞–ø–∏—Å–∏ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
        return `artifacts/${appId}/public/data/surveys`;
    }
    const SURVEYS_COLLECTION = getCollectionPath();
    
    // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø FIREBASE ---
    
    onAuthStateChanged(auth, async (user) => {
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é db
        if (!initialAuthChecked && db) {
            telegramUser = getTelegramUser();
            
            if (user) {
                currentUserId = user.uid;
            } else {
                // –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
                currentUserId = 'anon_' + (telegramUser.id || crypto.randomUUID()); 
                await signInAnonymously(auth).catch(e => console.error("Anon sign-in error:", e));
                currentUserId = auth.currentUser.uid;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞ (–ø–æ Telegram ID, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ initData)
            isAdmin = (telegramUser.id == ADMIN_TELEGRAM_ID);
            
            document.getElementById('user-status').innerText = isAdmin 
                ? `–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (ID: ${currentUserId.substring(0, 8)}...)` 
                : `–ê–≥–∏—Ç–∞—Ç–æ—Ä (ID: ${currentUserId.substring(0, 8)}...)`;

            navigate('form'); // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            initialAuthChecked = true;
        }
    });

    if (initialAuthToken) {
         signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Custom token sign-in error:", e));
    }

    // --- –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò –ò –†–ï–ù–î–ï–†–ò–ù–ì–ê ---
    
    let currentPage = 'form';
    
    window.navigate = (page) => {
        if (!initialAuthChecked) return;
        
        // –î–ª—è –Ω–µ-–∞–¥–º–∏–Ω–æ–≤ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —Ä–∞–∑–¥–µ–ª 'form' –∏ 'settings'
        if (!isAdmin && page === 'reports') {
             showModal('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.');
             return;
        }
        
        currentPage = page;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.getElementById(`nav-${page}`).classList.add('active');
        
        const contentContainer = document.getElementById('content-container');
        contentContainer.innerHTML = '';
        
        switch (page) {
            case 'form':
                document.getElementById('main-title').innerText = '–ù–æ–≤–∞—è –ó–∞–ø–∏—Å—å';
                renderForm(contentContainer);
                break;
            case 'reports':
                document.getElementById('main-title').innerText = '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –û—Ç—á–µ—Ç—ã';
                renderReports(contentContainer);
                break;
            case 'settings':
                document.getElementById('main-title').innerText = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏';
                renderSettings(contentContainer);
                break;
        }
    }
    
    // --- –†–ê–ó–î–ï–õ 1: –§–û–†–ú–ê –ê–ì–ò–¢–ê–¢–û–†–ê ---
    
    function renderForm(container) {
        container.innerHTML = `
            <div class="ios-card p-4 space-y-4 mb-4">
                <h2 class="text-lg font-semibold border-b pb-2 mb-4">–î–∞–Ω–Ω—ã–µ –û–±—ä–µ–∫—Ç–∞</h2>
                <input type="hidden" id="form-doc-id" value="">
                
                <div>
                    <label for="settlement" class="block text-sm font-medium text-gray-700 mb-1">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ü—É–Ω–∫—Ç</label>
                    <select id="settlement" class="w-full">
                        ${SETTLEMENTS.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                
                <div>
                    <label for="street" class="block text-sm font-medium text-gray-700 mb-1">–£–ª–∏—Ü–∞</label>
                    <input type="text" id="street" placeholder="–í–≤–µ–¥–∏—Ç–µ —É–ª–∏—Ü—É" class="w-full" required>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="house" class="block text-sm font-medium text-gray-700 mb-1">–ù–æ–º–µ—Ä –î–æ–º–∞</label>
                        <input type="text" id="house" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 10–ê" class="w-full" required>
                    </div>
                    <div>
                        <label for="apartment" class="block text-sm font-medium text-gray-700 mb-1">–ö–≤–∞—Ä—Ç–∏—Ä–∞ (–æ–ø—Ü.)</label>
                        <input type="text" id="apartment" placeholder="–ö–≤. 5" class="w-full">
                    </div>
                </div>
            </div>

            <div class="ios-card p-4 space-y-4 mb-4">
                <h2 class="text-lg font-semibold border-b pb-2 mb-4">–†–µ–∑—É–ª—å—Ç–∞—Ç –ö–æ–Ω—Ç–∞–∫—Ç–∞</h2>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–î–µ–π—Å—Ç–≤–∏–µ</label>
                    <div id="action-result-options" class="grid grid-cols-2 gap-2">
                        <button data-value="positive" class="ios-button action-btn py-2 bg-gray-100 hover:bg-green-100 border border-gray-300">‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∞–ª</button>
                        <button data-value="negative" class="ios-button action-btn py-2 bg-gray-100 hover:bg-red-100 border border-gray-300">‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∞–ª</button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å / –ü—Ä–∏—á–∏–Ω–∞</label>
                    <select id="loyalty" class="w-full">
                        ${Object.entries(LOYALTY_OPTIONS).map(([key, value]) => `<option value="${key}">${value}</option>`).join('')}
                    </select>
                </div>
            </div>

            <div class="ios-card p-4 space-y-4 mb-4">
                <h2 class="text-lg font-semibold border-b pb-2 mb-4">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h2>
                
                <div>
                    <label for="comment" class="block text-sm font-medium text-gray-700 mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea id="comment" rows="3" placeholder="–û—Å–æ–±—ã–µ –æ—Ç–º–µ—Ç–∫–∏ –∏–ª–∏ —Ä–µ–∞–∫—Ü–∏—è" class="w-full"></textarea>
                </div>
                
                <div class="flex space-x-2">
                    <button onclick="getLocation()" id="location-button" class="ios-button flex-1 py-3 bg-gray-100 hover:bg-blue-100 border border-gray-300 text-blue-600">
                        <svg class="inline w-5 h-5 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 17.64A9 9 0 1 0 12 22v-3.37"/><circle cx="12" cy="11.5" r="3"/><path d="m22 2-7.5 7.5"/></svg>
                        –ì–µ–æ–ø–æ–∑–∏—Ü–∏—è
                    </button>
                    <button onclick="requestPhoto()" id="photo-button" class="ios-button flex-1 py-3 bg-gray-100 hover:bg-purple-100 border border-gray-300 text-purple-600">
                        <svg class="inline w-5 h-5 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.08-3.08a2 2 0 0 0-2.83 0L6 21"/></svg>
                        –ó–∞–ø—Ä–æ—Å–∏—Ç—å –§–æ—Ç–æ
                    </button>
                </div>
                <div id="location-status" class="text-xs text-gray-500 mt-1"></div>
                <div id="photo-status" class="text-xs text-gray-500 mt-1"></div>
            </div>
            
            <button onclick="submitSurvey()" class="ios-button w-full py-3 text-lg bg-blue-500 hover:bg-blue-600 text-white shadow-lg shadow-blue-500/50">
                üíæ –°–û–•–†–ê–ù–ò–¢–¨ –ó–ê–ü–ò–°–¨
            </button>
            
            <button onclick="duplicateSurvey()" id="duplicate-button" class="ios-button w-full py-2 mt-2 text-base bg-gray-200 hover:bg-gray-300 text-gray-700 hidden">
                üîÑ –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ü—Ä–µ–¥—ã–¥—É—â—É—é –ó–∞–ø–∏—Å—å
            </button>
        `;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // –°–±—Ä–æ—Å –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                document.querySelectorAll('.action-btn').forEach(b => {
                    b.classList.remove('bg-blue-500', 'text-white', 'border-blue-500', 'shadow-sm');
                    b.classList.add('bg-gray-100', 'border-gray-300');
                });
                // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π
                this.classList.add('bg-blue-500', 'text-white', 'border-blue-500', 'shadow-sm');
                this.classList.remove('bg-gray-100', 'border-gray-300');
            });
        });

         loadLastSurvey();
    }
    
    let lastSurveyData = null;
    let currentGeo = { lat: 0.0, lng: 0.0 };

    async function loadLastSurvey() {
        // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ db –∏ currentUserId –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        if (!currentUserId || !db) {
            console.error("loadLastSurvey: Auth not ready or DB not initialized.");
            return;
        }

        // –ó–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const q = query(collection(db, SURVEYS_COLLECTION), where("userId", "==", currentUserId));
        
        try {
            const snapshot = await getDocs(q);
            
            if (!snapshot.empty) {
                // –í Firestore –Ω–µ—Ç orderBy –±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –ø–∞–º—è—Ç–∏ –ø–æ –ø–æ–ª—é 'date'
                const sortedDocs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (sortedDocs.length > 0) {
                    lastSurveyData = sortedDocs[0];
                    document.getElementById('duplicate-button').classList.remove('hidden');
                    return;
                }
            }
        } catch (e) {
             console.error("Error loading last survey (Permissions issue likely):", e);
        }
        document.getElementById('duplicate-button').classList.add('hidden');
        lastSurveyData = null;
    }

    window.duplicateSurvey = () => {
        if (!lastSurveyData) return;
        
        document.getElementById('settlement').value = lastSurveyData.settlement;
        document.getElementById('street').value = lastSurveyData.street;
        document.getElementById('house').value = lastSurveyData.house;
        document.getElementById('apartment').value = lastSurveyData.apartment;
        
        // –°–±—Ä–æ—Å –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª–µ–π
        document.getElementById('loyalty').value = 'not_opened';
        document.getElementById('comment').value = '';
        document.getElementById('form-doc-id').value = '';
        document.getElementById('photo-status').innerText = '';
        
        // –°–±—Ä–æ—Å –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è
        document.querySelectorAll('.action-btn').forEach(b => {
            b.classList.remove('bg-blue-500', 'text-white', 'border-blue-500', 'shadow-sm');
            b.classList.add('bg-gray-100', 'border-gray-300');
        });
        
        // –°–±—Ä–æ—Å –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏
        currentGeo = { lat: 0.0, lng: 0.0 };
        document.getElementById('location-status').innerText = '';
        document.getElementById('location-button').classList.remove('bg-green-500', 'text-white');
        document.getElementById('location-button').classList.add('bg-gray-100', 'text-blue-600');
        
        showModal('–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ', '–ê–¥—Ä–µ—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–ø–∏—Å–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ.');
    }
    
    window.getLocation = () => {
        if (!navigator.geolocation) {
            showModal('–û—à–∏–±–∫–∞', '–í–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏.');
            return;
        }

        const status = document.getElementById('location-status');
        status.innerText = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...';
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentGeo.lat = position.coords.latitude;
                currentGeo.lng = position.coords.longitude;
                status.innerText = `–ì–µ–æ–ø–æ–∑–∏—Ü–∏—è: ${currentGeo.lat.toFixed(4)}, ${currentGeo.lng.toFixed(4)}`;
                document.getElementById('location-button').classList.remove('bg-gray-100', 'text-blue-600');
                document.getElementById('location-button').classList.add('bg-green-500', 'text-white');
            },
            (error) => {
                console.error("Geolocation error:", error);
                status.innerText = '–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è: ' + error.message;
                currentGeo = { lat: 0.0, lng: 0.0 };
                document.getElementById('location-button').classList.remove('bg-green-500', 'text-white');
                document.getElementById('location-button').classList.add('bg-gray-100', 'text-blue-600');
                showModal('–û—à–∏–±–∫–∞ –ì–µ–æ–ø–æ–∑–∏—Ü–∏–∏', `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã. –ö–æ–¥ –æ—à–∏–±–∫–∏: ${error.code}.`);
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    }

    window.requestPhoto = () => {
        const docId = crypto.randomUUID(); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ —Ñ–æ—Ç–æ
        document.getElementById('form-doc-id').value = docId;
        
        const photoStatus = document.getElementById('photo-status');
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –±–æ—Ç—É
        const data = {
            action: 'request_photo',
            docId: docId // ID, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –±–æ—Ç –ø—Ä–∏–≤—è–∂–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞
        };
        
        if (window.Telegram && window.Telegram.WebApp) {
             Telegram.WebApp.sendData(JSON.stringify(data));
             photoStatus.innerText = `–û–∂–∏–¥–∞–Ω–∏–µ —Ñ–æ—Ç–æ –¥–ª—è ID: ${docId.substring(0, 8)}. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º.`;
             showModal('–ó–∞–ø—Ä–æ—Å –§–æ—Ç–æ', '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é. –ë–æ—Ç —Å–∞–º –ø—Ä–∏–≤—è–∂–µ—Ç –µ–µ –∫ —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏.');
        } else {
             photoStatus.innerText = '–û—à–∏–±–∫–∞: Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.';
             showModal('–û—à–∏–±–∫–∞', 'Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ç–æ.');
        }
    }

    window.submitSurvey = async () => {
        // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ db –∏ currentUserId –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        if (!currentUserId || !db) {
            showModal('–û—à–∏–±–∫–∞', '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –≥–æ—Ç–æ–≤–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return;
        }

        const settlement = document.getElementById('settlement').value;
        const street = document.getElementById('street').value.trim();
        const house = document.getElementById('house').value.trim();
        const apartment = document.getElementById('apartment').value.trim() || '0';
        const loyalty = document.getElementById('loyalty').value;
        const comment = document.getElementById('comment').value.trim();
        const photoDocId = document.getElementById('form-doc-id').value;
        
        const selectedActionBtn = document.querySelector('.action-btn.bg-blue-500');
        const action_result = selectedActionBtn ? selectedActionBtn.getAttribute('data-value') : '';

        if (!street || !house || !action_result) {
            showModal('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –£–ª–∏—Ü–∞, –î–æ–º –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –†–µ–∑—É–ª—å—Ç–∞—Ç –î–µ–π—Å—Ç–≤–∏—è.');
            return;
        }
        
        const newDocRef = doc(collection(db, SURVEYS_COLLECTION));
        const dataToSave = {
            docId: newDocRef.id,
            userId: currentUserId,
            username: telegramUser.username || telegramUser.first_name,
            date: new Date().toISOString(),
            settlement: settlement,
            street: street,
            house: house,
            apartment: apartment,
            action_result: action_result,
            loyalty: loyalty,
            comment: comment,
            latitude: currentGeo.lat,
            longitude: currentGeo.lng,
            // –ò–º—è —Ñ–∞–π–ª–∞, –∫–æ—Ç–æ—Ä–æ–µ –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–æ—Ç
            photo_file_id: photoDocId ? `${photoDocId}_${telegramUser.id}.jpg` : ''
        };
        
        try {
            await setDoc(newDocRef, dataToSave);
            showModal('–£—Å–ø–µ—à–Ω–æ!', '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö Firestore.');
            
            // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
            document.getElementById('street').value = '';
            document.getElementById('house').value = '';
            document.getElementById('apartment').value = '';
            document.getElementById('comment').value = '';
            document.getElementById('loyalty').value = 'not_opened';
            document.getElementById('form-doc-id').value = '';
            document.getElementById('photo-status').innerText = '';
            currentGeo = { lat: 0.0, lng: 0.0 };
            document.getElementById('location-status').innerText = '';
            document.getElementById('location-button').classList.remove('bg-green-500', 'text-white');
            document.getElementById('location-button').classList.add('bg-gray-100', 'text-blue-600');
            document.querySelectorAll('.action-btn').forEach(b => {
                b.classList.remove('bg-blue-500', 'text-white', 'border-blue-500', 'shadow-sm');
                b.classList.add('bg-gray-100', 'border-gray-300');
            });
            loadLastSurvey(); // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å
        } catch (e) {
            console.error("Error saving document: ", e);
            showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        }
    }
    
    // --- –†–ê–ó–î–ï–õ 2: –û–¢–ß–ï–¢–´ –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê ---
    
    function renderReports(container) {
        if (!isAdmin) {
             container.innerHTML = `<div class="ios-card p-6 text-center text-red-600 font-semibold">‚ùå –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</div>`;
             return;
        }
        
        container.innerHTML = `
            <div class="ios-card p-4 space-y-4 mb-4">
                <h2 class="text-lg font-semibold border-b pb-2 mb-4">–§–∏–ª—å—Ç—Ä—ã</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="start_date" class="block text-sm font-medium text-gray-700 mb-1">–° –¥–∞—Ç—ã</label>
                        <input type="date" id="start_date" class="w-full">
                    </div>
                    <div>
                        <label for="end_date" class="block text-sm font-medium text-gray-700 mb-1">–ü–æ –¥–∞—Ç—É</label>
                        <input type="date" id="end_date" class="w-full">
                    </div>
                </div>
                <button onclick="fetchReports()" class="ios-button w-full py-2 bg-blue-500 hover:bg-blue-600 text-white">
                    –û–±–Ω–æ–≤–∏—Ç—å –û—Ç—á–µ—Ç—ã
                </button>
            </div>
            <div id="stats-summary" class="ios-card p-4 space-y-3 mb-4">
                <h2 class="text-lg font-semibold text-gray-700">–°–≤–æ–¥–∫–∞</h2>
                <p id="total-surveys" class="text-xl font-bold">–í—Å–µ–≥–æ: 0</p>
                <div class="flex justify-between text-base">
                    <span class="text-green-600">‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∞–ª–∏: <span id="positive-count">0</span></span>
                    <span class="text-red-600">‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∞–ª–∏: <span id="negative-count">0</span></span>
                </div>
            </div>
            
            <div class="ios-card p-4 mb-4">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã (–ì—Ä–∞—Ñ–∏–∫)</h2>
                <canvas id="results-chart" height="150"></canvas>
            </div>
            
             <div class="ios-card p-4 mb-4">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å (–ì—Ä–∞—Ñ–∏–∫)</h2>
                <canvas id="loyalty-chart" height="150"></canvas>
            </div>
            
            <div class="ios-card p-4 mb-4 overflow-x-auto">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞–º</h2>
                <table id="agitator-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">–ò–º—è</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">N</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">% –ü–æ–∑–∏—Ç–∏–≤</th>
                        </tr>
                    </thead>
                    <tbody id="agitator-body" class="bg-white divide-y divide-gray-200 text-sm">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>
                    </tbody>
                </table>
            </div>
        `;
        fetchReports();
    }
    
    let resultsChartInstance = null;
    let loyaltyChartInstance = null;

    window.fetchReports = async () => {
        // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ db –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–∞
        if (!isAdmin || !db) return;
        
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        let q = collection(db, SURVEYS_COLLECTION);
        
        try {
            const snapshot = await getDocs(q);
            let surveys = snapshot.docs.map(doc => doc.data());

            // 1. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ –ø–∞–º—è—Ç–∏ (–∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Firestore –Ω–∞ —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤)
            surveys = surveys.filter(s => {
                const docDate = new Date(s.date).getTime();
                let startMatch = true;
                let endMatch = true;
                
                if (startDate) {
                    startMatch = docDate >= new Date(startDate).getTime();
                }
                if (endDate) {
                    // –î–æ–±–∞–≤–ª—è–µ–º 1 –¥–µ–Ω—å, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å
                    endMatch = docDate < new Date(new Date(endDate).getTime() + 86400000).getTime();
                }
                return startMatch && endMatch;
            });
            
            const totalSurveys = surveys.length;
            
            if (totalSurveys === 0) {
                 // showModal('–û—Ç—á–µ—Ç', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.'); // –û—Ç–∫–ª—é—á–∞–µ–º –º–æ–¥–∞–ª–∫—É, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∞
                 document.getElementById('total-surveys').innerText = '–í—Å–µ–≥–æ: 0';
                 document.getElementById('positive-count').innerText = '0';
                 document.getElementById('negative-count').innerText = '0';
                 document.getElementById('agitator-body').innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
                 if (resultsChartInstance) resultsChartInstance.destroy();
                 if (loyaltyChartInstance) loyaltyChartInstance.destroy();
                 return;
            }

            // 2. –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            const positiveCount = surveys.filter(s => s.action_result === 'positive').length;
            const negativeCount = surveys.filter(s => s.action_result === 'negative').length;
            
            const loyaltyCounts = surveys.reduce((acc, s) => {
                acc[s.loyalty] = (acc[s.loyalty] || 0) + 1;
                return acc;
            }, {});
            
            // 3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–≥–∏—Ç–∞—Ç–æ—Ä–∞–º
            const agitatorStats = surveys.reduce((acc, s) => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∞–Ω–æ–Ω–∏–º–Ω—ã–π ID
                const userKey = s.username && s.username !== 'anon' ? s.username : `ID: ${s.userId.substring(0, 8)}`;
                if (!acc[userKey]) {
                    acc[userKey] = { count: 0, positive: 0 };
                }
                acc[userKey].count += 1;
                if (s.action_result === 'positive') {
                    acc[userKey].positive += 1;
                }
                return acc;
            }, {});
            
            // 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            document.getElementById('total-surveys').innerText = `–í—Å–µ–≥–æ: ${totalSurveys}`;
            document.getElementById('positive-count').innerText = positiveCount;
            document.getElementById('negative-count').innerText = negativeCount;

            updateResultsChart(positiveCount, negativeCount);
            updateLoyaltyChart(loyaltyCounts);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∞–≥–∏—Ç–∞—Ç–æ—Ä–æ–≤
            const agitatorBody = document.getElementById('agitator-body');
            agitatorBody.innerHTML = Object.entries(agitatorStats)
                .sort(([, a], [, b]) => b.count - a.count)
                .map(([name, stats]) => {
                    const positivePct = (stats.positive / stats.count * 100).toFixed(1);
                    return `
                        <tr>
                            <td class="px-3 py-2 whitespace-nowrap">${name}</td>
                            <td class="px-3 py-2 whitespace-nowrap">${stats.count}</td>
                            <td class="px-3 py-2 whitespace-nowrap">${positivePct}%</td>
                        </tr>
                    `;
                }).join('');

        } catch (e) {
            console.error("Error fetching reports:", e);
            showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—á–µ—Ç–∞.');
        }
    }

    function updateResultsChart(positive, negative) {
        if (resultsChartInstance) resultsChartInstance.destroy();
        
        const ctx = document.getElementById('results-chart').getContext('2d');
        resultsChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['–ü–æ–¥–¥–µ—Ä–∂–∞–ª–∏', '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∞–ª–∏'],
                datasets: [{
                    data: [positive, negative],
                    backgroundColor: ['#34C759', '#FF3B30'], // iOS green & red
                    borderColor: 'white',
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { family: 'Inter', size: 14 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: (context) => {
                                const total = context.dataset.data.reduce((sum, value) => sum + value, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1) + '%';
                                return percentage;
                            }
                        }
                    }
                }
            }
        });
    }

    function updateLoyaltyChart(loyaltyCounts) {
        if (loyaltyChartInstance) loyaltyChartInstance.destroy();
        
        // –ú–∞–ø–ø–∏–Ω–≥ –∫–ª—é—á–µ–π –Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        const keys = Object.keys(LOYALTY_OPTIONS);
        const labels = keys.map(key => LOYALTY_OPTIONS[key]);
        const data = keys.map(key => loyaltyCounts[key] || 0);

        const ctx = document.getElementById('loyalty-chart').getContext('2d');
        loyaltyChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π',
                    data: data,
                    backgroundColor: ['#007AFF', '#FF9500', '#FF3B30', '#8E8E93'], 
                    borderColor: '#f2f2f7',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    },
                    x: {
                        ticks: {
                             maxRotation: 45,
                             minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏'
                    }
                }
            }
        });
    }
    
    // --- –†–ê–ó–î–ï–õ 3: –ù–ê–°–¢–†–û–ô–ö–ò ---
    
    function renderSettings(container) {
        container.innerHTML = `
            <div class="ios-card p-4 space-y-4 mb-4">
                <h2 class="text-lg font-semibold border-b pb-2 mb-4">–î–∞–Ω–Ω—ã–µ –∏ –î–æ—Å—Ç—É–ø</h2>
                
                <div class="p-2 bg-gray-50 rounded-lg">
                    <p class="text-sm font-medium text-gray-700">–í–∞—à Firebase User ID:</p>
                    <p class="font-mono text-xs text-gray-500 break-all">${currentUserId}</p>
                    <p class="text-sm font-medium text-gray-700 mt-2">–í–∞—à Telegram ID:</p>
                    <p class="font-mono text-xs text-gray-500 break-all">${telegramUser.id}</p>
                </div>

                ${isAdmin ? `
                    <div class="space-y-2 pt-2">
                        <h3 class="text-md font-medium text-red-600">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –î–µ–π—Å—Ç–≤–∏—è</h3>
                         <button onclick="requestAdminAction('/delete_all')" class="ios-button w-full py-2 bg-red-500 hover:bg-red-600 text-white">
                            ‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï –î–∞–Ω–Ω—ã–µ Firestore
                        </button>
                    </div>
                ` : `
                    <div class="space-y-2 pt-2">
                        <h3 class="text-md font-medium text-gray-700">–°–ª—É–∂–µ–±–Ω—ã–µ –î–µ–π—Å—Ç–≤–∏—è</h3>
                        <p class="text-xs text-gray-500">
                            –ï—Å–ª–∏ –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –æ—Ç—á–µ—Ç–∞–º, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.
                        </p>
                        <button onclick="requestAdminLogin()" class="ios-button w-full py-2 bg-yellow-500 hover:bg-yellow-600 text-white">
                            üîë –í–æ–π—Ç–∏ –∫–∞–∫ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                        </button>
                    </div>
                `}
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <p class="text-xs text-gray-400">
                        –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Firebase Firestore –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏ Telegram-–±–æ—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π.
                    </p>
                </div>
            </div>
        `;
    }

    // --- –õ–û–ì–ò–ö–ê –ê–î–ú–ò–ù–ê –ò –û–¢–ü–†–ê–í–ö–ò –ö–û–ú–ê–ù–î –ë–û–¢–£ ---
    
    window.requestAdminAction = (command) => {
        if (command === '/delete_all') {
             document.getElementById('admin-modal').classList.remove('hidden');
             document.getElementById('admin-modal').classList.add('flex');
        }
    }
    
    window.closeAdminModal = () => {
         document.getElementById('admin-modal').classList.add('hidden');
         document.getElementById('admin-modal').classList.remove('flex');
    }
    
    window.confirmDeleteAll = async () => {
        closeAdminModal();
        if (isAdmin && db) { // –ü—Ä–æ–≤–µ—Ä–∫–∞ db –¥–æ–±–∞–≤–ª–µ–Ω–∞
             // 1. –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ Firestore
             const deleteSuccess = await deleteFirestoreCollection();
             if (deleteSuccess) {
                 // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É (—á—Ç–æ–±—ã –æ–Ω –º–æ–≥, –Ω–∞–ø—Ä–∏–º–µ—Ä, —É–¥–∞–ª–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ)
                 if (window.Telegram && window.Telegram.WebApp) {
                    Telegram.WebApp.sendData(JSON.stringify({ command: '/delete_all' }));
                 }
                 // –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç—á–µ—Ç–æ–≤
                 if (currentPage === 'reports') {
                    fetchReports();
                 }
             }
        }
    }
    
    async function deleteFirestoreCollection() {
        if (!db) return false; // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ db

        showModal('–£–¥–∞–ª–µ–Ω–∏–µ...', '–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.');
        const collectionRef = collection(db, SURVEYS_COLLECTION);
        const q = query(collectionRef);
        
        try {
             const snapshot = await getDocs(q);
             
             if (snapshot.empty) {
                 showModal('–£—Å–ø–µ—à–Ω–æ!', '–ö–æ–ª–ª–µ–∫—Ü–∏—è —É–∂–µ –ø—É—Å—Ç–∞.');
                 return true;
             }

             const deletePromises = [];
             snapshot.docs.forEach((doc) => {
                 deletePromises.push(deleteDoc(doc.ref));
             });
             
             await Promise.all(deletePromises);
             showModal('–£—Å–ø–µ—à–Ω–æ!', `–£–¥–∞–ª–µ–Ω–æ ${snapshot.size} –∑–∞–ø–∏—Å–µ–π. –î–∞–Ω–Ω—ã–µ Firestore –æ—á–∏—â–µ–Ω—ã.`);
             return true;
             
        } catch (e) {
             console.error("Error deleting collection:", e);
             showModal('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏.');
             return false;
        }
    }

    window.requestAdminLogin = () => {
         // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
         if (window.Telegram && window.Telegram.WebApp) {
             Telegram.WebApp.sendData(JSON.stringify({ action: 'log_in_admin' }));
             showModal('–í—Ö–æ–¥', '–í–∞–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –≤–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —á–∞—Ç–µ —Å –±–æ—Ç–æ–º. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —á–∞—Ç, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å, –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É (–∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ /start).');
         } else {
             showModal('–û—à–∏–±–∫–∞', 'Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
         }
    }
    
    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
    if (window.Telegram && window.Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ iOS-–ø–æ–¥–æ–±–Ω–æ–≥–æ —Ü–≤–µ—Ç–æ–≤–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
        Telegram.WebApp.setHeaderColor('#F2F2F7'); // –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω
        Telegram.WebApp.setBackgroundColor('#FFFFFF'); // –ë–µ–ª—ã–π –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Lucide –∏–∫–æ–Ω–æ–∫ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è lucide)
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
</script>

</body>
</html>
