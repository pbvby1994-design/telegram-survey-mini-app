<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | v2.4 (–§–∏–∫—Å –û—à–∏–±–∫–∏ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <style>
        :root {
            --primary: #0088cc;
            --secondary: #27a8e0;
            --background: #f0f2f5;
        }

        body {
            font-family: 'Jost', sans-serif;
            background-color: var(--background);
            color: #333;
        }

        .container {
            max-width: 100%;
            padding: 0;
        }

        .header {
            background-color: var(--primary);
            color: white;
        }

        .tab-button.active {
            border-bottom: 3px solid white;
            font-weight: 600;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: background-color 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #0077b3;
        }

        .input-style {
            border: 1px solid #ccc;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: border-color 0.2s;
        }
        .input-style:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.2);
        }

        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã */
        #map-container {
            height: 80vh; /* –í—ã—Å–æ—Ç–∞ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ö–∞—Ä—Ç–∞" */
            min-height: 400px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ */
        .report-card {
            background-color: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen">
        <header class="header p-4 shadow-lg sticky top-0 z-10">
            <h1 class="text-xl font-bold">–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ (–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å)</h1>
            <div id="debugInfo" class="text-xs opacity-70 mt-1 flex space-x-2">
                <span id="debugUserId">ID: ...</span>
                <span id="debugAdminStatus">–ê–¥–º–∏–Ω: ...</span>
                <span id="offlineStatus" class="font-medium text-red-300"></span>
            </div>
            <div id="authRequired" class="text-xs bg-yellow-400 text-gray-800 p-1 rounded-md mt-1 hidden">
                –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è!
            </div>
        </header>

        <nav class="bg-gray-700 text-white shadow-md sticky top-[72px] z-10">
            <div class="flex justify-around items-center text-sm">
                <button onclick="window.showSection('form')" class="tab-button active p-3 hover:bg-gray-600 w-full transition-colors flex justify-center items-center space-x-2">
                    <i data-lucide="edit-3" class="w-5 h-5"></i>
                    <span>–§–æ—Ä–º–∞</span>
                </button>
                <button onclick="window.showSection('reports')" class="tab-button p-3 hover:bg-gray-600 w-full transition-colors flex justify-center items-center space-x-2">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                    <span>–û—Ç—á–µ—Ç—ã</span>
                </button>
                <button onclick="window.showSection('map')" class="tab-button p-3 hover:bg-gray-600 w-full transition-colors flex justify-center items-center space-x-2">
                    <i data-lucide="map" class="w-5 h-5"></i>
                    <span>–ö–∞—Ä—Ç–∞</span>
                </button>
            </div>
        </nav>

        <main class="p-4 space-y-4">
            <section id="section-form" class="section">
                <div class="bg-white p-5 rounded-xl shadow-md space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>

                    <div>
                        <label for="settlementSelect" class="block text-sm font-medium text-gray-700 mb-1">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</label>
                        <select id="settlementSelect" class="input-style w-full bg-white" required>
                            </select>
                    </div>

                    <div>
                        <label for="addressInput" class="block text-sm font-medium text-gray-700 mb-1">–ê–¥—Ä–µ—Å (—É–ª–∏—Ü–∞ –∏ –¥–æ–º)</label>
                        <input type="text" id="addressInput" class="input-style w-full" 
                        placeholder="–ø—Ä. –õ–µ–Ω–∏–Ω–∞, 10" required>
                    </div>

                    <div>
                        <label for="photoFile" class="block text-sm font-medium text-gray-700 mb-1">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="file" id="photoFile" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-secondary">
                        <input type="hidden" id="photoBase64">
                        <div id="photoPreviewContainer" class="mt-2 hidden">
                            <img id="photoPreview" class="max-w-full h-auto rounded-lg shadow-sm">
                            <button onclick="clearPhoto()" class="text-red-500 text-sm mt-1 flex items-center space-x-1 hover:text-red-700">
                                <i data-lucide="x" class="w-4 h-4"></i>
                                <span>–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</span>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="commentTextarea" class="block text-sm font-medium text-gray-700 mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea id="commentTextarea" class="input-style w-full h-24" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
                    </div>

                    <div class="flex items-center space-x-4">
                        <button onclick="getGPS()" class="btn-primary flex items-center space-x-2 py-2 px-4 
                        rounded-lg text-sm font-medium shadow-md">
                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                            <span>–ü–æ–ª—É—á–∏—Ç—å GPS</span>
                        </button>
                        <span id="gpsDisplay" class="text-sm text-gray-600">–®–∏—Ä–æ—Ç–∞: –ù–ï–¢, –î–æ–ª–≥–æ—Ç–∞: –ù–ï–¢</span>
                        <input type="hidden" id="latitudeInput">
                        <input type="hidden" id="longitudeInput">
                    </div>

                    <button onclick="saveReport()" id="saveButton" class="btn-primary w-full py-3 rounded-xl text-lg font-bold shadow-xl mt-6 disabled:opacity-50" disabled>
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –û—Ç—á–µ—Ç
                    </button>
                    <p id="saveStatus" class="text-center text-sm mt-2 hidden"></p>
                </div>
            </section>

            <section id="section-reports" class="section hidden">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">–°–≤–æ–¥–∫–∞ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç—á–µ—Ç—ã</h2>
                
                <div id="latestDataSummary" class="bg-white p-5 rounded-xl shadow-md mb-4 space-y-4">
                    <h3 class="text-lg font-medium border-b pb-2 mb-3">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    <canvas id="reportsChart" class="w-full h-64"></canvas>
                    <div id="latestDataList" class="space-y-3">
                        <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–¥–∫–∏...</p>
                    </div>
                </div>

                <div class="flex space-x-2 mb-4">
                    <button onclick="fetchAndRenderReports('today')" id="btnToday" class="btn-primary py-2 px-4 rounded-lg text-sm font-medium w-full">–°–µ–≥–æ–¥–Ω—è</button>
                    <button onclick="fetchAndRenderReports('last7days')" id="btn7Days" class="btn-primary py-2 px-4 rounded-lg text-sm font-medium w-full">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</button>
                    <button onclick="fetchAndRenderReports('all')" id="btnAll" 
                    class="btn-primary py-2 px-4 rounded-lg text-sm font-medium w-full">–í—Å–µ–≥–æ</button>
                </div>

                <div id="reportsList" class="space-y-3">
                    <p class="text-center text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤.</p>
                </div>
            </section>

            <section id="section-map" class="section hidden">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∏ –ú–∞—Ä–∫–µ—Ä—ã</h2>
                <div id="map-container" class="bg-white rounded-xl shadow-md">
                    </div>
            </section>
        </main>
    </div>

    <div id="customModal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 id="modalTitle" class="text-xl font-bold mb-3 text-gray-800">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
            <p id="modalMessage" class="text-gray-600 mb-4"></p>
            <div id="modalButtons" class="flex justify-center space-x-3">
                <button id="modalConfirmBtn" class="btn-primary py-2 px-4 rounded-lg font-medium hidden">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button id="modalCloseBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-colors">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, limit, orderBy, getDocs, writeBatch, startAfter, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ Firestore
        setLogLevel('debug');
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const isTMA = typeof Telegram !== 'undefined' && Telegram.WebApp;
        // üö® –í–ê–ñ–ù–û: –≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤–Ω–µ—à–Ω–µ–π —Å—Ä–µ–¥–æ–π.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ?
        __initial_auth_token : '';


        let app, db, auth;
        let userTelegramId = null;
        let isAdmin = false;
        let chartInstance = null;
        let mapInstance = null;
        let reportsData = []; // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤

        const SETTLEMENTS = [
            '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç 1',
            '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç 2',
            '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç 3',
            '–î—Ä—É–≥–æ–µ'
        ];
        // --- –£–¢–ò–õ–ò–¢–´ ---

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É—Ç–∏ –¥–ª—è Firestore.
        // Public data: /artifacts/{appId}/public/data/{collectionName}
        // Private user data: /artifacts/{appId}/users/{userId}/{collectionName}
        function getCollectionPath(collectionName, isPublic = true) {
            if (isPublic) {
                return `artifacts/${appId}/public/data/${collectionName}`;
            }
            if (!userTelegramId) {
                console.error("–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É –ø—É—Ç–∏ –±–µ–∑ userTelegramId.");
                return null;
            }
            return `artifacts/${appId}/users/${userTelegramId}/${collectionName}`;
        }

        function getPrivatePath(collectionAndDoc) {
             if (!userTelegramId) {
                console.error("–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É –ø—É—Ç–∏ –±–µ–∑ userTelegramId.");
                return null;
            }
            return `artifacts/${appId}/users/${userTelegramId}/${collectionAndDoc}`;
        }


        // –ö–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–º–µ—Å—Ç–æ alert/confirm
        window.showAlert = (title, message) => {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalConfirmBtn').classList.add('hidden');
            
            const closeBtn = document.getElementById('modalCloseBtn');
            closeBtn.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
            closeBtn.onclick = () => {
                modal.style.display = 'none';
            };
            modal.style.display = 'flex';
        };

        window.showConfirm = (title, message) => {
            return new Promise(resolve => {
                const modal = document.getElementById('customModal');
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                
                const confirmBtn = document.getElementById('modalConfirmBtn');
                confirmBtn.textContent = '–î–∞';
                confirmBtn.classList.remove('hidden');

                const closeBtn = document.getElementById('modalCloseBtn');
                closeBtn.textContent = '–û—Ç–º–µ–Ω–∞';

                confirmBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(true);
                };
                closeBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(false);
                };
                modal.style.display = 'flex';
            });
        };

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        window.showSection = (sectionId) => {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`section-${sectionId}`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`[onclick="window.showSection('${sectionId}')"]`).classList.add('active');

            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–∞—Ä—Ç—ã
            if (sectionId === 'map') {
                setTimeout(() => generateMap(), 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∞ —É—Å–ø–µ–ª–∞ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å—Å—è
            }
        };
        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ---
        if (firebaseConfig.projectId) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                console.log("Firebase initialized successfully.");
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                window.showAlert('–û–®–ò–ë–ö–ê FIREBASE', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.');
            }
        } else {
            console.warn("Firebase config is empty. Database operations will not work.");
        }


        // üîë –§–£–ù–ö–¶–ò–Ø –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò (–£—Å—Ç–∞–Ω–æ–≤–∫–∞ userTelegramId –∏ isAdmin)
        async function authenticateUser() {
            if (!app) {
                window.showAlert('–û–®–ò–ë–ö–ê', 'Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏.');
                return false;
            }
            
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Auth
                const auth = getAuth(app);
                // --- 1. –ü–æ–ø—ã—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ---
                if (initialAuthToken) {
                    // –í—Ö–æ–¥ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
                    console.log('–ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ —Å Custom Token...');
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ —Å Custom Token.');
                } else {
                    // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥
                    console.log('Custom Token –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—ã—Ç–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –≤—Ö–æ–¥–∞...');
                    await signInAnonymously(auth);
                    console.log('–£—Å–ø–µ—à–Ω—ã–π –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥.');
                }

                const user = auth.currentUser;
                if (!user) throw new Error("–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");

                userTelegramId = user.uid; // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ - UID, –¥–ª—è —Ç–æ–∫–µ–Ω–∞ - Telegram ID)

                // --- 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω-—Å—Ç–∞—Ç—É—Å–∞ ---
                // –ê–¥–º–∏–Ω-—Å–ø–∏—Å–æ–∫ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø—É–±–ª–∏—á–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ /artifacts/{appId}/public/data/config, –¥–æ–∫—É–º–µ–Ω—Ç 'admin'
                const adminDocRef = doc(db, getCollectionPath('config', true), 'admin');
                const adminDocSnap = await getDoc(adminDocRef);

                if (adminDocSnap.exists()) {
                    // user.uid –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ Firestore
                    const adminList = adminDocSnap.data().list ||
                    [];
                    isAdmin = adminList.includes(userTelegramId);
                } else {
                    // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —Å –∞–¥–º–∏–Ω–∞–º–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–∏–∫—Ç–æ –Ω–µ –∞–¥–º–∏–Ω
                    isAdmin = false;
                }

                // --- 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ UI ---
                document.getElementById('debugUserId').textContent = userTelegramId ||
                '–ù–µ—Ç ID';
                document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';
                document.getElementById('saveButton').disabled = false; // –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö

                return true;
            } catch (e) {
                console.error('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò FIREBASE:', e);
                // –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
                let errorTitle = '–û–®–ò–ë–ö–ê –í–•–û–î–ê';
                let errorMessage = `–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Ö–æ–¥ –≤ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`;
                if (e.code === 'auth/invalid-custom-token') {
                    errorTitle = '–û–®–ò–ë–ö–ê –¢–û–ö–ï–ù–ê';
                    errorMessage = '–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç–æ–∫–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞ –≤ –±–æ—Ç–µ.';
                } else if (e.code === 'auth/network-request-failed') {
                    errorTitle = '–û–®–ò–ë–ö–ê –°–ï–¢–ò';
                    errorMessage = '–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
                } else {
                    errorMessage += `\n–°–æ–æ–±—â–µ–Ω–∏–µ: ${e.message}`;
                }

                window.showAlert(errorTitle, errorMessage);
                // –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –∫–æ–Ω—Å–æ–ª—å
                console.log('--- –î–ï–¢–ê–õ–ò –û–®–ò–ë–ö–ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ---');
                console.log(`Initial Auth Token (exists): ${!!initialAuthToken}`);
                if (initialAuthToken) console.log(`Initial Auth Token (first 10 chars): ${initialAuthToken.substring(0, 10)}...`);
                console.log(`Firebase App ID: ${firebaseConfig.projectId || '–ù–ï–¢'}`);
                console.log('------------------------------------');
                
                document.getElementById('authRequired').classList.remove('hidden');
                document.getElementById('saveButton').disabled = true; // –ó–∞–ø—Ä–µ—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö
                
                return false;
            }
        }


        // --- –õ–û–ì–ò–ö–ê –§–û–†–ú–´ ---

        function populateSettlements() {
            const select = document.getElementById('settlementSelect');
            select.innerHTML = '';
            SETTLEMENTS.forEach(settlement => {
                const option = document.createElement('option');
                option.value = settlement;
                option.textContent = settlement;
                select.appendChild(option);
            });
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –≤–∫–ª—é—á–∞—Ç—å –∫–Ω–æ–ø–∫—É
            select.addEventListener('change', checkFormValidity);
            document.getElementById('addressInput').addEventListener('input', checkFormValidity);
        }

        function checkFormValidity() {
            const settlement = document.getElementById('settlementSelect').value;
            const address = document.getElementById('addressInput').value.trim();
            const saveButton = document.getElementById('saveButton');
            
            const isValid = settlement && address;
            saveButton.disabled = !isValid;
        }

        async function getGPS() {
            if (isTMA) {
                if (Telegram.WebApp.isVersionAtLeast('6.1')) {
                    try {
                        const location = await new Promise((resolve, reject) => {
    
                            Telegram.WebApp.sendData(JSON.stringify({command: 'request_location'}));
                            
                            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–æ—Ç–∞
            
                            const handler = (event) => {
                                const data = JSON.parse(event.data);
                                if (data.command === 'receive_location') {
        
                                    Telegram.WebApp.offEvent('locationReceived', handler);
                                    resolve(data.location);
                                } else if 
                                (data.command === 'location_error') {
                                    Telegram.WebApp.offEvent('locationReceived', handler);
                                    reject(new Error(data.message));
                                }
                            };
                            // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ webApp.sendData, –∏ –æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
                            // –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–æ—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ webApp.sendData.
                            // –í —Ä–µ–∞–ª—å–Ω–æ–π TMA —ç—Ç–æ –æ–±—ã—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ requestLocation().
                            // –î–ª—è Canvas, –∏–º–∏—Ç–∏—Ä—É–µ–º, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –∏–¥–µ—Ç –∫ –±–æ—Ç—É.
                            // –ù–æ —Ç.–∫. requestLocation() –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ Canvas,
                            // –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π Geolocation API –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç.
                        });
                        
                        document.getElementById('latitudeInput').value = location.latitude;
                        document.getElementById('longitudeInput').value = location.longitude;
                        document.getElementById('gpsDisplay').textContent = `–®–∏—Ä–æ—Ç–∞: ${location.latitude.toFixed(4)}, –î–æ–ª–≥–æ—Ç–∞: ${location.longitude.toFixed(4)}`;
                    } catch (e) {
                         // –ï—Å–ª–∏ TMA –Ω–µ —Å–º–æ–≥–ª–æ, –ø—Ä–æ–±—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π
                        console.error("TMA location request failed. Falling back to native.", e);
                        useNativeGeolocation();
                    }
                } else {
                    window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–í–∞—à–∞ –≤–µ—Ä—Å–∏—è Telegram –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å GPS. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—Ç–∏–≤–Ω—ã–π GPS.');
                    useNativeGeolocation();
                }
            } else {
                useNativeGeolocation();
            }
        }

        function useNativeGeolocation() {
             if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
   
                    document.getElementById('latitudeInput').value = lat;
                    document.getElementById('longitudeInput').value = lon;
                    document.getElementById('gpsDisplay').textContent = `–®–∏—Ä–æ—Ç–∞: ${lat.toFixed(4)}, –î–æ–ª–≥–æ—Ç–∞: ${lon.toFixed(4)}`;
                }, error => {
               
                    console.error("Native Geolocation error:", error);
                    window.showAlert('–û–®–ò–ë–ö–ê GPS', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.');
                    document.getElementById('gpsDisplay').textContent = 'GPS: –û–®–ò–ë–ö–ê';
                }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
            } else {
                window.showAlert('–û–®–ò–ë–ö–ê GPS', '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º.');
            }
        }


        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
        document.getElementById('photoFile').onchange = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    document.getElementById('photoBase64').value = base64;
                    
                    const preview = document.getElementById('photoPreview');
                    preview.src = base64;
                    
                    document.getElementById('photoPreviewContainer').classList.remove('hidden');
                };
                reader.onerror = function(e) {
                    console.error("File reading error:", e);
                    window.showAlert('–û–®–ò–ë–ö–ê –§–ê–ô–õ–ê', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
                };
                reader.readAsDataURL(file);
            }
        };
        function clearPhoto() {
            document.getElementById('photoFile').value = '';
            document.getElementById('photoBase64').value = '';
            document.getElementById('photoPreviewContainer').classList.add('hidden');
            document.getElementById('photoPreview').src = '';
        }

        async function saveReport() {
            if (!userTelegramId) {
                 window.showAlert('–û–®–ò–ë–ö–ê', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                return;
            }
            if (!db) {
                window.showAlert('–û–®–ò–ë–ö–ê', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.');
                return;
            }

            const settlement = document.getElementById('settlementSelect').value;
            const address = document.getElementById('addressInput').value.trim();
            const comment = document.getElementById('commentTextarea').value.trim();
            const photoBase64 = document.getElementById('photoBase64').value;
            const lat = document.getElementById('latitudeInput').value;
            const lon = document.getElementById('longitudeInput').value;
            if (!settlement || !address) {
                window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç –∏ –∞–¥—Ä–µ—Å.');
                return;
            }

            const reportData = {
                settlement: settlement,
                address: address,
                comment: comment,
                photo: photoBase64,
                
                latitude: lat ? parseFloat(lat) : null,
                longitude: lon ?
                parseFloat(lon) : null,
                reporterId: userTelegramId,
                timestamp: serverTimestamp()
            };
            const saveButton = document.getElementById('saveButton');
            const saveStatus = document.getElementById('saveStatus');

            saveButton.disabled = true;
            saveStatus.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            saveStatus.classList.remove('hidden');
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø—É–±–ª–∏—á–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é 'reports'
                const reportsCol = collection(db, getCollectionPath('reports', true));
                await addDoc(reportsCol, reportData);

                window.showAlert('–£–°–ü–ï–•', '–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                
                // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                document.getElementById('addressInput').value = '';
                document.getElementById('commentTextarea').value = '';
                document.getElementById('latitudeInput').value = '';
                document.getElementById('longitudeInput').value = '';
                document.getElementById('gpsDisplay').textContent = '–®–∏—Ä–æ—Ç–∞: –ù–ï–¢, –î–æ–ª–≥–æ—Ç–∞: –ù–ï–¢';
                clearPhoto();
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤
                renderLatestData(); 
                fetchAndRenderReports('today');
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞:", e);
                window.showAlert('–û–®–ò–ë–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø', `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç. ${e.message}`);
            } finally {
                saveButton.disabled = false;
                saveStatus.classList.add('hidden');
            }
        }


        // --- –õ–û–ì–ò–ö–ê –û–¢–ß–ï–¢–û–í –ò –°–í–û–î–ö–ò ---

        function updateOfflineStatus() {
            const isOnline = navigator.onLine;
            const statusElement = document.getElementById('offlineStatus');
            if (isOnline) {
                statusElement.classList.add('hidden');
            } else {
                statusElement.textContent = '–û–§–§–õ–ê–ô–ù';
                statusElement.classList.remove('hidden');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        window.addEventListener('online', updateOfflineStatus);
        window.addEventListener('offline', updateOfflineStatus);


        // –†–µ–Ω–¥–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–≤–æ–¥–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function renderLatestData() {
            if (!db) return;
            const listContainer = document.getElementById('latestDataList');
            listContainer.innerHTML = '<p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–¥–∫–∏...</p>';

            try {
                // 1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–º –ø—É–Ω–∫—Ç–∞–º
                const reportsCol = collection(db, getCollectionPath('reports', true));
                
                // !!! –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º orderBy –¥–ª—è –æ–±—Ö–æ–¥–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º —Å 'list' –≤ –ü—Ä–∞–≤–∏–ª–∞—Ö Firestore.
                const q = query(reportsCol, orderBy('timestamp', 'desc')); 
                const allReportsSnapshot = await getDocs(q);
                // –í–ê–†–ò–ê–ù–¢ –î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø: const allReportsSnapshot = await getDocs(reportsCol); 

                const data = allReportsSnapshot.docs.map(doc => doc.data());
                const settlementCounts = data.reduce((acc, report) => {
                    acc[report.settlement] = (acc[report.settlement] || 0) + 1;
                    return acc;
                }, {});
                // 2. –†–µ–Ω–¥–µ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                listContainer.innerHTML = '';
                const totalCount = allReportsSnapshot.size;
                listContainer.innerHTML += `<p class="font-bold text-gray-800">–í—Å–µ–≥–æ –æ—Ç—á–µ—Ç–æ–≤ –≤ –±–∞–∑–µ: ${totalCount}</p>`;

                const statsDiv = document.createElement('div');
                statsDiv.className = 'grid grid-cols-2 gap-3 text-sm';
                
                Object.entries(settlementCounts)
                    .sort(([, a], [, b]) => b - a) // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                    .forEach(([settlement, count]) => {
                    statsDiv.innerHTML += `
                        <p class="font-medium truncate">${settlement}:</p>
                        <p class="text-right text-primary">${count} —à—Ç.</p>
                    `;
                });
                listContainer.appendChild(statsDiv);


                // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
                updateChart(settlementCounts, totalCount);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–≤–æ–¥–∫–∏:", e);
                listContainer.innerHTML = '<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–¥–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.</p>';
            }
        }

        function updateChart(counts, total) {
            const ctx = document.getElementById('reportsChart').getContext('2d');
            // –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–Ω–∏—á—Ç–æ–∂–∞–µ–º –µ–≥–æ
            if (chartInstance) {
                chartInstance.destroy();
            }

            const labels = Object.keys(counts);
            const data = Object.values(counts);
            const backgroundColors = [
                'rgba(0, 136, 204, 0.7)',
                'rgba(39, 168, 224, 0.7)',
                'rgba(110, 194, 235, 0.7)',
                'rgba(255, 189, 46, 0.7)',
            ].slice(0, labels.length);
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                    
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤',
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverOffset: 10
                   
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
   
                        legend: {
                            position: 'top',
                            labels: {
                    
                                font: {
                                    family: 'Jost'
                                }
                  
                            }
                        },
                        title: {
                            display: true,
            
                            text: `–í—Å–µ–≥–æ –æ—Ç—á–µ—Ç–æ–≤: ${total}`,
                            font: {
                                size: 16,
                   
                                family: 'Jost'
                            }
                        }
                    }
              
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä –æ—Ç—á–µ—Ç–æ–≤ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É
        async function fetchAndRenderReports(filter) {
             if (!db) return;
            const reportsCol = collection(db, getCollectionPath('reports', true));
            let q;
            let title = '–í—Å–µ –æ—Ç—á–µ—Ç—ã';
            // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('#section-reports button').forEach(btn => btn.classList.remove('bg-gray-700', 'text-white'));
            document.getElementById(`btn${filter.charAt(0).toUpperCase() + filter.slice(1).replace('7days', '7Days')}`).classList.add('bg-gray-700', 'text-white');

            try {
                if (filter === 'today') {
                    title = '–û—Ç—á–µ—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è';
                    const startOfToday = new Date();
                    startOfToday.setHours(0, 0, 0, 0);
                    // –í–∞–∂–Ω–æ: Timestamp.fromDate() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Firestore
                    q = query(reportsCol, where('timestamp', '>=', Timestamp.fromDate(startOfToday)), orderBy('timestamp', 'desc'));
                } else if (filter === 'last7days') {
                    title = '–û—Ç—á–µ—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π';
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    q = query(reportsCol, where('timestamp', '>=', Timestamp.fromDate(sevenDaysAgo)), orderBy('timestamp', 'desc'));
                } else { // 'all'
                    // –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç orderBy –∏ limit, —á—Ç–æ –æ–±—Ö–æ–¥–∏—Ç –ø—Ä–æ–±–ª–µ–º—É 'list'
                    q = query(reportsCol, orderBy('timestamp', 'desc'), limit(100));
                }

                const snapshot = await getDocs(q);
                reportsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const listContainer = document.getElementById('reportsList');
                listContainer.innerHTML = `<h3 class="text-lg font-medium border-b pb-2 mb-3">${title} (${reportsData.length})</h3>`;
                
                if (reportsData.length === 0) {
                    listContainer.innerHTML += '<p class="text-center text-gray-500">–û—Ç—á–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
                    return;
                }

                reportsData.forEach(report => {
                    const date = report.timestamp?.toDate ? report.timestamp.toDate().toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' }) : '–ù/–î';
                    
                    const card = document.createElement('div');
     
                    card.className = 'report-card';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-primary">${report.settlement} - ${report.address}</h4>
 
                            <span class="text-xs text-gray-500">${date}</span>
                        </div>
                        <p class="text-sm text-gray-700 mb-2">${report.comment || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}</p>
                 
                        ${report.latitude && report.longitude ? 
                            `<p class="text-xs text-gray-500">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}</p>` : 
                            '<p class="text-xs text-gray-500">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –ù/–î</p>'}
                        
                        ${report.photo ? 
                            `<div class="mt-3"><img src="${report.photo}" class="w-full max-h-40 object-cover rounded-lg shadow-sm cursor-pointer" onclick="window.showImageModal('${report.photo}')"></div>` : 
                            ''}
                        <p class="text-xs mt-2 text-gray-400">ID: ${report.reporterId}</p>
                    `;
                    listContainer.appendChild(card);
                });

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–æ–≤:", e);
                document.getElementById('reportsList').innerHTML = '<p class="text-red-500">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.</p>';
            }
        }

        window.showImageModal = (base64Data) => {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = '–ü—Ä–æ—Å–º–æ—Ç—Ä –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏';
            document.getElementById('modalMessage').innerHTML = `<img src="${base64Data}" class="w-full h-auto rounded-lg shadow-md">`;
            document.getElementById('modalConfirmBtn').classList.add('hidden');
            
            const closeBtn = document.getElementById('modalCloseBtn');
            closeBtn.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
            closeBtn.onclick = () => {
                modal.style.display = 'none';
                document.getElementById('modalMessage').textContent = ''; // –û—á–∏—Å—Ç–∫–∞ img
            };
            modal.style.display = 'flex';
        }


        // --- –õ–û–ì–ò–ö–ê –ö–ê–†–¢–´ (Leaflet) ---

        function generateMap() {
            const container = document.getElementById('map-container');
            if (mapInstance) {
                mapInstance.remove();
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (—Ü–µ–Ω—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–ª–∏ –ø–æ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–µ)
            const defaultCenter = [55.7558, 37.6173]; // –ú–æ—Å–∫–≤–∞
            const defaultZoom = 10;
            mapInstance = L.map(container, {
                center: defaultCenter,
                zoom: defaultZoom
            });
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è —Ç–∞–π–ª–æ–≤ (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(mapInstance);
            // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–ª–æ–µ–≤
            const markers = L.markerClusterGroup();
            const heatData = [];

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
            let validPointsCount = 0;
            reportsData.forEach(report => {
                if (report.latitude && report.longitude) {
                    const lat = report.latitude;
                    const lon = report.longitude;
                    validPointsCount++;

            
                    // –ú–∞—Ä–∫–µ—Ä—ã
                    const marker = L.marker([lat, lon]);
                    const date = report.timestamp?.toDate ? report.timestamp.toDate().toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' }) : '–ù/–î';
                    marker.bindPopup(`<b>${report.settlement}, ${report.address}</b><br>${report.comment || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}<br><small>${date}</small>`);
          
                    markers.addLayer(marker);

                    // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã (lat, lon, intensity)
                    heatData.push([lat, lon, 1]); // –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å = 1
                }
            });
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç—É
            mapInstance.addLayer(markers);
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
            if (heatData.length > 0) {
                const heat = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                
                    maxZoom: 17,
                    gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'}
                }).addTo(mapInstance);
            }

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç—ã –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º
            if (validPointsCount > 0) {
                const bounds = markers.getBounds();
                mapInstance.fitBounds(bounds, {padding: [50, 50]}); // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø
            }
            
            console.log(`–ö–∞—Ä—Ç–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞. –¢–æ—á–µ–∫ —Å GPS: ${validPointsCount}`);
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // üîë –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–û–∂–∏–¥–∞–µ–º authenticateUser) - –ò–°–ü–†–ê–í–õ–ï–ù–û
        window.onload = async () => {
            // 1. –°–Ω–∞—á–∞–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ isAdmin –∏ userTelegramId
            const isAuthenticated = await authenticateUser();
            // 2. –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            populateSettlements();
            updateOfflineStatus();
            window.showSection('form');
            lucide.createIcons();
            // –û–¢–õ–ê–î–ö–ê: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
            document.getElementById('debugUserId').textContent = userTelegramId ||
            '–ù–µ—Ç ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';

            if (isAuthenticated) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
                renderLatestData();
                fetchAndRenderReports('today'); 
            } else {
                 // –ï—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ"
                 document.getElementById('saveButton').disabled = true;
            }

            if (!firebaseConfig.projectId) {
                window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase –≤ –∫–æ–¥.');
            }
        };

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        window.authenticateUser = authenticateUser;
        window.fetchAndRenderReports = fetchAndRenderReports;
        window.renderLatestData = renderLatestData;
        window.generateMap = generateMap;

    </script>
</body>
</html>
