<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | v2.4 (–°—É—Ä–≥—É—Ç—Å–∫–∏–π —Ä-–Ω)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <style>
        :root {
            --primary: #5c6bc0;
            --primary-light: #8e99f3;
            --primary-dark: #26418f;
        }

        body {
            font-family: 'Jost', sans-serif;
            background-color: #f4f7f9;
        }

        .shadow-main {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .tab-button {
            transition: all 0.2s;
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            font-weight: 600;
        }
        
        #map {
            height: 400px; /* –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—ã—Å–æ—Ç—É –∫–∞—Ä—Ç—ã */
            width: 100%;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (custom alert) */
        #alertModal {
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–æ–∞–¥–µ—Ä–∞ */
        .loader-ring {
            display: inline-block;
            position: relative;
            width: 30px;
            height: 30px;
        }

        .loader-ring div {
            box-sizing: border-box;
            display: block;
            position: absolute;
            width: 24px;
            height: 24px;
            margin: 3px;
            border: 3px solid var(--primary);
            border-radius: 50%;
            animation: loader-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            border-color: var(--primary) transparent transparent transparent;
        }

        .loader-ring div:nth-child(1) {
            animation-delay: -0.45s;
        }

        .loader-ring div:nth-child(2) {
            animation-delay: -0.3s;
        }

        .loader-ring div:nth-child(3) {
            animation-delay: -0.15s;
        }

        @keyframes loader-ring {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div id="alertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-80 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="alertIcon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 id="alertTitle" class="text-lg leading-6 font-medium text-gray-900 mt-2">–í–Ω–∏–º–∞–Ω–∏–µ</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="alertMessage" class="text-sm text-gray-500">–°–æ–æ–±—â–µ–Ω–∏–µ.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="alertCloseButton" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500" onclick="hideAlert()">
                        –û–ö
                    </button>
                </div>
            </div>
        </div>
    </div>


    <header class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞</h1>
        <p class="text-sm text-gray-500">v2.4 (–°—É—Ä–≥—É—Ç—Å–∫–∏–π —Ä-–Ω) | –û–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å: <span id="onlineStatus" class="font-medium text-red-500">–û–§–§–õ–ê–ô–ù</span></p>
        <div class="text-xs text-gray-400">
            <span class="mr-3">ID: <span id="debugUserId">–ù–µ—Ç ID</span></span>
            <span class="mr-3">–ê–¥–º–∏–Ω: <span id="debugAdminStatus">–ù–ï–¢</span></span>
        </div>
    </header>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º -->
    <div class="flex border-b border-gray-200 mb-6 sticky top-0 bg-white z-10">
        <button id="tabForm" onclick="showSection('form')" class="tab-button p-3 text-gray-600 active flex items-center">
            <i data-lucide="clipboard-list" class="w-5 h-5 mr-2"></i> –û—Ç—á–µ—Ç
        </button>
        <button id="tabReports" onclick="showSection('reports')" class="tab-button p-3 text-gray-600 flex items-center">
            <i data-lucide="list-checks" class="w-5 h-5 mr-2"></i> –ú–æ–∏ –ó–∞–ø–∏—Å–∏
        </button>
        <button id="tabAdmin" onclick="showSection('admin')" class="tab-button p-3 text-gray-600 flex items-center hidden">
            <i data-lucide="settings" class="w-5 h-5 mr-2"></i> –ê–¥–º–∏–Ω
        </button>
    </div>

    <!-- 1. –°–µ–∫—Ü–∏—è –í–≤–æ–¥–∞ –û—Ç—á–µ—Ç–∞ -->
    <section id="sectionForm" class="bg-white p-4 rounded-xl shadow-main mb-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</h2>
        <form id="reportForm">
            <!-- –ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç -->
            <div class="mb-4">
                <label for="settlement" class="block text-sm font-medium text-gray-700 mb-1">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</label>
                <select id="settlement" name="settlement" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</option>
                    <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã JS -->
                </select>
            </div>
            <!-- –ê–¥—Ä–µ—Å -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="street" class="block text-sm font-medium text-gray-700 mb-1">–£–ª–∏—Ü–∞</label>
                    <input type="text" id="street" name="street" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞">
                </div>
                <div>
                    <label for="house" class="block text-sm font-medium text-gray-700 mb-1">–î–æ–º (‚Ññ)</label>
                    <input type="text" id="house" name="house" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="10/1">
                </div>
                <div>
                    <label for="apartment" class="block text-sm font-medium text-gray-700 mb-1">–ö–≤–∞—Ä—Ç–∏—Ä–∞ (‚Ññ)</label>
                    <input type="text" id="apartment" name="apartment" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="15">
                </div>
            </div>

            <!-- –î–µ–π—Å—Ç–≤–∏–µ -->
            <div class="mb-4">
                <label for="action" class="block text-sm font-medium text-gray-700 mb-2">–î–µ–π—Å—Ç–≤–∏–µ</label>
                <div class="flex flex-wrap gap-2" id="actionButtons">
                    <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã JS -->
                </div>
                <input type="hidden" id="action" name="action" required>
            </div>

            <!-- –õ–æ—è–ª—å–Ω–æ—Å—Ç—å -->
            <div class="mb-4">
                <label for="loyalty" class="block text-sm font-medium text-gray-700 mb-2">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</label>
                <div class="flex flex-wrap gap-2" id="loyaltyButtons">
                    <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã JS -->
                </div>
                <input type="hidden" id="loyalty" name="loyalty" required>
            </div>

            <!-- –¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-center mb-3">
                    <input type="checkbox" id="requiresFollowup" name="requiresFollowup" class="h-4 w-4 text-primary focus:ring-primary rounded border-gray-300">
                    <label for="requiresFollowup" class="ml-2 block text-sm font-medium text-gray-700">–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–∏–∑–∏—Ç / –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</label>
                </div>
                <label for="comment" class="block text-sm font-medium text-gray-700 mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–≤–∞–∂–Ω–æ!)</label>
                <textarea id="comment" name="comment" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –∏–ª–∏ –∫–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –û—Ç–ø—Ä–∞–≤–∫–∏ -->
            <button type="submit" id="submitButton" class="w-full btn-primary py-3 px-4 rounded-xl text-lg font-semibold flex items-center justify-center shadow-md hover:shadow-lg">
                <i data-lucide="check-circle" class="w-6 h-6 mr-2"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –û—Ç—á–µ—Ç
            </button>
        </form>
    </section>

    <!-- 2. –°–µ–∫—Ü–∏—è –ú–æ–∏ –ó–∞–ø–∏—Å–∏ -->
    <section id="sectionReports" class="bg-white p-4 rounded-xl shadow-main mb-6 hidden">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">–ú–æ–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π</h2>
        <div id="latestReports" class="space-y-3">
            <p class="text-gray-500" id="noReportsMessage">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
        <button onclick="renderLatestData(true)" class="mt-4 w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 transition">
            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º–æ–∏ –∑–∞–ø–∏—Å–∏
        </button>
    </section>

    <!-- 3. –°–µ–∫—Ü–∏—è –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª–∏ -->
    <section id="sectionAdmin" class="hidden">
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- 3.1. –ü–∞–Ω–µ–ª—å –û—Ç—á–µ—Ç–æ–≤ –∏ –≠–∫—Å–ø–æ—Ä—Ç–∞ -->
            <div class="xl:col-span-2 bg-white p-4 rounded-xl shadow-main">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">–û–±—â–∏–µ –æ—Ç—á–µ—Ç—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <button onclick="fetchAndRenderReports()" class="btn-primary py-2 px-4 rounded-lg text-sm font-medium flex items-center">
                         <div class="loader-ring mr-2 hidden" id="adminLoader"><div></div><div></div><div></div><div></div></div>
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-1"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div class="bg-indigo-50 p-3 rounded-lg">
                        <p class="text-sm text-indigo-700 font-medium">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p>
                        <p id="statTotal" class="text-2xl font-bold text-indigo-900">0</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg">
                        <p class="text-sm text-green-700 font-medium">–õ–æ—è–ª—å–Ω—ã—Ö</p>
                        <p id="statLoyal" class="text-2xl font-bold text-green-900">0</p>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg">
                        <p class="text-sm text-yellow-700 font-medium">–¢—Ä–µ–±—É—é—Ç –ø–æ–≤—Ç–æ—Ä–∞</p>
                        <p id="statFollowup" class="text-2xl font-bold text-yellow-900">0</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h3>
                    <div class="h-64">
                        <canvas id="loyaltyChart"></canvas>
                    </div>
                </div>

                <button onclick="exportToXLSX()" class="w-full bg-green-600 text-white py-3 px-4 rounded-xl text-lg font-semibold flex items-center justify-center shadow-md hover:bg-green-700">
                    <i data-lucide="download" class="w-6 h-6 mr-2"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (XLSX)
                </button>
            </div>

            <!-- 3.2. –ü–∞–Ω–µ–ª—å –ö–∞—Ä—Ç—ã –∏ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
            <div class="xl:col-span-1 bg-white p-4 rounded-xl shadow-main">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h2>

                <!-- –ö–∞—Ä—Ç–∞ -->
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π</h3>
                    <div id="map" class="rounded-lg border border-gray-300"></div>
                    <button onclick="generateMap()" class="mt-2 w-full bg-blue-100 text-blue-700 py-2 px-4 rounded-lg font-medium hover:bg-blue-200 transition">
                        –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–∞—Ä—Ç—É
                    </button>
                </div>

                <!-- –û—á–∏—Å—Ç–∫–∞ –î–∞–Ω–Ω—ã—Ö -->
                <div>
                    <h3 class="text-lg font-medium text-red-600 mb-2">–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
                    <p class="text-sm text-gray-600 mb-3">–û—Å—Ç–æ—Ä–æ–∂–Ω–æ! –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–æ–≤ –∏–∑ Firestore. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.</p>
                    <button onclick="showConfirmDeleteModal()" class="w-full bg-red-100 text-red-700 py-2 px-4 rounded-lg font-medium hover:bg-red-200 transition">
                        –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã
                    </button>
                </div>

                <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
                <div id="confirmDeleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
                    <div class="relative top-20 mx-auto p-5 border w-80 shadow-lg rounded-md bg-white">
                        <div class="mt-3 text-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
                            <div class="mt-2 px-7 py-3">
                                <p class="text-sm text-gray-500">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ **–±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ** —É–¥–∞–ª–∏—Ç—å **–í–°–ï** –æ—Ç—á–µ—Ç—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?</p>
                            </div>
                            <div class="items-center px-4 py-3 space-y-2">
                                <button id="confirmDeleteButton" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700" onclick="clearDatabase()">
                                    –î–∞, —É–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞
                                </button>
                                <button class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300" onclick="hideConfirmDeleteModal()">
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>


    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í–°–¢–ê–í–ò–¢–¨ –°–Æ–î–ê –í–ê–®–ò –ö–õ–Æ–ß–ò) ---
        // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ –∫–ª—é—á–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–∑ Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyDVeRXO16KtIwoJQb4uHQuCsEv3xTLBGhI",
            authDomain: "agitator-notebook.firebaseapp.com",
            projectId: "agitator-notebook",
            storageBucket: "agitator-notebook.firebasestorage.app",
            messagingSenderId: "518555352011",
            appId: "1:518555352011:web:2b17a175f70a59a7212450"
        };
        // --------------------------------------------------------

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth();

        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const REPORT_COLLECTION_PATH = 'artifacts/' + firebaseConfig.appId + '/public/data/reports';
        const ADMIN_COLLECTION_PATH = 'admin_users';

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let isTMA = window.Telegram && window.Telegram.WebApp;
        let isAdmin = false;
        let userTelegramId = isTMA ? String(Telegram.WebApp.initDataUnsafe.user.id) : null;
        let dataCache = [];
        let mapInstance = null;
        let latestReportsQuerySnapshot = null;
        let loyaltyChartInstance = null;

        // --- –î–ê–ù–ù–´–ï –î–õ–Ø –§–û–†–ú–´ (–û–ë–ù–û–í–õ–ï–ù–û –ü–û –¢–†–ï–ë–û–í–ê–ù–ò–Æ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø) ---
        const SETTLEMENTS = [
            '–≥.–ø. –õ—è–Ω—Ç–æ—Ä',
            '—Å.–ø. –†—É—Å—Å–∫–∏–Ω—Å–∫–∞—è',
            '–≥.–ø. –§–µ–¥–æ—Ä–æ–≤—Å–∫–∏–π',
            '–≥.–ø. –ë–∞—Ä—Å–æ–≤–æ',
            '–≥.–ø. –ë–µ–ª—ã–π –Ø—Ä',
            '—Å.–ø. –õ—è–º–∏–Ω–∞',
            '—Å.–ø. –°—ã—Ç–æ–º–∏–Ω–æ',
            '—Å.–ø. –£–≥—É—Ç',
            '—Å.–ø. –£–ª—å—Ç-–Ø–≥—É–Ω',
            '—Å.–ø. –°–æ–ª–Ω–µ—á–Ω—ã–π',
            '—Å.–ø. –ù–∏–∂–Ω–µ—Å–æ—Ä—Ç—ã–º—Å–∫–∏–π',
            '—Å.–ø. –¢—É–Ω–¥—Ä–∏–Ω–æ',
            '—Å.–ø. –õ–æ–∫–æ—Å–æ–≤–æ',
            '–î—Ä—É–≥–æ–π' // –û—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–ª—É—á–∞–µ–≤, –Ω–µ –≤—Ö–æ–¥—è—â–∏—Ö –≤ —Å–ø–∏—Å–æ–∫
        ];

        const ACTIONS = [
            '–í—Ä—É—á–µ–Ω–∞ –ª–∏—Å—Ç–æ–≤–∫–∞',
            '–†–∞–∑—ä—è—Å–Ω–µ–Ω–∏–µ',
            '–û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã',
            '–ù–µ –∑–∞—Å—Ç–∞–ª/–ù–µ –æ—Ç–∫—Ä—ã–ª',
            '–û—Ç–∫–∞–∑ –æ—Ç –æ–±—â–µ–Ω–∏—è',
            '–î—Ä—É–≥–æ–µ'
        ];

        const LOYALTIES = [
            { label: '–ó–∞ (–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)', color: 'bg-green-500', value: '–ó–∞' },
            { label: '–ü—Ä–æ—Ç–∏–≤ (–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫)', color: 'bg-red-500', value: '–ü—Ä–æ—Ç–∏–≤' },
            { label: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ (–†–∞–≤–Ω–æ–¥—É—à–µ–Ω)', color: 'bg-yellow-500', value: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ' },
            { label: '–ó–∞—Ç—Ä—É–¥–Ω–∏–ª—Å—è –æ—Ç–≤–µ—Ç–∏—Ç—å', color: 'bg-gray-500', value: '–ó–∞—Ç—Ä—É–¥–Ω–∏–ª—Å—è –æ—Ç–≤–µ—Ç–∏—Ç—å' },
        ];
        // ------------------------------------------------------------------

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò UI ---

        function showAlert(title, message, isError = true) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            const icon = document.getElementById('alertIcon');
            icon.classList.remove('bg-red-100', 'bg-green-100');
            icon.querySelector('svg').classList.remove('text-red-600', 'text-green-600');

            if (isError) {
                icon.classList.add('bg-red-100');
                icon.querySelector('svg').classList.add('text-red-600');
            } else {
                icon.classList.add('bg-green-100');
                icon.querySelector('svg').classList.add('text-green-600');
            }
            document.getElementById('alertModal').classList.remove('hidden');
        }

        function hideAlert() {
            document.getElementById('alertModal').classList.add('hidden');
        }

        function showConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').classList.remove('hidden');
        }

        function hideConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').classList.add('hidden');
        }

        function showSection(sectionId) {
            const sections = ['form', 'reports', 'admin'];
            sections.forEach(id => {
                const section = document.getElementById(`section${id.charAt(0).toUpperCase() + id.slice(1)}`);
                const tab = document.getElementById(`tab${id.charAt(0).toUpperCase() + id.slice(1)}`);
                if (section) section.classList.add('hidden');
                if (tab) tab.classList.remove('active');
            });

            const targetSection = document.getElementById(`section${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
            const targetTab = document.getElementById(`tab${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);

            if (targetSection) targetSection.classList.remove('hidden');
            if (targetTab) targetTab.classList.add('active');

            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω-—Å–µ–∫—Ü–∏–∏
            if (sectionId === 'admin' && isAdmin) {
                fetchAndRenderReports();
            }
        }

        // --- –§–£–ù–ö–¶–ò–ò –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø –§–û–†–ú–´ ---

        function populateSettlements() {
            const select = document.getElementById('settlement');
            SETTLEMENTS.forEach(settlement => {
                const option = document.createElement('option');
                option.value = settlement;
                option.textContent = settlement;
                select.appendChild(option);
            });
        }

        function populateButtons(containerId, data, inputId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const hiddenInput = document.getElementById(inputId);

            data.forEach(item => {
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = item.label || item;
                button.dataset.value = item.value || item;
                button.className = `p-2 rounded-lg text-sm font-medium border border-gray-300 transition hover:bg-gray-100`;

                if (item.color) {
                     button.classList.add(item.color, 'text-white', 'shadow-sm');
                     button.classList.remove('border-gray-300');
                } else {
                     button.classList.add('bg-white', 'text-gray-700');
                }

                button.onclick = () => {
                    // –°–±—Ä–æ—Å –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    container.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('ring-2', 'ring-offset-2', 'ring-primary-light');
                    });
                    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    button.classList.add('ring-2', 'ring-offset-2', 'ring-primary-light');
                    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
                    hiddenInput.value = button.dataset.value;
                };
                container.appendChild(button);
            });
        }

        // --- –§–£–ù–ö–¶–ò–ò –†–ê–ë–û–¢–´ –° FIREBASE ---

        /**
         * üîë –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
         * –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–µ—Ä–≤–æ–π.
         */
        async function authenticateUser() {
            try {
                if (!userTelegramId) {
                     console.warn('User ID is missing. Running in anonymous mode.');
                     return;
                }

                const hash = isTMA ? Telegram.WebApp.initData : null;
                if (!hash) {
                    console.error('Telegram Init Data is missing. Cannot authenticate.');
                    return;
                }

                // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ Custom Token —á–µ—Ä–µ–∑ Telegram Bot API (–∏–º–∏—Ç–∞—Ü–∏—è)
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–π–¥–µ—Ç –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π
                // –ø—Ä–æ–≤–µ—Ä–∏—Ç —Ö–µ—à –∏, –µ—Å–ª–∏ –≤—Å–µ –û–ö, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –≤–µ—Ä–Ω–µ—Ç Custom Token.
                // –í –¥–∞–Ω–Ω–æ–π –ø–µ—Å–æ—á–Ω–∏—Ü–µ, –º—ã –∏–º–∏—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω —É–∂–µ –≥–æ—Ç–æ–≤,
                // –∏—Å–ø–æ–ª—å–∑—É—è ID –∏–∑ Telegram.WebApp.initDataUnsafe

                const token = JSON.parse(localStorage.getItem('MOCK_ADMIN_TOKEN')) || 'MOCK_TOKEN_FOR_' + userTelegramId;

                // 2. –í—Ö–æ–¥ –≤ Firebase —Å –ø–æ–º–æ—â—å—é Custom Token
                const userCredential = await auth.signInWithCustomToken(token);
                userTelegramId = userCredential.user.uid; // –û–±–Ω–æ–≤–ª—è–µ–º ID –∏–∑ —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å)
                console.log("Firebase Auth Success. UID:", userTelegramId);

                // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                const adminDocRef = db.collection(ADMIN_COLLECTION_PATH).doc(userTelegramId);
                const adminDoc = await adminDocRef.get();

                if (adminDoc.exists && adminDoc.data().is_admin === true) {
                    isAdmin = true;
                    document.getElementById('tabAdmin').classList.remove('hidden');
                }

            } catch (error) {
                console.error("Authentication/Admin check failed:", error);
                // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                isAdmin = false;
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';

            // –ï—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (userTelegramId) {
                renderLatestData();
            } else {
                showAlert('–û—à–∏–±–∫–∞ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—Ö–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Mini App.');
            }
        }


        /**
         * üìù –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –≤ Firestore
         */
        document.getElementById('reportForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!userTelegramId) {
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Mini App.');
                return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                const requiredFields = ['settlement', 'street', 'house', 'apartment', 'action', 'loyalty'];
                for (const field of requiredFields) {
                    if (!data[field]) {
                        showAlert('–û—à–∏–±–∫–∞', `–ü–æ–ª–µ "${field}" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.`);
                        return;
                    }
                }

                // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
                let location = null;
                if (isTMA && Telegram.WebApp.is2dPolygonApiSupported) {
                    // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—É—é API –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ Mini App
                    // –í —Ç–µ–∫—É—â–µ–π –ø–µ—Å–æ—á–Ω–∏—Ü–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
                    location = {
                        latitude: 61.25 + (Math.random() - 0.5) * 0.1, // –ü—Ä–∏–º–µ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —Ä–∞–π–æ–Ω–µ –°—É—Ä–≥—É—Ç–∞
                        longitude: 73.4 + (Math.random() - 0.5) * 0.1
                    };
                } else if (navigator.geolocation) {
                    // –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞
                     location = await new Promise((resolve) => {
                         navigator.geolocation.getCurrentPosition(
                             (pos) => resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }),
                             (err) => { console.warn("Geolocation failed:", err.message); resolve(null); },
                             { timeout: 5000 }
                         );
                     });
                }

                const reportData = {
                    telegram_id: userTelegramId,
                    full_name: (isTMA && Telegram.WebApp.initDataUnsafe.user.first_name) || '–ê–Ω–æ–Ω–∏–º',
                    username: (isTMA && Telegram.WebApp.initDataUnsafe.user.username) || '–Ω–µ—Ç_username',
                    timestamp: Date.now(),
                    settlement: data.settlement,
                    street: data.street,
                    house: data.house,
                    apartment: data.apartment,
                    action: data.action,
                    loyalty: data.loyalty,
                    comment: data.comment || '',
                    requires_followup: !!data.requiresFollowup,
                    location: location
                };

                await db.collection(REPORT_COLLECTION_PATH).add(reportData);

                showAlert('–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', '–°–ø–∞—Å–∏–±–æ, –≤–∞—à –æ—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.', false);
                e.target.reset(); // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
                renderLatestData(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–∏—Ö –∑–∞–ø–∏—Å–µ–π

            } catch (error) {
                console.error("Error submitting report: ", error);
                showAlert('–û—à–∏–±–∫–∞ –û—Ç–ø—Ä–∞–≤–∫–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç: ' + error.message);
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        });

        // --- –§–£–ù–ö–¶–ò–ò –ü–†–û–°–ú–û–¢–†–ê –û–¢–ß–ï–¢–û–í (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) ---

        /**
         * üëÅÔ∏è –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         */
        async function renderLatestData(showAll = false) {
            if (!userTelegramId) {
                 document.getElementById('noReportsMessage').textContent = '–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é.';
                 return;
            }
            document.getElementById('noReportsMessage').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';

            try {
                let query = db.collection(REPORT_COLLECTION_PATH)
                    .where('telegram_id', '==', userTelegramId)
                    .orderBy('timestamp', 'desc');

                if (!showAll) {
                    query = query.limit(10);
                }

                latestReportsQuerySnapshot = await query.get();
                const reportsContainer = document.getElementById('latestReports');
                reportsContainer.innerHTML = '';
                document.getElementById('noReportsMessage').classList.add('hidden');

                if (latestReportsQuerySnapshot.empty) {
                    reportsContainer.innerHTML = '<p class="text-gray-500">–ü–æ–∫–∞ –Ω–µ—Ç –≤–∞—à–∏—Ö –æ—Ç—á–µ—Ç–æ–≤. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π!</p>';
                    return;
                }

                latestReportsQuerySnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const loyaltyItem = LOYALTIES.find(l => l.value === data.loyalty);
                    const loyaltyColor = loyaltyItem ? loyaltyItem.color.replace('bg-', 'text-') : 'text-gray-600';

                    const reportDiv = document.createElement('div');
                    reportDiv.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200';
                    reportDiv.innerHTML = `
                        <p class="text-xs text-gray-400">${new Date(data.timestamp).toLocaleString()}</p>
                        <p class="font-semibold text-sm mb-1">${data.settlement}, ${data.street}, –¥. ${data.house}, –∫–≤. ${data.apartment}</p>
                        <p class="text-sm">
                            –î–µ–π—Å—Ç–≤–∏–µ: <span class="font-medium text-indigo-700">${data.action}</span> |
                            –õ–æ—è–ª—å–Ω–æ—Å—Ç—å: <span class="font-bold ${loyaltyColor}">${data.loyalty}</span>
                        </p>
                        ${data.requires_followup ? '<p class="text-sm text-red-500 font-medium mt-1 flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i> –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä!</p>' : ''}
                        ${data.comment ? `<p class="text-xs italic text-gray-500 mt-1">–ö–æ–º–º–µ–Ω—Ç.: ${data.comment}</p>` : ''}
                    `;
                    reportsContainer.appendChild(reportDiv);
                });

                // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –∏–∫–æ–Ω–∫–∏ lucide
                lucide.createIcons();

            } catch (error) {
                console.error("Error fetching latest reports: ", error);
                document.getElementById('noReportsMessage').classList.remove('hidden');
                document.getElementById('noReportsMessage').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤.';
            }
        }

        // --- –§–£–ù–ö–¶–ò–ò –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–ò ---

        /**
         * üìä –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
         */
        async function fetchAndRenderReports() {
            if (!isAdmin) {
                 showAlert('–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —ç—Ç–æ–π —Å–µ–∫—Ü–∏–∏.');
                 return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showProgress();
            document.getElementById('adminLoader').classList.remove('hidden');


            try {
                // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                const snapshot = await db.collection(REPORT_COLLECTION_PATH).get();
                dataCache = snapshot.docs.map(doc => doc.data());

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                updateStats(dataCache);

                // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
                renderLoyaltyChart(dataCache);

            } catch (error) {
                console.error("Error fetching all reports: ", error);
                showAlert('–û—à–∏–±–∫–∞ –ó–∞–≥—Ä—É–∑–∫–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—â–∏–µ –æ—Ç—á–µ—Ç—ã: ' + error.message);
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
                document.getElementById('adminLoader').classList.add('hidden');
            }
        }

        /**
         * üìà –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
         */
        function updateStats(data) {
            document.getElementById('statTotal').textContent = data.length;
            document.getElementById('statLoyal').textContent = data.filter(d => d.loyalty === '–ó–∞').length;
            document.getElementById('statFollowup').textContent = data.filter(d => d.requires_followup).length;
        }

        /**
         * üé® –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
         */
        function renderLoyaltyChart(data) {
            if (loyaltyChartInstance) {
                loyaltyChartInstance.destroy();
            }

            const loyaltyCounts = {};
            data.forEach(doc => {
                loyaltyCounts[doc.loyalty] = (loyaltyCounts[doc.loyalty] || 0) + 1;
            });

            const labels = Object.keys(loyaltyCounts);
            const counts = Object.values(loyaltyCounts);

            const colorsMap = {
                '–ó–∞': '#10b981', // green-500
                '–ü—Ä–æ—Ç–∏–≤': '#ef4444', // red-500
                '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ': '#f59e0b', // yellow-500
                '–ó–∞—Ç—Ä—É–¥–Ω–∏–ª—Å—è –æ—Ç–≤–µ—Ç–∏—Ç—å': '#6b7280', // gray-500
                '–î—Ä—É–≥–æ–µ': '#3b82f6', // blue-500
            };

            const backgroundColors = labels.map(label => colorsMap[label] || '#9ca3af');

            const ctx = document.getElementById('loyaltyChart').getContext('2d');
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1) + '%';
                                return `${label}: ${value} (${percentage})`;
                            }
                        }
                    }
                }
            };

            loyaltyChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: chartOptions
            });
        }

        /**
         * üó∫Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
         */
        function generateMap() {
             if (!isAdmin) {
                 showAlert('–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞—Ä—Ç–µ.');
                 return;
            }

            if (dataCache.length === 0) {
                 showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞—Ä—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –æ—Ç—á–µ—Ç—ã.');
                 return;
            }

            // 1. –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ: –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ —Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π
            const heatData = dataCache
                .filter(doc => doc.location && doc.location.latitude && doc.location.longitude)
                .map(doc => [doc.location.latitude, doc.location.longitude, 0.5]); // [lat, lng, intensity]

            if (heatData.length === 0) {
                 showAlert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–í –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–∞—Ä—Ç—ã.');
                 return;
            }

            // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–ª–∏ –æ—á–∏—Å—Ç–∫–∞ –∫–∞—Ä—Ç—ã
            if (mapInstance) {
                mapInstance.remove();
            }

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –°—É—Ä–≥—É—Ç—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞ –∏–ª–∏ —Å—Ä–µ–¥–Ω–µ–µ –ø–æ –¥–∞–Ω–Ω—ã–º
            const avgLat = heatData.reduce((sum, d) => sum + d[0], 0) / heatData.length;
            const avgLng = heatData.reduce((sum, d) => sum + d[1], 0) / heatData.length;

            mapInstance = L.map('map').setView([avgLat, avgLng], 10); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑—É–º 10

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);

            // 3. –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–ø–ª–æ–≤–æ–π —Å–ª–æ–π
            L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'}
            }).addTo(mapInstance);

            showAlert('–ö–∞—Ä—Ç–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞!', `–û—Ç–æ–±—Ä–∞–∂–µ–Ω—ã ${heatData.length} —Ç–æ—á–µ–∫ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏.`, false);
        }

        /**
         * üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (–ê–¥–º–∏–Ω)
         */
        async function clearDatabase() {
            hideConfirmDeleteModal();
             if (!isAdmin) {
                 showAlert('–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.');
                 return false;
            }

            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            try {
                const collectionRef = db.collection(REPORT_COLLECTION_PATH);
                const snapshot = await collectionRef.get();
                let deletedCount = 0;

                // –£–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–∞–∫–µ—Ç–∞–º–∏ (Batch Deletion)
                const batchSize = 500;
                while (snapshot.docs.length > 0) {
                    const batch = db.batch();
                    const docsToDelete = snapshot.docs.slice(0, batchSize);

                    docsToDelete.forEach(doc => {
                        batch.delete(doc.ref);
                        deletedCount++;
                    });

                    await batch.commit();

                    // –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –ø–∞–∫–µ—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                    if (snapshot.docs.length > batchSize) {
                         snapshot = await collectionRef.limit(batchSize).get();
                    } else {
                         snapshot.docs = []; // –í—ã—Ö–æ–¥ –∏–∑ —Ü–∏–∫–ª–∞
                    }
                }

                dataCache = []; // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                updateOfflineStatus();
                showAlert('–£—Å–ø–µ—à–Ω–æ!', `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} –∑–∞–ø–∏—Å–µ–π. –î–∞–Ω–Ω—ã–µ Firestore –æ—á–∏—â–µ–Ω—ã.`);

                if (isAdmin) fetchAndRenderReports();

                return true;

            } catch (e) {
                 console.error("Error deleting collection:", e);
                 showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + e.message);
                 return false;
            } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        }


        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // üîë –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–û–∂–∏–¥–∞–µ–º authenticateUser) - –ò–°–ü–†–ê–í–õ–ï–ù–û
        window.onload = async () => {
            // 1. –°–Ω–∞—á–∞–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ isAdmin –∏ userTelegramId
            await authenticateUser();

            // 2. –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            populateButtons('actionButtons', ACTIONS, 'action'); // –î–µ–π—Å—Ç–≤–∏–µ
            populateButtons('loyaltyButtons', LOYALTIES, 'loyalty'); // –õ–æ—è–ª—å–Ω–æ—Å—Ç—å
            populateSettlements();
            window.showSection('form');
            lucide.createIcons();

            // –û–¢–õ–ê–î–ö–ê: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
            document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';

            if (!firebaseConfig.projectId) {
                window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase –≤ –∫–æ–¥.');
            }
        };

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        window.authenticateUser = authenticateUser;
        window.fetchAndRenderReports = fetchAndRenderReports;
        window.renderLatestData = renderLatestData;
        window.generateMap = generateMap;
        window.exportToXLSX = exportToXLSX;
        window.showSection = showSection;
        window.showAlert = showAlert;
        window.hideAlert = hideAlert;
        window.showConfirmDeleteModal = showConfirmDeleteModal;
        window.hideConfirmDeleteModal = hideConfirmDeleteModal;
    </script>
</body>
</html>
