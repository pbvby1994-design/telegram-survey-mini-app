<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Блокнот Агитатора</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        /* Стилизация под iOS/TMA: полупрозрачный фон, мягкие тени, системный шрифт */
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #f2f2f7); /* TMA Theme BG */
            color: var(--tg-theme-text-color, #1c1c1e); /* TMA Theme Text */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-bottom: 80px; /* Для навигационной панели */
            transition: background-color 0.3s;
        }
        /* Адаптивные карточки */
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-secondary-bg-color, #e5e5ea);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        /* Навигационная панель */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border-top: 1px solid var(--tg-theme-secondary-bg-color, #e5e5ea);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }
        .nav-item {
            color: var(--tg-theme-hint-color, #8e8e93);
            transition: color 0.2s;
        }
        .nav-item.active {
            color: var(--tg-theme-link-color, #007aff);
        }
        .nav-item:hover {
            color: var(--tg-theme-link-color, #007aff);
        }
        /* Стили для формы */
        input[type="text"], textarea, select {
            background-color: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-secondary-bg-color, #d1d1d6);
            color: var(--tg-theme-text-color, #1c1c1e);
            border-radius: 8px;
            padding: 10px;
            transition: border-color 0.2s, background-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-link-color, #007aff);
        }
        /* Стили для кнопок */
        .btn-primary {
            background-color: var(--tg-theme-button-color, #007aff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-radius: 8px;
            padding: 10px 15px;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .btn-primary:hover {
            opacity: 0.8;
        }
        .btn-secondary {
            background-color: var(--tg-theme-secondary-bg-color, #e5e5ea);
            color: var(--tg-theme-text-color, #1c1c1e);
            border-radius: 8px;
            padding: 10px 15px;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        .btn-secondary:hover {
            opacity: 0.8;
        }
        /* Map container style */
        #map-container {
            width: 100%;
            height: 400px; /* Фиксированная высота для карты */
            border-radius: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body class="p-4">

    <div class="nav-bar">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            <a href="#" onclick="showSection('form'); return false;" class="nav-item active flex flex-col items-center text-xs">
                <i data-lucide="clipboard-pen" class="w-5 h-5"></i>
                <span>Форма</span>
            </a>
            <a href="#" onclick="showSection('reports'); return false;" class="nav-item flex flex-col items-center text-xs">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                <span>Отчеты</span>
            </a>
            <a href="#" onclick="showSection('admin'); return false;" class="nav-item flex flex-col items-center text-xs">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span>Админ</span>
            </a>
        </div>
    </div>

    <main class="max-w-lg mx-auto">
        <section id="form" class="section">
            <h1 class="text-2xl font-bold mb-4">Ввод Данных</h1>
            <div class="card p-4">
                <form id="surveyForm" onsubmit="saveSurveyData(event)">
                    <div class="mb-4">
                        <label for="settlement" class="block text-sm font-medium mb-1">Населенный пункт</label>
                        <input type="text" id="settlement" required class="w-full">
                    </div>
                    <div class="mb-4">
                        <label for="street" class="block text-sm font-medium mb-1">Улица</label>
                        <input type="text" id="street" required class="w-full">
                    </div>
                    <div class="mb-4">
                        <label for="house" class="block text-sm font-medium mb-1">Дом/Квартира</label>
                        <input type="text" id="house" required class="w-1/2 inline-block" placeholder="Дом">
                        <input type="text" id="apartment" class="w-1/2 inline-block pl-2" placeholder="Квартира">
                    </div>
                    <div class="mb-4">
                        <label for="action" class="block text-sm font-medium mb-1">Действие</label>
                        <select id="action" required class="w-full">
                            <option value="">Выберите...</option>
                            <option value="positive">Позитивное</option>
                            <option value="negative">Негативное</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="loyalty" class="block text-sm font-medium mb-1">Лояльность</label>
                        <select id="loyalty" required class="w-full">
                            <option value="">Выберите...</option>
                            <option value="loyal">Лояльный</option>
                            <option value="not_loyal">Не лояльный</option>
                            <option value="doubtful">Сомневающийся</option>
                            <option value="not_opened">Не открыли</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="comment" class="block text-sm font-medium mb-1">Комментарий</label>
                        <textarea id="comment" class="w-full" rows="3"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Геолокация</label>
                        <div id="locationStatus" class="text-sm italic text-gray-500 mb-2">Ожидание...</div>
                        <button type="button" onclick="getLocation()" class="btn-secondary text-sm flex items-center">
                            <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i>
                            <span>Получить GPS</span>
                        </button>
                    </div>

                    <button type="submit" class="btn-primary w-full mt-4">Сохранить Запись</button>
                </form>
            </div>
        </section>

        <section id="reports" class="section hidden">
            <h1 class="text-2xl font-bold mb-4">Отчеты</h1>
            
            <div id="admin-reports-content">
                <div class="flex space-x-2 mb-4">
                    <button onclick="exportToXLSX()" class="btn-primary flex-1 flex items-center justify-center text-sm">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-1"></i>
                        <span>Экспорт XLSX</span>
                    </button>
                    <button onclick="fetchAndRenderReports()" class="btn-secondary flex-1 flex items-center justify-center text-sm">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-1"></i>
                        <span>Обновить</span>
                    </button>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">Сводка</h2>
                    <div id="summary-metrics" class="grid grid-cols-2 gap-3 text-sm">
                        </div>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">Лояльность</h2>
                    <canvas id="loyaltyChart"></canvas>
                </div>
                
                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">Действия</h2>
                    <canvas id="actionChart"></canvas>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">Карта Геолокаций</h2>
                    <div id="map-container"></div>
                </div>

            </div>
            
            <div id="admin-reports-login" class="card p-4 text-center hidden">
                <p class="mb-4">Для просмотра отчетов требуется авторизация администратора.</p>
                <button onclick="requestAdminLogin()" class="btn-primary">Войти как Администратор</button>
            </div>
        </section>

        <section id="admin" class="section hidden">
            <h1 class="text-2xl font-bold mb-4">Администрирование</h1>
            
            <div id="admin-panel-content">
                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2 text-red-600">Опасная Зона</h2>
                    <p class="text-sm mb-4">Нажмите, чтобы безвозвратно удалить ВСЕ данные (записи) из базы Firestore.</p>
                    <button onclick="confirmAndDeleteData()" class="btn-secondary w-full bg-red-100 text-red-600 border border-red-400">
                        <i data-lucide="trash-2" class="w-4 h-4 mr-1 inline-block align-middle"></i>
                        Удалить Все Данные
                    </button>
                </div>
            </div>

            <div id="admin-panel-login" class="card p-4 text-center hidden">
                <p class="mb-4">Для доступа к админ-панели требуется авторизация администратора.</p>
                <button onclick="requestAdminLogin()" class="btn-primary">Войти как Администратор</button>
            </div>
        </section>

    </main>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sheetjs@0.19.0/dist/xlsx.full.min.js"></script>

    <script>
        // --- КОНФИГУРАЦИЯ ---
        const firebaseConfig = {
            // !!! ВСТАВЬТЕ СЮДА ВАШИ КЛЮЧИ КОНФИГУРАЦИИ FIREBASE !!!
            // apiKey: "...",
            // authDomain: "...",
            // projectId: "...",
            // storageBucket: "...",
            // messagingSenderId: "...",
            // appId: "..."
        };

        // ⚠️ ВАЖНО: Хранение ID на клиенте не безопасно. Используйте Security Rules!
        // Этот ID используется только для отображения интерфейса.
        const ADMIN_TELEGRAM_ID = 541459471; // Ваш Telegram user_id

        const isTMA = window.Telegram && window.Telegram.WebApp;
        let userTelegramId = isTMA ? Telegram.WebApp.initDataUnsafe.user.id : null;
        let isAdmin = userTelegramId === ADMIN_TELEGRAM_ID;
        let userLocation = null;

        // --- ИНИЦИАЛИЗАЦИЯ FIREBASE ---
        if (firebaseConfig.projectId) {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const surveysCollection = db.collection('surveys');
        } else {
            console.error("Firebase config is missing. Data saving will not work.");
        }


        // --- ОБЩИЕ ФУНКЦИИ И УТИЛИТЫ ---
        function showAlert(title, message) {
            if (isTMA) {
                Telegram.WebApp.showAlert(`${title}: ${message}`);
            } else {
                alert(`${title}: ${message}`);
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`a[onclick*="${sectionId}"]`).classList.add('active');

            if (sectionId === 'reports' || sectionId === 'admin') {
                if (isAdmin) {
                    document.getElementById(`admin-${sectionId}-login`).classList.add('hidden');
                    document.getElementById(`admin-${sectionId}-content`).classList.remove('hidden');
                    if (sectionId === 'reports') {
                        // При переходе на Отчеты - автоматически загружаем данные
                        fetchAndRenderReports(); 
                    }
                } else {
                    document.getElementById(`admin-${sectionId}-login`).classList.remove('hidden');
                    document.getElementById(`admin-${sectionId}-content`).classList.add('hidden');
                }
            }
            
            // Перерисовка иконок Lucide
            lucide.createIcons();
            if (isTMA) Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }

        // --- ФУНКЦИИ ФОРМЫ И СОХРАНЕНИЯ ---
        
        // 🆕 Улучшенная обработка геолокации
        window.getLocation = () => {
            const statusElement = document.getElementById('locationStatus');
            statusElement.textContent = 'Запрос геолокации...';
            userLocation = null; // Сброс старого значения

            if (!navigator.geolocation) {
                statusElement.textContent = 'Ошибка: Геолокация не поддерживается вашим браузером.';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = new firebase.firestore.GeoPoint(
                        position.coords.latitude,
                        position.coords.longitude
                    );
                    statusElement.textContent = `Успешно: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;
                    if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                },
                (error) => {
                    console.error("Geolocation Error:", error);
                    let errorMessage = 'Ошибка при получении GPS.';
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage = 'Отказано в доступе к геолокации.';
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        errorMessage = 'Геолокация недоступна.';
                    }
                    statusElement.textContent = `Ошибка: ${errorMessage}`;
                    showAlert('Ошибка GPS', errorMessage);
                    if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        };
        
        window.saveSurveyData = async (e) => {
            e.preventDefault();
            if (!firebaseConfig.projectId) {
                showAlert('Ошибка', 'Конфигурация Firebase отсутствует.');
                return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            try {
                const data = {
                    settlement: document.getElementById('settlement').value,
                    street: document.getElementById('street').value,
                    house: document.getElementById('house').value,
                    apartment: document.getElementById('apartment').value,
                    action: document.getElementById('action').value,
                    loyalty: document.getElementById('loyalty').value,
                    comment: document.getElementById('comment').value || '',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    user_id: userTelegramId,
                    username: isTMA ? (Telegram.WebApp.initDataUnsafe.user.username || 'n/a') : 'web-test',
                    location: userLocation, // Сохраняем GeoPoint или null
                };

                await surveysCollection.add(data);
                
                // Очистка формы
                document.getElementById('surveyForm').reset();
                document.getElementById('locationStatus').textContent = 'Ожидание...';
                userLocation = null;
                
                showAlert('Успешно!', 'Данные сохранены.');
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');

            } catch (error) {
                console.error("Error adding document: ", error);
                showAlert('Ошибка', 'Произошла ошибка при сохранении данных.');
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        };


        // --- ФУНКЦИИ ОТЧЕТОВ ---
        let mapInstance = null; // Для хранения экземпляра Leaflet карты
        let dataCache = []; // Кэш данных для экспорта и отчетов

        // 🆕 Функция генерации карты (Перенос map_command)
        function generateMap(data) {
            const container = document.getElementById('map-container');
            // Очистка контейнера перед рендерингом
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
            container.innerHTML = '';

            const locations = data
                .filter(doc => doc.location && doc.location.latitude && doc.location.longitude)
                .map(doc => ({
                    lat: doc.location.latitude,
                    lon: doc.location.longitude,
                    loyalty: doc.loyalty
                }));

            if (locations.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-500">Нет данных о геолокации для отображения на карте.</div>';
                return;
            }

            // Центр карты - среднее из всех точек
            const avgLat = locations.reduce((sum, p) => sum + p.lat, 0) / locations.length;
            const avgLon = locations.reduce((sum, p) => sum + p.lon, 0) / locations.length;

            mapInstance = L.map(container).setView([avgLat, avgLon], 10); // 10 - уровень зума

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);

            locations.forEach(point => {
                let color = '#34D399'; // loyal (green-400)
                if (point.loyalty === 'not_loyal') {
                    color = '#F87171'; // not_loyal (red-400)
                } else if (point.loyalty === 'doubtful') {
                    color = '#FBBF24'; // doubtful (yellow-500)
                }

                // Кастомный маркер
                const iconHtml = `<div style="background-color: ${color}; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white;"></div>`;
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: iconHtml,
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });

                L.marker([point.lat, point.lon], { icon: customIcon })
                    .addTo(mapInstance)
                    .bindPopup(`Лояльность: ${point.loyalty}`);
            });
            
            // Адаптация карты под размер контейнера после рендеринга
            mapInstance.invalidateSize();
        }

        // 🆕 Функция экспорта в XLSX (Перенос export_all_command)
        function exportToXLSX() {
            if (dataCache.length === 0) {
                showAlert('Ошибка', 'Нет данных для экспорта. Пожалуйста, обновите отчеты.');
                return;
            }

            // Преобразование данных для Excel
            const exportData = dataCache.map(doc => ({
                'ID Пользователя': doc.user_id,
                'Username': doc.username,
                'Время': doc.timestamp ? new Date(doc.timestamp).toLocaleString() : 'N/A',
                'Населенный пункт': doc.settlement,
                'Улица': doc.street,
                'Дом': doc.house,
                'Квартира': doc.apartment,
                'Действие': doc.action,
                'Лояльность': doc.loyalty,
                'Комментарий': doc.comment,
                'Широта': doc.location ? doc.location.latitude : 'N/A',
                'Долгота': doc.location ? doc.location.longitude : 'N/A',
            }));

            // Создание и скачивание файла
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Данные");
            XLSX.writeFile(workbook, "agitator_data_" + new Date().toISOString().slice(0, 10) + ".xlsx");

            showAlert('Успешно', `Экспортировано ${exportData.length} записей в XLSX.`);
            if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        let loyaltyChart = null;
        let actionChart = null;

        window.fetchAndRenderReports = async () => {
            if (!isAdmin) {
                showAlert('Ошибка', 'Нет прав администратора.');
                return;
            }
            if (!firebaseConfig.projectId) return showAlert('Ошибка', 'Конфигурация Firebase отсутствует.');
            
            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            try {
                const snapshot = await surveysCollection.orderBy('timestamp', 'desc').get();
                const rawData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // Преобразование Firestore Timestamp в Unix Timestamp (мс) для удобства
                    const timestampMs = data.timestamp ? data.timestamp.toDate().getTime() : 0;
                    return { ...data, timestamp: timestampMs };
                });
                
                dataCache = rawData; // Обновляем кэш данных
                
                // 1. Агрегация данных
                const totalCount = rawData.length;
                const loyaltyCounts = {};
                const actionCounts = {};

                rawData.forEach(doc => {
                    // Лояльность
                    loyaltyCounts[doc.loyalty] = (loyaltyCounts[doc.loyalty] || 0) + 1;
                    // Действия
                    actionCounts[doc.action] = (actionCounts[doc.action] || 0) + 1;
                });
                
                // 2. Рендеринг сводки
                const summaryHtml = `
                    <div class="p-2 bg-gray-100 rounded-lg text-center">Всего: <span class="font-bold">${totalCount}</span></div>
                    <div class="p-2 bg-green-100 rounded-lg text-center">Лояльных: <span class="font-bold">${loyaltyCounts['loyal'] || 0}</span></div>
                    <div class="p-2 bg-red-100 rounded-lg text-center">Не лояльных: <span class="font-bold">${loyaltyCounts['not_loyal'] || 0}</span></div>
                    <div class="p-2 bg-yellow-100 rounded-lg text-center">Сомневающихся: <span class="font-bold">${loyaltyCounts['doubtful'] || 0}</span></div>
                `;
                document.getElementById('summary-metrics').innerHTML = summaryHtml;

                // 3. Рендеринг графиков
                const loyaltyLabels = ['Лояльный', 'Не лояльный', 'Сомневающийся', 'Не открыли'];
                const loyaltyData = [
                    loyaltyCounts['loyal'] || 0,
                    loyaltyCounts['not_loyal'] || 0,
                    loyaltyCounts['doubtful'] || 0,
                    loyaltyCounts['not_opened'] || 0,
                ];
                renderChart('loyaltyChart', 'doughnut', loyaltyLabels, loyaltyData, ['#34D399', '#F87171', '#FBBF24', '#D1D5DB'], loyaltyChart);
                
                const actionLabels = ['Позитивное', 'Негативное'];
                const actionData = [
                    actionCounts['positive'] || 0,
                    actionCounts['negative'] || 0,
                ];
                renderChart('actionChart', 'bar', actionLabels, actionData, ['#007aff', '#ff3b30'], actionChart);
                
                // 4. Рендеринг карты (🆕)
                generateMap(rawData);

            } catch (e) {
                console.error("Error fetching reports:", e);
                showAlert('Ошибка', 'Произошла ошибка при загрузке отчетов: ' + e.message);
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        };

        function renderChart(canvasId, type, labels, data, colors, chartInstance) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            const chartOptions = {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: getComputedStyle(document.body).getPropertyValue('--tg-theme-text-color') || '#1c1c1e',
                        }
                    }
                },
                scales: type === 'bar' ? {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--tg-theme-hint-color') || '#8e8e93',
                        },
                        grid: {
                            color: getComputedStyle(document.body).getPropertyValue('--tg-theme-secondary-bg-color') || '#e5e5ea',
                        }
                    },
                    x: {
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--tg-theme-hint-color') || '#8e8e93',
                        },
                        grid: {
                            color: 'rgba(0,0,0,0)', // Скрываем вертикальные линии
                        }
                    }
                } : {}
            };

            const newChart = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Количество',
                        data: data,
                        backgroundColor: colors,
                        borderColor: getComputedStyle(document.body).getPropertyValue('--tg-theme-secondary-bg-color') || '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });

            if (canvasId === 'loyaltyChart') loyaltyChart = newChart;
            if (canvasId === 'actionChart') actionChart = newChart;
        }

        // --- АДМИН ФУНКЦИИ ---

        window.confirmAndDeleteData = () => {
            if (!isAdmin) {
                showAlert('Ошибка', 'Нет прав администратора.');
                return;
            }
            if (!firebaseConfig.projectId) return showAlert('Ошибка', 'Конфигурация Firebase отсутствует.');

            if (confirm("Вы уверены? Это действие безвозвратно удалит ВСЕ данные (записи) из Firestore!")) {
                deleteCollection();
            }
        };

        // Функция для удаления коллекции (рекурсивная)
        async function deleteCollection() {
            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            try {
                // ВАЖНО: В реальном проекте используйте Cloud Functions для рекурсивного удаления
                // Здесь - упрощенная версия для Mini App, которая может быть медленной на больших объемах
                const batchSize = 50;
                let deletedCount = 0;
                let query = surveysCollection.limit(batchSize);

                while (true) {
                    const snapshot = await query.get();
                    if (snapshot.size === 0) break;

                    const batch = db.batch();
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    deletedCount += snapshot.size;

                    // Если размер меньше batchSize, значит удалили все
                    if (snapshot.size < batchSize) break;
                }

                showAlert('Успешно!', `Удалено ${deletedCount} записей. Данные Firestore очищены.`);
                
                // Перезагрузить отчеты после удаления
                if (isAdmin) fetchAndRenderReports(); 
                
                return true;
                
            } catch (e) {
                 console.error("Error deleting collection:", e);
                 showAlert('Ошибка', 'Произошла ошибка при удалении коллекции: ' + e.message);
                 return false;
            } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        }

        // ❌ УДАЛЕНО: window.requestAdminLogin (Логика входа полностью перенесена на клиента)
        // Теперь, если userTelegramId === ADMIN_TELEGRAM_ID, то isAdmin = true, и отчеты/админ-панель доступны.
        window.requestAdminLogin = () => {
             showAlert('Информация', 'Авторизация администратора теперь происходит автоматически по Вашему Telegram ID при запуске.');
             if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
        
        // --- ИНИЦИАЛИЗАЦИЯ WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // Инициализация при загрузке
        window.onload = () => {
            showSection('form');
            lucide.createIcons();
            
            if (isAdmin) {
                // Если админ, можно сразу загрузить отчеты на фоне, но не переключать секцию
                console.log("Admin detected. Initializing reports...");
                fetchAndRenderReports(); 
            }
            
            // Если нет Firebase config, показываем ошибку
            if (!firebaseConfig.projectId) {
                showAlert('ВНИМАНИЕ', 'Необходимо вставить ключи конфигурации Firebase в код.');
            }
        };
    </script>
</body>
</html>
