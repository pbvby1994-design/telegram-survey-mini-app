<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | v2.5 (–ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <style>
        :root {
            --primary: #0088cc;
            --secondary: #27a8e0;
            --background: #f0f2f5;
        }

        body {
            font-family: 'Jost', sans-serif;
            background-color: var(--background);
            color: #333;
        }

        .container {
            max-width: 100%;
            padding: 0;
        }

        .header {
            background-color: var(--primary);
            color: white;
        }

        .tab-button.active {
            border-bottom: 3px solid white;
            font-weight: 600;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: background-color 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #0077b3;
        }

        .input-style {
            border: 1px solid #ccc;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: border-color 0.2s;
        }
        .input-style:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.2);
        }

        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã */
        #map-container {
            height: 80vh; 
            min-height: 400px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ */
        .report-card {
            background-color: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen">
        <header class="header p-4 shadow-lg sticky top-0 z-10">
            <h1 class="text-xl font-bold">–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ (–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å)</h1>
            <div id="debugInfo" class="text-xs opacity-70 mt-1 flex space-x-2">
                <span id="debugUserId">ID: ...</span>
                <span id="debugAdminStatus">–ê–¥–º–∏–Ω: ...</span>
                <span id="offlineStatus" class="font-medium text-red-300"></span>
            </div>
            <div id="authRequired" class="text-xs bg-yellow-400 text-gray-800 p-1 rounded-md mt-1 hidden">
                –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è!
            </div>
        </header>

        <nav class="bg-gray-700 text-white shadow-md sticky top-[72px] z-10">
            <div class="flex justify-around items-center text-sm">
                <button onclick="window.showSection('form')" class="tab-button active p-3 hover:bg-gray-600 w-full transition-colors flex justify-center items-center space-x-2">
                    <i data-lucide="edit-3" class="w-5 h-5"></i>
                    <span>–§–æ—Ä–º–∞</span>
                </button>
                <button onclick="window.showSection('reports')" class="tab-button p-3 hover:bg-gray-600 w-full transition-colors flex justify-center items-center space-x-2">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                    <span>–û—Ç—á–µ—Ç—ã</span>
                </button>
                <button onclick="window.showSection('map')" class="tab-button p-3 hover:bg-gray-600 w-full transition-colors flex justify-center items-center space-x-2">
                    <i data-lucide="map" class="w-5 h-5"></i>
                    <span>–ö–∞—Ä—Ç–∞</span>
                </button>
            </div>
        </nav>

        <main class="p-4 space-y-4">
            <section id="section-form" class="section">
                <div class="bg-white p-5 rounded-xl shadow-md space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>

                    <div>
                        <label for="settlementSelect" class="block text-sm font-medium text-gray-700 mb-1">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</label>
                        <select id="settlementSelect" class="input-style w-full bg-white" required>
                            </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">–û—Ü–µ–Ω–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="loyalty" value="strong" class="text-green-500" checked>
                                <span class="ml-2 text-sm text-green-600 font-medium">–°–∏–ª—å–Ω–∞—è</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="loyalty" value="weak" class="text-yellow-500">
                                <span class="ml-2 text-sm text-yellow-600 font-medium">–°–ª–∞–±–∞—è</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="loyalty" value="against" class="text-red-500">
                                <span class="ml-2 text-sm text-red-600 font-medium">–ü—Ä–æ—Ç–∏–≤</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label for="addressInput" class="block text-sm font-medium text-gray-700 mb-1">–ê–¥—Ä–µ—Å (—É–ª–∏—Ü–∞ –∏ –¥–æ–º)</label>
                        <input type="text" id="addressInput" class="input-style w-full" 
                        placeholder="–ø—Ä. –õ–µ–Ω–∏–Ω–∞, 10" required>
                    </div>

                    <div>
                        <label for="photoFile" class="block text-sm font-medium text-gray-700 mb-1">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="file" id="photoFile" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-secondary">
                        <input type="hidden" id="photoBase64">
                        <div id="photoPreviewContainer" class="mt-2 hidden">
                            <img id="photoPreview" class="max-w-full h-auto rounded-lg shadow-sm">
                            <button onclick="clearPhoto()" class="text-red-500 text-sm mt-1 flex items-center space-x-1 hover:text-red-700">
                                <i data-lucide="x" class="w-4 h-4"></i>
                                <span>–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</span>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="commentTextarea" class="block text-sm font-medium text-gray-700 mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea id="commentTextarea" class="input-style w-full h-24" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
                    </div>

                    <div class="flex items-center space-x-4">
                        <button onclick="getGPS()" class="btn-primary flex items-center space-x-2 py-2 px-4 
                        rounded-lg text-sm font-medium shadow-md">
                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                            <span>–ü–æ–ª—É—á–∏—Ç—å GPS</span>
                        </button>
                        <span id="gpsDisplay" class="text-sm text-gray-600">–®–∏—Ä–æ—Ç–∞: –ù–ï–¢, –î–æ–ª–≥–æ—Ç–∞: –ù–ï–¢</span>
                        <input type="hidden" id="latitudeInput">
                        <input type="hidden" id="longitudeInput">
                    </div>

                    <button onclick="saveReport()" id="saveButton" class="btn-primary w-full py-3 rounded-xl text-lg font-bold shadow-xl mt-6 disabled:opacity-50" disabled>
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –û—Ç—á–µ—Ç
                    </button>
                    <p id="saveStatus" class="text-center text-sm mt-2 hidden"></p>
                </div>
            </section>

            <section id="section-reports" class="section hidden">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">–°–≤–æ–¥–∫–∞ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç—á–µ—Ç—ã</h2>
                
                <div id="latestDataSummary" class="bg-white p-5 rounded-xl shadow-md mb-4 space-y-4">
                    <h3 class="text-lg font-medium border-b pb-2 mb-3">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    <canvas id="reportsChart" class="w-full h-64"></canvas>
                    <div id="latestDataList" class="space-y-3">
                        <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–¥–∫–∏...</p>
                    </div>
                </div>

                <div class="flex space-x-2 mb-4">
                    <button onclick="fetchAndRenderReports('today')" id="btnToday" class="btn-primary py-2 px-4 rounded-lg text-sm font-medium w-full">–°–µ–≥–æ–¥–Ω—è</button>
                    <button onclick="fetchAndRenderReports('last7days')" id="btn7Days" class="btn-primary py-2 px-4 rounded-lg text-sm font-medium w-full">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</button>
                    <button onclick="fetchAndRenderReports('all')" id="btnAll" 
                    class="btn-primary py-2 px-4 rounded-lg text-sm font-medium w-full">–í—Å–µ–≥–æ</button>
                </div>

                <div id="reportsList" class="space-y-3">
                    <p class="text-center text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤.</p>
                </div>
            </section>

            <section id="section-map" class="section hidden">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∏ –ú–∞—Ä–∫–µ—Ä—ã</h2>
                <div id="map-container" class="bg-white rounded-xl shadow-md">
                    </div>
            </section>
        </main>
    </div>

    <div id="customModal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 id="modalTitle" class="text-xl font-bold mb-3 text-gray-800">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
            <p id="modalMessage" class="text-gray-600 mb-4"></p>
            <div id="modalButtons" class="flex justify-center space-x-3">
                <button id="modalConfirmBtn" class="btn-primary py-2 px-4 rounded-lg font-medium hidden">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button id="modalCloseBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-colors">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, limit, orderBy, getDocs, writeBatch, startAfter, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ Firestore
        setLogLevel('debug');
        
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const isTMA = typeof Telegram !== 'undefined' && Telegram.WebApp;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤–Ω–µ—à–Ω–µ–π —Å—Ä–µ–¥–æ–π (Python-–±–æ—Ç–æ–º)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ?
        __initial_auth_token : '';

        let app, db, auth;
        let userTelegramId = null;
        let isAdmin = false;
        let chartInstance = null;
        let mapInstance = null;
        let reportsData = []; // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤

        // –í–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ—Å–µ–ª–µ–Ω–∏—è
        const SETTLEMENTS = [
            '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç 1',
            '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç 2',
            '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç 3',
            '–î—Ä—É–≥–æ–µ'
        ];
        
        // --- –£–¢–ò–õ–ò–¢–´ ---

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É—Ç–∏ –¥–ª—è Firestore. 
        function getCollectionPath(collectionName, isPublic = true) {
            if (isPublic) {
                // –í—Å–µ –æ—Ç—á–µ—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø—É–±–ª–∏—á–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ 'reports'
                return collectionName; 
            }
            // –≠—Ç–æ—Ç –ø—É—Ç—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –≤—Å–µ –æ—Ç—á–µ—Ç—ã –ø—É–±–ª–∏—á–Ω—ã –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
            return `artifacts/${appId}/users/${userTelegramId}/${collectionName}`; 
        }

        // –ö–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        window.showAlert = (title, message) => {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalConfirmBtn').classList.add('hidden');
            
            const closeBtn = document.getElementById('modalCloseBtn');
            closeBtn.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
            closeBtn.onclick = () => {
                modal.style.display = 'none';
            };
            modal.style.display = 'flex';
        };

        window.showConfirm = (title, message) => {
            return new Promise(resolve => {
                const modal = document.getElementById('customModal');
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                
                const confirmBtn = document.getElementById('modalConfirmBtn');
                confirmBtn.textContent = '–î–∞';
                confirmBtn.classList.remove('hidden');

                const closeBtn = document.getElementById('modalCloseBtn');
                closeBtn.textContent = '–û—Ç–º–µ–Ω–∞';

                confirmBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(true);
                };
                closeBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(false);
                };
                modal.style.display = 'flex';
            });
        };
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
        window.showImageModal = (base64Img) => {
            window.showAlert('–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏', '');
            document.getElementById('modalMessage').innerHTML = 
                `<img src="${base64Img}" class="max-w-full h-auto rounded-lg shadow-sm">`;
        };

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        window.showSection = (sectionId) => {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`section-${sectionId}`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`[onclick="window.showSection('${sectionId}')"]`).classList.add('active');

            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–∞—Ä—Ç—ã
            if (sectionId === 'map') {
                setTimeout(() => generateMap(), 100); 
            }
        };

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ---
        if (firebaseConfig.projectId) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                console.log("Firebase initialized successfully.");
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                window.showAlert('–û–®–ò–ë–ö–ê FIREBASE', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.');
            }
        } else {
            console.warn("Firebase config is empty. Database operations will not work.");
        }


        // üîë –§–£–ù–ö–¶–ò–Ø –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò (–ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï)
        async function authenticateUser() {
            if (!app) {
                window.showAlert('–û–®–ò–ë–ö–ê', 'Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏.');
                return false;
            }
            
            try {
                const auth = getAuth(app);
                
                // 1. –ü–æ–ø—ã—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å Custom Token
                if (!initialAuthToken) throw new Error("Custom Token –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start.");

                await signInWithCustomToken(auth, initialAuthToken);

                const user = auth.currentUser;
                if (!user) throw new Error("–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");

                userTelegramId = user.uid; 
                
                // 2. !!! –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω-—Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ Custom Claims
                const tokenResult = await user.getIdTokenResult();
                isAdmin = tokenResult.claims.admin === true; 
                
                // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ UI
                document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
                document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';
                document.getElementById('saveButton').disabled = false;

                return true;
            } catch (e) {
                console.error('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò FIREBASE:', e);
                let errorMessage = `–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Ö–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å. –°–æ–æ–±—â–µ–Ω–∏–µ: ${e.message}`;

                if (e.code === 'auth/invalid-custom-token') {
                    errorMessage = '–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç–æ–∫–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start.';
                }

                window.showAlert('–û–®–ò–ë–ö–ê –í–•–û–î–ê', errorMessage);
                document.getElementById('authRequired').classList.remove('hidden');
                document.getElementById('saveButton').disabled = true;
                
                return false;
            }
        }


        // --- –õ–û–ì–ò–ö–ê –§–û–†–ú–´ ---

        function populateSettlements() {
            const select = document.getElementById('settlementSelect');
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>';
            SETTLEMENTS.forEach(settlement => {
                const option = document.createElement('option');
                option.value = settlement;
                option.textContent = settlement;
                select.appendChild(option);
            });
            select.addEventListener('change', checkFormValidity);
            document.getElementById('addressInput').addEventListener('input', checkFormValidity);
        }

        function checkFormValidity() {
            const settlement = document.getElementById('settlementSelect').value;
            const address = document.getElementById('addressInput').value.trim();
            const saveButton = document.getElementById('saveButton');
            
            const isValid = settlement && address;
            saveButton.disabled = !isValid;
        }

        // GPS (–û—Å—Ç–∞–≤–ª–µ–Ω–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Geolocation API –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π)
        function getGPS() {
            document.getElementById('gpsDisplay').textContent = '–ü–æ–∏—Å–∫ GPS...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    document.getElementById('latitudeInput').value = lat;
                    document.getElementById('longitudeInput').value = lon;
                    document.getElementById('gpsDisplay').textContent = `–®–∏—Ä–æ—Ç–∞: ${lat.toFixed(4)}, –î–æ–ª–≥–æ—Ç–∞: ${lon.toFixed(4)}`;
                }, error => {
                    console.error("Geolocation error:", error);
                    window.showAlert('–û–®–ò–ë–ö–ê GPS', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
                    document.getElementById('gpsDisplay').textContent = 'GPS: –û–®–ò–ë–ö–ê';
                }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
            } else {
                window.showAlert('–û–®–ò–ë–ö–ê GPS', '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º.');
                document.getElementById('gpsDisplay').textContent = 'GPS: –ù–ï–¢';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        document.getElementById('photoFile').onchange = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    document.getElementById('photoBase64').value = base64;
                    const preview = document.getElementById('photoPreview');
                    preview.src = base64;
                    document.getElementById('photoPreviewContainer').classList.remove('hidden');
                };
                reader.onerror = function(e) { 
                    console.error("File reading error:", e);
                    window.showAlert('–û–®–ò–ë–ö–ê –§–ê–ô–õ–ê', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
                };
                reader.readAsDataURL(file);
            }
        };

        function clearPhoto() {
            document.getElementById('photoFile').value = '';
            document.getElementById('photoBase64').value = '';
            document.getElementById('photoPreviewContainer').classList.add('hidden');
            document.getElementById('photoPreview').src = '';
        } 
        
        // üíæ –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞
        async function saveReport() {
            if (!userTelegramId || !db) {
                 window.showAlert('–û–®–ò–ë–ö–ê', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –ë–î –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.'); return;
            }

            const settlement = document.getElementById('settlementSelect').value;
            const loyalty = document.querySelector('input[name="loyalty"]:checked').value; // –ù–æ–≤–æ–µ –ø–æ–ª–µ
            const address = document.getElementById('addressInput').value.trim();
            const comment = document.getElementById('commentTextarea').value.trim();
            const photoBase64 = document.getElementById('photoBase64').value;
            const lat = document.getElementById('latitudeInput').value;
            const lon = document.getElementById('longitudeInput').value;

            if (!settlement || !address) {
                window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç –∏ –∞–¥—Ä–µ—Å.'); return;
            }

            const reportData = {
                user_id: userTelegramId, // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å user_id –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø—Ä–∞–≤–∏–ª–∞–º Firestore
                settlement: settlement,
                loyalty: loyalty, // –ù–æ–≤–æ–µ –ø–æ–ª–µ
                address: address,
                comment: comment,
                photo: photoBase64,
                latitude: lat ? parseFloat(lat) : null,
                longitude: lon ? parseFloat(lon) : null,
                timestamp: serverTimestamp()
            };

            const saveButton = document.getElementById('saveButton');
            const saveStatus = document.getElementById('saveStatus');
            saveButton.disabled = true;
            saveStatus.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            saveStatus.classList.remove('hidden', 'text-green-500', 'text-red-500');
            
            try {
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø—É–±–ª–∏—á–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é 'reports'
                const reportsCol = collection(db, getCollectionPath('reports'));
                await addDoc(reportsCol, reportData);
                
                saveStatus.textContent = '‚úÖ –û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!';
                saveStatus.classList.add('text-green-500');
                
                // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                document.getElementById('addressInput').value = '';
                document.getElementById('commentTextarea').value = '';
                document.getElementById('settlementSelect').value = '';
                clearPhoto();
                document.getElementById('gpsDisplay').textContent = '–®–∏—Ä–æ—Ç–∞: –ù–ï–¢, –î–æ–ª–≥–æ—Ç–∞: –ù–ï–¢';
                document.getElementById('latitudeInput').value = '';
                document.getElementById('longitudeInput').value = '';
                checkFormValidity();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤, –µ—Å–ª–∏ –∞–¥–º–∏–Ω
                if (isAdmin) {
                    renderLatestData();
                    fetchAndRenderReports('today');
                }
                
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞:", e);
                saveStatus.textContent = `‚ùå –û—à–∏–±–∫–∞: ${e.message}`;
                saveStatus.classList.add('text-red-500');
            } finally {
                saveButton.disabled = false;
            }
        }
        
        // --- –õ–û–ì–ò–ö–ê –û–¢–ß–ï–¢–û–í ---
        
        // üìà –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        function updateChart(counts, total) {
            const ctx = document.getElementById('reportsChart').getContext('2d');

            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const labels = Object.keys(counts);
            const data = Object.values(counts);

            const backgroundColors = [ 
                'rgba(0, 136, 204, 0.8)', // Primary
                'rgba(39, 168, 224, 0.8)', // Secondary
                'rgba(110, 194, 235, 0.8)', // Light Blue
                'rgba(255, 189, 46, 0.8)', // Yellow
            ].slice(0, labels.length);

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤',
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { family: 'Jost' }
                            }
                        },
                        title: {
                            display: true,
                            text: `–í—Å–µ–≥–æ: ${total}`,
                            font: { size: 16, family: 'Jost', weight: 'bold' }
                        }
                    }
                }
            });
        }
        
        // üìä –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å–≤–æ–¥–∫–∏
        async function renderLatestData() {
            if (!db) return;
            const listContainer = document.getElementById('latestDataList');
            listContainer.innerHTML = '<p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–¥–∫–∏...</p>';

            try {
                const reportsCol = collection(db, getCollectionPath('reports'));
                const allReportsSnapshot = await getDocs(reportsCol);
                const data = allReportsSnapshot.docs.map(doc => doc.data());
                
                // –°—á–∏—Ç–∞–µ–º –ø–æ –ø–æ—Å–µ–ª–µ–Ω–∏—è–º
                const settlementCounts = data.reduce((acc, report) => {
                    acc[report.settlement] = (acc[report.settlement] || 0) + 1;
                    return acc;
                }, {});

                // –°—á–∏—Ç–∞–µ–º –ø–æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
                const loyaltyCounts = data.reduce((acc, report) => {
                    acc[report.loyalty] = (acc[report.loyalty] || 0) + 1;
                    return acc;
                }, {});

                // –†–µ–Ω–¥–µ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                listContainer.innerHTML = '';
                const totalCount = allReportsSnapshot.size;
                listContainer.innerHTML += `<p class="font-bold text-gray-800">–í—Å–µ–≥–æ –æ—Ç—á–µ—Ç–æ–≤ –≤ –±–∞–∑–µ: ${totalCount}</p>`;
                
                const statsDiv = document.createElement('div');
                statsDiv.className = 'grid grid-cols-2 gap-3 text-sm';

                statsDiv.innerHTML += '<h4 class="col-span-2 font-semibold mt-2 border-t pt-2">–û—Ç—á–µ—Ç—ã –ø–æ –ø–æ—Å–µ–ª–µ–Ω–∏—è–º:</h4>';
                Object.entries(settlementCounts)
                    .sort(([, a], [, b]) => b - a)
                    .forEach(([settlement, count]) => {
                        statsDiv.innerHTML += ` <p class="font-medium truncate">${settlement}:</p> <p class="text-right text-primary">${count} —à—Ç.</p> `;
                    });

                statsDiv.innerHTML += '<h4 class="col-span-2 font-semibold mt-2 border-t pt-2">–û—Ü–µ–Ω–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏:</h4>';
                Object.entries(loyaltyCounts)
                    .forEach(([loyalty, count]) => {
                        const loyaltyColor = loyalty === 'strong' ? 'text-green-600' : loyalty === 'against' ? 'text-red-600' : 'text-yellow-600';
                        const loyaltyText = loyalty === 'strong' ? '–°–∏–ª—å–Ω–∞—è' : loyalty === 'against' ? '–ü—Ä–æ—Ç–∏–≤' : '–°–ª–∞–±–∞—è';
                        statsDiv.innerHTML += ` <p class="font-medium truncate ${loyaltyColor}">${loyaltyText}:</p> <p class="text-right ${loyaltyColor}">${count} —à—Ç.</p> `;
                    });


                listContainer.appendChild(statsDiv);

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
                updateChart(settlementCounts, totalCount);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–≤–æ–¥–∫–∏:", e);
                listContainer.innerHTML = '<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–¥–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.</p>';
            }
        }
        
        // üìã –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
        async function fetchAndRenderReports(filterType) {
            if (!db) return;
            const listContainer = document.getElementById('reportsList');
            listContainer.innerHTML = '<p class="text-gray-500 text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤...</p>';
            
            let title = '–í—Å–µ –æ—Ç—á–µ—Ç—ã';
            const reportsCol = collection(db, getCollectionPath('reports'));
            let q = reportsCol;
            let now = new Date();
            let filterDate;

            // 1. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            if (filterType === 'today') {
                title = '–û—Ç—á–µ—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è';
                filterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            } else if (filterType === 'last7days') {
                title = '–û—Ç—á–µ—Ç—ã –∑–∞ 7 –¥–Ω–µ–π';
                filterDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            }

            if (filterType !== 'all') {
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
                q = query(q, where('timestamp', '>=', Timestamp.fromDate(filterDate)));
            }
            
            // 2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–ï—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω)
            if (!isAdmin) {
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ user_id
                q = query(q, where('user_id', '==', userTelegramId));
                title = `–ú–æ–∏ –æ—Ç—á–µ—Ç—ã (${title})`;
            }

            // 3. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
            q = query(q, orderBy('timestamp', 'desc'));

            try {
                const snapshot = await getDocs(q);
                reportsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                listContainer.innerHTML = `<h3 class="text-lg font-medium border-b pb-2 mb-3">${title} (${reportsData.length})</h3>`;

                if (!isAdmin) {
                    listContainer.innerHTML = `<p class="text-yellow-600 mb-4">–í—ã –≤–∏–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –æ—Ç—á–µ—Ç—ã.</p>` + listContainer.innerHTML;
                }

                if (reportsData.length === 0) {
                    listContainer.innerHTML += '<p class="text-center text-gray-500">–û—Ç—á–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
                    return;
                }

                // 4. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç–æ—á–µ–∫ –æ—Ç—á–µ—Ç–æ–≤
                reportsData.forEach(report => {
                    const date = report.timestamp?.toDate ? report.timestamp.toDate().toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' }) : '–ù/–î';
                    
                    let loyaltyClass = 'text-gray-900';
                    if (report.loyalty === 'strong') loyaltyClass = 'text-green-600 font-bold';
                    else if (report.loyalty === 'against') loyaltyClass = 'text-red-600 font-bold';

                    const card = document.createElement('div');
                    card.className = 'report-card';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-primary">${report.settlement} - ${report.address}</h4>
                            <span class="text-xs text-gray-500">${date}</span>
                        </div>
                        <p class="text-sm font-semibold mb-2 ${loyaltyClass}">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å: ${report.loyalty || '–ù/–î'}</p>
                        <p class="text-sm text-gray-700 mb-2">${report.comment || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}</p>
                        ${report.latitude && report.longitude ? 
                            `<p class="text-xs text-gray-500">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}</p>` : 
                            '<p class="text-xs text-gray-500">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –ù/–î</p>'}
                        ${report.photo ? 
                            `<div class="mt-3"><img src="${report.photo}" class="w-full max-h-40 object-cover rounded-lg shadow-sm cursor-pointer" onclick="window.showImageModal('${report.photo}')"></div>` : ''}
                        ${isAdmin ? `<p class="text-xs mt-2 text-gray-400">ID –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞: ${report.user_id}</p>` : ''}
                    `;
                    listContainer.appendChild(card);
                });

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–æ–≤:", e);
                document.getElementById('reportsList').innerHTML = '<p class="text-red-500">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.</p>';
            }
        }

        // üó∫Ô∏è –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
        window.generateMap = function() {
            if (!reportsData || reportsData.length === 0) {
                 document.getElementById('map-container').innerHTML = '<p class="p-4 text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ—Ç—á–µ—Ç—ã (–í—Å–µ–≥–æ) —Å–Ω–∞—á–∞–ª–∞.</p>';
                 return;
            }

            const mapDiv = document.getElementById('map-container');
            if (mapInstance) {
                mapInstance.remove();
            }
            mapDiv.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ—á–µ–∫ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
            const validPoints = reportsData.filter(r => r.latitude && r.longitude);
            const validPointsCount = validPoints.length;

            if (validPointsCount === 0) {
                mapDiv.innerHTML = '<p class="p-4 text-center text-gray-500">–û—Ç—á–µ—Ç—ã –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç.</p>';
                return;
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (—Ü–µ–Ω—Ç—Ä –±–µ—Ä–µ–º –æ—Ç –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏)
            mapInstance = L.map('map-container').setView([validPoints[0].latitude, validPoints[0].longitude], 10);
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–ª–æ–≤ (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(mapInstance);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∏ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
            const markers = L.markerClusterGroup();
            const heatData = [];
            
            validPoints.forEach(report => {
                const lat = report.latitude;
                const lon = report.longitude;
                const date = report.timestamp?.toDate ? report.timestamp.toDate().toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' }) : '–ù/–î';

                // Popup –∫–æ–Ω—Ç–µ–Ω—Ç
                const popupContent = `
                    <h4 class="font-bold">${report.settlement} - ${report.address}</h4>
                    <p class="text-xs text-gray-500">${date}</p>
                    <p class="text-sm">${report.comment || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}</p>
                    ${report.photo ? '<p class="mt-2 text-primary text-xs">–ï—Å—Ç—å —Ñ–æ—Ç–æ</p>' : ''}
                    ${isAdmin ? `<p class="text-xs mt-2 text-gray-400">ID: ${report.user_id}</p>` : ''}
                `;

                // –ú–∞—Ä–∫–µ—Ä
                const marker = L.marker([lat, lon]);
                marker.bindPopup(popupContent);
                markers.addLayer(marker);

                // –¢–æ—á–∫–∞ –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã (LatLng + –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å)
                heatData.push([lat, lon, 0.5]); 
            });

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç—É
            mapInstance.addLayer(markers);

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã 
            if (heatData.length > 0) {
                const heat = L.heatLayer(heatData, {
                    radius: 20,
                    blur: 15,
                    maxZoom: 17,
                    gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'}
                }).addTo(mapInstance);
            }

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç—ã –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º
            if (validPointsCount > 0) {
                const bounds = markers.getBounds();
                mapInstance.fitBounds(bounds, {padding: [50, 50]}); 
            }
            console.log(`–ö–∞—Ä—Ç–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞. –¢–æ—á–µ–∫ —Å GPS: ${validPointsCount}`);
        }

        // --- –ì–õ–ê–í–ù–´–ô –ë–õ–û–ö –ó–ê–ü–£–°–ö–ê ---

        window.onload = async () => {
            // 1. –°–Ω–∞—á–∞–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ isAdmin –∏ userTelegramId
            const isAuthenticated = await authenticateUser();

            // 2. –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            populateSettlements();
            lucide.createIcons();

            // 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π —Å–µ–∫—Ü–∏–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            if (isAuthenticated) {
                if (isAdmin) {
                    // –ê–¥–º–∏–Ω: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –û—Ç—á–µ—Ç—ã –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                    window.showSection('reports');
                    renderLatestData();
                    fetchAndRenderReports('today'); 
                } else {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –§–æ—Ä–º—É –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ —Å–≤–æ–¥–∫—É
                    window.showSection('form');
                    renderLatestData(); // –ó–∞–≥—Ä—É–∑–∏—Ç —Å–≤–æ–¥–∫—É (–ø–æ–∫–∞–∂–µ—Ç 100% –µ–≥–æ –¥–∞–Ω–Ω—ã–µ)
                }
            } else {
                 // –ï—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ –∑–∞–ø—Ä–µ—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
                 window.showSection('form');
                 document.getElementById('saveButton').disabled = true;
            }

            if (!firebaseConfig.projectId) {
                window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–¥–∞—á—É Base64 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.');
            }
        };

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        window.saveReport = saveReport;
        window.getGPS = getGPS;
        window.fetchAndRenderReports = fetchAndRenderReports;
        window.renderLatestData = renderLatestData;
        window.generateMap = generateMap;

    </script>
</body>
</html>
