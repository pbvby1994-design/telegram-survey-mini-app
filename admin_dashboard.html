<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | v2.5 (–§–∏–∫—Å –ê–¥–º–∏–Ω–∞/ID/–û–Ω–ª–∞–π–Ω)</title>

    <!-- Tailwind CSS, Lucide Icons, Chart.js, Leaflet.js, XLSX, Firebase -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <!-- Firebase SDKs - v9 compat for wider support -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Jost', sans-serif; }
        .tab-button.active { @apply border-b-2 border-indigo-500 font-semibold text-indigo-700; }
        .tab-button { @apply px-4 py-2 text-center text-gray-500 transition duration-150 ease-in-out; }
        .card { @apply bg-white p-4 rounded-xl shadow-lg border border-gray-100; }
        .input-group label { @apply block text-sm font-medium text-gray-700 mb-1; }
        .input-group input, .input-group select, .input-group textarea { @apply w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500; }
        #map { height: 600px; width: 100%; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .leaflet-popup-content-wrapper { border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- –°–µ–∫—Ü–∏—è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (Alert/Toast) -->
    <div id="alertContainer" class="fixed top-0 left-0 right-0 p-4 z-50 pointer-events-none">
        <!-- Alerts will be inserted here -->
    </div>

    <!-- –û–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-1 flex items-center">
            <i data-lucide="notebook-pen" class="w-6 h-6 mr-2 text-indigo-600"></i>
            –ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞
        </h1>
        <p class="text-sm text-gray-500 mb-4">v2.5 (–§–∏–∫—Å –ê–¥–º–∏–Ω–∞/ID/–û–Ω–ª–∞–π–Ω)</p>

        <!-- –°—Ç–∞—Ç—É—Å –∏ –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–î–ª—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞) -->
        <div class="card mb-6 p-3 bg-indigo-50 border-indigo-200">
            <div class="flex flex-wrap items-center justify-between text-sm">
                <div class="flex items-center space-x-2">
                    <span class="font-medium text-indigo-700">–°—Ç–∞—Ç—É—Å:</span>
                    <span id="offlineStatus" class="font-medium flex items-center">
                        <i data-lucide="zap" class="w-4 h-4 mr-1 text-green-500 animate-pulse"></i>
                        –û–Ω–ª–∞–π–Ω
                    </span>
                </div>
                <div class="flex flex-wrap text-xs text-indigo-600 space-x-3">
                    <span title="–í–∞—à ID –≤ Telegram">ID: <span id="debugUserId" class="font-bold text-indigo-800">–ù–µ—Ç ID</span></span>
                    <span title="–í–∞—à–µ –ò–º—è">–ò–º—è: <span id="debugUserName" class="font-bold text-indigo-800">N/A</span></span>
                    <span title="–ü—Ä–∞–≤–∞ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">–ê–¥–º–∏–Ω: <span id="debugAdminStatus" class="font-bold text-indigo-800">–ù–ï–¢</span></span>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏-—Ç–∞–±—ã -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="formTab" class="tab-button active" onclick="showSection('form')">
                <i data-lucide="square-pen" class="w-4 h-4 inline-block mr-1"></i>
                –í–≤–æ–¥ –î–∞–Ω–Ω—ã—Ö
            </button>
            <button id="reportsTab" class="tab-button hidden" onclick="showSection('reports')">
                <i data-lucide="bar-chart-3" class="w-4 h-4 inline-block mr-1"></i>
                –û—Ç—á–µ—Ç—ã (–ê–¥–º–∏–Ω)
            </button>
            <button id="latestDataTab" class="tab-button" onclick="showSection('latestData')">
                <i data-lucide="list-checks" class="w-4 h-4 inline-block mr-1"></i>
                –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ó–∞–ø–∏—Å–∏
            </button>
        </div>

        <!-- 1. –°–µ–∫—Ü–∏—è –í–≤–æ–¥ –î–∞–Ω–Ω—ã—Ö -->
        <section id="form" class="space-y-6">
            <div class="card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                <form id="agitatorForm" onsubmit="submitForm(event)" class="space-y-4">
                    <!-- –ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç -->
                    <div class="input-group">
                        <label for="settlement">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</label>
                        <select id="settlement" required>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>

                    <div class="flex space-x-4">
                        <!-- –£–ª–∏—Ü–∞ -->
                        <div class="input-group w-3/4">
                            <label for="street">–£–ª–∏—Ü–∞</label>
                            <input type="text" id="street" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –õ–µ–Ω–∏–Ω–∞" required>
                        </div>
                        <!-- –î–æ–º -->
                        <div class="input-group w-1/4">
                            <label for="house">–î–æ–º</label>
                            <input type="text" id="house" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 10–ê" required>
                        </div>
                    </div>

                    <!-- –ö–≤–∞—Ä—Ç–∏—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) -->
                    <div class="input-group">
                        <label for="apartment">–ö–≤–∞—Ä—Ç–∏—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="text" id="apartment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 5">
                    </div>

                    <!-- –î–µ–π—Å—Ç–≤–∏–µ -->
                    <div class="input-group">
                        <label for="action">–î–µ–π—Å—Ç–≤–∏–µ</label>
                        <select id="action" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</option>
                            <option value="–í–∏–∑–∏—Ç">–í–∏–∑–∏—Ç (–ù–µ –∑–∞—Å—Ç–∞–ª–∏)</option>
                            <option value="–ü—Ä–æ–≤–µ–¥–µ–Ω –æ–ø—Ä–æ—Å">–ü—Ä–æ–≤–µ–¥–µ–Ω –æ–ø—Ä–æ—Å</option>
                            <option value="–û—Å—Ç–∞–≤–ª–µ–Ω –º–∞—Ç–µ—Ä–∏–∞–ª">–û—Å—Ç–∞–≤–ª–µ–Ω –º–∞—Ç–µ—Ä–∏–∞–ª</option>
                        </select>
                    </div>

                    <!-- –õ–æ—è–ª—å–Ω–æ—Å—Ç—å -->
                    <div class="input-group">
                        <label for="loyalty">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</label>
                        <select id="loyalty" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</option>
                            <option value="–ù–µ–π—Ç—Ä–∞–ª–µ–Ω">–ù–µ–π—Ç—Ä–∞–ª–µ–Ω</option>
                            <option value="–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç</option>
                            <option value="–ü—Ä–æ—Ç–∏–≤">–ü—Ä–æ—Ç–∏–≤</option>
                            <option value="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</option>
                        </select>
                    </div>

                    <!-- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–∏–∑–∏—Ç -->
                    <div class="input-group flex items-center space-x-2 pt-2">
                        <input type="checkbox" id="requiresFollowup" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="requiresFollowup" class="mb-0">–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–∏–∑–∏—Ç</label>
                    </div>

                    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                    <div class="input-group">
                        <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–≤–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏)</label>
                        <textarea id="comment" rows="3" placeholder="–ö—Ä–∞—Ç–∫–∏–µ, –≤–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è..."></textarea>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –û—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                        <i data-lucide="save" class="w-5 h-5 inline-block mr-2"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ó–∞–ø–∏—Å—å
                    </button>
                </form>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ö–µ—à–µ–º -->
            <div class="card bg-orange-50 border-orange-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <i data-lucide="server-off" class="w-5 h-5 mr-2 text-orange-500"></i>
                    –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º (–ö—ç—à)
                </h2>
                <p class="text-sm text-gray-600 mb-4">
                    –í–∞—à–∏ –∑–∞–ø–∏—Å–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫—ç—à–µ, –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –ò–Ω—Ç–µ—Ä–Ω–µ—Ç.
                </p>
                <div class="flex space-x-4">
                    <button onclick="syncData()" class="flex-1 bg-green-600 text-white p-3 rounded-xl font-semibold hover:bg-green-700 transition duration-150 shadow-md" id="syncButton">
                        <i data-lucide="upload" class="w-5 h-5 inline-block mr-2"></i>
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (<span id="cacheCount">0</span>)
                    </button>
                    <button onclick="clearCache()" class="bg-gray-400 text-white p-3 rounded-xl font-semibold hover:bg-gray-500 transition duration-150 shadow-md">
                        <i data-lucide="trash-2" class="w-5 h-5 inline-block"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- 2. –°–µ–∫—Ü–∏—è –û—Ç—á–µ—Ç—ã (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä) -->
        <section id="reports" class="hidden space-y-6">
            <div class="card bg-red-50 border-red-200" id="adminPanel">
                <h2 class="text-xl font-semibold text-red-700 mb-4 flex items-center">
                    <i data-lucide="shield-alert" class="w-5 h-5 mr-2 text-red-500"></i>
                    –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                </h2>
                <p class="text-sm text-gray-600 mb-4">
                    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å ID: <span class="font-bold text-red-800">541459471</span>
                </p>
                <button onclick="confirmClearDatabase()" class="w-full bg-red-600 text-white p-3 rounded-xl font-semibold hover:bg-red-700 transition duration-150 shadow-md">
                    <i data-lucide="flame" class="w-5 h-5 inline-block mr-2"></i>
                    –û–ß–ò–°–¢–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï –í –ë–ê–ó–ï (DANGER!)
                </button>
            </div>

            <div class="card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <i data-lucide="area-chart" class="w-5 h-5 mr-2 text-indigo-500"></i>
                    –°–≤–æ–¥–Ω—ã–π –û—Ç—á–µ—Ç
                </h2>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-blue-50 p-3 rounded-lg text-center shadow-inner">
                        <p class="text-sm text-gray-500">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p>
                        <p class="text-2xl font-bold text-blue-700" id="statTotalCount">0</p>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg text-center shadow-inner">
                        <p class="text-sm text-gray-500">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞–≥–∏—Ç–∞—Ç–æ—Ä–æ–≤</p>
                        <p class="text-2xl font-bold text-yellow-700" id="statUniqueUsers">0</p>
                    </div>
                </div>

                <!-- –ì—Ä–∞—Ñ–∏–∫ –õ–æ—è–ª—å–Ω–æ—Å—Ç–∏ -->
                <h3 class="text-lg font-medium text-gray-700 mb-2">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</h3>
                <canvas id="loyaltyChart" class="mb-6"></canvas>

                <!-- –ö–∞—Ä—Ç–∞ -->
                <h3 class="text-lg font-medium text-gray-700 mb-2">–ö–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
                <div id="map" class="mb-6"></div>

                <!-- –ö–Ω–æ–ø–∫–∞ –≠–∫—Å–ø–æ—Ä—Ç–∞ -->
                <button onclick="exportToXLSX()" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                    <i data-lucide="file-spreadsheet" class="w-5 h-5 inline-block mr-2"></i>
                    –≠–∫—Å–ø–æ—Ä—Ç –≤ XLSX
                </button>
            </div>
        </section>

        <!-- 3. –°–µ–∫—Ü–∏—è –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ -->
        <section id="latestData" class="hidden space-y-6">
            <div class="card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <i data-lucide="history" class="w-5 h-5 mr-2 text-indigo-500"></i>
                    –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ó–∞–ø–∏—Å–µ–π
                </h2>
                <div id="latestDataTable" class="overflow-x-auto">
                    <!-- Data will be inserted here -->
                </div>
                <p class="text-sm text-gray-500 mt-4 text-center">
                    <span class="font-bold">–í–Ω–∏–º–∞–Ω–∏–µ:</span> –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ –∫—ç—à–∞ (–∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º). –î–ª—è –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–û—Ç—á–µ—Ç—ã".
                </p>
            </div>
        </section>

    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full space-y-4">
            <h3 class="text-lg font-bold text-red-600 flex items-center">
                <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –£–¥–∞–ª–µ–Ω–∏—è
            </h3>
            <p class="text-gray-700">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ **–ù–ê–í–°–ï–ì–î–ê** —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!</p>
            <p class="text-sm text-gray-500">–í–≤–µ–¥–∏—Ç–µ `–£–î–ê–õ–ò–¢–¨` –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</p>
            <input type="text" id="confirmDeleteInput" class="w-full p-2 border border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500">
            <div class="flex justify-end space-x-3">
                <button onclick="document.getElementById('confirmModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="clearDatabase()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition" id="confirmDeleteButton">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>


    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í–°–¢–ê–í–ò–¢–¨ –°–Æ–î–ê –í–ê–®–ò –ö–õ–Æ–ß–ò) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVeRXO16KtIwoJQb4uHQuCsEv3xTLBGhI",
            authDomain: "agitator-notebook.firebaseapp.com",
            projectId: "agitator-notebook",
            storageBucket: "agitator-notebook.firebasestorage.app",
            messagingSenderId: "518555352011",
            appId: "1:518555352011:web:2b152d193d56a29774619d"
        };
        const COLLECTION_NAME = "reports"; // –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –≤ Firestore

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ö–û–ù–°–¢–ê–ù–¢–´ ---
        const ADMIN_ID = 541459471; // üëà –í–ê–®–ï ID –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê (Mikhail)
        const TMA_URL_PLACEHOLDER = 'https://t.me/your_bot_username/your_webapp_name'; // URL –¥–ª—è –∑–∞–≥–ª—É—à–∫–∏

        let app = null;
        let db = null;
        let isTMA = window.Telegram && window.Telegram.WebApp;
        let userTelegramId = null;
        let userFirstName = 'N/A';
        let isAdmin = false;
        let dataCache = []; // –õ–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à –¥–ª—è –æ—Ñ–ª–∞–π–Ω-–¥–∞–Ω–Ω—ã—Ö

        // --- –£–¢–ò–õ–ò–¢–´ ---

        /**
         * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ/—Ç–æ—Å—Ç –≤–≤–µ—Ä—Ö—É —ç–∫—Ä–∞–Ω–∞.
         * @param {string} title - –ó–∞–≥–æ–ª–æ–≤–æ–∫.
         * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ.
         * @param {string} type - –¢–∏–ø: 'success', 'error', 'warning', 'info'.
         */
        function showAlert(title, message, type = 'info') {
            const container = document.getElementById('alertContainer');
            let colorClass = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            }[type] || 'bg-gray-500';

            const alert = document.createElement('div');
            alert.className = `${colorClass} text-white p-3 rounded-xl shadow-lg mb-2 flex justify-between items-center transition-opacity duration-300 pointer-events-auto`;
            alert.innerHTML = `
                <div>
                    <strong class="font-bold">${title}:</strong>
                    <span>${message}</span>
                </div>
                <button onclick="this.parentElement.remove()" class="ml-4 opacity-75 hover:opacity-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            `;

            container.prepend(alert);
            lucide.createIcons(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                alert.classList.add('opacity-0');
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–µ–∫—Ü–∏–π –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–∞–±–æ–≤.
         * @param {string} sectionId - ID —Å–µ–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ('form', 'reports', 'latestData').
         */
        function showSection(sectionId) {
            ['form', 'reports', 'latestData'].forEach(id => {
                const section = document.getElementById(id);
                const tab = document.getElementById(id + 'Tab');
                if (section && tab) {
                    if (id === sectionId) {
                        section.classList.remove('hidden');
                        tab.classList.add('active');
                    } else {
                        section.classList.add('hidden');
                        tab.classList.remove('active');
                    }
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Ç–∞–±–∞
            if (sectionId === 'latestData') {
                renderLatestData();
            } else if (sectionId === 'reports' && isAdmin) {
                fetchAndRenderReports();
            }
        }
        window.showSection = showSection; // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è HTML

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞.
         */
        function updateOfflineStatus() {
            const statusElement = document.getElementById('offlineStatus');
            const cacheCountElement = document.getElementById('cacheCount');
            const syncButton = document.getElementById('syncButton');

            cacheCountElement.textContent = dataCache.length;

            // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            if (dataCache.length > 0) {
                syncButton.classList.remove('hidden');
                syncButton.innerHTML = `<i data-lucide="upload" class="w-5 h-5 inline-block mr-2"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (${dataCache.length})`;
                statusElement.innerHTML = `<i data-lucide="cloud-off" class="w-4 h-4 mr-1 text-orange-500"></i> –û—Ñ–ª–∞–π–Ω (${dataCache.length} –∑–∞–ø.)`;
                statusElement.classList.remove('text-green-700');
                statusElement.classList.add('text-orange-700');
            } else {
                syncButton.classList.add('hidden');
                statusElement.innerHTML = `<i data-lucide="zap" class="w-4 h-4 mr-1 text-green-500 animate-pulse"></i> –û–Ω–ª–∞–π–Ω`;
                statusElement.classList.remove('text-orange-700');
                statusElement.classList.add('text-green-700');
            }
            lucide.createIcons();
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ IndexedDB (–∫—ç—à).
         */
        async function loadCache() {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º localforage –¥–ª—è –Ω–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                const cacheStore = localforage.createInstance({ name: 'agitator_data_cache', storeName: COLLECTION_NAME });
                dataCache = [];
                await cacheStore.iterate((value) => {
                    dataCache.push(value);
                });
                updateOfflineStatus();
                console.log(`–ö—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω. –ù–∞–π–¥–µ–Ω–æ ${dataCache.length} –∑–∞–ø–∏—Å–µ–π.`);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫—ç—à–∞:", e);
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à.', 'error');
            }
        }

        // --- –õ–û–ì–ò–ö–ê –§–û–†–ú–´ –ò –°–û–•–†–ê–ù–ï–ù–ò–Ø ---

        /**
         * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ—Å–µ–ª–µ–Ω–∏–π.
         */
        function populateSettlements() {
            const settlements = [
                "–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–ö–∞–∑–∞–Ω—å" // –ú–æ–∫-–¥–∞–Ω–Ω—ã–µ
                // –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã
            ];
            const select = document.getElementById('settlement');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</option>';
            settlements.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                select.appendChild(option);
            });
        }

        /**
         * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –≤ –∫—ç—à –∏–ª–∏ Firestore.
         * @param {Event} event - –°–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã.
         */
        async function submitForm(event) {
            event.preventDefault();

            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            // 1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
            const formData = {
                timestamp: Date.now(),
                user_id: userTelegramId || 'anon_' + (isTMA ? Telegram.WebApp.initDataUnsafe.user.id : 'web_mock'), // –ï—Å–ª–∏ ID –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
                full_name: userFirstName, // –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–º—è
                settlement: document.getElementById('settlement').value,
                street: document.getElementById('street').value.trim(),
                house: document.getElementById('house').value.trim(),
                apartment: document.getElementById('apartment').value.trim() || 'N/A',
                action: document.getElementById('action').value,
                loyalty: document.getElementById('loyalty').value,
                requires_followup: document.getElementById('requiresFollowup').checked,
                comment: document.getElementById('comment').value.trim(),
                location: window.currentLocation || null, // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            };

            // 2. –ü–æ–ø—ã—Ç–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            let success = await saveToFirestore(formData);

            if (isTMA) Telegram.WebApp.MainButton.hideProgress();

            if (success) {
                showAlert('–£—Å–ø–µ—à–Ω–æ!', '–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ.', 'success');
                document.getElementById('agitatorForm').reset();
                if (isAdmin) fetchAndRenderReports(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—á–µ—Ç—ã —Å—Ä–∞–∑—É
            } else {
                await saveToCache(formData);
                showAlert('–í–Ω–∏–º–∞–Ω–∏–µ!', '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫—ç—à–µ. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.', 'warning');
            }

            renderLatestData(); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏
        }

        /**
         * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ Firestore.
         * @param {Object} data - –û–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö.
         * @returns {boolean} - true, –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, false –ø—Ä–∏ –æ—à–∏–±–∫–µ (–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è).
         */
        async function saveToFirestore(data) {
            if (!db) return false;
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º addDoc –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–º ID
                await firebase.firestore().collection(COLLECTION_NAME).add(data);
                return true;
            } catch (e) {
                console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ Firestore (–≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è):", e);
                return false;
            }
        }

        /**
         * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ IndexedDB (localforage).
         * @param {Object} data - –û–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö.
         */
        async function saveToCache(data) {
            try {
                const cacheStore = localforage.createInstance({ name: 'agitator_data_cache', storeName: COLLECTION_NAME });
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º timestamp –∫–∞–∫ –∫–ª—é—á
                await cacheStore.setItem(data.timestamp.toString(), data);
                dataCache.push(data); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤
                updateOfflineStatus();
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –∫—ç—à:", e);
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à.', 'error');
            }
        }

        /**
         * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ —Å Firestore.
         */
        async function syncData() {
            if (dataCache.length === 0) {
                showAlert('–ò–Ω—Ñ–æ', '–ö—ç—à –ø—É—Å—Ç, –Ω–µ—á–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å.', 'info');
                return;
            }
            if (!db) {
                showAlert('–û—à–∏–±–∫–∞', 'Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
                return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            let successfulSyncs = 0;
            const cacheStore = localforage.createInstance({ name: 'agitator_data_cache', storeName: COLLECTION_NAME });
            const recordsToSync = [...dataCache]; // –ö–æ–ø–∏—Ä—É–µ–º –¥–ª—è –∏—Ç–µ—Ä–∞—Ü–∏–∏

            for (const record of recordsToSync) {
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º addDoc, –∫–∞–∫ –ø—Ä–∏ –æ–±—ã—á–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
                    await firebase.firestore().collection(COLLECTION_NAME).add(record);
                    // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ –∫—ç—à–∞ –∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
                    await cacheStore.removeItem(record.timestamp.toString());
                    dataCache = dataCache.filter(item => item.timestamp !== record.timestamp);
                    successfulSyncs++;
                } catch (e) {
                    // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–ø–∞–ª–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
                    console.error("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏:", e);
                    showAlert('–í–Ω–∏–º–∞–Ω–∏–µ!', `–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${successfulSyncs} –∏–∑ ${recordsToSync.length}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`, 'warning');
                    break;
                }
            }

            if (isTMA) Telegram.WebApp.MainButton.hideProgress();

            updateOfflineStatus();
            renderLatestData();

            if (successfulSyncs > 0) {
                showAlert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è!', `–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${successfulSyncs} –∑–∞–ø–∏—Å–µ–π!`, 'success');
            }

            if (isAdmin) fetchAndRenderReports(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—á–µ—Ç—ã
        }

        /**
         * –û—á–∏—â–∞–µ—Ç –≤–µ—Å—å –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à (IndexedDB).
         */
        async function clearCache() {
            try {
                const cacheStore = localforage.createInstance({ name: 'agitator_data_cache', storeName: COLLECTION_NAME });
                await cacheStore.clear();
                dataCache = [];
                updateOfflineStatus();
                renderLatestData();
                showAlert('–ö—ç—à –æ—á–∏—â–µ–Ω', '–í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã.', 'info');
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞:", e);
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à.', 'error');
            }
        }

        // --- –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ---

        /**
         * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         */
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        window.currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        showAlert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è', `–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ: ${window.currentLocation.latitude.toFixed(4)}, ${window.currentLocation.longitude.toFixed(4)}`, 'info');
                    },
                    (error) => {
                        console.error("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:", error);
                        window.currentLocation = null;
                        showAlert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.', 'warning');
                    },
                    { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showAlert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è', '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.', 'warning');
                window.currentLocation = null;
            }
        }


        // --- –û–¢–ß–ï–¢–´ –ò –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø (–ê–î–ú–ò–ù) ---

        let mapInstance = null; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–∞—Ä—Ç—ã
        let mapData = []; // –ö–µ—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã

        /**
         * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
         * @param {Array<Object>} data - –î–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–æ–≤.
         */
        function generateMap(data) {
            const mapElement = document.getElementById('map');
            if (!mapElement) return;

            // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–¥–∞–ª—è–µ–º –µ–µ
            if (mapInstance) {
                mapInstance.remove();
            }

            // 1. –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã (—Ç–æ–ª—å–∫–æ —Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π)
            mapData = data.filter(d => d.location && d.location.latitude && d.location.longitude);
            const latLngs = mapData.map(d => [d.location.latitude, d.location.longitude, 0.5]); // [lat, lng, intensity]

            // 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã
            let centerLat = 55.7558; // –ú–æ—Å–∫–≤–∞
            let centerLng = 37.6173;
            let zoom = 5;

            if (mapData.length > 0) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ, –Ω–∞—Ö–æ–¥–∏–º —Å—Ä–µ–¥–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                const avgLat = mapData.reduce((sum, d) => sum + d.location.latitude, 0) / mapData.length;
                const avgLng = mapData.reduce((sum, d) => sum + d.location.longitude, 0) / mapData.length;
                centerLat = avgLat;
                centerLng = avgLng;
                zoom = 10; // –ü—Ä–∏–±–ª–∏–∂–∞–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
            }

            // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
            mapInstance = L.map('map').setView([centerLat, centerLng], zoom);

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–ª—ã (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);

            // 4. –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
            const markers = L.markerClusterGroup();

            mapData.forEach(d => {
                const marker = L.marker([d.location.latitude, d.location.longitude]);
                const popupContent = `
                    <div class="font-sans text-sm">
                        <strong class="text-indigo-600">${d.full_name || d.user_id}</strong>
                        <p class="mt-1">
                            <i data-lucide="map-pin" class="w-4 h-4 inline-block mr-1 text-gray-500"></i>
                            ${d.settlement}, ${d.street}, ${d.house}
                        </p>
                        <p>
                            <i data-lucide="hand-metal" class="w-4 h-4 inline-block mr-1 text-gray-500"></i>
                            ${d.action} / ${d.loyalty}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            ${new Date(d.timestamp).toLocaleString()}
                        </p>
                    </div>
                `;
                marker.bindPopup(popupContent);
                markers.addLayer(marker);
            });

            mapInstance.addLayer(markers);

            // 5. –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É
            L.heatLayer(latLngs, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                gradient: { 0.4: 'blue', 0.6: 'lime', 1.0: 'red' }
            }).addTo(mapInstance);

            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –∏–∫–æ–Ω–æ–∫ Lucide –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
            mapInstance.on('popupopen', () => {
                lucide.createIcons();
            });
        }

        /**
         * –°—Ç—Ä–æ–∏—Ç –∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É.
         * @param {string} canvasId - ID —ç–ª–µ–º–µ–Ω—Ç–∞ canvas.
         * @param {Object} data - –î–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã.
         * @param {string} label - –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.
         */
        function generatePieChart(canvasId, data, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const existingChart = Chart.getChart(canvasId);
            if (existingChart) existingChart.destroy();

            const labels = Object.keys(data);
            const values = Object.values(data);
            const total = values.reduce((sum, val) => sum + val, 0);

            // –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ –¥–ª—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
            const colorMap = {
                '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç': '#10b981', // green-500
                '–ù–µ–π—Ç—Ä–∞–ª–µ–Ω': '#f59e0b',    // amber-500
                '–ü—Ä–æ—Ç–∏–≤': '#ef4444',       // red-500
                '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ': '#9ca3af',   // gray-400
            };
            const colors = labels.map(l => colorMap[l] || '#3b82f6'); // blue-500 - –¥–µ—Ñ–æ–ª—Ç

            const chartOptions = {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const value = context.parsed;
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    },
                    title: {
                        display: false,
                    }
                }
            };

            new Chart(ctx, {
                type: 'pie',
                data: { labels: labels, datasets: [{ label: label, data: values, backgroundColor: colors, borderColor: '#ffffff', borderWidth: 1 }] },
                options: chartOptions
            });
        }

        /**
         * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ—Ç—á–µ—Ç—ã (–¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º).
         */
        async function fetchAndRenderReports() {
            if (!isAdmin || !db) return;
            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            try {
                const snapshot = await firebase.firestore().collection(COLLECTION_NAME).get();
                const data = snapshot.docs.map(doc => doc.data());

                // 1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                document.getElementById('statTotalCount').textContent = data.length;
                const uniqueUsers = new Set(data.map(d => d.user_id));
                document.getElementById('statUniqueUsers').textContent = uniqueUsers.size;

                // 2. –ì—Ä–∞—Ñ–∏–∫ –õ–æ—è–ª—å–Ω–æ—Å—Ç–∏
                const loyaltyCounts = data.reduce((acc, d) => {
                    acc[d.loyalty] = (acc[d.loyalty] || 0) + 1;
                    return acc;
                }, {});
                generatePieChart('loyaltyChart', loyaltyCounts, '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å');

                // 3. –ö–∞—Ä—Ç–∞
                generateMap(data);

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–æ–≤:", e);
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç—ã –∏–∑ Firestore. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.', 'error');
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        }

        /**
         * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–∞–ø–∏—Å–µ–π –∏–∑ –∫—ç—à–∞.
         */
        function renderLatestData() {
            const tableContainer = document.getElementById('latestDataTable');
            if (dataCache.length === 0) {
                tableContainer.innerHTML = '<p class="text-center text-gray-500 p-4">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –∫—ç—à–µ. <br>–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.</p>';
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–æ—Ç –Ω–æ–≤–æ–≥–æ –∫ —Å—Ç–∞—Ä–æ–º—É)
            const latestData = [...dataCache].sort((a, b) => b.timestamp - a.timestamp).slice(0, 20);

            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–í—Ä–µ–º—è</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ê–¥—Ä–µ—Å</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            latestData.forEach(d => {
                const date = new Date(d.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                const loyaltyColor = { '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç': 'bg-green-100 text-green-800', '–ü—Ä–æ—Ç–∏–≤': 'bg-red-100 text-red-800', '–ù–µ–π—Ç—Ä–∞–ª–µ–Ω': 'bg-yellow-100 text-yellow-800', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ': 'bg-gray-100 text-gray-800' }[d.loyalty] || 'bg-gray-100 text-gray-800';

                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${date}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${d.settlement}, ${d.street}, ${d.house}${d.apartment !== 'N/A' ? `, –∫–≤. ${d.apartment}` : ''}</td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${loyaltyColor}">${d.loyalty}</span>
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-500 max-w-xs truncate">${d.comment || '‚Äî'}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            tableContainer.innerHTML = tableHTML;
        }

        // --- –£–î–ê–õ–ï–ù–ò–ï –ö–û–õ–õ–ï–ö–¶–ò–ò (DANGER!) ---

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è.
         */
        function confirmClearDatabase() {
            document.getElementById('confirmDeleteInput').value = '';
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmDeleteInput').focus();
        }

        /**
         * –í—ã–ø–æ–ª–Ω—è–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ Firestore.
         */
        async function clearDatabase() {
            const confirmInput = document.getElementById('confirmDeleteInput').value.trim();
            if (confirmInput !== '–£–î–ê–õ–ò–¢–¨') {
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ–≤–µ—Ä–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–µ–µ —Å–ª–æ–≤–æ.', 'error');
                return;
            }

            document.getElementById('confirmModal').classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ

            if (!isAdmin) {
                showAlert('–û—à–∏–±–∫–∞', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.', 'error');
                return;
            }
            if (!db) {
                showAlert('–û—à–∏–±–∫–∞', 'Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.', 'error');
                return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            try {
                 // –í–ù–ò–ú–ê–ù–ò–ï: –í Firestore –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ –º–µ—Ç–æ–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏.
                 // –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.
                 // –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω-—Å–∏—Å—Ç–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é (Cloud Function).
                 // –û–¥–Ω–∞–∫–æ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.

                let deletedCount = 0;
                let batch = firebase.firestore().batch();
                let hasMore = true;

                while(hasMore) {
                    const snapshot = await firebase.firestore().collection(COLLECTION_NAME).limit(500).get(); // –£–¥–∞–ª—è–µ–º –ø–∞—Ä—Ç–∏—è–º–∏ –ø–æ 500
                    hasMore = snapshot.size > 0;
                    if (snapshot.size === 0) break;

                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                        deletedCount++;
                    });

                    await batch.commit();
                    batch = firebase.firestore().batch(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º batch
                }

                // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
                await clearCache();
                dataCache = []; // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                updateOfflineStatus();
                showAlert('–£—Å–ø–µ—à–Ω–æ!', `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} –∑–∞–ø–∏—Å–µ–π. –î–∞–Ω–Ω—ã–µ Firestore –æ—á–∏—â–µ–Ω—ã.`);

                if (isAdmin) fetchAndRenderReports();

                return true;

            } catch (e) {
                 console.error("Error deleting collection:", e);
                 showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + e.message);
                 return false;
            } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        };


        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ---

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Firebase –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
         */
        async function authenticateUser() {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
                if (!app) {
                    app = firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    // Firebase Auth is not strictly necessary for this Firestore-only anonymous access,
                    // but we can use an anonymous sign-in if needed for security rules.
                    // For simplicity, we rely on the security rules that allow writing.
                }

                // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ Telegram User ID –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ê–¥–º–∏–Ω–∞
                if (isTMA && Telegram.WebApp.initDataUnsafe.user) {
                    const user = Telegram.WebApp.initDataUnsafe.user;
                    userTelegramId = user.id.toString();
                    userFirstName = user.first_name || user.username || '–ê–≥–∏—Ç–∞—Ç–æ—Ä';

                    // üîë –ö–û–†–†–ï–ö–¢–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ù–ê –ê–î–ú–ò–ù–ê
                    isAdmin = parseInt(userTelegramId) === ADMIN_ID;

                } else if (!isTMA) {
                    // –ú–æ–∫-–¥–∞–Ω–Ω—ã–µ –¥–ª—è Web Preview
                    userTelegramId = ADMIN_ID.toString(); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID –∞–¥–º–∏–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
                    userFirstName = 'Web Preview (–ê–¥–º–∏–Ω)';
                    isAdmin = true;
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ Web Preview, —á—Ç–æ–±—ã –±—ã–ª–æ —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
                    getLocation();
                }

                // 2. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ/—Å–∫—Ä—ã—Ç–∏–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
                if (isAdmin) {
                    document.getElementById('adminPanel').classList.remove('hidden');
                    document.getElementById('reportsTab').classList.remove('hidden');
                } else {
                    document.getElementById('adminPanel').classList.add('hidden');
                    document.getElementById('reportsTab').classList.add('hidden');
                }

                return true;

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
                showAlert('–û—à–∏–±–∫–∞', '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase/Telegram: ' + e.message, 'error');
                return false;
            }
        }


        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é —Å—Ä–∞–∑—É, –µ—Å–ª–∏ —ç—Ç–æ TMA
            getLocation();
        }


        // üîë –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–û–∂–∏–¥–∞–µ–º authenticateUser)
        window.onload = async () => {
            // 0. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—ç—à (–Ω—É–∂–Ω–æ –¥–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
            await loadCache();

            // 1. –°–Ω–∞—á–∞–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ isAdmin –∏ userTelegramId
            await authenticateUser();

            // 2. –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            populateSettlements();
            // updateOfflineStatus() —É–∂–µ –≤—ã–∑–≤–∞–Ω –≤ loadCache, –Ω–æ –≤—ã–∑–æ–≤–µ–º –µ—â–µ —Ä–∞–∑ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
            updateOfflineStatus();
            window.showSection('form');
            lucide.createIcons();

            // –û–¢–õ–ê–î–ö–ê: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
            document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
            document.getElementById('debugUserName').textContent = userFirstName || 'N/A';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';

            if (!firebaseConfig.projectId) {
                window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase –≤ –∫–æ–¥.');
            }
        };

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        window.authenticateUser = authenticateUser;
        window.fetchAndRenderReports = fetchAndRenderReports;
        window.renderLatestData = renderLatestData;
        window.generateMap = generateMap;
        window.submitForm = submitForm;
        window.syncData = syncData;
        window.clearCache = clearCache;
        window.confirmClearDatabase = confirmClearDatabase;
        window.clearDatabase = clearDatabase;
        window.showAlert = showAlert;

        // –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        // firebase.firestore().setLogLevel('debug');

    </script>
</body>
</html>
