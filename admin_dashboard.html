<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | v2.5 (–§–∏–∫—Å –ê–¥–º–∏–Ω–∞/Firestore)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.4/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />

    <style>
        body { font-family: 'Jost', sans-serif; }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –≤–∏–¥–Ω–∞ */
        #mapContainer { height: 60vh; width: 100%; border-radius: 0.5rem; }
        .tab-button.active { @apply border-b-2 border-indigo-600 font-semibold; }
        .data-table th, .data-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .data-table th { background-color: #f3f4f6; }
        .data-table-container { max-height: 80vh; overflow-y: auto; }
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        .custom-alert { position: fixed; top: 1rem; right: 1rem; z-index: 50; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
    </style>

    <!-- Firebase SDK (Compatibility mode for easy access) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-4">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <header class="mb-6">
        <h1 class="text-3xl font-bold text-indigo-600 flex items-center">
            <i data-lucide="notebook-text" class="w-8 h-8 mr-3"></i>
            –ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞
        </h1>
        <p class="text-sm text-gray-500">v2.5 (Firestore Admin Check)</p>
    </header>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="custom-alert" class="custom-alert hidden"></div>

    <!-- –û–±–ª–∞—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏ (–í–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏) -->
    <div class="bg-indigo-100 p-3 rounded-lg mb-6 text-sm">
        <p>–í–∞—à ID Telegram: <span id="debugUserId" class="font-mono font-semibold">...</span></p>
        <p>–°—Ç–∞—Ç—É—Å –ê–¥–º–∏–Ω–∞: <span id="debugAdminStatus" class="font-bold">...</span></p>
        <p>–°—Ç–∞—Ç—É—Å –ö—ç—à–∞: <span id="debugCacheStatus" class="font-bold">...</span></p>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å–µ–∫—Ü–∏—è–º -->
    <div class="flex border-b border-gray-200 mb-6">
        <button onclick="showSection('form')" class="tab-button p-3 text-lg text-gray-600 transition duration-150 active">–§–æ—Ä–º–∞</button>
        <button onclick="showSection('reports')" id="reports-tab" class="tab-button p-3 text-lg text-gray-600 transition duration-150 hidden">–û—Ç—á–µ—Ç—ã</button>
        <button onclick="showSection('map')" id="map-tab" class="tab-button p-3 text-lg text-gray-600 transition duration-150 hidden">–ö–∞—Ä—Ç–∞</button>
    </div>

    <!-- –°–µ–∫—Ü–∏—è 1: –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö -->
    <section id="form-section" class="mb-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</h2>
            <form id="data-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- –§–ò–û/Username -->
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700">–§–ò–û / Username</label>
                        <input type="text" id="fullName" name="fullName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>

                    <!-- –ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç -->
                    <div>
                        <label for="settlement" class="block text-sm font-medium text-gray-700">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</label>
                        <select id="settlement" name="settlement" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                            <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã JS -->
                        </select>
                    </div>

                    <!-- –£–ª–∏—Ü–∞ -->
                    <div>
                        <label for="street" class="block text-sm font-medium text-gray-700">–£–ª–∏—Ü–∞</label>
                        <input type="text" id="street" name="street" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>

                    <!-- –î–æ–º -->
                    <div>
                        <label for="house" class="block text-sm font-medium text-gray-700">–î–æ–º</label>
                        <input type="text" id="house" name="house" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>

                    <!-- –ö–≤–∞—Ä—Ç–∏—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) -->
                    <div>
                        <label for="apartment" class="block text-sm font-medium text-gray-700">–ö–≤–∞—Ä—Ç–∏—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="text" id="apartment" name="apartment" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>

                    <!-- –õ–æ—è–ª—å–Ω–æ—Å—Ç—å -->
                    <div>
                        <label for="loyalty" class="block text-sm font-medium text-gray-700">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</label>
                        <select id="loyalty" name="loyalty" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="–í—ã—Å–æ–∫–∞—è">–í—ã—Å–æ–∫–∞—è (–ó–ê)</option>
                            <option value="–°—Ä–µ–¥–Ω—è—è">–°—Ä–µ–¥–Ω—è—è (–ù–ï –ó–ù–ê–ï–¢)</option>
                            <option value="–ù–∏–∑–∫–∞—è">–ù–∏–∑–∫–∞—è (–ü–†–û–¢–ò–í)</option>
                        </select>
                    </div>

                    <!-- –î–µ–π—Å—Ç–≤–∏–µ -->
                    <div class="md:col-span-2">
                        <label for="action" class="block text-sm font-medium text-gray-700">–¢–∏–ø –∫–æ–Ω—Ç–∞–∫—Ç–∞/–î–µ–π—Å—Ç–≤–∏–µ</label>
                        <select id="action" name="action" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="–í–∏–∑–∏—Ç (—É—Å–ø–µ—à–Ω—ã–π)">–í–∏–∑–∏—Ç (—É—Å–ø–µ—à–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç)</option>
                            <option value="–í–∏–∑–∏—Ç (–Ω–µ—Ç –¥–æ–º–∞)">–í–∏–∑–∏—Ç (–Ω–µ—Ç –¥–æ–º–∞)</option>
                            <option value="–í–∏–∑–∏—Ç (–æ—Ç–∫–∞–∑)">–í–∏–∑–∏—Ç (–æ—Ç–∫–∞–∑ –æ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–∞)</option>
                            <option value="–¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫">–¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫</option>
                            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>

                    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                    <div class="md:col-span-2">
                        <label for="comment" class="block text-sm font-medium text-gray-700">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea id="comment" name="comment" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    </div>

                    <!-- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä -->
                    <div class="md:col-span-2 flex items-center">
                        <input type="checkbox" id="requiresFollowup" name="requiresFollowup" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="requiresFollowup" class="ml-2 block text-sm font-medium text-gray-700">–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç / –≤–∏–∑–∏—Ç</label>
                    </div>

                    <!-- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã -->
                    <div class="md:col-span-2 border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</span>
                            <button type="button" onclick="getLocation()" class="text-xs bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full hover:bg-indigo-200 transition">
                                <i data-lucide="map-pin" class="w-4 h-4 inline-block mr-1"></i>
                                –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å GPS
                            </button>
                        </div>
                        <p id="location-display" class="text-sm text-gray-600">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã</p>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 flex items-center justify-center">
                    <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
                <button type="button" onclick="syncData(true)" id="sync-button" class="mt-2 w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition duration-200 flex items-center justify-center hidden">
                    <i data-lucide="cloud-upload" class="w-5 h-5 mr-2"></i>
                    –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å (<span id="offline-count">0</span>)
                </button>
            </form>

            <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-700 border-t pt-4">–õ–æ–∫–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
            <div id="latest-data-container" class="space-y-3">
                <p class="text-sm text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</p>
            </div>
        </div>
    </section>

    <!-- –°–µ–∫—Ü–∏—è 2: –û—Ç—á–µ—Ç—ã (–í–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º) -->
    <section id="reports-section" class="mb-8 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">–û—Ç—á–µ—Ç—ã –∏ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>

            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-3 sm:space-y-0 sm:space-x-3">
                <button onclick="fetchAndRenderReports()" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                    <i data-lucide="rotate-cw" class="w-5 h-5 mr-2"></i>
                    –û–±–Ω–æ–≤–∏—Ç—å –û—Ç—á–µ—Ç—ã (Firestore)
                </button>
                <button onclick="exportToXLSX()" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-200 flex items-center justify-center">
                    <i data-lucide="file-spreadsheet" class="w-5 h-5 mr-2"></i>
                    –≠–∫—Å–ø–æ—Ä—Ç –≤ XLSX
                </button>
            </div>

            <div id="report-summary" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—É–º–º–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- –ì—Ä–∞—Ñ–∏–∫ 1: –õ–æ—è–ª—å–Ω–æ—Å—Ç—å -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold mb-2">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –õ–æ—è–ª—å–Ω–æ—Å—Ç–∏</h3>
                    <canvas id="loyaltyChart"></canvas>
                </div>
                <!-- –ì—Ä–∞—Ñ–∏–∫ 2: –î–µ–π—Å—Ç–≤–∏—è -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold mb-2">–¢–∏–ø—ã –ö–æ–Ω—Ç–∞–∫—Ç–æ–≤</h3>
                    <canvas id="actionChart"></canvas>
                </div>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-gray-700">–ü–æ–¥—Ä–æ–±–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
            <div class="data-table-container bg-gray-50 rounded-lg shadow-inner">
                <table id="reports-table" class="min-w-full divide-y divide-gray-200 data-table">
                    <thead>
                        <tr>
                            <th>–í—Ä–µ–º—è</th>
                            <th>ID</th>
                            <th>–ê–≥–∏—Ç–∞—Ç–æ—Ä (–§–ò–û)</th>
                            <th>–ù–ü</th>
                            <th>–£–ª–∏—Ü–∞</th>
                            <th>–î–æ–º</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            <th>–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</th>
                            <th>–ü–æ–≤—Ç–æ—Ä</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã JS -->
                    </tbody>
                </table>
                <p id="reports-status" class="text-center p-4 text-gray-500">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –û—Ç—á–µ—Ç—ã", —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>
            </div>

            <button onclick="confirmClearDatabase()" class="mt-6 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-200 flex items-center justify-center w-full">
                <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i>
                –û—á–∏—Å—Ç–∏—Ç—å –í–°–Æ –ë–∞–∑—É –î–∞–Ω–Ω—ã—Ö (–í–ù–ò–ú–ê–ù–ò–ï!)
            </button>
        </div>
    </section>

    <!-- –°–µ–∫—Ü–∏—è 3: –ö–∞—Ä—Ç–∞ (–í–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º) -->
    <section id="map-section" class="mb-8 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</h2>
            <div id="mapContainer"></div>
            <p class="mt-4 text-sm text-gray-600">–ù–∞ –∫–∞—Ä—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ–Ω—Ç–∞–∫—Ç—ã, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –±—ã–ª–∏ —É–∫–∞–∑–∞–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.</p>
            <div class="flex items-center space-x-4 mt-4">
                 <button onclick="toggleMapType('marker')" id="marker-btn" class="bg-indigo-500 text-white py-2 px-4 rounded-lg text-sm transition">–ú–∞—Ä–∫–µ—Ä—ã</button>
                 <button onclick="toggleMapType('heat')" id="heat-btn" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-lg text-sm transition">–¢–µ–ø–ª–æ–≤–∞—è –ö–∞—Ä—Ç–∞</button>
            </div>
        </div>
    </section>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –±–∞–∑—ã) -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-red-600 mb-4">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <p class="mb-4">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ **–±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ** —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã Firestore?</p>
            <p class="mb-6 font-semibold">–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ "<span class="text-red-500">–£–î–ê–õ–ò–¢–¨</span>" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</p>
            <input type="text" id="delete-confirm-input" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="–í–≤–µ–¥–∏—Ç–µ –£–î–ê–õ–ò–¢–¨">
            <div class="flex justify-end space-x-3">
                <button onclick="hideConfirmModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400 transition">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="clearDatabase()" id="clear-db-button" disabled class="bg-red-500 text-white py-2 px-4 rounded-lg opacity-50 cursor-not-allowed transition">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –£–¥–∞–ª–µ–Ω–∏–µ</button>
            </div>
        </div>
    </div>


    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í–°–¢–ê–í–ò–¢–¨ –°–Æ–î–ê –í–ê–®–ò –ö–õ–Æ–ß–ò) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVeRXO16KtIwoJQb4uHQuCsEv3xTLBGhI",
            authDomain: "agitator-notebook.firebaseapp.com",
            projectId: "agitator-notebook",
            storageBucket: "agitator-notebook.firebasestorage.app",
            messagingSenderId: "518555352011",
            appId: "1:518555352011:web:2b11ffed6d85918a202e86"
        };
        // -----------------------------------------------------------

        let firebaseApp, db;
        let isAdmin = false;
        let userTelegramId = null;
        let dataCache = []; // –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –¥–∞–Ω–Ω—ã—Ö
        let mapInstance = null;
        let currentMapType = 'marker'; // 'marker' –∏–ª–∏ 'heat'

        const COLLECTION_NAME = "agitator_data";
        const ADMIN_COLLECTION_NAME = "admin_users"; // üî• –ù–û–í–ê–Ø –ö–û–õ–õ–ï–ö–¶–ò–Ø –î–õ–Ø –ê–î–ú–ò–ù–û–í
        const isTMA = typeof Telegram !== 'undefined' && Telegram.WebApp;
        const OFFLINE_STORAGE_KEY = 'offline_reports';
        const SETTLEMENTS = [
            '–ì–æ—Ä–æ–¥ 1', '–ì–æ—Ä–æ–¥ 2', '–ì–æ—Ä–æ–¥ 3', '–î–µ—Ä–µ–≤–Ω—è –ê', '–ü–æ—Å–µ–ª–æ–∫ –ë'
        ]; // –í–∞—à —Å–ø–∏—Å–æ–∫ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ---
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebaseApp.firestore();
            db.settings({
                 // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                 // cache: 'disabled'
            });
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", e);
        }

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò –£–¢–ò–õ–ò–¢–´ ---

        function showAlert(title, message, type = 'info', duration = 5000) {
            const alertBox = document.getElementById('custom-alert');
            alertBox.innerHTML = `<strong>${title}:</strong> ${message}`;
            alertBox.className = `custom-alert bg-${type === 'error' ? 'red' : type === 'success' ? 'green' : 'indigo'}-500 text-white`;
            alertBox.classList.remove('hidden');

            setTimeout(() => {
                alertBox.classList.add('hidden');
            }, duration);
        }

        function showSection(id) {
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`${id}-section`).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-button[onclick="showSection('${id}')"]`)?.classList.add('active');
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –∫–∞—Ä—Ç—É, —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–∞
            if (id === 'map' && isAdmin) {
                generateMap(currentMapType);
            }
        }

        function populateSettlements() {
            const select = document.getElementById('settlement');
            select.innerHTML = ''; // –û—á–∏—â–∞–µ–º
            SETTLEMENTS.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                select.appendChild(option);
            });
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
            if (SETTLEMENTS.length > 0) {
                select.value = SETTLEMENTS[0];
            }
        }

        // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –ü–†–û–í–ï–†–ö–ê –ê–î–ú–ò–ù–ê (–ö–õ–Æ–ß–ï–í–û–ô –ú–û–ú–ï–ù–¢) ---

        /**
         * üî• –ù–û–í–´–ô –ú–ï–•–ê–ù–ò–ó–ú: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ ID –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ Firestore.
         * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ 'admin_users' —Å –µ–≥–æ Telegram ID.
         */
        async function checkFirestoreAdminStatus(uid) {
            if (!db || !uid) return false;
            try {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ID –≤ —Å—Ç—Ä–æ–∫—É, —Ç.–∫. –≤ Firestore ID –¥–æ–∫—É–º–µ–Ω—Ç–∞ - —Å—Ç—Ä–æ–∫–∞
                const adminDocRef = db.collection(ADMIN_COLLECTION_NAME).doc(String(uid));
                const adminDoc = await adminDocRef.get();
                
                if (adminDoc.exists) {
                    console.log(`Firestore: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${uid} –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∞–¥–º–∏–Ω–æ–≤.`);
                }
                
                return adminDoc.exists;
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ Firestore:", e);
                return false;
            }
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
         */
        async function authenticateUser() {
            // 1. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å ID –∏–∑ Telegram WebApp
            if (isTMA && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                userTelegramId = Telegram.WebApp.initDataUnsafe.user.id;
            } else {
                // –ï—Å–ª–∏ –Ω–µ –≤ TMA (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ), –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≥–ª—É—à–∫—É.
                // –í –†–ï–ê–õ–¨–ù–û–ú –ü–†–û–ò–ó–í–û–î–°–¢–í–ï –≠–¢–û –ù–£–ñ–ù–û –£–î–ê–õ–ò–¢–¨!
                // userTelegramId = 541459471; // <-- –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à Telegram ID –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            }

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            if (userTelegramId) {
                // üî• –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Firestore
                const isFirestoreAdmin = await checkFirestoreAdminStatus(userTelegramId);
                isAdmin = isFirestoreAdmin;
            } else {
                 console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å userTelegramId.");
            }

            // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';

            if (isAdmin) {
                document.getElementById('reports-tab').classList.remove('hidden');
                document.getElementById('map-tab').classList.remove('hidden');
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É –¥–ª—è –∞–¥–º–∏–Ω–∞
                await fetchAndRenderReports(); 
                showAlert('–£—Å–ø–µ—à–Ω–æ!', '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.', 'success');
            }
        }

        // --- –û–§–§–õ–ê–ô–ù/–û–ù–õ–ê–ô–ù –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ---

        function getOfflineData() {
            try {
                const data = localStorage.getItem(OFFLINE_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:", e);
                return [];
            }
        }

        function saveOfflineData(data) {
            try {
                localStorage.setItem(OFFLINE_STORAGE_KEY, JSON.stringify(data));
                updateOfflineStatus();
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:", e);
            }
        }

        function updateOfflineStatus() {
            const offlineData = getOfflineData();
            const count = offlineData.length;
            document.getElementById('offline-count').textContent = count;
            const syncButton = document.getElementById('sync-button');

            if (count > 0) {
                syncButton.classList.remove('hidden');
                syncButton.textContent = `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å (${count})`;
            } else {
                syncButton.classList.add('hidden');
            }
            document.getElementById('debugCacheStatus').textContent = count > 0 ? `–î–ê (${count})` : '–ù–ï–¢';
            renderLatestData(offlineData);
        }

        function renderLatestData(data) {
            const container = document.getElementById('latest-data-container');
            container.innerHTML = '';
            
            if (data.length === 0) {
                 container.innerHTML = '<p class="text-sm text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</p>';
                 return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∑–∞–ø–∏—Å–µ–π
            data.slice(-5).reverse().forEach((doc, index) => {
                const item = document.createElement('div');
                item.className = 'bg-indigo-50 p-3 rounded-lg border border-indigo-200 shadow-sm';
                item.innerHTML = `
                    <p class="text-sm font-semibold">${doc.settlement}, ${doc.street}, ${doc.house}${doc.apartment ? ', –∫–≤. ' + doc.apartment : ''}</p>
                    <p class="text-xs text-gray-600">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å: <span class="font-medium">${doc.loyalty}</span> | –î–µ–π—Å—Ç–≤–∏–µ: <span class="font-medium">${doc.action}</span></p>
                    ${doc.requires_followup ? '<p class="text-xs text-red-500 font-semibold flex items-center mt-1"><i data-lucide="bell" class="w-3 h-3 mr-1"></i>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä</p>' : ''}
                    <p class="text-xs text-gray-500 mt-1">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${new Date(doc.timestamp).toLocaleTimeString()}</p>
                `;
                container.appendChild(item);
            });
            lucide.createIcons(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –∏–∫–æ–Ω–∫–∏
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('data-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userTelegramId) {
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à ID Telegram. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram.', 'error');
                return;
            }

            const form = e.target;
            const data = {
                user_id: userTelegramId,
                full_name: form.fullName.value || 'N/A', // –î–æ–±–∞–≤–ª–µ–Ω–æ –§–ò–û
                settlement: form.settlement.value,
                street: form.street.value.trim(),
                house: form.house.value.trim(),
                apartment: form.apartment.value.trim(),
                loyalty: form.loyalty.value,
                action: form.action.value,
                comment: form.comment.value.trim(),
                requires_followup: form.requiresFollowup.checked,
                timestamp: Date.now(),
                location: {
                    latitude: form.latitude.value,
                    longitude: form.longitude.value
                }
            };

            const isOnline = navigator.onLine && db;

            if (isOnline) {
                await uploadData(data);
            } else {
                saveOfflineData([...getOfflineData(), data]);
                showAlert('–û—Ñ—Ñ–ª–∞–π–Ω', '–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø–æ–∑–∂–µ.', 'info');
            }

            form.reset(); // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            populateSettlements(); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
            document.getElementById('location-display').textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
        });

        async function uploadData(data) {
             if (!db) {
                 showAlert('–û—à–∏–±–∫–∞', 'Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.', 'error');
                 return false;
             }
             if (isTMA) Telegram.WebApp.MainButton.showLoader();

             try {
                 await db.collection(COLLECTION_NAME).add(data);
                 showAlert('–£—Å–ø–µ—à–Ω–æ', '–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä.', 'success');
                 return true;
             } catch (e) {
                 console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö:", e);
                 showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –°–æ—Ö—Ä–∞–Ω—è—é –ª–æ–∫–∞–ª—å–Ω–æ.', 'error');
                 saveOfflineData([...getOfflineData(), data]); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –æ–Ω–ª–∞–π–Ω-–æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
                 return false;
             } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideLoader();
             }
        }

        async function syncData(showProgress = false) {
            const offlineData = getOfflineData();
            if (offlineData.length === 0) {
                 showAlert('–£—Å–ø–µ—à–Ω–æ', '–õ–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ç.', 'info');
                 return;
            }

            if (!db) {
                 showAlert('–û—à–∏–±–∫–∞', 'Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å.', 'error');
                 return;
            }

            if (isTMA && showProgress) Telegram.WebApp.MainButton.showProgress();

            const successfullySynced = [];
            const failedToSync = [];

            for (const data of offlineData) {
                const success = await uploadData(data);
                if (success) {
                    successfullySynced.push(data);
                } else {
                    failedToSync.push(data);
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –Ω–µ—É–¥–∞–≤—à–∏–µ—Å—è
            saveOfflineData(failedToSync);
            
            if (isTMA && showProgress) Telegram.WebApp.MainButton.hideProgress();

            if (successfullySynced.length > 0) {
                 showAlert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è', `–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${successfullySynced.length} –∑–∞–ø–∏—Å–µ–π.`, 'success');
            }
            if (failedToSync.length > 0) {
                 showAlert('–í–Ω–∏–º–∞–Ω–∏–µ', `–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ${failedToSync.length} –∑–∞–ø–∏—Å–µ–π. –û–Ω–∏ –æ—Å—Ç–∞–ª–∏—Å—å –≤ –∫—ç—à–µ.`, 'error');
            }

            // –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—á–µ—Ç—ã
            if (isAdmin) fetchAndRenderReports();
        }


        // --- –û–¢–ß–ï–¢–´ –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê (–¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–ê) ---

        async function fetchAndRenderReports() {
            if (!isAdmin || !db) return;

            document.getElementById('reports-status').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';

            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            try {
                const snapshot = await db.collection(COLLECTION_NAME).get();
                dataCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderReportsTable(dataCache);
                renderCharts(dataCache);
                renderSummary(dataCache);
                generateMap(currentMapType, dataCache);
                
                document.getElementById('reports-status').textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${dataCache.length} –∑–∞–ø–∏—Å–µ–π.`;

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤:", e);
                document.getElementById('reports-status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.';
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç—ã –∏–∑ Firebase.', 'error');
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        }

        function renderReportsTable(data) {
            const tbody = document.getElementById('reports-table').querySelector('tbody');
            tbody.innerHTML = '';

            data.sort((a, b) => b.timestamp - a.timestamp); // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)

            data.forEach(doc => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-100 transition';
                tr.innerHTML = `
                    <td class="whitespace-nowrap text-xs">${new Date(doc.timestamp).toLocaleString()}</td>
                    <td class="text-xs">${doc.user_id}</td>
                    <td class="text-xs font-medium">${doc.full_name || doc.user_id}</td>
                    <td class="text-xs">${doc.settlement}</td>
                    <td class="text-xs">${doc.street}, ${doc.house}${doc.apartment ? `/${doc.apartment}` : ''}</td>
                    <td class="text-xs">${doc.action}</td>
                    <td class="text-xs font-semibold">${doc.loyalty}</td>
                    <td class="text-xs text-${doc.requires_followup ? 'red' : 'green'}-600">${doc.requires_followup ? '–î–ê' : '–ù–ï–¢'}</td>
                    <td class="text-xs max-w-xs truncate">${doc.comment}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderSummary(data) {
            const summaryContainer = document.getElementById('report-summary');
            summaryContainer.innerHTML = '';
            
            const total = data.length;
            const loyaltyCounts = data.reduce((acc, doc) => {
                acc[doc.loyalty] = (acc[doc.loyalty] || 0) + 1;
                return acc;
            }, {});
            const followupCount = data.filter(doc => doc.requires_followup).length;

            const summaries = [
                { title: '–í—Å–µ–≥–æ –ö–æ–Ω—Ç–∞–∫—Ç–æ–≤', value: total, icon: 'users', color: 'indigo' },
                { title: '–í—ã—Å–æ–∫–∞—è –õ–æ—è–ª—å–Ω–æ—Å—Ç—å', value: loyaltyCounts['–í—ã—Å–æ–∫–∞—è'] || 0, icon: 'trending-up', color: 'green' },
                { title: '–ù–∏–∑–∫–∞—è –õ–æ—è–ª—å–Ω–æ—Å—Ç—å', value: loyaltyCounts['–ù–∏–∑–∫–∞—è'] || 0, icon: 'trending-down', color: 'red' },
                { title: '–¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä', value: followupCount, icon: 'bell', color: 'orange' },
            ];

            summaries.forEach(s => {
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-xl shadow-lg border-l-4 border-${s.color}-500`;
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-500">${s.title}</p>
                        <i data-lucide="${s.icon}" class="w-5 h-5 text-${s.color}-500"></i>
                    </div>
                    <p class="text-2xl font-bold text-gray-900 mt-1">${s.value}</p>
                `;
                summaryContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        let loyaltyChartInstance, actionChartInstance;

        function renderCharts(data) {
            const loyaltyCtx = document.getElementById('loyaltyChart').getContext('2d');
            const actionCtx = document.getElementById('actionChart').getContext('2d');

            if (loyaltyChartInstance) loyaltyChartInstance.destroy();
            if (actionChartInstance) actionChartInstance.destroy();

            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
            const loyaltyData = data.reduce((acc, doc) => {
                acc[doc.loyalty] = (acc[doc.loyalty] || 0) + 1;
                return acc;
            }, {});
            const loyaltyLabels = ['–í—ã—Å–æ–∫–∞—è', '–°—Ä–µ–¥–Ω—è—è', '–ù–∏–∑–∫–∞—è'];
            const loyaltyCounts = loyaltyLabels.map(label => loyaltyData[label] || 0);
            const loyaltyColors = ['#10b981', '#fbbf24', '#ef4444']; // green, yellow, red

            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π
            const actionData = data.reduce((acc, doc) => {
                acc[doc.action] = (acc[doc.action] || 0) + 1;
                return acc;
            }, {});
            const actionLabels = Object.keys(actionData);
            const actionCounts = Object.values(actionData);
            
            const chartOptions = {
                responsive: true,
                plugins: {
                    legend: { position: 'right' },
                    title: { display: false }
                }
            };

            loyaltyChartInstance = new Chart(loyaltyCtx, {
                type: 'doughnut',
                data: { labels: loyaltyLabels, datasets: [{ data: loyaltyCounts, backgroundColor: loyaltyColors, borderColor: '#ffffff', borderWidth: 1 }] },
                options: chartOptions
            });

            actionChartInstance = new Chart(actionCtx, {
                type: 'bar',
                data: { labels: actionLabels, datasets: [{ label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', data: actionCounts, backgroundColor: '#6366f1', borderColor: '#ffffff', borderWidth: 1 }] },
                options: { ...chartOptions, scales: { y: { beginAtZero: true } } }
            });
        }

        function exportToXLSX() {
            if (dataCache.length === 0) {
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –æ—Ç—á–µ—Ç—ã.', 'error');
                return;
            }
            const exportData = dataCache.map(doc => ({
                '–í—Ä–µ–º—è': new Date(doc.timestamp).toLocaleString(), 
                'ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è': doc.user_id, 
                '–ê–≥–∏—Ç–∞—Ç–æ—Ä (–§–ò–û)': doc.full_name || 'N/A',
                '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç': doc.settlement, 
                '–£–ª–∏—Ü–∞': doc.street, 
                '–î–æ–º': doc.house, 
                '–ö–≤–∞—Ä—Ç–∏—Ä–∞': doc.apartment, 
                '–î–µ–π—Å—Ç–≤–∏–µ': doc.action,
                '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å': doc.loyalty, 
                '–¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä': doc.requires_followup ? '–î–ê' : '–ù–ï–¢', 
                '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': doc.comment,
                '–®–∏—Ä–æ—Ç–∞': doc.location ? doc.location.latitude : 'N/A', 
                '–î–æ–ª–≥–æ—Ç–∞': doc.location ? doc.location.longitude : 'N/A',
            }));
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "–î–∞–Ω–Ω—ã–µ");
            XLSX.writeFile(workbook, "agitator_data_" + new Date().toISOString().slice(0, 10) + ".xlsx");
        }

        // --- –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ---

        function getLocation() {
            if (navigator.geolocation) {
                const display = document.getElementById('location-display');
                display.textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lon = position.coords.longitude.toFixed(6);
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lon;
                        display.textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat}, ${lon}`;
                        showAlert('–£—Å–ø–µ—à–Ω–æ', '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã.', 'success', 2000);
                    },
                    (error) => {
                        console.error("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:", error);
                        display.textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.';
                        showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.', 'error', 3000);
                        document.getElementById('latitude').value = '';
                        document.getElementById('longitude').value = '';
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showAlert('–û—à–∏–±–∫–∞', '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.', 'error');
            }
        }

        function generateMap(type = 'marker', data = dataCache) {
            if (!isAdmin) return;

            const mapDiv = document.getElementById('mapContainer');
            if (!mapDiv.offsetParent) return; // –ù–µ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º, –µ—Å–ª–∏ —Å–µ–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∞

            const coordinates = data
                .filter(doc => doc.location && doc.location.latitude && doc.location.longitude)
                .map(doc => ({
                    lat: parseFloat(doc.location.latitude), 
                    lon: parseFloat(doc.location.longitude), 
                    doc: doc 
                }));

            if (coordinates.length === 0) {
                mapDiv.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>';
                return;
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–ª–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
            if (mapInstance) {
                mapInstance.off();
                mapInstance.remove();
            }
            
            const centerLat = coordinates.reduce((sum, c) => sum + c.lat, 0) / coordinates.length;
            const centerLon = coordinates.reduce((sum, c) => sum + c.lon, 0) / coordinates.length;
            
            mapInstance = L.map('mapContainer').setView([centerLat, centerLon], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18,
            }).addTo(mapInstance);

            currentMapType = type;
            document.getElementById('marker-btn').className = `py-2 px-4 rounded-lg text-sm transition ${type === 'marker' ? 'bg-indigo-500 text-white' : 'bg-gray-300 text-gray-700'}`;
            document.getElementById('heat-btn').className = `py-2 px-4 rounded-lg text-sm transition ${type === 'heat' ? 'bg-indigo-500 text-white' : 'bg-gray-300 text-gray-700'}`;


            if (type === 'marker') {
                const markerCluster = L.markerClusterGroup();
                coordinates.forEach(coord => {
                    const popupContent = `
                        <strong class="text-indigo-600">${coord.doc.settlement}, ${coord.doc.street}, ${coord.doc.house}</strong><br>
                        –õ–æ—è–ª—å–Ω–æ—Å—Ç—å: <b>${coord.doc.loyalty}</b><br>
                        –î–µ–π—Å—Ç–≤–∏–µ: ${coord.doc.action}<br>
                        –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${coord.doc.comment.substring(0, 50)}...<br>
                        –ê–≥–∏—Ç–∞—Ç–æ—Ä: ${coord.doc.full_name || coord.doc.user_id}<br>
                        –í—Ä–µ–º—è: ${new Date(coord.doc.timestamp).toLocaleString()}
                    `;
                    const marker = L.marker([coord.lat, coord.lon]).bindPopup(popupContent);
                    markerCluster.addLayer(marker);
                });
                mapInstance.addLayer(markerCluster);
            } else if (type === 'heat') {
                const heatPoints = coordinates.map(coord => [coord.lat, coord.lon, 0.5]); // 0.5 - –≤–µ—Å
                L.heatLayer(heatPoints, { radius: 25 }).addTo(mapInstance);
            }
        }

        function toggleMapType(type) {
             generateMap(type, dataCache);
        }

        // --- –£–î–ê–õ–ï–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–• (–¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–ê) ---
        
        function confirmClearDatabase() {
            if (!isAdmin) {
                showAlert('–û—à–∏–±–∫–∞', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.', 'error');
                return;
            }
            document.getElementById('delete-confirm-input').value = '';
            document.getElementById('clear-db-button').disabled = true;
            document.getElementById('clear-db-button').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('confirm-modal').classList.add('flex');

            document.getElementById('delete-confirm-input').oninput = (e) => {
                const isMatch = e.target.value.trim().toUpperCase() === '–£–î–ê–õ–ò–¢–¨';
                document.getElementById('clear-db-button').disabled = !isMatch;
                if (isMatch) {
                    document.getElementById('clear-db-button').classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    document.getElementById('clear-db-button').classList.add('opacity-50', 'cursor-not-allowed');
                }
            };
        }

        function hideConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('confirm-modal').classList.remove('flex');
        }

        async function clearDatabase() {
            hideConfirmModal();
            if (!isAdmin || !db) {
                 showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç –ø—Ä–∞–≤ –∏–ª–∏ Firebase –Ω–µ –≥–æ—Ç–æ–≤.', 'error');
                 return;
            }

            const inputVal = document.getElementById('delete-confirm-input').value.trim().toUpperCase();
            if (inputVal !== '–£–î–ê–õ–ò–¢–¨') {
                 showAlert('–û—à–∏–±–∫–∞', '–ù–µ–≤–µ—Ä–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.', 'error');
                 return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            try {
                const collectionRef = db.collection(COLLECTION_NAME);
                const snapshot = await collectionRef.get();
                
                if (snapshot.docs.length === 0) {
                     showAlert('–£—Å–ø–µ—à–Ω–æ!', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –ø—É—Å—Ç–∞.', 'success');
                     return true;
                }

                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();

                // –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
                localStorage.removeItem(OFFLINE_STORAGE_KEY);
                dataCache = []; // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                updateOfflineStatus();
                showAlert('–£—Å–ø–µ—à–Ω–æ!', `–£–¥–∞–ª–µ–Ω–æ ${snapshot.docs.length} –∑–∞–ø–∏—Å–µ–π. –î–∞–Ω–Ω—ã–µ Firestore –æ—á–∏—â–µ–Ω—ã.`);

                if (isAdmin) fetchAndRenderReports();

                return true;

            } catch (e) {
                 console.error("Error deleting collection:", e);
                 showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + e.message, 'error');
                 return false;
            } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // üîë –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–û–∂–∏–¥–∞–µ–º authenticateUser) - –ò–°–ü–†–ê–í–õ–ï–ù–û
        window.onload = async () => {
            // 1. –°–Ω–∞—á–∞–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ isAdmin –∏ userTelegramId
            await authenticateUser(); // üëà –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ñ–î–ï–ú –ü–†–û–í–ï–†–ö–ò –ê–î–ú–ò–ù–ê

            // 2. –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            populateSettlements();
            updateOfflineStatus();
            window.showSection('form');
            lucide.createIcons();

            // –û–¢–õ–ê–î–ö–ê: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
            document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';

            if (!firebaseConfig.projectId) {
                window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase –≤ –∫–æ–¥.', 'error');
            }
        };

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        window.showSection = showSection;
        window.authenticateUser = authenticateUser;
        window.fetchAndRenderReports = fetchAndRenderReports;
        window.renderLatestData = renderLatestData;
        window.generateMap = generateMap;
        window.toggleMapType = toggleMapType;
        window.getLocation = getLocation;
        window.syncData = syncData;
        window.exportToXLSX = exportToXLSX;
        window.confirmClearDatabase = confirmClearDatabase;
        window.clearDatabase = clearDatabase;
        window.hideConfirmModal = hideConfirmModal;
    </script>
</body>
</html>
