<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | v2.3 (–§–∏–∫—Å –ê–¥–º–∏–Ω–∞/–û–Ω–ª–∞–π–Ω)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <style>
        /* üé® –£–ª—É—á—à–µ–Ω–Ω–∞—è –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ (Jost) */
        body {
            font-family: 'Jost', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #f2f2f7); /* TMA Theme BG */
            color: var(--tg-theme-text-color, #1c1c1e); /* TMA Theme Text */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-bottom: 80px;
            transition: background-color 0.3s;
        }
        h1, h2, h3 { color: var(--tg-theme-text-color, #000000); font-weight: 600; }
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-secondary-bg-color, #e5e5ea);
            transition: transform 0.2s ease-in-out;
        }
        .nav-bar {
             position: fixed;
             bottom: 0;
             left: 0;
             right: 0;
             background-color: var(--tg-theme-secondary-bg-color, #ffffff);
             border-top: 1px solid var(--tg-theme-secondary-bg-color, #d1d1d6);
             z-index: 10;
        }
        .nav-item {
            color: var(--tg-theme-hint-color, #8e8e93);
            transition: color 0.2s;
        }
        .nav-item.active {
            color: var(--tg-theme-link-color, #007aff);
            font-weight: 500;
        }
        /* üí° –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π —Ñ–æ—Ä–º—ã */
        input[type="text"], textarea, select {
            background-color: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-secondary-bg-color, #d1d1d6);
            color: var(--tg-theme-text-color, #1c1c1e);
            border-radius: 10px;
            padding: 12px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
            transition: border-color 0.2s, background-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-link-color, #007aff);
        }
        /* üöÄ –°—Ç–∏–ª–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫ (#1) */
        .loyalty-btn, .action-btn {
            border: 2px solid var(--tg-theme-secondary-bg-color, #e5e5ea);
            font-weight: 500;
            padding: 10px 8px;
            border-radius: 10px;
            transition: all 0.1s ease-in-out;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #1c1c1e);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .loyalty-btn.active-loyal { border-color: #10B981; background-color: #D1FAE5; }
        .loyalty-btn.active-not_loyal { border-color: #EF4444; background-color: #FEE2E2; }
        .loyalty-btn.active-doubtful { border-color: #F59E0B; background-color: #FEF3C7; }
        .loyalty-btn.active-not_opened { border-color: #6B7280; background-color: #E5E7EB; }

        .action-btn.active-action { border-color: var(--tg-theme-link-color, #007aff); background-color: #E0F2FF; }

        /* Map container style */
        #map-container {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            margin-top: 20px;
        }
        /* üé® –°—Ç–∏–ª—å –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
        .btn-primary {
            background-color: var(--tg-theme-button-color, #007aff);
            color: var(--tg-theme-button-text-color, #ffffff);
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: 600;
            transition: background-color 0.15s ease-in-out;
        }
        .btn-secondary {
            background-color: var(--tg-theme-secondary-bg-color, #e5e5ea);
            color: var(--tg-theme-text-color, #1c1c1e);
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: 500;
            border: 1px solid var(--tg-theme-hint-color, #d1d1d6);
            transition: background-color 0.15s ease-in-out;
        }
    </style>
</head>
<body class="p-4">

    <div id="offlineStatus" class="fixed top-0 left-0 right-0 p-2 text-center text-xs font-medium text-white bg-red-500 hidden z-20">
        <i data-lucide="cloud-off" class="w-4 h-4 mr-1 inline-block align-middle"></i>
        –û—Ñ–ª–∞–π–Ω: <span id="debugOfflineCount">0</span> –∑–∞–ø–∏—Å–µ–π –≤ –∫—ç—à–µ. –ù–∞–∂–º–∏—Ç–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å".
    </div>

    <div class="nav-bar">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            <a href="#" onclick="showSection('form'); return false;" class="nav-item active flex flex-col items-center text-xs">
                <i data-lucide="clipboard-pen" class="w-5 h-5"></i>
                <span>–í–≤–æ–¥</span>
            </a>
            <a href="#" onclick="showSection('walklist'); return false;" class="nav-item flex flex-col items-center text-xs">
                 <i data-lucide="route" class="w-5 h-5"></i>
                <span>–ú–∞—Ä—à—Ä—É—Ç</span>
            </a>
            <a id="navReports" href="#" onclick="showSection('reports'); return false;" class="nav-item flex flex-col items-center text-xs hidden">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                <span>–û—Ç—á–µ—Ç—ã</span>
            </a>
            <a id="navAdmin" href="#" onclick="showSection('admin'); return false;" class="nav-item flex flex-col items-center text-xs hidden">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span>–ê–¥–º–∏–Ω</span>
            </a>
        </div>
    </div>
    <main class="max-w-lg mx-auto">
        <section id="form" class="section">
            <h1 class="text-2xl font-bold mb-4">–ë—ã—Å—Ç—Ä—ã–π –í–≤–æ–¥ –î–∞–Ω–Ω—ã—Ö</h1>

            <div id="debugCard" class="card p-3 mb-4 bg-yellow-100 border-l-4 border-yellow-500">
                <p class="text-xs text-yellow-800 font-semibold">
                    <i data-lucide="alert-triangle" class="w-4 h-4 mr-1 inline-block align-middle"></i>
                    –û—Ç–ª–∞–¥–∫–∞: –í–∞—à ID: <span id="debugUserId">...</span>
                </p>
                <p class="text-xs text-yellow-800">
                    –°—Ç–∞—Ç—É—Å –ê–¥–º–∏–Ω–∞: <span id="debugAdminStatus">...</span> |
                    –û—Ñ–ª–∞–π–Ω-–ö—ç—à: <span id="debugOfflineCountForm">0</span>
                </p>
            </div>

            <div id="historyCheck" class="card p-3 mb-4 bg-yellow-50 border-l-4 border-yellow-500 hidden">
                <p class="text-sm text-yellow-800 font-semibold">‚ö†Ô∏è –ò—Å—Ç–æ—Ä–∏—è –ü–æ—Å–µ—â–µ–Ω–∏—è:</p>
                <p id="historyText" class="text-xs text-yellow-700 mt-1 italic">–ê–¥—Ä–µ—Å –ø–æ—Å–µ—â–∞–ª—Å—è —Ä–∞–Ω–µ–µ.</p>
            </div>

            <div class="card p-4">
                <form id="surveyForm" onsubmit="saveSurveyData(event)">

                    <div class="mb-4">
                        <label for="settlement" class="block text-sm font-medium mb-1">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</label>
                        <select id="settlement" required class="w-full"></select>
                    </div>

                    <div class="mb-4">
                        <label for="street" class="block text-sm font-medium mb-1">–£–ª–∏—Ü–∞</label>
                        <input type="text" id="street" required class="w-full" data-local-storage="lastStreet" oninput="checkAddressHistory()">
                    </div>
                    <div class="mb-4 flex space-x-2">
                        <div class="flex-1">
                            <label for="house" class="block text-sm font-medium mb-1">–î–æ–º</label>
                            <input type="text" id="house" required class="w-full" placeholder="–ù–æ–º–µ—Ä –¥–æ–º–∞" oninput="checkAddressHistory()">
                        </div>
                         <div class="flex-1">
                            <label for="apartment" class="block text-sm font-medium mb-1">–ö–≤–∞—Ä—Ç–∏—Ä–∞ (–æ–ø—Ü.)</label>
                            <input type="text" id="apartment" class="w-full" placeholder="–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã" oninput="checkAddressHistory()">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</label>
                        <div id="loyaltyButtons" class="grid grid-cols-2 gap-2">
                            <button type="button" class="loyalty-btn text-sm" data-value="loyal" data-color="green" onclick="setLoyalty('loyal')">üü¢ –õ–æ—è–ª—å–Ω—ã–π</button>
                            <button type="button" class="loyalty-btn text-sm" data-value="doubtful" data-color="yellow" onclick="setLoyalty('doubtful')">üü° –°–æ–º–Ω–µ–≤–∞—é—â–∏–π—Å—è</button>
                            <button type="button" class="loyalty-btn text-sm" data-value="not_loyal" data-color="red" onclick="setLoyalty('not_loyal')">üî¥ –ù–µ –ª–æ—è–ª—å–Ω—ã–π</button>
                            <button type="button" class="loyalty-btn text-sm" data-value="not_opened" data-color="gray" onclick="setLoyalty('not_opened')">‚ö´ –ù–µ –æ—Ç–∫—Ä—ã–ª–∏</button>
                        </div>
                        <input type="hidden" id="loyalty" required value="">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">–î–µ–π—Å—Ç–≤–∏–µ</label>
                        <div id="actionButtons" class="grid grid-cols-2 gap-2">
                            <button type="button" class="action-btn text-sm" data-value="canvassing" onclick="setAction('canvassing')">üö™ –û–±—Ö–æ–¥</button>
                            <button type="button" class="action-btn text-sm" data-value="leafleting" onclick="setAction('leafleting')">üì∞ –õ–∏—Å—Ç–æ–≤–∫–∞</button>
                            <button type="button" class="action-btn text-sm" data-value="meeting" onclick="setAction('meeting')">ü§ù –í—Å—Ç—Ä–µ—á–∞</button>
                            <button type="button" class="action-btn text-sm" data-value="call" onclick="setAction('call')">üìû –ó–≤–æ–Ω–æ–∫</button>
                            <button type="button" class="action-btn text-sm" data-value="positive" onclick="setAction('positive')">‚úÖ –ü–æ–∑–∏—Ç–∏–≤</button>
                            <button type="button" class="action-btn text-sm" data-value="negative" onclick="setAction('negative')">‚ùå –ù–µ–≥–∞—Ç–∏–≤</button>
                        </div>
                        <input type="hidden" id="action" required value="">
                    </div>

                    <div id="conversationScript" class="card p-3 mb-4 bg-blue-50 border-l-4 border-blue-500 hidden">
                        <p class="text-sm text-blue-800 font-semibold">–°—Ü–µ–Ω–∞—Ä–∏–π / –ü–æ–¥—Å–∫–∞–∑–∫–∞:</p>
                        <p id="scriptText" class="text-xs text-blue-700 mt-1 italic"></p>
                    </div>

                    <div class="mb-4 flex items-center p-3 rounded-lg bg-red-50 border border-red-200">
                        <input type="checkbox" id="requires_followup" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
                        <label for="requires_followup" class="ml-2 block text-base font-medium text-red-600">
                            üî¥ –¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ö–æ–Ω—Ç–∞–∫—Ç (–í–∞–∂–Ω–æ)
                        </label>
                    </div>

                    <div class="mb-4">
                        <label for="comment" class="block text-sm font-medium mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea id="comment" class="w-full" rows="3"></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</label>
                        <div id="locationStatus" class="text-sm italic text-gray-500 mb-2">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                        <div class="flex space-x-2">
                            <button type="button" id="getLocationBtn" onclick="getLocation()" class="btn-secondary text-sm flex-1 flex items-center justify-center">
                                <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i>
                                <span>–ü–æ–ª—É—á–∏—Ç—å GPS + –ê–¥—Ä–µ—Å</span>
                            </button>
                             <button type="button" id="copyLocationBtn" onclick="copyLocation()" class="btn-secondary text-sm px-3 flex items-center justify-center hidden" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å GPS">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <button type="submit" id="submitFormBtn" class="btn-primary w-full mt-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ó–∞–ø–∏—Å—å</button>
                </form>
            </div>
        </section>

        <section id="walklist" class="section hidden">
            <h1 class="text-2xl font-bold mb-4">–ú–æ–π –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –õ–∏—Å—Ç</h1>

            <div class="card p-4">
                <h2 class="text-md font-semibold mb-3">–§–∏–ª—å—Ç—Ä –∏ –ü–æ–∏—Å–∫ (–£–ª—É—á—à–µ–Ω–∏–µ UX)</h2>
                <div class="mb-3">
                    <input type="text" id="walklistSearch" oninput="filterWalkList()" placeholder="–ü–æ–∏—Å–∫ –ø–æ —É–ª–∏—Ü–µ, –¥–æ–º—É –∏–ª–∏ –∫–≤–∞—Ä—Ç–∏—Ä–µ..." class="w-full">
                </div>
                <div class="flex space-x-2">
                    <button class="btn-secondary flex-1 text-sm" onclick="filterWalkList('pending')">–¢–æ–ª—å–∫–æ –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ</button>
                    <button class="btn-secondary flex-1 text-sm" onclick="filterWalkList('done')">–¢–æ–ª—å–∫–æ –ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ</button>
                    <button class="btn-secondary flex-1 text-sm" onclick="filterWalkList('all')">–ü–æ–∫–∞–∑–∞—Ç—å –í—Å–µ</button>
                </div>
            </div>

            <div class="card p-4 mt-4">
                <h2 class="text-lg font-semibold mb-3">–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –ê–¥—Ä–µ—Å–∞ (Firebase)</h2>
                <ul id="assignedAddresses" class="space-y-2 text-sm">
                    <li><span class="text-gray-500">–ù–∞–∂–º–∏—Ç–µ "–ú–∞—Ä—à—Ä—É—Ç" –µ—â–µ —Ä–∞–∑, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫...</span></li>
                </ul>
            </div>

            <div class="card p-4 mt-4">
                <h2 class="text-lg font-semibold mb-2 text-red-600">–¢—Ä–µ–∫–∏–Ω–≥ –ü–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è</h2>
                <p class="text-xs text-gray-500 mb-2" id="trackingStatusText">–¢—Ä–µ–∫–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.</p>
                <button id="trackingButton" onclick="startTracking()" class="btn-primary w-full bg-green-500 border-green-700">
                    <i data-lucide="map-pin" class="w-4 h-4 mr-1 inline-block align-middle"></i>
                    –ù–∞—á–∞—Ç—å –¢—Ä–µ–∫–∏–Ω–≥
                </button>

                <p class="text-sm mt-4 mb-2 text-gray-500">
                    **#2 –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** –£ –≤–∞—Å –≤ –∫—ç—à–µ <span id="syncOfflineCount">0</span> –Ω–µ–æ—Ç–æ—Å–ª–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.
                </p>
                <button id="syncButton" onclick="syncOfflineData()" class="btn-primary w-full bg-green-500 border-green-700 disabled:opacity-50" disabled>
                    <i data-lucide="cloud-upload" class="w-4 h-4 mr-1 inline-block align-middle"></i>
                    –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –î–∞–Ω–Ω—ã–µ
                </button>
            </div>
        </section>

        <section id="reports" class="section hidden">
            <h1 class="text-2xl font-bold mb-4">–û—Ç—á–µ—Ç—ã</h1>

            <div id="admin-reports-content">

                <div class="card p-4 mb-4">
                    <h2 class="text-md font-semibold mb-3">–§–∏–ª—å—Ç—Ä –¥–∞–Ω–Ω—ã—Ö</h2>
                    <div class="flex space-x-2 mb-3">
                        <select id="dateRangeFilter" onchange="fetchAndRenderReports()" class="w-1/2 text-sm p-2 border border-gray-300 rounded-md">
                            <option value="30d" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                            <option value="7d">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                            <option value="all">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</option>
                        </select>
                        <select id="userFilter" onchange="fetchAndRenderReports()" class="w-1/2 text-sm p-2 border border-gray-300 rounded-md">
                            <option value="all" selected>–í—Å–µ –ê–≥–∏—Ç–∞—Ç–æ—Ä—ã</option>
                        </select>
                    </div>
                    <div class="text-xs text-gray-500" id="filterStatus">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ **Firebase Firestore**.</div>
                </div>

                <div class="flex space-x-2 mb-4">
                    <button onclick="exportToXLSX()" class="btn-primary flex-1 flex items-center justify-center text-sm">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-1"></i>
                        <span>–≠–∫—Å–ø–æ—Ä—Ç XLSX</span>
                    </button>
                    <button onclick="fetchAndRenderReports()" class="btn-secondary flex-1 flex items-center justify-center text-sm">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-1"></i>
                        <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                    </button>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–°–≤–æ–¥–∫–∞</h2>
                    <div id="summary-metrics" class="grid grid-cols-2 gap-3">
                        </div>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –î–Ω—è–º</h2>
                    <canvas id="dailyActivityChart"></canvas>
                </div>

                 <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–†–µ–π—Ç–∏–Ω–≥ –ê–≥–∏—Ç–∞—Ç–æ—Ä–æ–≤ (Leaderboard)</h2>
                    <div class="overflow-x-auto">
                        <table id="leaderboardTbl" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <th class="px-2 py-2">–ê–≥–∏—Ç–∞—Ç–æ—Ä</th>
                                    <th class="px-2 py-2 text-center">–í—Å–µ–≥–æ –ó–∞–ø–∏—Å–µ–π</th>
                                    <th class="px-2 py-2 text-center">–õ–æ—è–ª—å–Ω—ã—Ö</th>
                                    <th class="px-2 py-2 text-center">Rate, %</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</h2>
                    <canvas id="loyaltyChart"></canvas>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–î–µ–π—Å—Ç–≤–∏—è</h2>
                    <canvas id="actionChart"></canvas>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–ö–∞—Ä—Ç–∞ –ì–µ–æ–ª–æ–∫–∞—Ü–∏–π (–¢–æ—á–∫–∏ –∏ –¢–µ–ø–ª–æ–≤–∞—è –ö–∞—Ä—Ç–∞)</h2>
                    <div class="mb-4 flex items-center">
                        <input type="radio" id="mapTypePoints" name="mapType" value="points" checked onchange="generateMap(dataCache)" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <label for="mapTypePoints" class="ml-2 mr-4 block text-sm font-medium text-gray-700">–¢–æ—á–∫–∏/–ö–ª–∞—Å—Ç–µ—Ä—ã</label>
                        <input type="radio" id="mapTypeHeat" name="mapType" value="heat" onchange="generateMap(dataCache)" class="h-4 w-4 text-red-600 border-gray-300 focus:ring-red-500">
                        <label for="mapTypeHeat" class="ml-2 block text-sm font-medium text-gray-700">–¢–µ–ø–ª–æ–≤–∞—è –ö–∞—Ä—Ç–∞</label>
                    </div>

                    <div id="map-container"></div>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h2>
                     <div class="mb-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="followUpFilter" onchange="renderLatestData(dataCache)" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <label for="followUpFilter" class="ml-2 block text-sm font-medium text-red-600">
                                –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
                            </label>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="latestDataTbl" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <th class="px-2 py-2 cursor-pointer" onclick="sortTable(0)">–í—Ä–µ–º—è</th>
                                    <th class="px-2 py-2 cursor-pointer" onclick="sortTable(1)">–ê–¥—Ä–µ—Å</th>
                                    <th class="px-2 py-2 cursor-pointer" onclick="sortTable(2)">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</th>
                                    <th class="px-2 py-2 cursor-pointer" onclick="sortTable(3)">–ê–≥–∏—Ç–∞—Ç–æ—Ä</th>
                                    <th class="px-2 py-2">–ü–æ–≤—Ç–æ—Ä</th>
                                    <th class="px-2 py-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                </tr>
                            </thead>
                            <tbody id="latestDataBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                    <button onclick="showAlert('–§—É–Ω–∫—Ü–∏—è', '–ü–∞–≥–∏–Ω–∞—Ü–∏—è –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞. –≠–∫—Å–ø–æ—Ä—Ç XLSX –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ.')" class="btn-secondary w-full mt-4 text-xs">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ (–°–∫–æ—Ä–æ)</button>
                </div>

            </div>

            <div id="no-reports-data" class="card p-8 text-center hidden">
                <i data-lucide="frown" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                <h3 class="text-lg font-semibold text-gray-700">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</h3>
                <p class="text-sm text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –±—ã–ª–∏ –ª–∏ –≤–≤–µ–¥–µ–Ω—ã –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏.</p>
            </div>
        </section>

        <section id="admin" class="section hidden">
            <h1 class="text-2xl font-bold mb-4">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>

            <div id="admin-panel-content">
                 <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–ò–º–∏—Ç–∞—Ü–∏—è)</h2>
                    <p class="text-sm mb-4">–í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å –∞–≥–∏—Ç–∞—Ç–æ—Ä–æ–≤ –∏ –Ω–∞–∑–Ω–∞—á–∞—Ç—å –∏–º **–ú–∞—Ä—à—Ä—É—Ç–Ω—ã–µ –õ–∏—Å—Ç—ã**.</p>
                    <button onclick="showAlert('–ò–º–∏—Ç–∞—Ü–∏—è', '–§—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Ç—Ä–µ–±—É–µ—Ç –±—ç–∫–µ–Ω–¥–∞.')" class="btn-secondary w-full">
                        <i data-lucide="users" class="w-4 h-4 mr-1 inline-block align-middle"></i>
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ò–º–∏—Ç–∞—Ü–∏—è)
                    </button>
                </div>
                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2 text-red-600">–û–ø–∞—Å–Ω–∞—è –ó–æ–Ω–∞</h2>
                    <p class="text-sm mb-4">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ.</p>
                    <button onclick="deleteCollection()" class="btn-secondary w-full bg-red-100 text-red-600 border border-red-400">
                        <i data-lucide="trash-2" class="w-4 h-4 mr-1 inline-block align-middle"></i>
                        –£–¥–∞–ª–∏—Ç—å –í—Å–µ –î–∞–Ω–Ω—ã–µ
                    </button>
                </div>
            </div>
        </section>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/sheetjs@0.19.0/dist/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, updateDoc, writeBatch, limit } from 'https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js';

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í–ê–®–ò –ö–õ–Æ–ß–ò) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVeRXO16KtIwoJQb4uHQuCsEv3xTLBGhI",
            authDomain: "agitator-notebook.firebaseapp.com",
            projectId: "agitator-notebook",
            storageBucket: "agitator-notebook.firebasestorage.app",
            messagingSenderId: "518555352011",
            appId: "1:518555352011:web:2b18d460a6fa4acb66944e"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        // üîë –í–ê–ñ–ù–û: –í–ê–® –†–ï–ê–õ–¨–ù–´–ô TELEGRAM ID
        const ADMIN_TELEGRAM_ID = '541459471';

        const isTMA = window.Telegram && window.Telegram.WebApp;
        // üîë –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è userTelegramId —Å –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ–º –∫ —Å—Ç—Ä–æ–∫–µ
        let userTelegramId = isTMA && Telegram.WebApp.initDataUnsafe.user ? String(Telegram.WebApp.initDataUnsafe.user.id) : 'web-test-user-' + (Math.floor(Math.random() * 10000) + 1);

        let isAdmin = false;
        let userLocation = null;
        let isLocationPending = false;
        let dataCache = [];
        let walklistCache = [];
        let offlineCache = JSON.parse(localStorage.getItem('offlineCache') || '[]');
        let mapInstance = null;
        let markerCluster = null;

        const SETTLEMENTS = [
            '–≥.–ø. –ë–∞—Ä—Å–æ–≤–æ', '—Å.–ø. –°–æ–ª–Ω–µ—á–Ω—ã–π', '–≥.–ø. –õ—è–Ω—Ç–æ—Ä', '–≥.–ø. –§–µ–¥–æ—Ä–æ–≤—Å–∫–∏–π', '—Å.–ø. –õ–æ–∫–æ—Å–æ–≤–æ'
        ];
        const INTERACTIVE_SCRIPTS = {
            'loyal': "–ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç–µ. –£–∑–Ω–∞–π—Ç–µ, –≥–æ—Ç–æ–≤ –ª–∏ –ø–æ–º–æ—á—å (–ª–∏—Å—Ç–æ–≤–∫–∏, –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å).",
            'doubtful': "–°–ø—Ä–æ—Å–∏—Ç–µ –æ –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.",
            'not_loyal': "–°–ø–æ–∫–æ–π–Ω–æ –≤—ã—Å–ª—É—à–∞–π—Ç–µ –∫—Ä–∏—Ç–∏–∫—É. –ù–µ —Å–ø–æ—Ä—å—Ç–µ. –ó–∞–ø–∏—à–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏.",
            'not_opened': "–û—Å—Ç–∞–≤—å—Ç–µ –ª–∏—Å—Ç–æ–≤–∫—É. –ó–∞–ø–∏—à–∏—Ç–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π '–¢–∏—à–∏–Ω–∞' –∏–ª–∏ '–ù–µ—Ç –¥–æ–º–∞'.",
            'meeting': "–£—Ç–æ—á–Ω–∏—Ç–µ –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–π –≤—Å—Ç—Ä–µ—á–∏. –ù–∞–ø–æ–º–Ω–∏—Ç–µ –æ –∑–∞–ø–∏—Å–∏.",
            'call': "–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç–µ, —É–¥–æ–±–Ω–æ –ª–∏ –≥–æ–≤–æ—Ä–∏—Ç—å, –ø—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞—á–∏–Ω–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä.",
            'positive': "–°–ø—Ä–æ—Å–∏—Ç–µ, –ø–æ—á–µ–º—É –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç. –ó–∞–ø–∏—à–∏—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∞–≥–∏—Ç–∞—Ü–∏–∏."
        };

        // --- –§–£–ù–ö–¶–ò–ò ---

        // üîë –§–£–ù–ö–¶–ò–Ø –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò –ò –ü–†–û–í–ï–†–ö–ò –ê–î–ú–ò–ù–ê (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
        async function authenticateUser() {
            try {
                if (!userTelegramId) {
                     console.error("User Telegram ID is missing! Using fallback.");
                     userTelegramId = 'web-test-user-0'; // Fallback
                }

                // 1. –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í –º–æ–¥—É–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ signInAnonymously –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç UserCredential, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ Promise.
                await signInAnonymously(auth);

                // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–£–°–ò–õ–ï–ù–û: –æ–±–∞ ID –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è –∫ —Å—Ç—Ä–æ–∫–µ)
                // –ï—Å–ª–∏ userTelegramId —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å ADMIN_TELEGRAM_ID, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º isAdmin –≤ true.
                isAdmin = (String(userTelegramId) === String(ADMIN_TELEGRAM_ID));

                // 3. –û—Ç—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤ –æ—Ç–ª–∞–¥–∫–µ
                document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
                document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';
                console.log("–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. Is Admin:", isAdmin);

                // 4. –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∞
                if (isAdmin) {
                    document.getElementById('navReports').classList.remove('hidden');
                    document.getElementById('navAdmin').classList.remove('hidden');
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", error);
                window.showAlert('–û—à–∏–±–∫–∞ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Auth.');
            }
        }

        // üó∫Ô∏è –¢—Ä–µ–∫–∏–Ω–≥ –ü–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è
        let trackingInterval = null;

        async function sendTrackingUpdate() {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const data = {
                        user_id: userTelegramId,
                        username: isTMA && Telegram.WebApp.initDataUnsafe.user ? Telegram.WebApp.initDataUnsafe.user.username : 'web-test',
                        timestamp: new Date().toISOString(),
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    try {
                        await addDoc(collection(db, "tracking_logs"), data);
                        console.log("Tracking update sent.");
                        document.getElementById('trackingStatusText').textContent = `–¢—Ä–µ–∫–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω. –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleTimeString()}`;
                    } catch (error) {
                        console.warn("–û—à–∏–±–∫–∞ —Ç—Ä–µ–∫–∏–Ω–≥–∞ Firebase (–Ω–µ—Ç —Å–µ—Ç–∏?):", error.message);
                    }
                },
                (error) => {
                    console.error("–û—à–∏–±–∫–∞ GPS –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞:", error.message);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 10000 }
            );
        }

        window.startTracking = () => {
            const button = document.getElementById('trackingButton');

            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
                button.textContent = '–ù–∞—á–∞—Ç—å –¢—Ä–µ–∫–∏–Ω–≥';
                button.classList.remove('bg-red-500', 'border-red-700');
                button.classList.add('bg-green-500', 'border-green-700');
                document.getElementById('trackingStatusText').textContent = `–¢—Ä–µ–∫–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.`;
                window.showAlert('–¢—Ä–µ–∫–∏–Ω–≥', '–¢—Ä–µ–∫–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');
            } else {
                if (!navigator.geolocation) {
                    window.showAlert('–û—à–∏–±–∫–∞', '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞.');
                    return;
                }

                sendTrackingUpdate();
                trackingInterval = setInterval(sendTrackingUpdate, 60000);

                button.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¢—Ä–µ–∫–∏–Ω–≥';
                button.classList.remove('bg-green-500', 'border-green-700');
                button.classList.add('bg-red-500', 'border-red-700');
                document.getElementById('trackingStatusText').textContent = `–¢—Ä–µ–∫–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥.`;
                window.showAlert('–¢—Ä–µ–∫–∏–Ω–≥', '–¢—Ä–µ–∫–∏–Ω–≥ –Ω–∞—á–∞—Ç. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥.');
            }
            if (isTMA) Telegram.WebApp.HapticFeedback.impactOccurred('medium');
        };

        // üó∫Ô∏è –ü–æ–ª—É—á–µ–Ω–∏–µ GPS —Å –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        window.getLocation = () => {
            if (isLocationPending) {
                window.showAlert('–ü–æ–¥–æ–∂–¥–∏—Ç–µ', '–ü—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è.');
                return;
            }
            const statusElement = document.getElementById('locationStatus');
            const btn = document.getElementById('getLocationBtn');
            const copyBtn = document.getElementById('copyLocationBtn');
            statusElement.textContent = '–ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...';
            btn.disabled = true;
            isLocationPending = true;
            userLocation = null;
            copyBtn.classList.add('hidden');

            if (!navigator.geolocation) {
                statusElement.textContent = '–û—à–∏–±–∫–∞: –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.';
                btn.disabled = false;
                isLocationPending = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                    let addressFound = false;
                    let statusText = `–£—Å–ø–µ—à–Ω–æ: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;

                    try {
                        // –û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Nominatim
                        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&addressdetails=1`;
                        const response = await fetch(url, { headers: { 'User-Agent': 'AgitatorApp/1.0' } });
                        const data = await response.json();

                        const address = data.address;

                        if (address) {
                            const street = address.road || address.pedestrian || '';
                            const house = address.house_number || '';

                            if (street && house) {
                                document.getElementById('street').value = street;
                                document.getElementById('house').value = house;
                                addressFound = true;
                                statusText += ' (–ê–¥—Ä–µ—Å –∑–∞–ø–æ–ª–Ω–µ–Ω)';
                            } else if (street) {
                                document.getElementById('street').value = street;
                                document.getElementById('house').value = '';
                                statusText += ' (–ù–∞–π–¥–µ–Ω–∞ —Ç–æ–ª—å–∫–æ —É–ª–∏—Ü–∞)';
                            } else {
                                statusText += ' (–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω)';
                            }
                        } else {
                            statusText += ' (–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è)';
                        }

                    } catch (error) {
                        console.error("–û—à–∏–±–∫–∞ Nominatim:", error);
                        statusText += ' (–û—à–∏–±–∫–∞ —Å–µ—Ç–∏/Nominatim)';
                    }

                    statusElement.textContent = statusText;
                    copyBtn.classList.remove('hidden');
                    btn.disabled = false;
                    isLocationPending = false;
                    if(addressFound) checkAddressHistory();
                    if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                },
                (error) => {
                    let errorMessage = (error.code === error.PERMISSION_DENIED) ? '–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ GPS. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                    statusElement.textContent = `–û—à–∏–±–∫–∞: ${errorMessage}`;
                    window.showAlert('–û—à–∏–±–∫–∞ GPS', errorMessage);
                    btn.disabled = false;
                    isLocationPending = false;
                    if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        };

        // üè† –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ –ú–∞—Ä—à—Ä—É—Ç–Ω–æ–º –õ–∏—Å—Ç–µ
        async function updateWalklistStatus(settlement, street, house, apartment) {
            try {
                // –ò—â–µ–º –∑–∞–ø–∏—Å—å –≤ walklists, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–≤–µ–¥–µ–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É –ò –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ò –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å 'pending'
                const q = query(
                    collection(db, "walklists"),
                    where('user_id', '==', userTelegramId.toString()),
                    where('settlement', '==', settlement),
                    where('street', '==', street),
                    where('house', '==', house),
                    where('apartment', '==', apartment || ''),
                    where('status', '==', 'pending'),
                    limit(1)
                );

                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const docRef = querySnapshot.docs[0].ref;
                    await updateDoc(docRef, {
                        status: 'done',
                        finished_at: new Date().toISOString()
                    });
                    console.log(`Walklist item updated to 'done': ${docRef.id}`);

                    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥, –µ—Å–ª–∏ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ú–∞—Ä—à—Ä—É—Ç"
                    if (document.querySelector('.nav-item.active span').textContent === '–ú–∞—Ä—à—Ä—É—Ç') {
                        const index = walklistCache.findIndex(item =>
                            item.settlement === settlement &&
                            item.street === street &&
                            item.house === house &&
                            item.apartment === (apartment || '') &&
                            item.status === 'pending'
                        );
                        if(index !== -1) {
                            walklistCache[index].status = 'done';
                            walklistCache[index].finished_at = new Date().toISOString();
                        }
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä, —á—Ç–æ–±—ã –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –∏—Å—á–µ–∑, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω —Ñ–∏–ª—å—Ç—Ä 'pending'
                        filterWalkList(document.getElementById('walklistSearch').value ? 'all' : 'pending');
                    }
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è walklist:", e);
            }
        }

        // üè† –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ú–∞—Ä—à—Ä—É—Ç–Ω–æ–≥–æ –õ–∏—Å—Ç–∞
        window.renderWalkList = async () => {
            const list = document.getElementById('assignedAddresses');
            if (!list) return;

            list.innerHTML = '<li><i data-lucide="loader" class="w-4 h-4 inline-block animate-spin mr-2"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</li>';
            lucide.createIcons();
            document.getElementById('walklistSearch').value = '';

            try {
                const q = query(
                    collection(db, "walklists"),
                    where('user_id', '==', userTelegramId.toString()),
                    orderBy('status', 'asc') // –°–Ω–∞—á–∞–ª–∞ "pending", –ø–æ—Ç–æ–º "done"
                );
                const querySnapshot = await getDocs(q);

                walklistCache = [];
                querySnapshot.forEach(doc => {
                    walklistCache.push(doc.data());
                });

                filterWalkList('pending'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

            } catch (e) {
                list.innerHTML = '<li><span class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä—à—Ä—É—Ç–Ω–æ–≥–æ –ª–∏—Å—Ç–∞.</span></li>';
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ walklist:", e);
            }
        };

        // üîç –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ú–∞—Ä—à—Ä—É—Ç–Ω–æ–≥–æ –õ–∏—Å—Ç–∞
        window.filterWalkList = (statusFilter = 'all') => {
            const list = document.getElementById('assignedAddresses');
            const searchText = document.getElementById('walklistSearch').value.toLowerCase().trim();
            list.innerHTML = '';

            let filteredData = walklistCache;

            if (statusFilter !== 'all') {
                filteredData = filteredData.filter(address => address.status === statusFilter);
            }

            if (searchText) {
                 filteredData = filteredData.filter(address =>
                    address.street.toLowerCase().includes(searchText) ||
                    address.house.toLowerCase().includes(searchText) ||
                    (address.apartment || '').toLowerCase().includes(searchText)
                 );
            }

            if (filteredData.length === 0) {
                 list.innerHTML = '<li><span class="text-gray-500">–ê–¥—Ä–µ—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É.</span></li>';
                 return;
            }

            filteredData.forEach(address => {
                const item = document.createElement('li');
                item.className = `cursor-pointer hover:bg-gray-100 p-1 rounded transition ${address.status === 'done' ? 'text-green-600 line-through' : 'text-gray-900'}`;
                item.innerHTML = `
                    **${address.settlement}**, —É–ª. ${address.street}, –¥. ${address.house}${address.apartment ? `, –∫–≤. ${address.apartment}` : ''}
                    <span class="text-xs ml-2 text-gray-500">(${address.status === 'done' ? '–ü—Ä–æ–π–¥–µ–Ω–æ' : '–ù–∞–∑–Ω–∞—á–µ–Ω–æ'})</span>
                `;

                if (address.status !== 'done') {
                    item.onclick = () => {
                        document.getElementById('settlement').value = address.settlement;
                        document.getElementById('street').value = address.street;
                        document.getElementById('house').value = address.house;
                        document.getElementById('apartment').value = address.apartment;
                        window.showSection('form');
                        checkAddressHistory();
                        if (isTMA) Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    };
                }
                list.appendChild(item);
            });
            lucide.createIcons();
        };

        // --- –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò –ò –£–¢–ò–õ–ò–¢–´ ---

        window.showAlert = (title, message) => {
            if (isTMA) {
                Telegram.WebApp.showAlert(`${title}: ${message}`);
            } else {
                alert(`${title}: ${message}`);
            }
        };

        function updateOfflineStatus() {
            const count = offlineCache.length;
            const statusElement = document.getElementById('offlineStatus');
            const debugElementTop = document.getElementById('debugOfflineCount');
            const debugElementForm = document.getElementById('debugOfflineCountForm');
            const syncButton = document.getElementById('syncButton');

            if (debugElementTop) debugElementTop.textContent = count;
            if (debugElementForm) debugElementForm.textContent = count;
            document.getElementById('syncOfflineCount').textContent = count;

            if (count > 0) {
                statusElement.classList.remove('hidden');
                syncButton.disabled = false;
                syncButton.classList.remove('bg-green-500');
                syncButton.classList.add('bg-orange-500');
            } else {
                statusElement.classList.add('hidden');
                syncButton.disabled = true;
                syncButton.classList.remove('bg-orange-500');
                syncButton.classList.add('bg-green-500');
            }
        }

        // üõë showSection —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ê–¥–º–∏–Ω–∞
        window.showSection = (sectionId) => {
            // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ isTMA –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ –±–µ–∑ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            if (isAdmin === false && (sectionId === 'reports' || sectionId === 'admin')) {
                window.showAlert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª—É.');
                return;
            }

            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            let activeNavElement = document.querySelector(`a[onclick*="${sectionId}"]`);
            if (sectionId === 'reports' && document.getElementById('navReports')) {
                 activeNavElement = document.getElementById('navReports');
            } else if (sectionId === 'admin' && document.getElementById('navAdmin')) {
                 activeNavElement = document.getElementById('navAdmin');
            }

            if (activeNavElement) {
                activeNavElement.classList.add('active');
            }

            if (sectionId === 'reports') {
                fetchAndRenderReports();
            } else if (sectionId === 'walklist') {
                renderWalkList();
                updateOfflineStatus();
            }
            lucide.createIcons();
            if (isTMA) Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }

        // --- –§–£–ù–ö–¶–ò–ò –§–û–†–ú–´ ---

        function populateSettlements() {
            const selectElement = document.getElementById('settlement');
            const lastSettlement = localStorage.getItem('lastSettlement');
            selectElement.innerHTML = '<option value="" disabled selected hidden>–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
            SETTLEMENTS.forEach(settlement => {
                const option = document.createElement('option');
                option.value = settlement;
                option.textContent = settlement;
                if (settlement === lastSettlement) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        // üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –õ–æ—è–ª—å–Ω–æ—Å—Ç–∏
        window.setLoyalty = (value) => {
            const container = document.getElementById('loyaltyButtons');
            const input = document.getElementById('loyalty');
            input.value = value;
            container.querySelectorAll('.loyalty-btn').forEach(btn => {
                btn.classList.remove('active-loyal', 'active-not_loyal', 'active-doubtful', 'active-not_opened');
                if (btn.dataset.value === value) {
                    btn.classList.add(`active-${value}`);
                }
            });
            updateConversationScript(value);
            if (isTMA) Telegram.WebApp.HapticFeedback.impactOccurred('light');
        };

        // üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –î–µ–π—Å—Ç–≤–∏—è
        window.setAction = (value) => {
            const container = document.getElementById('actionButtons');
            const input = document.getElementById('action');
            if (input.value === value) {
                input.value = '';
                container.querySelector(`[data-value="${value}"]`).classList.remove('active-action');
                updateConversationScript(document.getElementById('loyalty').value);
            } else {
                input.value = value;
                container.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('active-action'));
                container.querySelector(`[data-value="${value}"]`).classList.add('active-action');
                updateConversationScript(value);
            }
            if (isTMA) Telegram.WebApp.HapticFeedback.impactOccurred('light');
        };

        // üí¨ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –°–∫—Ä–∏–ø—Ç–∞
        function updateConversationScript(key) {
            const scriptCard = document.getElementById('conversationScript');
            const scriptText = document.getElementById('scriptText');

            const activeLoyalty = document.getElementById('loyalty').value;
            const activeAction = document.getElementById('action').value;

            let keyToUse = activeAction || activeLoyalty;

            if (INTERACTIVE_SCRIPTS[keyToUse]) {
                scriptText.textContent = INTERACTIVE_SCRIPTS[keyToUse];
                scriptCard.classList.remove('hidden');
            } else {
                scriptCard.classList.add('hidden');
            }
        }

        // ‚úçÔ∏è –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ GPS
        window.copyLocation = () => {
            if (!userLocation) {
                window.showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç GPS –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.');
                return;
            }
            const gpsString = `${userLocation.latitude.toFixed(6)}, ${userLocation.longitude.toFixed(6)}`;
            navigator.clipboard.writeText(gpsString).then(() => {
                window.showAlert('–£—Å–ø–µ—à–Ω–æ', `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã: ${gpsString}`);
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }).catch(err => {
                window.showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
                console.error('Copy failed:', err);
            });
        };

        // üëÅÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ò—Å—Ç–æ—Ä–∏–∏
        window.checkAddressHistory = async () => {
            const street = document.getElementById('street').value.trim();
            const house = document.getElementById('house').value.trim();
            const apartment = document.getElementById('apartment').value.trim();
            const historyCard = document.getElementById('historyCheck');
            const historyText = document.getElementById('historyText');

            if (!street || !house) {
                historyCard.classList.add('hidden');
                return;
            }

            try {
                // –ó–∞–ø—Ä–æ—Å –∫ Firestore –ø–æ –∞–¥—Ä–µ—Å—É
                let q = query(
                    collection(db, "surveys"),
                    where('street', '==', street),
                    where('house', '==', house),
                    orderBy('timestamp', 'desc'),
                    limit(1)
                );

                if (apartment) {
                    q = query(
                        collection(db, "surveys"),
                        where('street', '==', street),
                        where('house', '==', house),
                        where('apartment', '==', apartment),
                        orderBy('timestamp', 'desc'),
                        limit(1)
                    );
                }

                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const lastEntry = snapshot.docs[0].data();
                    const date = new Date(lastEntry.timestamp).toLocaleDateString('ru-RU', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const user = lastEntry.full_name || lastEntry.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≥–∏—Ç–∞—Ç–æ—Ä';
                    const loyaltyMap = { loyal: '–õ–æ—è–ª—å–Ω—ã–π', not_loyal: '–ù–µ –ª–æ—è–ª—å–Ω—ã–π', doubtful: '–°–æ–º–Ω–µ–≤–∞—é—â–∏–π—Å—è', not_opened: '–ù–µ –æ—Ç–∫—Ä—ã–ª–∏' };
                    const loyalty = loyaltyMap[lastEntry.loyalty] || lastEntry.loyalty;

                    historyText.innerHTML = `
                        **–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ:** ${date}
                        <br>
                        **–ê–≥–∏—Ç–∞—Ç–æ—Ä:** ${user}
                        <br>
                        **–õ–æ—è–ª—å–Ω–æ—Å—Ç—å:** <span class="font-semibold">${loyalty}</span>
                        <br>
                        **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:** ${lastEntry.comment ? lastEntry.comment.substring(0, 50) + (lastEntry.comment.length > 50 ? '...' : '') : '–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}
                    `;
                    historyCard.classList.remove('hidden');
                } else {
                    historyCard.classList.add('hidden');
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:", error);
                historyCard.classList.add('hidden');
            }
        };

        // üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –î–∞–Ω–Ω—ã—Ö (–û—Ñ–ª–∞–π–Ω + –û–Ω–ª–∞–π–Ω)
        window.saveSurveyData = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitFormBtn');
            btn.disabled = true;
            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            const data = {
                timestamp: new Date().toISOString(),
                user_id: userTelegramId.toString(),
                username: isTMA && Telegram.WebApp.initDataUnsafe.user ? Telegram.WebApp.initDataUnsafe.user.username : 'web-test',
                full_name: isTMA && Telegram.WebApp.initDataUnsafe.user ? (Telegram.WebApp.initDataUnsafe.user.first_name + ' ' + (Telegram.WebApp.initDataUnsafe.user.last_name || '')).trim() : 'Test User',
                settlement: document.getElementById('settlement').value,
                street: document.getElementById('street').value.trim(),
                house: document.getElementById('house').value.trim(),
                apartment: document.getElementById('apartment').value.trim(),
                loyalty: document.getElementById('loyalty').value,
                action: document.getElementById('action').value,
                requires_followup: document.getElementById('requires_followup').checked,
                comment: document.getElementById('comment').value.trim(),
                location: userLocation ? {
                    latitude: userLocation.latitude,
                    longitude: userLocation.longitude,
                    address_from_gps: `${document.getElementById('street').value}, ${document.getElementById('house').value}`
                } : null,
                is_admin: isAdmin,
            };

            localStorage.setItem('lastSettlement', data.settlement);
            let statusMessage = '';
            let isOnlineSave = false;

            try {
                // 1. –ü—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Firebase (–æ–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º)
                const docRef = await addDoc(collection(db, "surveys"), data);
                statusMessage = `–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (ID: ${docRef.id}).`;
                isOnlineSave = true;
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');

                // üöÄ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –º–∞—Ä—à—Ä—É—Ç–Ω–æ–º –ª–∏—Å—Ç–µ
                await updateWalklistStatus(data.settlement, data.street, data.house, data.apartment);

            } catch (error) {
                // 2. –û—Ñ–ª–∞–π–Ω-–∫—ç—à (–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
                let errorType = '–æ—à–∏–±–∫–∏ —Å–µ—Ç–∏/—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                if (error.code === 'permission-denied') {
                    errorType = '–æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ Security Rules)';
                } else if (error.code) {
                    errorType = `Firebase –æ—à–∏–±–∫–∏: ${error.code}`;
                }

                console.warn(`–û—à–∏–±–∫–∞ Firebase (${errorType}), —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à:`, error.message);

                data.offline_timestamp = new Date().toISOString();
                offlineCache.push(data);
                localStorage.setItem('offlineCache', JSON.stringify(offlineCache));
                updateOfflineStatus();
                statusMessage = `–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –û–§–õ–ê–ô–ù-–∫—ç—à –∏–∑-–∑–∞ ${errorType}. ${offlineCache.length} –∑–∞–ø–∏—Å–µ–π –æ–∂–∏–¥–∞—é—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.`;
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
            }

            // 3. –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ
            window.showAlert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ', statusMessage);
            document.getElementById('surveyForm').reset();
            document.getElementById('loyalty').value = '';
            document.getElementById('action').value = '';
            document.getElementById('loyaltyButtons').querySelectorAll('.loyalty-btn').forEach(btn => btn.classList.remove('active-loyal', 'active-not_loyal', 'active-doubtful', 'active-not_opened'));
            document.getElementById('actionButtons').querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('active-action'));
            document.getElementById('conversationScript').classList.add('hidden');
            document.getElementById('historyCheck').classList.add('hidden');
            document.getElementById('locationStatus').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
            document.getElementById('copyLocationBtn').classList.add('hidden');
            userLocation = null;

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å–µ–ª–µ–Ω–∏—è
            const lastSettlement = localStorage.getItem('lastSettlement');
            if (lastSettlement) document.getElementById('settlement').value = lastSettlement;

            btn.disabled = false;
            if (isTMA) Telegram.WebApp.MainButton.hideLoader();
        };

        // üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –û—Ñ–ª–∞–π–Ω-–î–∞–Ω–Ω—ã—Ö
        window.syncOfflineData = async () => {
            if (offlineCache.length === 0) {
                window.showAlert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è', '–ö—ç—à –ø—É—Å—Ç, –Ω–µ—á–µ–≥–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å.');
                return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            let successfulSyncs = 0;
            const failedData = [];

            // –ü—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –∫–æ–ø–∏–∏ –∫—ç—à–∞
            for (const data of offlineCache) {
                try {
                    // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ Firestore
                    await addDoc(collection(db, "surveys"), data);

                    // –û–±–Ω–æ–≤–ª—è–µ–º walklist
                    await updateWalklistStatus(data.settlement, data.street, data.house, data.apartment);

                    successfulSyncs++;
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏:", data, error);
                    failedData.push(data);
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à: —Ç–æ–ª—å–∫–æ –Ω–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –æ—Å—Ç–∞—é—Ç—Å—è
            offlineCache = failedData;
            localStorage.setItem('offlineCache', JSON.stringify(offlineCache));
            updateOfflineStatus();

            if (isTMA) Telegram.WebApp.MainButton.hideLoader();

            if (successfulSyncs > 0) {
                window.showAlert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è', `–£—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${successfulSyncs} –∑–∞–ø–∏—Å–µ–π. –û—Å—Ç–∞–ª–æ—Å—å: ${failedData.length}.`);
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            } else {
                window.showAlert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è', `–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –û—Å—Ç–∞–ª–æ—Å—å: ${failedData.length}.`);
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            }
        };

        // --- –§–£–ù–ö–¶–ò–ò –û–¢–ß–ï–¢–û–í ---

        async function fetchAndRenderReports() {
            if (!isAdmin) return;

            const filterStatus = document.getElementById('filterStatus');
            filterStatus.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";

            const dateRange = document.getElementById('dateRangeFilter').value;
            const selectedUser = document.getElementById('userFilter').value;

            let q = query(collection(db, "surveys"), orderBy('timestamp', 'desc'));

            // 1. –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
            const now = new Date();
            let startDate;

            if (dateRange === '7d') startDate = new Date(now.setDate(now.getDate() - 7));
            else if (dateRange === '30d') startDate = new Date(now.setDate(now.getDate() - 30));
            else if (dateRange === 'today') {
                startDate = new Date(now.setHours(0, 0, 0, 0));
            }

            if (startDate) {
                q = query(q, where('timestamp', '>=', startDate.toISOString()));
            }

            // 2. –ó–∞–ø—Ä–æ—Å
            let allUsers = new Set();
            try {
                const snapshot = await getDocs(q);
                dataCache = snapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤:", error);
                filterStatus.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase.";
                return;
            }

            // 3. –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            dataCache.forEach(doc => {
                allUsers.add(doc.full_name || doc.username);
            });
            renderUserFilter(Array.from(allUsers));

            let filteredData = dataCache;
            if (selectedUser !== 'all') {
                filteredData = dataCache.filter(doc => (doc.full_name || doc.username) === selectedUser);
            }

            // 4. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
            renderSummary(filteredData);
            renderLeaderboard(filteredData);
            renderCharts(filteredData);
            renderDailyActivityChart(filteredData);
            renderLatestData(filteredData);
            generateMap(filteredData);

            filterStatus.textContent = `–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${dataCache.length}.`;

            document.getElementById('admin-reports-content').classList.remove('hidden');
            document.getElementById('no-reports-data').classList.add('hidden');
            if (filteredData.length === 0) {
                 document.getElementById('no-reports-data').classList.remove('hidden');
            }
        }

        // üöÄ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ì—Ä–∞—Ñ–∏–∫ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –î–Ω—è–º
        let dailyActivityChartInstance = null;
        function renderDailyActivityChart(data) {
            const ctx = document.getElementById('dailyActivityChart').getContext('2d');

            if (dailyActivityChartInstance) {
                dailyActivityChartInstance.destroy();
            }

            const dailyCounts = data.reduce((acc, d) => {
                const date = new Date(d.timestamp).toISOString().split('T')[0];
                acc[date] = (acc[date] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(dailyCounts).sort();
            const counts = labels.map(label => dailyCounts[label]);

            dailyActivityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π',
                        data: counts,
                        backgroundColor: 'rgba(0, 122, 255, 0.5)',
                        borderColor: '#007aff',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: '–ó–∞–ø–∏—Å–∏' } },
                        x: { title: { display: true, text: '–î–∞—Ç–∞' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –î–Ω—è–º' }
                    }
                }
            });
        }

        // üó∫Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ö–∞—Ä—Ç—ã
        function generateMap(data) {
            const mapContainer = document.getElementById('map-container');

            if (mapInstance) {
                mapInstance.remove();
            }

            const geoData = data.filter(d => d.location && d.location.latitude && d.location.longitude);

            if (geoData.length === 0) {
                mapContainer.innerHTML = '<div class="h-full flex items-center justify-center text-gray-500">–ù–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>';
                return;
            }

            mapContainer.innerHTML = '';

            mapInstance = L.map('map-container').setView([geoData[0].location.latitude, geoData[0].location.longitude], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);

            const mapType = document.querySelector('input[name="mapType"]:checked').value;

            if (mapType === 'points') {
                if (markerCluster) {
                    markerCluster.clearLayers();
                } else {
                    markerCluster = L.markerClusterGroup();
                    mapInstance.addLayer(markerCluster);
                }

                geoData.forEach(d => {
                    const loyaltyColor = { loyal: 'green', not_loyal: 'red', doubtful: 'orange', not_opened: 'gray' }[d.loyalty] || 'blue';

                    const marker = L.marker([d.location.latitude, d.location.longitude], { icon: L.divIcon({
                        className: `bg-${loyaltyColor}-500 text-white rounded-full p-2 text-xs shadow-lg flex items-center justify-center`,
                        html: `<i data-lucide="map-pin" class="w-4 h-4"></i>`,
                        iconSize: [30, 30]
                    })});

                    const popupContent = `
                        <div class="text-sm">
                            <strong>${d.settlement}, —É–ª. ${d.street}, –¥. ${d.house}</strong>
                            <br>–õ–æ—è–ª—å–Ω–æ—Å—Ç—å: <b>${d.loyalty}</b>
                            <br>–ê–≥–∏—Ç–∞—Ç–æ—Ä: ${d.full_name || d.username}
                            <br>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${d.comment ? d.comment.substring(0, 50) + '...' : '–ù–µ—Ç'}
                            <br><small>${new Date(d.timestamp).toLocaleString()}</small>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    markerCluster.addLayer(marker);
                });

                if (geoData.length > 0) {
                     mapInstance.fitBounds(markerCluster.getBounds());
                }

                lucide.createIcons();

            } else if (mapType === 'heat') {
                const heatPoints = geoData.map(d => [d.location.latitude, d.location.longitude, 0.5]);
                L.heatLayer(heatPoints, { radius: 25, maxZoom: 14 }).addTo(mapInstance);

                if (geoData.length > 0) {
                    const bounds = L.latLngBounds(geoData.map(d => [d.location.latitude, d.location.longitude]));
                    mapInstance.fitBounds(bounds);
                }
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        function renderLatestData(data) {
            const body = document.getElementById('latestDataBody');
            const followUpFilter = document.getElementById('followUpFilter').checked;

            body.innerHTML = '';

            let displayData = data;
            if (followUpFilter) {
                displayData = data.filter(d => d.requires_followup);
            }

            const latest = displayData.slice(0, 50);

            latest.forEach(d => {
                const row = body.insertRow();
                const loyaltyColor = { loyal: 'text-green-600', not_loyal: 'text-red-600', doubtful: 'text-orange-500', not_opened: 'text-gray-500' }[d.loyalty] || 'text-gray-900';

                row.insertCell().textContent = new Date(d.timestamp).toLocaleString('ru-RU', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
                row.insertCell().textContent = `${d.street}, ${d.house}${d.apartment ? `/${d.apartment}` : ''}`;
                row.insertCell().innerHTML = `<span class="${loyaltyColor} font-semibold">${d.loyalty}</span>`;
                row.insertCell().textContent = d.full_name || d.username;
                row.insertCell().innerHTML = d.requires_followup ? '<i data-lucide="check" class="w-4 h-4 text-red-600 mx-auto"></i>' : '<i data-lucide="x" class="w-4 h-4 text-gray-400 mx-auto"></i>';
                row.insertCell().textContent = d.comment ? d.comment.substring(0, 30) + (d.comment.length > 30 ? '...' : '') : '-';

                row.classList.add('border-b', 'border-gray-100');
            });
            lucide.createIcons();
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è Leaderboard
        function renderLeaderboard(data) {
            const leaderboardBody = document.getElementById('leaderboardBody');
            leaderboardBody.innerHTML = '';

            const userStats = {};
            data.forEach(d => {
                const userKey = d.full_name || d.username;
                if (!userStats[userKey]) {
                    userStats[userKey] = { total: 0, loyal: 0 };
                }
                userStats[userKey].total++;
                if (d.loyalty === 'loyal') {
                    userStats[userKey].loyal++;
                }
            });

            const leaderboardData = Object.keys(userStats).map(userKey => {
                const stats = userStats[userKey];
                const loyalRate = stats.total > 0 ? ((stats.loyal / stats.total) * 100).toFixed(1) : 0;
                return {
                    user: userKey,
                    total: stats.total,
                    loyal: stats.loyal,
                    rate: parseFloat(loyalRate)
                };
            }).sort((a, b) => b.total - a.total);

            leaderboardData.forEach((item, index) => {
                const row = leaderboardBody.insertRow();
                row.insertCell().textContent = item.user;
                row.insertCell().textContent = item.total;
                row.insertCell().textContent = item.loyal;
                row.insertCell().textContent = `${item.rate}%`;

                row.cells[1].className = 'text-center';
                row.cells[2].className = 'text-center';
                row.cells[3].className = 'text-center font-bold';

                if (index === 0) row.classList.add('bg-yellow-100', 'font-semibold');
            });
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è Summary
        function renderSummary(data) {
            const summaryMetrics = document.getElementById('summary-metrics');
            summaryMetrics.innerHTML = '';

            const total = data.length;
            const loyal = data.filter(d => d.loyalty === 'loyal').length;
            const notLoyal = data.filter(d => d.loyalty === 'not_loyal').length;
            const followUp = data.filter(d => d.requires_followup).length;

            const loyalRate = total > 0 ? ((loyal / total) * 100).toFixed(1) : 0;

            const metrics = [
                { title: '–í—Å–µ–≥–æ –ó–∞–ø–∏—Å–µ–π', value: total, icon: 'clipboard-list', color: 'text-blue-500' },
                { title: '–õ–æ—è–ª—å–Ω—ã—Ö', value: loyal, icon: 'smile', color: 'text-green-500' },
                { title: '–ü—Ä–æ—Ü–µ–Ω—Ç –õ–æ—è–ª—å–Ω–æ—Å—Ç–∏', value: `${loyalRate}%`, icon: 'trending-up', color: 'text-green-700' },
                { title: '–¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä', value: followUp, icon: 'alert-triangle', color: 'text-red-500' },
            ];

            metrics.forEach(m => {
                summaryMetrics.innerHTML += `
                    <div class="p-3 bg-gray-50 rounded-lg border flex items-center shadow-sm">
                        <i data-lucide="${m.icon}" class="w-5 h-5 mr-3 ${m.color}"></i>
                        <div>
                            <p class="text-xs text-gray-500">${m.title}</p>
                            <p class="text-lg font-bold text-gray-800">${m.value}</p>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        let chartInstances = {};
        function renderCharts(data) {
            const loyaltyCtx = document.getElementById('loyaltyChart').getContext('2d');
            const actionCtx = document.getElementById('actionChart').getContext('2d');

            const loyaltyCounts = data.reduce((acc, d) => {
                acc[d.loyalty] = (acc[d.loyalty] || 0) + 1;
                return acc;
            }, {});

            const actionCounts = data.reduce((acc, d) => {
                acc[d.action] = (acc[d.action] || 0) + 1;
                return acc;
            }, {});

            // –õ–æ—è–ª—å–Ω–æ—Å—Ç—å
            renderBarChart(loyaltyCtx, loyaltyCounts, '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å', {
                loyal: '#10B981', not_loyal: '#EF4444', doubtful: '#F59E0B', not_opened: '#6B7280'
            });

            // –î–µ–π—Å—Ç–≤–∏—è
            renderBarChart(actionCtx, actionCounts, '–î–µ–π—Å—Ç–≤–∏—è', {
                canvassing: '#007aff', leafleting: '#3B82F6', meeting: '#A855F7', call: '#F97316', positive: '#14B8A6', negative: '#DC2626'
            });
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        function renderBarChart(ctx, dataCounts, label, colorMap) {
            if (ctx.chart) {
                ctx.chart.destroy();
            }

            const labels = Object.keys(dataCounts);
            const data = Object.values(dataCounts);
            const colors = labels.map(l => colorMap[l] || '#D1D5DB');

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: label }
                }
            };

            ctx.chart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', data: data, backgroundColor: colors, borderColor: '#ffffff', borderWidth: 1 }] }, options: chartOptions });
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function renderUserFilter(users) {
            const userFilter = document.getElementById('userFilter');
            const selectedValue = userFilter.value;
            userFilter.innerHTML = '<option value="all">–í—Å–µ –ê–≥–∏—Ç–∞—Ç–æ—Ä—ã</option>';

            users.sort().forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                if (user === selectedValue) {
                    option.selected = true;
                }
                userFilter.appendChild(option);
            });
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ XLSX
        window.exportToXLSX = () => {
            if (dataCache.length === 0) {
                window.showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –æ—Ç—á–µ—Ç—ã.');
                return;
            }
            const exportData = dataCache.map(doc => ({
                '–í—Ä–µ–º—è': new Date(doc.timestamp).toLocaleString(),
                'ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è': doc.user_id,
                '–ê–≥–∏—Ç–∞—Ç–æ—Ä (–§–ò–û)': doc.full_name || doc.username,
                '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç': doc.settlement,
                '–£–ª–∏—Ü–∞': doc.street,
                '–î–æ–º': doc.house,
                '–ö–≤–∞—Ä—Ç–∏—Ä–∞': doc.apartment,
                '–î–µ–π—Å—Ç–≤–∏–µ': doc.action,
                '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å': doc.loyalty,
                '–¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä': doc.requires_followup ? '–î–ê' : '–ù–ï–¢',
                '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': doc.comment,
                '–®–∏—Ä–æ—Ç–∞': doc.location ? doc.location.latitude : 'N/A',
                '–î–æ–ª–≥–æ—Ç–∞': doc.location ? doc.location.longitude : 'N/A',
                '–ê–¥—Ä–µ—Å –∏–∑ GPS': doc.location ? doc.location.address_from_gps : 'N/A',
            }));
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "–î–∞–Ω–Ω—ã–µ");
            XLSX.writeFile(workbook, "agitator_data_" + new Date().toISOString().slice(0, 10) + ".xlsx");
            window.showAlert('–≠–∫—Å–ø–æ—Ä—Ç', '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ agitator_data.xlsx');
        }

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        let sortDirection = {};
        window.sortTable = (n) => {
            const table = document.getElementById("latestDataTbl");
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            const isAsc = sortDirection[n] !== 'asc';
            sortDirection[n] = isAsc ? 'asc' : 'desc';

            rows.sort((a, b) => {
                let aText = a.cells[n].textContent.trim();
                let bText = b.cells[n].textContent.trim();

                if (n === 0) { // –í—Ä–µ–º—è
                    aText = new Date(a.cells[n].textContent).getTime();
                    bText = new Date(b.cells[n].textContent).getTime();
                }

                if (aText < bText) return isAsc ? -1 : 1;
                if (aText > bText) return isAsc ? 1 : -1;
                return 0;
            });

            rows.forEach(row => tbody.appendChild(row));
            window.showAlert('–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞', `–¢–∞–±–ª–∏—Ü–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ —Å—Ç–æ–ª–±—Ü—É ${n+1} –≤ ${isAsc ? '–≤–æ—Å—Ö–æ–¥—è—â–µ–º' : '–Ω–∏—Å—Ö–æ–¥—è—â–µ–º'} –ø–æ—Ä—è–¥–∫–µ.`);
        };

        // –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–ê–î–ú–ò–ù)
        window.deleteCollection = async () => {
            if (!isAdmin) {
                window.showAlert('–û—à–∏–±–∫–∞', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.');
                return;
            }

            const confirmation = confirm("–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–ø–∏—Å–∏ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ surveys? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.");
            if (!confirmation) return;

            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            const batchSize = 500;
            const collectionRef = collection(db, 'surveys');
            let deletedCount = 0;

            try {
                const batch = writeBatch(db);

                while (true) {
                    const q = query(collectionRef, limit(batchSize));
                    const snapshot = await getDocs(q);

                    if (snapshot.size === 0) break;

                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    deletedCount += snapshot.size;

                    if (snapshot.size < batchSize) break;
                }

                // –¢–∞–∫–∂–µ –æ—á–∏—Å—Ç–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
                offlineCache = [];
                localStorage.removeItem('offlineCache');
                dataCache = [];
                updateOfflineStatus();
                window.showAlert('–£—Å–ø–µ—à–Ω–æ!', `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} –∑–∞–ø–∏—Å–µ–π. –î–∞–Ω–Ω—ã–µ Firestore –æ—á–∏—â–µ–Ω—ã.`);

                if (isAdmin) fetchAndRenderReports();

                return true;

            } catch (e) {
                 console.error("Error deleting collection:", e);
                 window.showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + e.message);
                 return false;
            } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // üîë –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–û–∂–∏–¥–∞–µ–º authenticateUser) - –ò–°–ü–†–ê–í–õ–ï–ù–û
        window.onload = async () => {
            // 1. –°–Ω–∞—á–∞–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ isAdmin –∏ userTelegramId
            await authenticateUser();

            // 2. –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            populateSettlements();
            updateOfflineStatus();
            window.showSection('form');
            lucide.createIcons();

            // –û–¢–õ–ê–î–ö–ê: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
            document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';

            if (!firebaseConfig.projectId) {
                window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase –≤ –∫–æ–¥.');
            }
        };

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        window.authenticateUser = authenticateUser;
        window.fetchAndRenderReports = fetchAndRenderReports;
        window.renderLatestData = renderLatestData;
        window.generateMap = generateMap;
    </script>
</body>
</html>
