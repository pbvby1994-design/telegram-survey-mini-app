<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        /* üé® –£–ª—É—á—à–µ–Ω–Ω–∞—è –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ (Jost) */
        body {
            font-family: 'Jost', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #f2f2f7); /* TMA Theme BG */
            color: var(--tg-theme-text-color, #1c1c1e); /* TMA Theme Text */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-bottom: 80px; 
            transition: background-color 0.3s;
        }
        h1, h2, h3 {
             /* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –±–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π —Ü–≤–µ—Ç –∏ –ø–æ–ª—É–∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç */
            color: var(--tg-theme-text-color, #000000); 
            font-weight: 600; 
        }
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 16px; /* –ß—É—Ç—å –±–æ–ª–µ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08); /* –ë–æ–ª–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–Ω–∞—è —Ç–µ–Ω—å */
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-secondary-bg-color, #e5e5ea);
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        /* –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border-top: 1px solid var(--tg-theme-secondary-bg-color, #e5e5ea);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }
        .nav-item {
            color: var(--tg-theme-hint-color, #8e8e93);
            transition: color 0.2s;
        }
        .nav-item.active {
            color: var(--tg-theme-link-color, #007aff);
            font-weight: 500;
        }
        .nav-item:hover {
            color: var(--tg-theme-link-color, #007aff);
        }
        /* üí° –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π —Ñ–æ—Ä–º—ã */
        input[type="text"], textarea, select {
            background-color: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-secondary-bg-color, #d1d1d6);
            color: var(--tg-theme-text-color, #1c1c1e);
            border-radius: 10px; /* –ë–æ–ª–µ–µ –º—è–≥–∫–∏–µ —É–≥–ª—ã */
            padding: 12px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06); /* –ú—è–≥–∫–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ç–µ–Ω—å */
            transition: border-color 0.2s, background-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-link-color, #007aff);
        }
        /* üü¢ –¶–≤–µ—Ç–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è –õ–æ—è–ª—å–Ω–æ—Å—Ç–∏ */
        .loyalty-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        .loyalty-indicator.loyal { background-color: #10B981; /* Emerald Green */ }
        .loyalty-indicator.not_loyal { background-color: #EF4444; /* Red */ }
        .loyalty-indicator.doubtful { background-color: #F59E0B; /* Amber Yellow */ }
        .loyalty-indicator.not_opened { background-color: #6B7280; /* Gray */ }
        
        /* üöÄ –£–ª—É—á—à–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ */
        .btn-primary {
            background-color: var(--tg-theme-button-color, #007aff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-radius: 10px;
            padding: 12px 15px;
            font-weight: 600;
            transition: all 0.2s ease-in-out; 
            transform: translateZ(0); 
        }
        .btn-primary:active {
            transform: scale(0.98); 
            opacity: 0.9;
        }
        .btn-secondary {
            background-color: var(--tg-theme-secondary-bg-color, #e5e5ea);
            color: var(--tg-theme-text-color, #1c1c1e);
            border-radius: 10px;
            padding: 10px 15px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            transform: translateZ(0);
        }
        .btn-secondary:active {
            transform: scale(0.98);
        }
        /* Map container style */
        #map-container {
            width: 100%;
            height: 400px; 
            border-radius: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body class="p-4">

    <div class="nav-bar">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            <a href="#" onclick="showSection('form'); return false;" class="nav-item active flex flex-col items-center text-xs">
                <i data-lucide="clipboard-pen" class="w-5 h-5"></i>
                <span>–§–æ—Ä–º–∞</span>
            </a>
            <a href="#" onclick="showSection('reports'); return false;" class="nav-item flex flex-col items-center text-xs">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                <span>–û—Ç—á–µ—Ç—ã</span>
            </a>
            <a href="#" onclick="showSection('admin'); return false;" class="nav-item flex flex-col items-center text-xs">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span>–ê–¥–º–∏–Ω</span>
            </a>
        </div>
    </div>

    <main class="max-w-lg mx-auto">
        <section id="form" class="section">
            <h1 class="text-2xl font-bold mb-4">–í–≤–æ–¥ –î–∞–Ω–Ω—ã—Ö</h1>
            <div class="card p-4">
                <form id="surveyForm" onsubmit="saveSurveyData(event)">
                    
                    <div class="mb-4">
                        <label for="settlement" class="block text-sm font-medium mb-1">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</label>
                        <select id="settlement" required class="w-full">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                            </select>
                    </div>
                    
                    <div class="mb-4">
                        <label for="street" class="block text-sm font-medium mb-1">–£–ª–∏—Ü–∞</label>
                        <input type="text" id="street" required class="w-full">
                    </div>
                    <div class="mb-4 flex space-x-2">
                        <div class="flex-1">
                            <label for="house" class="block text-sm font-medium mb-1">–î–æ–º</label>
                            <input type="text" id="house" required class="w-full" placeholder="–ù–æ–º–µ—Ä –¥–æ–º–∞">
                        </div>
                         <div class="flex-1">
                            <label for="apartment" class="block text-sm font-medium mb-1">–ö–≤–∞—Ä—Ç–∏—Ä–∞ (–æ–ø—Ü.)</label>
                            <input type="text" id="apartment" class="w-full" placeholder="–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="action" class="block text-sm font-medium mb-1">–î–µ–π—Å—Ç–≤–∏–µ</label>
                        <select id="action" required class="w-full">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                            <option value="positive">–ü–æ–∑–∏—Ç–∏–≤–Ω–æ–µ</option>
                            <option value="negative">–ù–µ–≥–∞—Ç–∏–≤–Ω–æ–µ</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label for="loyalty" class="block text-sm font-medium mb-1">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</label>
                        <select id="loyalty" required class="w-full">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                            <option value="loyal" class="text-green-600">–õ–æ—è–ª—å–Ω—ã–π</option>
                            <option value="not_loyal" class="text-red-600">–ù–µ –ª–æ—è–ª—å–Ω—ã–π</option>
                            <option value="doubtful" class="text-yellow-600">–°–æ–º–Ω–µ–≤–∞—é—â–∏–π—Å—è</option>
                            <option value="not_opened" class="text-gray-600">–ù–µ –æ—Ç–∫—Ä—ã–ª–∏</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label for="comment" class="block text-sm font-medium mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea id="comment" class="w-full" rows="3"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</label>
                        <div id="locationStatus" class="text-sm italic text-gray-500 mb-2">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                        <button type="button" onclick="getLocation()" class="btn-secondary text-sm flex items-center justify-center">
                            <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i>
                            <span>–ü–æ–ª—É—á–∏—Ç—å GPS</span>
                        </button>
                    </div>

                    <button type="submit" class="btn-primary w-full mt-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ó–∞–ø–∏—Å—å</button>
                </form>
            </div>
        </section>

        <section id="reports" class="section hidden">
            <h1 class="text-2xl font-bold mb-4">–û—Ç—á–µ—Ç—ã</h1>
            
            <div id="admin-reports-content">
                
                <div class="card p-4 mb-4">
                    <h2 class="text-md font-semibold mb-3">–§–∏–ª—å—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–µ—Ä–∏–æ–¥—É</h2>
                    <select id="dateRangeFilter" onchange="fetchAndRenderReports()" class="w-full mb-3 text-sm p-2 border border-gray-300 rounded-md">
                        <option value="30d" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                        <option value="7d">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                        <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                        <option value="all">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</option>
                    </select>
                    <div class="text-xs text-gray-500" id="filterStatus">–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π.</div>
                </div>

                <div class="flex space-x-2 mb-4">
                    <button onclick="exportToXLSX()" class="btn-primary flex-1 flex items-center justify-center text-sm">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-1"></i>
                        <span>–≠–∫—Å–ø–æ—Ä—Ç XLSX</span>
                    </button>
                    <button onclick="fetchAndRenderReports()" class="btn-secondary flex-1 flex items-center justify-center text-sm">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-1"></i>
                        <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                    </button>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–°–≤–æ–¥–∫–∞</h2>
                    <div id="summary-metrics" class="grid grid-cols-2 gap-3">
                        </div>
                </div>
                
                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</h2>
                    <canvas id="loyaltyChart"></canvas>
                </div>
                
                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–î–µ–π—Å—Ç–≤–∏—è</h2>
                    <canvas id="actionChart"></canvas>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–ö–∞—Ä—Ç–∞ –ì–µ–æ–ª–æ–∫–∞—Ü–∏–π</h2>
                    <div id="map-container"></div>
                </div>
                
                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h2>
                    <div class="overflow-x-auto">
                        <table id="latestDataTbl" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <th class="px-2 py-2">–í—Ä–µ–º—è</th>
                                    <th class="px-2 py-2">–ê–¥—Ä–µ—Å</th>
                                    <th class="px-2 py-2">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</th>
                                    <th class="px-2 py-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                </tr>
                            </thead>
                            <tbody id="latestDataBody" class="divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>

            </div>
            
            <div id="no-reports-data" class="card p-8 text-center hidden">
                <i data-lucide="frown" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                <h3 class="text-lg font-semibold text-gray-700">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</h3>
                <p class="text-sm text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –±—ã–ª–∏ –ª–∏ –≤–≤–µ–¥–µ–Ω—ã –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏.</p>
            </div>
            
            <div id="admin-reports-login" class="card p-4 text-center hidden">
                <p class="mb-4">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç—á–µ—Ç–æ–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (Telegram ID –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç).</p>
            </div>
        </section>

        <section id="admin" class="section hidden">
            <h1 class="text-2xl font-bold mb-4">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
            
            <div id="admin-panel-content">
                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2 text-red-600">–û–ø–∞—Å–Ω–∞—è –ó–æ–Ω–∞</h2>
                    <p class="text-sm mb-4">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ (–∑–∞–ø–∏—Å–∏) –∏–∑ –±–∞–∑—ã Firestore.</p>
                    <button onclick="confirmAndDeleteData()" class="btn-secondary w-full bg-red-100 text-red-600 border border-red-400">
                        <i data-lucide="trash-2" class="w-4 h-4 mr-1 inline-block align-middle"></i>
                        –£–¥–∞–ª–∏—Ç—å –í—Å–µ –î–∞–Ω–Ω—ã–µ
                    </button>
                </div>
            </div>

            <div id="admin-panel-login" class="card p-4 text-center hidden">
                <p class="mb-4">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (Telegram ID –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç).</p>
            </div>
        </section>

    </main>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sheetjs@0.19.0/dist/xlsx.full.min.js"></script>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const firebaseConfig = {
            // !!! –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–ò –ö–õ–Æ–ß–ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò FIREBASE !!!
            // –ü—Ä–∏–º–µ—Ä:
            // apiKey: "AIzaSy...",
            // authDomain: "your-project.firebaseapp.com",
            // projectId: "your-project-id",
            // storageBucket: "your-project.appspot.com",
            // messagingSenderId: "...",
            // appId: "..."
        };
        
        // üîë –í–ê–ñ–ù–û: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ Telegram ID –¥–ª—è —ç—Ç–∞–ø–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        const ADMIN_TELEGRAM_ID = 541459471; // –í–∞—à Telegram user_id

        // –°–ø–∏—Å–æ–∫ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤
        const SETTLEMENTS = [
            '–≥.–ø. –ë–∞—Ä—Å–æ–≤–æ',
            '—Å.–ø. –°–æ–ª–Ω–µ—á–Ω—ã–π',
            '—Å.–ø. –¢—É–Ω–¥—Ä–∏–Ω–æ',
            '—Å.–ø. –õ—è–º–∏–Ω–∞',
            '–≥.–ø. –õ—è–Ω—Ç–æ—Ä',
            '–≥.–ø. –§–µ–¥–æ—Ä–æ–≤—Å–∫–∏–π',
            '–≥.–ø. –ë–µ–ª—ã–π –Ø—Ä',
            '—Å.–ø. –£–ª—å—Ç-–Ø–≥—É–Ω',
            '—Å.–ø. –°—ã—Ç–æ–º–∏–Ω–æ',
            '—Å.–ø. –†—É—Å—Å–∫–∏–Ω—Å–∫–∞—è',
            '—Å.–ø. –ù–∏–∂–Ω–µ—Å–æ—Ä—Ç—ã–º—Å–∫–∏–π',
            '—Å.–ø. –£–≥—É—Ç',
            '—Å.–ø. –õ–æ–∫–æ—Å–æ–≤–æ'
        ];

        const isTMA = window.Telegram && window.Telegram.WebApp;
        let userTelegramId = isTMA ? Telegram.WebApp.initDataUnsafe.user.id : null;
        let isAdmin = userTelegramId === ADMIN_TELEGRAM_ID;
        let userLocation = null;

        let db = null;
        let surveysCollection = null;

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ---
        if (firebaseConfig.projectId) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            surveysCollection = db.collection('surveys');
            
            // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥ –¥–ª—è —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏—è Firebase Security Rules (allow read, write: if request.auth != null)
            firebase.auth().signInAnonymously()
                .then(() => {
                    console.log("Firebase Authenticated (Anonymous).");
                })
                .catch(error => {
                    console.error("Auth error:", error);
                });
        } else {
            console.error("Firebase config is missing. Data saving will not work.");
        }


        // --- –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò –ò –£–¢–ò–õ–ò–¢–´ ---
        function showAlert(title, message) {
            if (isTMA) {
                Telegram.WebApp.showAlert(`${title}: ${message}`);
            } else {
                alert(`${title}: ${message}`);
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`a[onclick*="${sectionId}"]`).classList.add('active');

            // üÜï –õ–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∞–¥–º–∏–Ω-–∫–æ–Ω—Ç–µ–Ω—Ç–∞
            if (sectionId === 'reports' || sectionId === 'admin') {
                const content = document.getElementById(`admin-${sectionId}-content`);
                const login = document.getElementById(`admin-${sectionId}-login`);
                
                if (isAdmin) {
                    login.classList.add('hidden');
                    content.style.display = 'block'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º style.display –¥–ª—è Chart.js
                    if (sectionId === 'reports') {
                        // –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –û—Ç—á–µ—Ç—ã - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                        fetchAndRenderReports(); 
                    }
                } else {
                    login.classList.remove('hidden');
                    content.style.display = 'none';
                    if (sectionId === 'reports') {
                        // –°–∫—Ä—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                        document.getElementById('no-reports-data').classList.add('hidden'); 
                    }
                }
            }
            
            lucide.createIcons();
            if (isTMA) Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }

        // --- –§–£–ù–ö–¶–ò–ò –§–û–†–ú–´ –ò –°–û–•–†–ê–ù–ï–ù–ò–Ø ---
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤
        function populateSettlements() {
            const selectElement = document.getElementById('settlement');
            selectElement.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>'; 
            SETTLEMENTS.forEach(settlement => {
                const option = document.createElement('option');
                option.value = settlement;
                option.textContent = settlement;
                selectElement.appendChild(option);
            });
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        window.getLocation = () => {
            const statusElement = document.getElementById('locationStatus');
            statusElement.textContent = '–ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...';
            userLocation = null; 

            if (!navigator.geolocation) {
                statusElement.textContent = '–û—à–∏–±–∫–∞: –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = new firebase.firestore.GeoPoint(
                        position.coords.latitude,
                        position.coords.longitude
                    );
                    statusElement.textContent = `–£—Å–ø–µ—à–Ω–æ: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;
                    if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                },
                (error) => {
                    console.error("Geolocation Error:", error);
                    let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ GPS.';
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage = '–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞/Telegram.';
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        errorMessage = '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
                    }
                    statusElement.textContent = `–û—à–∏–±–∫–∞: ${errorMessage}`;
                    showAlert('–û—à–∏–±–∫–∞ GPS', errorMessage);
                    if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        };
        
        window.saveSurveyData = async (e) => {
            e.preventDefault();
            if (!firebaseConfig.projectId || !surveysCollection) {
                showAlert('–û—à–∏–±–∫–∞', '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.');
                return;
            }

            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            try {
                const data = {
                    settlement: document.getElementById('settlement').value,
                    street: document.getElementById('street').value,
                    house: document.getElementById('house').value,
                    apartment: document.getElementById('apartment').value || '',
                    action: document.getElementById('action').value,
                    loyalty: document.getElementById('loyalty').value,
                    comment: document.getElementById('comment').value || '',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    user_id: userTelegramId, 
                    username: isTMA ? (Telegram.WebApp.initDataUnsafe.user.username || 'n/a') : 'web-test',
                    location: userLocation, 
                };

                await surveysCollection.add(data);
                
                // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                document.getElementById('surveyForm').reset();
                document.getElementById('locationStatus').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
                userLocation = null;
                populateSettlements(); 
                
                showAlert('–£—Å–ø–µ—à–Ω–æ!', '–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');

            } catch (error) {
                console.error("Error adding document: ", error);
                showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        };


        // --- –§–£–ù–ö–¶–ò–ò –û–¢–ß–ï–¢–û–í ---
        let mapInstance = null; 
        let dataCache = []; 

        function generateMap(data) {
            // ... (–ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ generateMap)
            const container = document.getElementById('map-container');
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
            container.innerHTML = '';

            const locations = data
                .filter(doc => doc.location && doc.location.latitude && doc.location.longitude)
                .map(doc => ({
                    lat: doc.location.latitude,
                    lon: doc.location.longitude,
                    loyalty: doc.loyalty
                }));

            if (locations.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ.</div>';
                return;
            }

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—Ä—Ç—ã
            const avgLat = locations.reduce((sum, p) => sum + p.lat, 0) / locations.length;
            const avgLon = locations.reduce((sum, p) => sum + p.lon, 0) / locations.length;

            mapInstance = L.map(container).setView([avgLat, avgLon], 10); 

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);

            locations.forEach(point => {
                let color = '#34D399'; 
                if (point.loyalty === 'not_loyal') {
                    color = '#F87171'; 
                } else if (point.loyalty === 'doubtful') {
                    color = '#FBBF24'; 
                }

                // –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∫—Ä—É–≥–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                const iconHtml = `<div style="background-color: ${color}; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.4);"></div>`;
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: iconHtml,
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });

                L.marker([point.lat, point.lon], { icon: customIcon })
                    .addTo(mapInstance)
                    .bindPopup(`–õ–æ—è–ª—å–Ω–æ—Å—Ç—å: ${point.loyalty}`);
            });
            
            mapInstance.invalidateSize();
        }

        function exportToXLSX() {
            if (dataCache.length === 0) {
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –æ—Ç—á–µ—Ç—ã.');
                return;
            }

            const exportData = dataCache.map(doc => ({
                '–í—Ä–µ–º—è': doc.timestamp ? new Date(doc.timestamp).toLocaleString() : 'N/A',
                'ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è': doc.user_id,
                'Username': doc.username,
                '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç': doc.settlement,
                '–£–ª–∏—Ü–∞': doc.street,
                '–î–æ–º': doc.house,
                '–ö–≤–∞—Ä—Ç–∏—Ä–∞': doc.apartment,
                '–î–µ–π—Å—Ç–≤–∏–µ': doc.action,
                '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å': doc.loyalty,
                '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': doc.comment,
                '–®–∏—Ä–æ—Ç–∞': doc.location ? doc.location.latitude : 'N/A',
                '–î–æ–ª–≥–æ—Ç–∞': doc.location ? doc.location.longitude : 'N/A',
            }));

            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "–î–∞–Ω–Ω—ã–µ");
            XLSX.writeFile(workbook, "agitator_data_" + new Date().toISOString().slice(0, 10) + ".xlsx");

            showAlert('–£—Å–ø–µ—à–Ω–æ', `–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${exportData.length} –∑–∞–ø–∏—Å–µ–π –≤ XLSX.`);
            if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        let loyaltyChart = null;
        let actionChart = null;

        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π
        function renderLatestData(data) {
            const tbody = document.getElementById('latestDataBody');
            tbody.innerHTML = ''; 
            
            // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–∞–ø–∏—Å–µ–π
            const latestData = data.slice(0, 20);

            latestData.forEach(doc => {
                const row = tbody.insertRow();
                row.className = "bg-white dark:bg-gray-800 hover:bg-gray-50";

                const timeStr = doc.timestamp ? new Date(doc.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : 'N/A';
                const address = `${doc.settlement || ''}, ${doc.street || ''}, ${doc.house || ''}`;

                let loyaltyText = doc.loyalty || 'N/A';
                let loyaltyColor = 'text-gray-500';
                if (doc.loyalty === 'loyal') loyaltyColor = 'text-green-600 font-medium';
                else if (doc.loyalty === 'not_loyal') loyaltyColor = 'text-red-600 font-medium';
                else if (doc.loyalty === 'doubtful') loyaltyColor = 'text-yellow-600';

                // –Ø—á–µ–π–∫–∞ "–í—Ä–µ–º—è"
                let cell = row.insertCell();
                cell.className = "px-2 py-2 whitespace-nowrap text-xs";
                cell.textContent = timeStr;

                // –Ø—á–µ–π–∫–∞ "–ê–¥—Ä–µ—Å"
                cell = row.insertCell();
                cell.className = "px-2 py-2 whitespace-nowrap text-xs truncate max-w-xs";
                cell.textContent = address;

                // –Ø—á–µ–π–∫–∞ "–õ–æ—è–ª—å–Ω–æ—Å—Ç—å"
                cell = row.insertCell();
                cell.className = `px-2 py-2 whitespace-nowrap text-xs ${loyaltyColor}`;
                cell.textContent = loyaltyText;
                
                // –Ø—á–µ–π–∫–∞ "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
                cell = row.insertCell();
                cell.className = "px-2 py-2 text-xs text-gray-500 truncate max-w-sm";
                cell.textContent = doc.comment.length > 50 ? doc.comment.substring(0, 50) + '...' : doc.comment;
            });
        }


        // ‚ùå –ò–ó–ú–ï–ù–ï–ù–û: –õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ –∏–Ω–¥–µ–∫—Å–µ.
        window.fetchAndRenderReports = async () => {
            if (!isAdmin) {
                // –≠—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏, —Ç–∞–∫ –∫–∞–∫ showSection —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                return; 
            }
            if (!firebaseConfig.projectId || !surveysCollection) return showAlert('–û—à–∏–±–∫–∞', '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.');
            
            if (isTMA) Telegram.WebApp.MainButton.showLoader();
            
            const contentDiv = document.getElementById('admin-reports-content');
            const noDataElement = document.getElementById('no-reports-data');
            
            // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç—á–µ—Ç–æ–≤, –ø–æ–∫–∞ –≥—Ä—É–∑–∏–º
            contentDiv.style.display = 'none';

            try {
                const filterValue = document.getElementById('dateRangeFilter').value;
                const filterStatus = document.getElementById('filterStatus');
                
                let startDate = null;
                const now = new Date();
                
                // 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                if (filterValue === '30d') {
                    startDate = new Date(now.setDate(now.getDate() - 30)).getTime();
                    filterStatus.textContent = '–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π.';
                } else if (filterValue === '7d') {
                    startDate = new Date(now.setDate(now.getDate() - 7)).getTime();
                    filterStatus.textContent = '–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π.';
                } else if (filterValue === 'today') {
                    startDate = new Date(now.setHours(0, 0, 0, 0)).getTime(); // –ù–∞—á–∞–ª–æ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
                    filterStatus.textContent = '–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.';
                } else {
                    filterStatus.textContent = '–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.';
                }

                // 2. –ó–∞–ø—Ä–æ—Å Firestore: –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏.
                // !!! –ò–ó–ë–ï–ì–ê–ï–ú –§–ò–õ–¨–¢–†–ê–¶–ò–ò –ù–ê –°–ï–†–í–ï–†–ï !!!
                const snapshot = await surveysCollection.orderBy('timestamp', 'desc').get();
                
                const rawDataUnfiltered = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Firebase Timestamp –≤ JS Timestamp (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã)
                    const timestampMs = data.timestamp ? data.timestamp.toDate().getTime() : 0;
                    return { ...data, timestamp: timestampMs };
                });
                
                // 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (JS)
                const rawData = rawDataUnfiltered.filter(doc => {
                    if (filterValue === 'all') return true;
                    return doc.timestamp >= startDate;
                });
                
                dataCache = rawData; 
                const totalCount = rawData.length;

                // 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (totalCount === 0) {
                    contentDiv.style.display = 'none';
                    noDataElement.classList.remove('hidden');
                    if (isTMA) Telegram.WebApp.MainButton.hideLoader();
                    return; 
                } else {
                    noDataElement.classList.add('hidden');
                    contentDiv.style.display = 'block';
                }

                // 5. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∏ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
                const loyaltyCounts = {};
                const actionCounts = {};

                rawData.forEach(doc => {
                    loyaltyCounts[doc.loyalty] = (loyaltyCounts[doc.loyalty] || 0) + 1;
                    actionCounts[doc.action] = (actionCounts[doc.action] || 0) + 1;
                });
                
                // üöÄ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–≤–æ–¥–∫–∏ (—Å –∏–∫–æ–Ω–∫–∞–º–∏)
                const summaryHtml = `
                    <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg text-center border-l-4 border-gray-400">
                        <i data-lucide="hash" class="w-5 h-5 mx-auto mb-1 text-gray-500"></i>
                        <div class="text-sm text-gray-600">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div> 
                        <span class="text-xl font-extrabold text-gray-900">${totalCount}</span>
                    </div>
                    <div class="p-3 bg-green-100 dark:bg-green-700 rounded-lg text-center border-l-4 border-green-500">
                        <i data-lucide="check-circle" class="w-5 h-5 mx-auto mb-1 text-green-700"></i>
                        <div class="text-sm text-green-800">–õ–æ—è–ª—å–Ω—ã—Ö</div>
                        <span class="text-xl font-extrabold text-green-900">${loyaltyCounts['loyal'] || 0}</span>
                    </div>
                    <div class="p-3 bg-red-100 dark:bg-red-700 rounded-lg text-center border-l-4 border-red-500">
                        <i data-lucide="x-circle" class="w-5 h-5 mx-auto mb-1 text-red-700"></i>
                        <div class="text-sm text-red-800">–ù–µ –ª–æ—è–ª—å–Ω—ã—Ö</div>
                        <span class="text-xl font-extrabold text-red-900">${loyaltyCounts['not_loyal'] || 0}</span>
                    </div>
                    <div class="p-3 bg-yellow-100 dark:bg-yellow-700 rounded-lg text-center border-l-4 border-yellow-500">
                        <i data-lucide="help-circle" class="w-5 h-5 mx-auto mb-1 text-yellow-700"></i>
                        <div class="text-sm text-yellow-800">–°–æ–º–Ω–µ–≤–∞—é—â–∏—Ö—Å—è</div>
                        <span class="text-xl font-extrabold text-yellow-900">${loyaltyCounts['doubtful'] || 0}</span>
                    </div>
                `;
                document.getElementById('summary-metrics').innerHTML = summaryHtml;
                lucide.createIcons(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫–∏

                const loyaltyLabels = ['–õ–æ—è–ª—å–Ω—ã–π', '–ù–µ –ª–æ—è–ª—å–Ω—ã–π', '–°–æ–º–Ω–µ–≤–∞—é—â–∏–π—Å—è', '–ù–µ –æ—Ç–∫—Ä—ã–ª–∏'];
                const loyaltyData = [
                    loyaltyCounts['loyal'] || 0,
                    loyaltyCounts['not_loyal'] || 0,
                    loyaltyCounts['doubtful'] || 0,
                    loyaltyCounts['not_opened'] || 0,
                ];
                loyaltyChart = renderChart('loyaltyChart', 'doughnut', loyaltyLabels, loyaltyData, ['#10B981', '#EF4444', '#F59E0B', '#6B7280'], loyaltyChart);
                
                const actionLabels = ['–ü–æ–∑–∏—Ç–∏–≤–Ω–æ–µ', '–ù–µ–≥–∞—Ç–∏–≤–Ω–æ–µ'];
                const actionData = [
                    actionCounts['positive'] || 0,
                    actionCounts['negative'] || 0,
                ];
                actionChart = renderChart('actionChart', 'bar', actionLabels, actionData, ['#007aff', '#ff3b30'], actionChart);
                
                generateMap(rawData);
                
                renderLatestData(rawData); 

            } catch (e) {
                console.error("Error fetching reports:", e);
                showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–æ–≤: ' + e.message);
                noDataElement.classList.remove('hidden');
                contentDiv.style.display = 'none';
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        };

        function renderChart(canvasId, type, labels, data, colors, chartInstance) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            const chartOptions = {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: getComputedStyle(document.body).getPropertyValue('--tg-theme-text-color') || '#1c1c1e',
                            font: {
                                size: 12,
                                family: 'Jost' 
                            }
                        }
                    }
                },
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å—Ç–æ–ª–±—á–∞—Ç–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã (Bar)
                scales: type === 'bar' ? {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--tg-theme-hint-color') || '#8e8e93',
                            callback: function(value) { if (value % 1 === 0) { return value; } }
                        },
                        grid: {
                            color: getComputedStyle(document.body).getPropertyValue('--tg-theme-secondary-bg-color') || '#e5e5ea',
                        }
                    },
                    x: {
                        ticks: {
                            color: getComputedStyle(document.body).getPropertyValue('--tg-theme-hint-color') || '#8e8e93',
                        },
                        grid: {
                            color: 'rgba(0,0,0,0)', 
                        }
                    }
                } : {}
            };

            return new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                        data: data,
                        backgroundColor: colors,
                        borderColor: getComputedStyle(document.body).getPropertyValue('--tg-theme-secondary-bg-color') || '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });
        }

        // --- –ê–î–ú–ò–ù –§–£–ù–ö–¶–ò–ò ---

        window.confirmAndDeleteData = () => {
            if (!isAdmin) {
                showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
                return;
            }
            if (!firebaseConfig.projectId || !surveysCollection) return showAlert('–û—à–∏–±–∫–∞', '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.');

            if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ (–∑–∞–ø–∏—Å–∏) –∏–∑ –±–∞–∑—ã Firestore.")) {
                deleteCollection();
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è)
        async function deleteCollection() {
            if (isTMA) Telegram.WebApp.MainButton.showLoader();

            try {
                const batchSize = 50;
                let deletedCount = 0;
                let query = surveysCollection.limit(batchSize);

                while (true) {
                    const snapshot = await query.get();
                    if (snapshot.size === 0) break;

                    const batch = db.batch();
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    deletedCount += snapshot.size;

                    if (snapshot.size < batchSize) break;
                }

                showAlert('–£—Å–ø–µ—à–Ω–æ!', `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} –∑–∞–ø–∏—Å–µ–π. –î–∞–Ω–Ω—ã–µ Firestore –æ—á–∏—â–µ–Ω—ã.`);
                
                if (isAdmin) fetchAndRenderReports(); 
                
                return true;
                
            } catch (e) {
                 console.error("Error deleting collection:", e);
                 showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + e.message);
                 return false;
            } finally {
                 if (isTMA) Telegram.WebApp.MainButton.hideLoader();
            }
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            populateSettlements(); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–µ–ª–µ–Ω–∏–π
            showSection('form');
            lucide.createIcons();
            
            if (!firebaseConfig.projectId) {
                showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase –≤ –∫–æ–¥.');
            }
        };
    </script>
</body>
</html>
