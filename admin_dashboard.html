<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | v2.5 (–§–∏–∫—Å Firebase –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <!-- üí° –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ï –ò–ú–ü–û–†–¢–´ FIREBASE (v9 COMPAT) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<style>
    /* ... (CSS –∫–æ–¥ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω) ... */
    :root { font-family: 'Jost', sans-serif; }
    .nav-button-active { background-color: #f7fafc; color: #3b82f6; }
    .nav-button:hover:not(.nav-button-active) { background-color: #f3f4f6; }
    .loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.8); z-index: 1000;
        display: none; align-items: center; justify-content: center;
        flex-direction: column;
    }
    #map { height: 60vh; width: 100%; }
</style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="loadingOverlay" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-blue-600 font-semibold">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>

    <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="modalTitle" class="text-xl font-bold mb-3 text-gray-800">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
            <p id="modalMessage" class="text-gray-600 mb-6">–°–æ–æ–±—â–µ–Ω–∏–µ</p>
            <div class="flex justify-end space-x-3">
                <button onclick="document.getElementById('modalOverlay').classList.add('hidden');" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button id="modalConfirmBtn" onclick="modalConfirmHandler()" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition hidden">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                <i data-lucide="compass" class="h-6 w-6 mr-3 text-blue-600"></i>
                –ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞
                <span id="offlineBadge" class="ml-3 text-xs font-medium text-red-700 bg-red-100 px-2.5 py-0.5 rounded-full hidden">
                    –û–§–§–õ–ê–ô–ù –ö–≠–®
                </span>
            </h1>
            <nav class="flex space-x-2">
                <button id="navForm" onclick="showSection('form', this)" class="nav-button nav-button-active flex items-center px-4 py-2 text-gray-600 rounded-lg transition">
                    <i data-lucide="clipboard-list" class="h-5 w-5 mr-2"></i> –§–æ—Ä–º–∞
                </button>
                <button id="navReports" onclick="showSection('reports', this); if(isAdmin) fetchAndRenderReports(); else showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –æ—Ç—á–µ—Ç–∞–º.');" class="nav-button flex items-center px-4 py-2 text-gray-600 rounded-lg transition" disabled>
                    <i data-lucide="bar-chart-3" class="h-5 w-5 mr-2"></i> –û—Ç—á–µ—Ç—ã
                </button>
                <button id="navMap" onclick="showSection('map', this); generateMap(dataCache);" class="nav-button flex items-center px-4 py-2 text-gray-600 rounded-lg transition" disabled>
                    <i data-lucide="map" class="h-5 w-5 mr-2"></i> –ö–∞—Ä—Ç–∞
                </button>
                <button id="navAdmin" onclick="showSection('admin', this)" class="nav-button flex items-center px-4 py-2 text-gray-600 rounded-lg transition hidden">
                    <i data-lucide="shield" class="h-5 w-5 mr-2"></i> –ê–¥–º–∏–Ω
                </button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- –°–µ–∫—Ü–∏—è –§–æ—Ä–º—ã -->
        <section id="form" class="space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</h2>
                <form id="reportForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- –ü–æ—Å–µ–ª–µ–Ω–∏–µ -->
                    <div>
                        <label for="settlement" class="block text-sm font-medium text-gray-700">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</label>
                        <select id="settlement" name="settlement" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JavaScript -->
                        </select>
                    </div>

                    <!-- –£–ª–∏—Ü–∞ -->
                    <div>
                        <label for="street" class="block text-sm font-medium text-gray-700">–£–ª–∏—Ü–∞</label>
                        <input type="text" id="street" name="street" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- –î–æ–º -->
                    <div>
                        <label for="house" class="block text-sm font-medium text-gray-700">–î–æ–º / –ù–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞</label>
                        <input type="text" id="house" name="house" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- –ö–≤–∞—Ä—Ç–∏—Ä–∞ -->
                    <div>
                        <label for="apartment" class="block text-sm font-medium text-gray-700">–ö–≤–∞—Ä—Ç–∏—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input type="text" id="apartment" name="apartment" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- –î–µ–π—Å—Ç–≤–∏–µ -->
                    <div>
                        <label for="action" class="block text-sm font-medium text-gray-700">–î–µ–π—Å—Ç–≤–∏–µ</label>
                        <select id="action" name="action" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                            <option value="–í—Å—Ç—Ä–µ—á–∞">–í—Å—Ç—Ä–µ—á–∞ (–ø—Ä–æ–≤–µ–ª–∏ –∞–≥–∏—Ç–∞—Ü–∏—é)</option>
                            <option value="–ù–µ –æ—Ç–∫—Ä—ã–ª–∏">–ù–µ –æ—Ç–∫—Ä—ã–ª–∏</option>
                            <option value="–û—Ç–∫–∞–∑–∞–ª–∏—Å—å">–û—Ç–∫–∞–∑–∞–ª–∏—Å—å (–æ—Ç –∞–≥–∏—Ç–∞—Ü–∏–∏)</option>
                            <option value="–ù–µ –ø—Ä–æ–∂–∏–≤–∞–µ—Ç">–ù–µ –ø—Ä–æ–∂–∏–≤–∞–µ—Ç</option>
                            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>

                    <!-- –õ–æ—è–ª—å–Ω–æ—Å—Ç—å -->
                    <div>
                        <label for="loyalty" class="block text-sm font-medium text-gray-700">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</label>
                        <select id="loyalty" name="loyalty" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                            <option value="–õ–æ—è–ª–µ–Ω">–õ–æ—è–ª–µ–Ω</option>
                            <option value="–ù–µ–π—Ç—Ä–∞–ª–µ–Ω">–ù–µ–π—Ç—Ä–∞–ª–µ–Ω</option>
                            <option value="–ù–µ–ª–æ—è–ª–µ–Ω">–ù–µ–ª–æ—è–ª–µ–Ω</option>
                            <option value="–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ">–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (–µ—Å–ª–∏ –Ω–µ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏)</option>
                        </select>
                    </div>

                    <!-- –¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä -->
                    <div class="flex items-center space-x-2 md:col-span-2">
                        <input type="checkbox" id="requiresFollowup" name="requiresFollowup" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="requiresFollowup" class="text-sm font-medium text-gray-700">–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–∏–∑–∏—Ç / –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
                    </div>

                    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                    <div class="md:col-span-2">
                        <label for="comment" class="block text-sm font-medium text-gray-700">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏)</label>
                        <textarea id="comment" name="comment" rows="3" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è -->
                    <div class="md:col-span-2 flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                         <div id="locationStatus" class="text-sm text-gray-600">
                            <i data-lucide="map-pin" class="h-4 w-4 inline mr-1 text-gray-500"></i>
                            –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: <span id="latDisplay">N/A</span>, <span id="lngDisplay">N/A</span>
                         </div>
                         <button type="button" onclick="getCurrentLocation()" class="flex items-center px-4 py-2 bg-yellow-500 text-white font-medium rounded-lg hover:bg-yellow-600 transition shadow-md">
                            <i data-lucide="locate-fixed" class="h-5 w-5 mr-2"></i>
                            –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å GPS
                        </button>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –û—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-lg font-medium rounded-lg shadow-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition transform hover:scale-[1.01]">
                            <i data-lucide="send" class="h-5 w-5 mr-3"></i>
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û—Ç—á–µ—Ç
                        </button>
                    </div>
                </form>
            </div>
            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç—á–µ—Ç—ã -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex justify-between items-center">
                    –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –æ—Ç—á–µ—Ç–æ–≤
                    <button onclick="renderLatestData(true)" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center">
                        <i data-lucide="rotate-cw" class="h-4 w-4 mr-1"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </h2>
                <div id="latestDataContainer" class="space-y-3">
                    <p class="text-gray-500">–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –≤–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç—á–µ—Ç—ã.</p>
                </div>
            </div>
        </section>

        <!-- –°–µ–∫—Ü–∏—è –û—Ç—á–µ—Ç–æ–≤ -->
        <section id="reports" class="space-y-8 hidden">
             <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-blue-500">
                    <p class="text-sm font-medium text-gray-500">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p>
                    <p id="statTotal" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-green-500">
                    <p class="text-sm font-medium text-gray-500">–õ–æ—è–ª–µ–Ω</p>
                    <p id="statLoyal" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-red-500">
                    <p class="text-sm font-medium text-gray-500">–ù–µ–ª–æ—è–ª–µ–Ω</p>
                    <p id="statDisloyal" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º</h3>
                    <canvas id="loyaltyChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4">–î–µ–π—Å—Ç–≤–∏—è –ø–æ –ø–æ—Å–µ–ª–µ–Ω–∏—è–º</h3>
                    <canvas id="settlementChart"></canvas>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex justify-between items-center">
                    –ü–æ–ª–Ω—ã–π –û—Ç—á–µ—Ç
                    <div class="flex space-x-3">
                        <button onclick="fetchAndRenderReports()" class="flex items-center px-3 py-2 bg-blue-100 text-blue-700 font-medium rounded-lg hover:bg-blue-200 transition text-sm shadow-sm">
                            <i data-lucide="refresh-ccw" class="h-4 w-4 mr-2"></i> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                        <button onclick="exportToXLSX()" class="flex items-center px-3 py-2 bg-green-500 text-white font-medium rounded-lg hover:bg-green-600 transition text-sm shadow-sm">
                            <i data-lucide="download" class="h-4 w-4 mr-2"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ XLSX
                        </button>
                    </div>
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–í—Ä–µ–º—è</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–§–ò–û</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ê–¥—Ä–µ—Å</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü–æ–≤—Ç–æ—Ä</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- –°–µ–∫—Ü–∏—è –ö–∞—Ä—Ç—ã -->
        <section id="map" class="space-y-6 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">–¢–µ–ø–ª–æ–≤–∞—è –ö–∞—Ä—Ç–∞ –∏ –ö–ª–∞—Å—Ç–µ—Ä—ã –û—Ç—á–µ—Ç–æ–≤</h2>
                <div id="map" class="rounded-xl shadow-inner"></div>
                <p class="text-sm text-gray-500 mt-4">–ö–∞—Ä—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏, —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –≤ –æ—Ç—á–µ—Ç–∞—Ö. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä—ã –¥–ª—è –≥—Ä—É–ø–ø –∏ —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É –¥–ª—è –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏.</p>
                <div class="mt-4 flex space-x-4">
                    <button onclick="mapMode='cluster'; generateMap(dataCache);" class="px-4 py-2 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600 transition">–ö–ª–∞—Å—Ç–µ—Ä—ã</button>
                    <button onclick="mapMode='heat'; generateMap(dataCache);" class="px-4 py-2 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition">–¢–µ–ø–ª–æ–≤–∞—è –ö–∞—Ä—Ç–∞</button>
                </div>
            </div>
        </section>

        <!-- –°–µ–∫—Ü–∏—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <section id="admin" class="space-y-6 hidden">
            <div class="bg-red-50 border border-red-200 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-red-800 mb-4 flex items-center">
                    <i data-lucide="alert-triangle" class="h-6 w-6 mr-2"></i>
                    –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö
                </h2>
                <p class="text-red-700 mb-6">
                    –≠—Ç–∞ —Å–µ–∫—Ü–∏—è –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤. –î–µ–π—Å—Ç–≤–∏—è –∑–¥–µ—Å—å –Ω–µ–æ–±—Ä–∞—Ç–∏–º—ã!
                </p>
                <button onclick="showConfirmDeleteModal()" class="flex items-center px-6 py-3 bg-red-600 text-white font-medium rounded-lg shadow-lg hover:bg-red-700 transition transform hover:scale-[1.01]">
                    <i data-lucide="trash-2" class="h-5 w-5 mr-3"></i>
                    –û–ß–ò–°–¢–ò–¢–¨ –í–°–Æ –ë–ê–ó–£ –î–ê–ù–ù–´–•
                </button>
            </div>
        </section>

        <!-- Debug Info -->
        <div class="mt-8 text-xs text-gray-400 p-4 border-t border-gray-200">
            <p>–¢–µ–∫—É—â–∏–π ID Telegram: <span id="debugUserId">N/A</span></p>
            <p>–°—Ç–∞—Ç—É—Å –ê–¥–º–∏–Ω–∞: <span id="debugAdminStatus">–ù–ï–¢</span></p>
            <p>–í–µ—Ä—Å–∏—è UI: v2.5</p>
        </div>

    </main>

    <!-- –û–°–ù–û–í–ù–û–ô –°–ö–†–ò–ü–¢ -->
<script>
    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï FIREBASE ---
    let app;
    let db;
    let userTelegramId = null; // ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
    let isAdmin = false;       // –°—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

    // ‚ö†Ô∏è –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å–≤–æ–∏ –∫–ª—é—á–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDVeRXO16KtIwoJQb4uHQuCsEv3xTLBGhI", // –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê –°–í–û–ô –ö–õ–Æ–ß
        authDomain: "agitator-notebook.firebaseapp.com", // –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê –°–í–û–ô DOMAIN
        projectId: "agitator-notebook", // –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê –°–í–û–ô PROJECT ID
        storageBucket: "agitator-notebook.firebasestorage.app",
        messagingSenderId: "518555352011",
        appId: "1:518555352011:web:2b1f8791097e34d16853e5"
    };

    const ADMIN_IDS = [541459471]; // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê ID –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–û–í TELEGRAM

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ù–û–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï)
    try {
        // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º 'firebase' –∏–∑ compat.js
        app = firebase.initializeApp(firebaseConfig);
        db = app.firestore();
        console.log("‚úÖ Firebase –∏ Firestore —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.");
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –±—É–¥—É—â–∏–º–∏ –≤–µ—Ä—Å–∏—è–º–∏
        db.settings({ timestampsInSnapshots: true });
    } catch (e) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", e);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É
        window.showAlert('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê', `–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Firebase: ${e.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ console.log –∏ –∫–ª—é—á–∏ –≤ firebaseConfig.`);
    }

    // –í–ê–ñ–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    const isTMA = typeof Telegram !== 'undefined' && Telegram.WebApp;
    let dataCache = [];
    let mapInstance = null;
    let markerClusterGroup = null;
    let mapMode = 'cluster';

    // –í–ê–®–ò –ü–û–°–ï–õ–ï–ù–ò–Ø (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô –°–ü–ò–°–û–ö)
    const settlementsList = [
        "–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–ö–∞–∑–∞–Ω—å", "–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥"
    ];

    // --- –£–¢–ò–õ–ò–¢–´ ---

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    let modalConfirmHandler = () => {};

    function showConfirmDeleteModal() {
        if (!isAdmin) {
            showAlert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
            return;
        }

        showAlert(
            '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è',
            '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ "reports"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û.',
            () => {
                deleteCollection('reports');
            },
            true // showConfirm
        );
    }

    function showAlert(title, message, onConfirm = null, showConfirm = false) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;
        const confirmBtn = document.getElementById('modalConfirmBtn');

        if (showConfirm && onConfirm) {
            confirmBtn.classList.remove('hidden');
            modalConfirmHandler = () => {
                document.getElementById('modalOverlay').classList.add('hidden');
                onConfirm(); // –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
            };
        } else {
            confirmBtn.classList.add('hidden');
            modalConfirmHandler = () => {
                document.getElementById('modalOverlay').classList.add('hidden');
            };
        }

        document.getElementById('modalOverlay').classList.remove('hidden');
    }

    function showLoader() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoader() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function showSection(sectionId, element = null) {
        document.querySelectorAll('section').forEach(section => {
            section.classList.add('hidden');
        });
        document.getElementById(sectionId).classList.remove('hidden');

        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.classList.remove('nav-button-active');
        });
        if (element) {
            element.classList.add('nav-button-active');
        }
    }

    function populateSettlements() {
        const select = document.getElementById('settlement');
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
        settlementsList.forEach(settlement => {
            const option = document.createElement('option');
            option.value = settlement;
            option.textContent = settlement;
            select.appendChild(option);
        });
    }

    // --- –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ---

    let currentLatitude = null;
    let currentLongitude = null;

    function getCurrentLocation() {
        if (isTMA) {
             // –î–ª—è Telegram Mini App
             Telegram.WebApp.MainButton.setText('–û–ø—Ä–µ–¥–µ–ª—è–µ–º GPS...');
             Telegram.WebApp.MainButton.showProgress();

             Telegram.WebApp.sendData(JSON.stringify({ type: 'get_location' }));
             // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –±—É–¥–µ—Ç –≤ –±–æ—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ webapp_data_handler (–µ—Å–ª–∏ –±—ã –º—ã —Ä–∞–±–æ—Ç–∞–ª–∏ —Å –±–æ—Ç–æ–º)
             // –í —Ç–µ–∫—É—â–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ Canvas, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API
        }

        const statusDisplay = document.getElementById('locationStatus');
        statusDisplay.innerHTML = `<i data-lucide="loader-2" class="h-4 w-4 inline mr-1 text-yellow-500 animate-spin"></i> –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...`;
        lucide.createIcons();

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLatitude = position.coords.latitude;
                    currentLongitude = position.coords.longitude;
                    document.getElementById('latitude').value = currentLatitude;
                    document.getElementById('longitude').value = currentLongitude;
                    document.getElementById('latDisplay').textContent = currentLatitude.toFixed(6);
                    document.getElementById('lngDisplay').textContent = currentLongitude.toFixed(6);

                    statusDisplay.innerHTML = `<i data-lucide="check-circle" class="h-4 w-4 inline mr-1 text-green-500"></i> –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${currentLatitude.toFixed(6)}, ${currentLongitude.toFixed(6)}`;
                    lucide.createIcons();

                    if (isTMA) {
                        Telegram.WebApp.MainButton.hideProgress();
                        Telegram.WebApp.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û—Ç—á–µ—Ç');
                    }
                },
                (error) => {
                    console.error("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:", error);
                    statusDisplay.innerHTML = `<i data-lucide="map-pin-off" class="h-4 w-4 inline mr-1 text-red-500"></i> –û—à–∏–±–∫–∞: ${error.message}`;
                    lucide.createIcons();
                    showAlert('–û—à–∏–±–∫–∞ GPS', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ.');

                    if (isTMA) {
                        Telegram.WebApp.MainButton.hideProgress();
                        Telegram.WebApp.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û—Ç—á–µ—Ç');
                    }
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        } else {
            statusDisplay.innerHTML = `<i data-lucide="map-pin-off" class="h-4 w-4 inline mr-1 text-red-500"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.`;
            lucide.createIcons();
            showAlert('–û—à–∏–±–∫–∞ GPS', '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.');
        }
    }

    // --- –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –ü–†–û–í–ï–†–ö–ê –ê–î–ú–ò–ù–ê ---

    async function authenticateUser() {
        // –õ–æ–≥–∏–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ ID –≤ Mini App)
        // –í —ç—Ç–æ–º —É–ø—Ä–æ—â–µ–Ω–Ω–æ–º TMA/Canvas –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –º—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º ID –∏ —Å—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∞
        // –Ω–∞ –æ—Å–Ω–æ–≤–µ initData (–∫–æ—Ç–æ—Ä–æ–≥–æ –∑–¥–µ—Å—å –Ω–µ—Ç) –∏–ª–∏ –∑–∞–≥–ª—É—à–∫–∏.
        try {
            if (isTMA && Telegram.WebApp.initDataUnsafe.user) {
                userTelegramId = Telegram.WebApp.initDataUnsafe.user.id;
            } else {
                // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è Canvas: –∏—Å–ø–æ–ª—å–∑—É–µ–º ID –∏–∑ ADMIN_IDS –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∞
                userTelegramId = ADMIN_IDS[0];
            }

            if (ADMIN_IDS.includes(userTelegramId)) {
                isAdmin = true;
                document.getElementById('navReports').removeAttribute('disabled');
                document.getElementById('navMap').removeAttribute('disabled');
                document.getElementById('navAdmin').classList.remove('hidden');
            } else {
                isAdmin = false;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';

        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", e);
            showAlert('–û—à–∏–±–∫–∞ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram.');
        }
    }


    // --- –û–§–§–õ–ê–ô–ù/–ö–≠–® –õ–û–ì–ò–ö–ê ---

    function saveToCache(data) {
        try {
            const cachedReports = JSON.parse(localStorage.getItem('cachedReports') || '[]');
            cachedReports.push(data);
            localStorage.setItem('cachedReports', JSON.stringify(cachedReports));
            updateOfflineStatus();
            renderLatestData(false); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—Ç—á–µ—Ç–æ–≤
            return true;
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫—ç—à:", e);
            showAlert('–û—à–∏–±–∫–∞ –ö—ç—à–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.');
            return false;
        }
    }

    function updateOfflineStatus() {
        const cachedReports = JSON.parse(localStorage.getItem('cachedReports') || '[]');
        const badge = document.getElementById('offlineBadge');
        if (cachedReports.length > 0) {
            badge.textContent = `–û–§–§–õ–ê–ô–ù –ö–≠–® (${cachedReports.length})`;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    async function processCache() {
        const cachedReports = JSON.parse(localStorage.getItem('cachedReports') || '[]');
        if (cachedReports.length === 0) return true; // –ù–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ

        if (isTMA) Telegram.WebApp.MainButton.setText(`–û—Ç–ø—Ä–∞–≤–∫–∞ –∫—ç—à–∞ (${cachedReports.length})...`);
        showLoader();

        try {
            // –ú–∞—Å—Å–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (–¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã - –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è)
            for (const report of cachedReports) {
                await db.collection('reports').add(report);
            }
            // –ï—Å–ª–∏ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ:
            localStorage.removeItem('cachedReports');
            updateOfflineStatus();
            showAlert('–£—Å–ø–µ—Ö', `–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${cachedReports.length} –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ –≤ Firebase.`);
            if (isAdmin) fetchAndRenderReports(); // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç—á–µ—Ç—ã –∞–¥–º–∏–Ω–∞
            renderLatestData(true); // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç—á–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            return true;

        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫—ç—à–∞:", e);
            showAlert('–û—à–∏–±–∫–∞', `–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—ç—à –≤ Firebase: ${e.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`);
            return false;
        } finally {
            hideLoader();
            if (isTMA) Telegram.WebApp.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û—Ç—á–µ—Ç');
        }
    }

    // --- –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• ---

    document.getElementById('reportForm').onsubmit = async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitButton = form.querySelector('button[type="submit"]');

        if (isTMA) Telegram.WebApp.MainButton.showProgress();
        submitButton.disabled = true;
        submitButton.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        const reportData = {
            user_id: userTelegramId,
            full_name: isTMA && Telegram.WebApp.initDataUnsafe.user ? (Telegram.WebApp.initDataUnsafe.user.first_name + ' ' + (Telegram.WebApp.initDataUnsafe.user.last_name || '')).trim() : userTelegramId,
            username: isTMA && Telegram.WebApp.initDataUnsafe.user ? (Telegram.WebApp.initDataUnsafe.user.username || 'n/a') : 'n/a',
            timestamp: new Date().getTime(),
            settlement: form.settlement.value,
            street: form.street.value.trim(),
            house: form.house.value.trim(),
            apartment: form.apartment.value.trim() || 'N/A',
            action: form.action.value,
            loyalty: form.loyalty.value,
            requires_followup: form.requiresFollowup.checked,
            comment: form.comment.value.trim() || 'N/A',
            location: (currentLatitude && currentLongitude) ? {
                latitude: currentLatitude,
                longitude: currentLongitude
            } : null
        };

        try {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
            if (db) {
                await db.collection('reports').add(reportData);
                showAlert('–£—Å–ø–µ—Ö!', '–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firebase.');
                form.reset();
                currentLatitude = null;
                currentLongitude = null;
                document.getElementById('latDisplay').textContent = 'N/A';
                document.getElementById('lngDisplay').textContent = 'N/A';

                // –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—ç—à –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–Ω–ª–∞–π–Ω-–æ—Ç–ø—Ä–∞–≤–∫–∏
                await processCache();

            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                if (saveToCache(reportData)) {
                    showAlert('–û—Ñ—Ñ–ª–∞–π–Ω –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ', '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase. –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –∏ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ.');
                    form.reset();
                }
            }
            if (isAdmin) fetchAndRenderReports(); // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç—á–µ—Ç—ã –∞–¥–º–∏–Ω–∞
            renderLatestData(true); // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç—á–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞:", e);
            // –ï—Å–ª–∏ –æ–Ω–ª–∞–π–Ω-–æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
            if (saveToCache(reportData)) {
                showAlert('–û—à–∏–±–∫–∞ –∏ –ö—ç—à', `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç –≤ Firebase: ${e.message}. –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à.`);
                form.reset();
            }
        } finally {
            if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            submitButton.disabled = false;
            submitButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û—Ç—á–µ—Ç';
            lucide.createIcons();
        }
    };

    // --- –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ü–û–°–õ–ï–î–ù–ò–• –û–¢–ß–ï–¢–û–í –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---

    function renderLatestData(fromCache) {
        const container = document.getElementById('latestDataContainer');
        container.innerHTML = '';
        const dataToRender = [];

        // 1. –ò–∑ –∫—ç—à–∞
        const cachedReports = JSON.parse(localStorage.getItem('cachedReports') || '[]');
        cachedReports.forEach(r => dataToRender.push({ ...r, is_cached: true }));

        // 2. –ò–∑ dataCache (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–Ω–ª–∞–π–Ω-–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        const userOnlineReports = dataCache
            .filter(r => r.user_id === userTelegramId)
            .sort((a, b) => b.timestamp - a.timestamp)
            .slice(0, 5 - cachedReports.length); // –ë–µ—Ä–µ–º —Å—Ç–æ–ª—å–∫–æ, —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –º–µ—Å—Ç–∞

        dataToRender.push(...userOnlineReports.map(r => ({ ...r, is_cached: false })));

        if (dataToRender.length === 0) {
            container.innerHTML = '<p class="text-gray-500">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤.</p>';
            return;
        }

        dataToRender
            .sort((a, b) => b.timestamp - a.timestamp)
            .slice(0, 5)
            .forEach(report => {
            const date = new Date(report.timestamp).toLocaleString();
            const locationStr = report.location ? ` | GPS: ${report.location.latitude.toFixed(4)}, ${report.location.longitude.toFixed(4)}` : '';
            const cacheBadge = report.is_cached ?
                '<span class="ml-2 text-xs font-medium text-yellow-700 bg-yellow-100 px-2 py-0.5 rounded-full">–ö—ç—à</span>' :
                '<span class="ml-2 text-xs font-medium text-green-700 bg-green-100 px-2 py-0.5 rounded-full">Online</span>';

            const loyaltyColor = {
                "–õ–æ—è–ª–µ–Ω": "bg-green-100 text-green-800",
                "–ù–µ–π—Ç—Ä–∞–ª–µ–Ω": "bg-blue-100 text-blue-800",
                "–ù–µ–ª–æ—è–ª–µ–Ω": "bg-red-100 text-red-800",
                "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ": "bg-gray-100 text-gray-800"
            }[report.loyalty] || "bg-gray-100 text-gray-800";

            container.innerHTML += `
                <div class="p-4 border border-gray-200 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm font-medium text-gray-500">${date} ${cacheBadge}</p>
                        <span class="text-xs font-semibold ${loyaltyColor} px-2 py-1 rounded-full">${report.loyalty}</span>
                    </div>
                    <p class="text-gray-900 font-semibold mb-1">
                        ${report.settlement}, —É–ª. ${report.street}, –¥. ${report.house}${report.apartment !== 'N/A' ? `, –∫–≤. ${report.apartment}` : ''}
                    </p>
                    <p class="text-sm text-gray-700">–î–µ–π—Å—Ç–≤–∏–µ: <span class="font-medium">${report.action}</span></p>
                    <p class="text-sm text-gray-700 truncate">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${report.comment}</p>
                    ${locationStr ? `<p class="text-xs text-gray-400 mt-1">${locationStr}</p>` : ''}
                </div>
            `;
        });
    }


    // --- –û–¢–ß–ï–¢–´ –ê–î–ú–ò–ù–ê ---

    async function fetchAndRenderReports() {
        if (!isAdmin) return;
        if (!db) {
             showAlert('–û—à–∏–±–∫–∞ Firebase', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫.');
             return;
        }
        showLoader();

        try {
            const snapshot = await db.collection('reports').get();
            dataCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const total = dataCache.length;
            const loyal = dataCache.filter(d => d.loyalty === '–õ–æ—è–ª–µ–Ω').length;
            const disloyal = dataCache.filter(d => d.loyalty === '–ù–µ–ª–æ—è–ª–µ–Ω').length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statLoyal').textContent = loyal;
            document.getElementById('statDisloyal').textContent = disloyal;

            // –†–µ–Ω–¥–µ—Ä –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ —Ç–∞–±–ª–∏—Ü—ã
            renderCharts();
            renderReportsTable();
            generateMap(dataCache); // –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É
            renderLatestData(false); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—Ç—á–µ—Ç–æ–≤

        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤:", e);
            showAlert('–û—à–∏–±–∫–∞ –ó–∞–≥—Ä—É–∑–∫–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.');
        } finally {
            hideLoader();
        }
    }

    function renderCharts() {
        // –õ–æ—è–ª—å–Ω–æ—Å—Ç—å –ø–æ –î–µ–π—Å—Ç–≤–∏—è–º
        const loyaltyByAction = dataCache.reduce((acc, doc) => {
            if (!acc[doc.action]) acc[doc.action] = { loyal: 0, neutral: 0, disloyal: 0, undefined: 0 };
            if (doc.loyalty === '–õ–æ—è–ª–µ–Ω') acc[doc.action].loyal++;
            else if (doc.loyalty === '–ù–µ–π—Ç—Ä–∞–ª–µ–Ω') acc[doc.action].neutral++;
            else if (doc.loyalty === '–ù–µ–ª–æ—è–ª–µ–Ω') acc[doc.action].disloyal++;
            else acc[doc.action].undefined++;
            return acc;
        }, {});

        const actionLabels = Object.keys(loyaltyByAction);
        const loyalData = actionLabels.map(a => loyaltyByAction[a].loyal);
        const neutralData = actionLabels.map(a => loyaltyByAction[a].neutral);
        const disloyalData = actionLabels.map(a => loyaltyByAction[a].disloyal);

        renderBarChart('loyaltyChart', actionLabels, [
            { label: '–õ–æ—è–ª–µ–Ω', data: loyalData, backgroundColor: '#34d399' },
            { label: '–ù–µ–π—Ç—Ä–∞–ª–µ–Ω', data: neutralData, backgroundColor: '#60a5fa' },
            { label: '–ù–µ–ª–æ—è–ª–µ–Ω', data: disloyalData, backgroundColor: '#f87171' },
        ], 'bar', '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å');

        // –î–µ–π—Å—Ç–≤–∏—è –ø–æ –ü–æ—Å–µ–ª–µ–Ω–∏—è–º
        const actionBySettlement = dataCache.reduce((acc, doc) => {
            if (!acc[doc.settlement]) acc[doc.settlement] = 0;
            acc[doc.settlement]++;
            return acc;
        }, {});

        const settlementLabels = Object.keys(actionBySettlement);
        const settlementData = Object.values(actionBySettlement);

        renderBarChart('settlementChart', settlementLabels, [
            { label: '–û—Ç—á–µ—Ç—ã', data: settlementData, backgroundColor: '#818cf8' }
        ], 'bar', '–û—Ç—á–µ—Ç—ã');
    }

    let chartInstances = {};

    function renderBarChart(canvasId, labels, datasets, type, titleText) {
        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }
        const ctx = document.getElementById(canvasId).getContext('2d');
        chartInstances[canvasId] = new Chart(ctx, {
            type: type,
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: false, text: titleText }
                },
                scales: {
                    x: { stacked: type === 'bar' && datasets.length > 1, title: { display: false } },
                    y: { stacked: type === 'bar' && datasets.length > 1, beginAtZero: true }
                }
            }
        });
    }


    function renderReportsTable() {
        const tableBody = document.getElementById('reportsTableBody');
        tableBody.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
        const sortedData = [...dataCache].sort((a, b) => b.timestamp - a.timestamp);

        if (sortedData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</td></tr>';
            return;
        }

        sortedData.forEach(doc => {
            const date = new Date(doc.timestamp).toLocaleString();
            const loyaltyColor = {
                "–õ–æ—è–ª–µ–Ω": "text-green-600 font-semibold",
                "–ù–µ–π—Ç—Ä–∞–ª–µ–Ω": "text-blue-600 font-semibold",
                "–ù–µ–ª–æ—è–ª–µ–Ω": "text-red-600 font-semibold",
                "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ": "text-gray-500"
            }[doc.loyalty] || "text-gray-500";

            const row = `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${doc.full_name || doc.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.settlement}, —É–ª. ${doc.street}, –¥. ${doc.house}${doc.apartment !== 'N/A' ? `, –∫–≤. ${doc.apartment}` : ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${doc.action}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${loyaltyColor}">${doc.loyalty}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.requires_followup ? '–î–ê' : '–ù–ï–¢'}</td>
                    <td class="px-6 py-4 whitespace-normal text-sm text-gray-500 max-w-xs">${doc.comment}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    function exportToXLSX() {
        if (dataCache.length === 0) {
            showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –æ—Ç—á–µ—Ç—ã.');
            return;
        }
        const exportData = dataCache.map(doc => ({
            '–í—Ä–µ–º—è': new Date(doc.timestamp).toLocaleString(), 'ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è': doc.user_id, '–ê–≥–∏—Ç–∞—Ç–æ—Ä (–§–ò–û)': doc.full_name || doc.username,
            '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç': doc.settlement, '–£–ª–∏—Ü–∞': doc.street, '–î–æ–º': doc.house, '–ö–≤–∞—Ä—Ç–∏—Ä–∞': doc.apartment, '–î–µ–π—Å—Ç–≤–∏–µ': doc.action,
            '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å': doc.loyalty, '–¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä': doc.requires_followup ? '–î–ê' : '–ù–ï–¢', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': doc.comment,
            '–®–∏—Ä–æ—Ç–∞': doc.location ? doc.location.latitude : 'N/A', '–î–æ–ª–≥–æ—Ç–∞': doc.location ? doc.location.longitude : 'N/A',
        }));
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "–î–∞–Ω–Ω—ã–µ");
        XLSX.writeFile(workbook, "agitator_data_" + new Date().toISOString().slice(0, 10) + ".xlsx");
    }

    // --- –õ–ò–°–¢–ê–Ø –ö–ê–†–¢–ê ---

    function generateMap(data) {
        if (mapInstance) {
            mapInstance.remove(); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
        }

        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
        const geoData = data.filter(doc => doc.location && doc.location.latitude && doc.location.longitude);

        if (geoData.length === 0) {
            const mapContainer = document.getElementById('map');
            mapContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>';
            return;
        }

        // –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã: —Å—Ä–µ–¥–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        const avgLat = geoData.reduce((sum, doc) => sum + doc.location.latitude, 0) / geoData.length;
        const avgLng = geoData.reduce((sum, doc) => sum + doc.location.longitude, 0) / geoData.length;

        mapInstance = L.map('map').setView([avgLat, avgLng], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(mapInstance);

        if (mapMode === 'cluster') {
            if (markerClusterGroup) {
                markerClusterGroup.clearLayers();
            } else {
                markerClusterGroup = L.markerClusterGroup();
            }

            geoData.forEach(doc => {
                const marker = L.marker([doc.location.latitude, doc.location.longitude]);
                const popupContent = `
                    <div style="font-family: Arial, sans-serif; font-size: 12px;">
                        <strong>${doc.full_name || doc.username}</strong>
                        <br>${new Date(doc.timestamp).toLocaleString()}
                        <br>–ê–¥—Ä–µ—Å: ${doc.street}, ${doc.house}
                        <br>–î–µ–π—Å—Ç–≤–∏–µ: ${doc.action}
                        <br>–õ–æ—è–ª—å–Ω–æ—Å—Ç—å: <strong>${doc.loyalty}</strong>
                        ${doc.requires_followup ? '<br><span style="color: red;">–¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä</span>' : ''}
                    </div>
                `;
                marker.bindPopup(popupContent);
                markerClusterGroup.addLayer(marker);
            });

            mapInstance.addLayer(markerClusterGroup);

        } else if (mapMode === 'heat') {
            const heatData = geoData.map(doc => [doc.location.latitude, doc.location.longitude, 0.5]); // intensity 0.5
            L.heatLayer(heatData, { radius: 25 }).addTo(mapInstance);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        setTimeout(() => mapInstance.invalidateSize(), 300);
    }


    // --- –ê–î–ú–ò–ù–ò–°–¢–†–ò–†–û–í–ê–ù–ò–ï ---

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (Firebase —Ç—Ä–µ–±—É–µ—Ç –∏—Ç–µ—Ä–∞—Ü–∏–π)
    async function deleteCollection(collectionPath) {
        if (!isAdmin) {
            showAlert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.');
            return false;
        }
        if (!db) {
             showAlert('–û—à–∏–±–∫–∞ Firebase', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.');
             return false;
        }

        if (isTMA) Telegram.WebApp.MainButton.showProgress();
        showLoader();

        try {
            const collectionRef = db.collection(collectionPath);
            const query = collectionRef.orderBy('__name__').limit(50); // –£–¥–∞–ª—è–µ–º –ø–æ 50 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            let deletedCount = 0;

            const deleteQueryBatch = async (db, query) => {
                const snapshot = await query.get();

                if (snapshot.size === 0) {
                    return 0; // –í—Å–µ —É–¥–∞–ª–µ–Ω–æ
                }

                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                deletedCount += snapshot.size;

                if (snapshot.size === 50) {
                    // –ï—Å—Ç—å –µ—â–µ, —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º
                    return deleteQueryBatch(db, query);
                }
                return deletedCount;
            };

            await deleteQueryBatch(db, query);

            localStorage.removeItem('cachedReports');
            dataCache = []; // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
            updateOfflineStatus();
            showAlert('–£—Å–ø–µ—à–Ω–æ!', `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} –∑–∞–ø–∏—Å–µ–π. –î–∞–Ω–Ω—ã–µ Firestore –æ—á–∏—â–µ–Ω—ã.`);

            if (isAdmin) fetchAndRenderReports();

            return true;

        } catch (e) {
             console.error("Error deleting collection:", e);
             showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + e.message);
             return false;
        } finally {
             hideLoader();
             if (isTMA) Telegram.WebApp.MainButton.hideProgress();
        }
    }


    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
    if (isTMA) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
    }

    // üîë –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–û–∂–∏–¥–∞–µ–º authenticateUser)
    window.onload = async () => {
        // 1. –°–Ω–∞—á–∞–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ isAdmin –∏ userTelegramId
        await authenticateUser();

        // 2. –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        populateSettlements();
        updateOfflineStatus();
        window.showSection('form');
        lucide.createIcons();

        // –û–¢–õ–ê–î–ö–ê: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
        document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
        document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê' : '–ù–ï–¢';

        if (!firebaseConfig.projectId) {
            window.showAlert('–í–ù–ò–ú–ê–ù–ò–ï', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase –≤ –∫–æ–¥.');
        }

        // 3. –ï—Å–ª–∏ –∞–¥–º–∏–Ω, –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç—ã
        if (isAdmin && db) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç—ã, –Ω–æ –±–µ–∑ showLoader/hideLoader, —Ç.–∫. onload —É–∂–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏–º–∏
            try {
                const snapshot = await db.collection('reports').get();
                dataCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLatestData(false);
            } catch (e) {
                console.warn("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
                renderLatestData(true); // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ –∏–∑ –∫—ç—à–∞
            }
        } else {
             // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –ø—Ä–æ—Å—Ç–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –∫—ç—à, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
             renderLatestData(true);
        }

        // –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—ç—à, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        await processCache();
    };

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
    window.authenticateUser = authenticateUser;
    window.fetchAndRenderReports = fetchAndRenderReports;
    window.renderLatestData = renderLatestData;
    window.generateMap = generateMap;
    window.showSection = showSection;
    window.showAlert = showAlert;
    window.exportToXLSX = exportToXLSX;
    window.showConfirmDeleteModal = showConfirmDeleteModal;
</script>
</body>
</html>
