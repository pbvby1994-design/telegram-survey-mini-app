<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Блокнот Агитатора | Панель</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="https://api-maps.yandex.ru/2.1/?apikey=35d34bfb-514d-42c1-b37d-cb751ea4793e&lang=ru_RU&onload=initMap" type="text/javascript" async></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Jost', sans-serif; 
            background-color: #f4f6f9;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .tab-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        .tab-button.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }
        .tab-button:not(.active):hover {
            background-color: #e5e7eb;
        }
        #mapContainer { 
            height: 600px; 
            width: 100%; 
            border-radius: 12px;
            background-color: #e5e7eb; 
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; 
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="mb-6 flex justify-between items-center bg-white p-6 rounded-xl shadow">
            <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                <span data-lucide="notebook-pen" class="w-8 h-8 mr-3 text-indigo-600"></span>
                Блокнот Агитатора
            </h1>
            <div class="text-right">
                <p class="text-sm font-medium text-gray-700">Ваш статус:</p>
                <p id="debugAdminStatus" class="text-lg font-bold text-red-500">⏳</p>
            </div>
        </header>

        <nav class="mb-8 p-3 bg-white rounded-xl shadow flex space-x-4">
            <div id="btn-form-view" class="tab-button" onclick="showSection('form-view')">
                <span data-lucide="notebook-pen" class="w-5 h-5 mr-2"></span> Форма
            </div>
            <div id="btn-my-reports-view" class="tab-button hidden" onclick="showSection('my-reports-view')">
                <span data-lucide="list-checks" class="w-5 h-5 mr-2"></span> Мои Отчеты
            </div>
            <div id="btn-map-view" class="tab-button hidden" onclick="showSection('map-view')">
                <span data-lucide="map-pin" class="w-5 h-5 mr-2"></span> Карта
            </div>
            <div id="btn-stats" class="tab-button hidden" onclick="showSection('stats')">
                <span data-lucide="line-chart" class="w-5 h-5 mr-2"></span> Статистика
            </div>
            <div id="btn-raw-data" class="tab-button hidden" onclick="showSection('raw-data')">
                <span data-lucide="table-2" class="w-5 h-5 mr-2"></span> Сырые данные
            </div>
        </nav>

        <section id="form-view" class="content-section">
            <div class="bg-white p-6 rounded-xl shadow">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Форма анкетирования</h2>
                <form id="reportForm" onsubmit="event.preventDefault(); window.saveReport();">
                    <div class="space-y-4">
                        <div>
                            <label for="settlement" class="block text-sm font-medium text-gray-700 required">Населенный пункт</label>
                            <select id="settlement" name="settlement" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">Выберите НП</option>
                                <option value="г.п. Лянтор">г.п. Лянтор</option>
                                <option value="с.п. Русскинская">с.п. Русскинская</option>
                                <option value="г.п. Федоровский">г.п. Федоровский</option>
                                <option value="г.п. Барсово">г.п. Барсово</option>
                                <option value="г.п. Белый Яр">г.п. Белый Яр</option>
                                <option value="с.п. Лямина">с.п. Лямина</option>
                                <option value="с.п. Сытомино">с.п. Сытомино</option>
                                <option value="с.п. Угут">с.п. Угут</option>
                                <option value="с.п. Ульт-Ягун">с.п. Ульт-Ягун</option>
                                <option value="с.п. Солнечный">с.п. Солнечный</option>
                                <option value="с.п. Нижнесортымский">с.п. Нижнесортымский</option>
                                <option value="с.п. Тундрино">с.п. Тундрино</option>
                                <option value="с.п. Локосово">с.п. Локосово</option>
                            </select>
                        </div>

                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-700 required">Адрес (Улица, Дом)</label>
                            <input type="text" id="address" name="address" required class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2" placeholder="Начните вводить адрес (ул. Ленина, 1)">
                            <ul id="suggestionsList" class="absolute z-10 bg-white border border-gray-300 w-full shadow-lg mt-1 rounded-md hidden">
                            </ul>
                            <p class="text-xs text-red-500 mt-1" id="addressError" style="display:none;">⚠️ Выберите адрес из списка Dadata!</p>
                        </div>
                        
                        <div class="flex items-center space-x-4 p-3 bg-gray-100 rounded-md">
                            <button type="button" onclick="window.getCurrentLocation()" class="flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                                <span id="geoIcon" data-lucide="map-pin" class="w-5 h-5 mr-2"></span> Получить GPS
                            </button>
                            <p id="geoStatus" class="text-sm font-medium text-gray-600">Геолокация: ❓ Не получена</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 required">Лояльность</label>
                            <div class="flex flex-wrap gap-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="loyalty" value="strong" class="form-radio text-green-600" required>
                                    <span class="ml-2">Сильная поддержка</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="loyalty" value="moderate" class="form-radio text-blue-600">
                                    <span class="ml-2">Умеренная поддержка</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="loyalty" value="neutral" class="form-radio text-yellow-600">
                                    <span class="ml-2">Нейтрально</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="loyalty" value="against" class="form-radio text-red-600">
                                    <span class="ml-2">Против</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 required">Совершенное действие</label>
                            <div class="flex flex-wrap gap-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="action" value="conversation" class="form-radio text-indigo-600" required>
                                    <span class="ml-2">Разговор</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="action" value="handout" class="form-radio text-indigo-600">
                                    <span class="ml-2">Вручение материала</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="action" value="visit" class="form-radio text-indigo-600">
                                    <span class="ml-2">Посещение</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label for="comment" class="block text-sm font-medium text-gray-700">Комментарий</label>
                            <textarea id="comment" name="comment" rows="3" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2"></textarea>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button id="saveButton" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition duration-150">
                            <span data-lucide="save" class="w-5 h-5 mr-2"></span> Сохранить Отчет
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <section id="my-reports-view" class="content-section hidden">
            <div class="bg-white p-6 rounded-xl shadow">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                     <span data-lucide="list-checks" class="w-6 h-6 mr-2 text-indigo-600"></span>
                     Мои Отчеты (Редактирование 30 минут)
                </h2>
                <div id="agitatorReportsList" class="space-y-4">
                    <p class="text-center text-gray-500">Загрузка ваших отчетов...</p>
                </div>
                <p class="mt-4 text-sm text-gray-500">
                    * Вы можете **редактировать** отчет, нажав "Редактировать", в течение **30 минут** после его сохранения. После этого срока функция редактирования блокируется.
                </p>
            </div>
        </section>

        <section id="map-view" class="content-section hidden">
            <div class="bg-white p-6 rounded-xl shadow mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-gray-800">Карта опросов</h2>
                <div class="flex items-center space-x-3">
                    <label for="settlementFilter" class="text-gray-700">Фильтр по НП:</label>
                    <select id="settlementFilter" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Все населенные пункты</option>
                        </select>
                </div>
            </div>
            <div id="mapContainer">
                 <div id="mapLoading" class="absolute inset-0 bg-gray-200/80 flex items-center justify-center rounded-xl z-10 transition-opacity duration-300">
                    <div class="flex flex-col items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-indigo-700">Загрузка карты и данных...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="stats" class="content-section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Лояльность (По всем отчетам)</h3>
                    <canvas id="loyaltyChart" class="w-full h-80"></canvas>
                </div>
                <div class="bg-white p-6 rounded-xl shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Действия (По всем отчетам)</h3>
                    <canvas id="actionChart" class="w-full h-80"></canvas>
                </div>
            </div>
        </section>

        <section id="raw-data" class="content-section hidden">
            <div class="bg-white p-6 rounded-xl shadow">
                <div class="flex justify-between items-center mb-4">
                    <p id="reportStatus" class="text-sm font-medium text-gray-600">Ожидание загрузки данных...</p>
                    <button id="exportCsvButton" onclick="window.exportToCsv()" disabled class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition duration-150">
                        <span data-lucide="download" class="w-5 h-5 mr-2"></span> Экспорт в CSV
                    </button>
                </div>
                <div class="mt-4 text-gray-500">
                    <p>Для просмотра полных данных используйте кнопку "Экспорт в CSV".</p>
                </div>
            </div>
            <div id="admin-upload-section" class="bg-gray-50 p-6 rounded-xl mt-6 shadow hidden">
                 <h3 class="text-xl font-semibold text-gray-800 mb-4">Загрузка файла для Агитаторов</h3>
                 <p class="text-sm text-gray-600 mb-4">Здесь будет реализован функционал для загрузки файлов (например, новых инструкций или опросов) для всех Агитаторов.</p>
                 <button disabled class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <span data-lucide="upload" class="w-5 h-5 mr-2"></span> Загрузить Файл (В разработке)
                 </button>
            </div>
        </section>
    </div>

    <div id="alertModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 transition-opacity duration-300" onclick="closeAlert()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4" onclick="event.stopPropagation()">
            <h3 id="alertTitle" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <p id="alertMessage" class="text-gray-600 mb-6"></p>
            <button onclick="closeAlert()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                Закрыть
            </button>
        </div>
    </div>

    <script type="module" src="./config.js"></script>
    <script src="./firebase-auth.js"></script>
    <script src="./reports.js"></script>
    <script src="./main.js"></script>

    <script>
        lucide.createIcons();
        
        // Централизованная функция переключения разделов
        window.showSection = function(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const sectionButton = document.getElementById(`btn-${sectionId}`);
            if (sectionButton) {
                sectionButton.classList.add('active');
            }

            // Логика инициализации данных для Карт/Отчетов Агитатора
            if (sectionId === 'map-view' || sectionId === 'stats' || sectionId === 'raw-data' || sectionId === 'my-reports-view') {
                // Показываем индикатор загрузки (скрывается в reports.js после загрузки)
                document.getElementById('mapLoading')?.classList.remove('hidden'); 
                if (typeof window.fetchReports === 'function') {
                    const settlementFilter = document.getElementById('settlementFilter')?.value || null;
                    // fetchReports внутри себя фильтрует данные по роли (для агитатора по его ID, для админа по НП)
                    window.fetchReports(window.isAdmin ? settlementFilter : null); 
                }
                if (window.mapInstance && sectionId === 'map-view') {
                     // Принудительно подгоняем карту под размер контейнера
                     window.mapInstance.container.fitToViewport();
                }
            } else {
                 document.getElementById('mapLoading')?.classList.add('hidden');
            }
            
            lucide.createIcons();
        }
        
        window.showAlert = function(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').classList.remove('hidden');
            document.getElementById('alertModal').classList.add('flex');
            
            if (window.Telegram.WebApp && window.Telegram.WebApp.showAlert) {
                 window.Telegram.WebApp.showAlert(`${title}: ${message}`);
            }
        }

        window.closeAlert = function() {
            document.getElementById('alertModal').classList.add('hidden');
            document.getElementById('alertModal').classList.remove('flex');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Запуск всей логики аутентификации, проверки роли и отображения UI
            if (window.loadDashboard) {
                window.loadDashboard();
            }
        });
    </script>
</body>
</html>
