<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–∫–Ω–æ—Ç –ê–≥–∏—Ç–∞—Ç–æ—Ä–∞ | v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <style>
        /* üé® –£–ª—É—á—à–µ–Ω–Ω–∞—è –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ (Jost) */
        body {
            font-family: 'Jost', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #f2f2f7); /* TMA Theme BG */
            color: var(--tg-theme-text-color, #1c1c1e); /* TMA Theme Text */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-bottom: 80px;
            transition: background-color 0.3s;
        }
        h1, h2, h3 { color: var(--tg-theme-text-color, #000000); font-weight: 600; }
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-secondary-bg-color, #e5e5ea);
            transition: transform 0.2s ease-in-out;
        }
        .nav-bar { /* ... styles for navigation ... */ }
        .nav-item {
            color: var(--tg-theme-hint-color, #8e8e93);
            transition: color 0.2s;
        }
        .nav-item.active {
            color: var(--tg-theme-link-color, #007aff);
            font-weight: 500;
        }
        /* üí° –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π —Ñ–æ—Ä–º—ã */
        input[type="text"], textarea, select {
            background-color: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-secondary-bg-color, #d1d1d6);
            color: var(--tg-theme-text-color, #1c1c1e);
            border-radius: 10px;
            padding: 12px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
            transition: border-color 0.2s, background-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-link-color, #007aff);
        }
        /* üöÄ –°—Ç–∏–ª–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫ (#1) */
        .loyalty-btn, .action-btn {
            border: 2px solid var(--tg-theme-secondary-bg-color, #e5e5ea);
            font-weight: 500;
            padding: 10px 8px;
            border-radius: 10px;
            transition: all 0.1s ease-in-out;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #1c1c1e);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .loyalty-btn.active-loyal { border-color: #10B981; background-color: #D1FAE5; }
        .loyalty-btn.active-not_loyal { border-color: #EF4444; background-color: #FEE2E2; }
        .loyalty-btn.active-doubtful { border-color: #F59E0B; background-color: #FEF3C7; }
        .loyalty-btn.active-not_opened { border-color: #6B7280; background-color: #E5E7EB; }
        
        .action-btn.active-action { border-color: var(--tg-theme-link-color, #007aff); background-color: #E0F2FF; }

        /* Map container style */
        #map-container {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body class="p-4">

    <div id="offlineStatus" class="fixed top-0 left-0 right-0 p-2 text-center text-xs font-medium text-white bg-red-500 hidden z-20">
        <i data-lucide="cloud-off" class="w-4 h-4 mr-1 inline-block align-middle"></i>
        –û—Ñ–ª–∞–π–Ω: <span id="debugOfflineCount">0</span> –∑–∞–ø–∏—Å–µ–π –≤ –∫—ç—à–µ. –ù–∞–∂–º–∏—Ç–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å".
    </div>
    
    <div class="nav-bar">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            <a href="#" onclick="showSection('form'); return false;" class="nav-item active flex flex-col items-center text-xs">
                <i data-lucide="clipboard-pen" class="w-5 h-5"></i>
                <span>–í–≤–æ–¥</span>
            </a>
            <a href="#" onclick="showSection('walklist'); return false;" class="nav-item flex flex-col items-center text-xs">
                 <i data-lucide="route" class="w-5 h-5"></i>
                <span>–ú–∞—Ä—à—Ä—É—Ç</span>
            </a>
            <a href="#" onclick="showSection('reports'); return false;" class="nav-item flex flex-col items-center text-xs">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                <span>–û—Ç—á–µ—Ç—ã</span>
            </a>
            <a href="#" onclick="showSection('admin'); return false;" class="nav-item flex flex-col items-center text-xs">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span>–ê–¥–º–∏–Ω</span>
            </a>
        </div>
    </div>

    <main class="max-w-lg mx-auto">
        <section id="form" class="section">
            <h1 class="text-2xl font-bold mb-4">–ë—ã—Å—Ç—Ä—ã–π –í–≤–æ–¥ –î–∞–Ω–Ω—ã—Ö</h1>

            <div id="debugCard" class="card p-3 mb-4 bg-yellow-100 border-l-4 border-yellow-500">
                <p class="text-xs text-yellow-800 font-semibold">
                    <i data-lucide="alert-triangle" class="w-4 h-4 mr-1 inline-block align-middle"></i>
                    –û—Ç–ª–∞–¥–∫–∞: –í–∞—à ID: <span id="debugUserId">...</span>
                </p>
                <p class="text-xs text-yellow-800">
                    –°—Ç–∞—Ç—É—Å –ê–¥–º–∏–Ω–∞: <span id="debugAdminStatus">...</span> |
                    –û—Ñ–ª–∞–π–Ω-–ö—ç—à: <span id="debugOfflineCount">0</span>
                </p>
            </div>

            <div id="historyCheck" class="card p-3 mb-4 bg-yellow-50 border-l-4 border-yellow-500 hidden">
                <p class="text-sm text-yellow-800 font-semibold">‚ö†Ô∏è –ò—Å—Ç–æ—Ä–∏—è –ü–æ—Å–µ—â–µ–Ω–∏—è:</p>
                <p id="historyText" class="text-xs text-yellow-700 mt-1 italic">–ê–¥—Ä–µ—Å –ø–æ—Å–µ—â–∞–ª—Å—è —Ä–∞–Ω–µ–µ.</p>
            </div>

            <div class="card p-4">
                <form id="surveyForm" onsubmit="saveSurveyData(event)">

                    <div class="mb-4">
                        <label for="settlement" class="block text-sm font-medium mb-1">–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</label>
                        <select id="settlement" required class="w-full"></select>
                    </div>

                    <div class="mb-4">
                        <label for="street" class="block text-sm font-medium mb-1">–£–ª–∏—Ü–∞</label>
                        <input type="text" id="street" required class="w-full" data-local-storage="lastStreet" oninput="checkAddressHistory()">
                    </div>
                    <div class="mb-4 flex space-x-2">
                        <div class="flex-1">
                            <label for="house" class="block text-sm font-medium mb-1">–î–æ–º</label>
                            <input type="text" id="house" required class="w-full" placeholder="–ù–æ–º–µ—Ä –¥–æ–º–∞" oninput="checkAddressHistory()">
                        </div>
                         <div class="flex-1">
                            <label for="apartment" class="block text-sm font-medium mb-1">–ö–≤–∞—Ä—Ç–∏—Ä–∞ (–æ–ø—Ü.)</label>
                            <input type="text" id="apartment" class="w-full" placeholder="–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</label>
                        <div id="loyaltyButtons" class="grid grid-cols-2 gap-2">
                            <button type="button" class="loyalty-btn text-sm" data-value="loyal" data-color="green" onclick="setLoyalty('loyal')">üü¢ –õ–æ—è–ª—å–Ω—ã–π</button>
                            <button type="button" class="loyalty-btn text-sm" data-value="doubtful" data-color="yellow" onclick="setLoyalty('doubtful')">üü° –°–æ–º–Ω–µ–≤–∞—é—â–∏–π—Å—è</button>
                            <button type="button" class="loyalty-btn text-sm" data-value="not_loyal" data-color="red" onclick="setLoyalty('not_loyal')">üî¥ –ù–µ –ª–æ—è–ª—å–Ω—ã–π</button>
                            <button type="button" class="loyalty-btn text-sm" data-value="not_opened" data-color="gray" onclick="setLoyalty('not_opened')">‚ö´ –ù–µ –æ—Ç–∫—Ä—ã–ª–∏</button>
                        </div>
                        <input type="hidden" id="loyalty" required value="">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">–î–µ–π—Å—Ç–≤–∏–µ</label>
                        <div id="actionButtons" class="grid grid-cols-2 gap-2">
                            <button type="button" class="action-btn text-sm" data-value="canvassing" onclick="setAction('canvassing')">üö™ –û–±—Ö–æ–¥</button>
                            <button type="button" class="action-btn text-sm" data-value="leafleting" onclick="setAction('leafleting')">üì∞ –õ–∏—Å—Ç–æ–≤–∫–∞</button>
                            <button type="button" class="action-btn text-sm" data-value="meeting" onclick="setAction('meeting')">ü§ù –í—Å—Ç—Ä–µ—á–∞</button>
                            <button type="button" class="action-btn text-sm" data-value="call" onclick="setAction('call')">üìû –ó–≤–æ–Ω–æ–∫</button>
                            <button type="button" class="action-btn text-sm" data-value="positive" onclick="setAction('positive')">‚úÖ –ü–æ–∑–∏—Ç–∏–≤</button>
                            <button type="button" class="action-btn text-sm" data-value="negative" onclick="setAction('negative')">‚ùå –ù–µ–≥–∞—Ç–∏–≤</button>
                        </div>
                        <input type="hidden" id="action" required value="">
                    </div>
                    
                    <div id="conversationScript" class="card p-3 mb-4 bg-blue-50 border-l-4 border-blue-500 hidden">
                        <p class="text-sm text-blue-800 font-semibold">–°—Ü–µ–Ω–∞—Ä–∏–π / –ü–æ–¥—Å–∫–∞–∑–∫–∞:</p>
                        <p id="scriptText" class="text-xs text-blue-700 mt-1 italic"></p>
                    </div>

                    <div class="mb-4 flex items-center p-3 rounded-lg bg-red-50 border border-red-200">
                        <input type="checkbox" id="requires_followup" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
                        <label for="requires_followup" class="ml-2 block text-base font-medium text-red-600">
                            üî¥ –¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ö–æ–Ω—Ç–∞–∫—Ç (–í–∞–∂–Ω–æ)
                        </label>
                    </div>

                    <div class="mb-4">
                        <label for="comment" class="block text-sm font-medium mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea id="comment" class="w-full" rows="3"></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</label>
                        <div id="locationStatus" class="text-sm italic text-gray-500 mb-2">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                        <div class="flex space-x-2">
                            <button type="button" id="getLocationBtn" onclick="getLocation()" class="btn-secondary text-sm flex-1 flex items-center justify-center">
                                <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i>
                                <span>–ü–æ–ª—É—á–∏—Ç—å GPS + –ê–¥—Ä–µ—Å</span>
                            </button>
                             <button type="button" id="copyLocationBtn" onclick="copyLocation()" class="btn-secondary text-sm px-3 flex items-center justify-center hidden" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å GPS">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <button type="submit" id="submitFormBtn" class="btn-primary w-full mt-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ó–∞–ø–∏—Å—å</button>
                </form>
            </div>
        </section>

        <section id="walklist" class="section hidden">
            <h1 class="text-2xl font-bold mb-4">–ú–æ–π –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –õ–∏—Å—Ç</h1>
            <div id="walkListContent" class="card p-4">
                <h2 class="text-lg font-semibold mb-2">–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ (–ò–º–∏—Ç–∞—Ü–∏—è)</h2>
                <p class="text-sm text-gray-500 mb-3">
                    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—à–∏ —Ç–µ–∫—É—â–∏–µ —Ü–µ–ª–∏. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∞–¥—Ä–µ—Å, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞.
                </p>
                <ul id="assignedAddresses" class="list-disc list-inside space-y-2 text-sm">
                    </ul>
            </div>
            
            <div class="card p-4 mt-4">
                <h2 class="text-lg font-semibold mb-2 text-red-600">–¢—Ä–µ–∫–∏–Ω–≥ –∏ –û—Ñ–ª–∞–π–Ω (#2, #9)</h2>
                <p class="text-sm mb-4">
                    **#9 –¢—Ä–µ–∫–∏–Ω–≥ (–ò–º–∏—Ç–∞—Ü–∏—è):** –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç—Ä–µ–∫–∏–Ω–≥–∞ –≤–∞—à–∏ GPS-–¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è.
                </p>
                 <button onclick="showAlert('–ò–º–∏—Ç–∞—Ü–∏—è', '–í–∞—à–∏ GPS-–¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (—Ñ–∏–∫—Ç–∏–≤–Ω–æ).')" class="btn-primary w-full bg-red-500 border-red-700">
                    <i data-lucide="map-pin" class="w-4 h-4 mr-1 inline-block align-middle"></i>
                    –ù–∞—á–∞—Ç—å/–û–±–Ω–æ–≤–∏—Ç—å –¢—Ä–µ–∫–∏–Ω–≥ (–ò–º–∏—Ç–∞—Ü–∏—è)
                </button>
                
                <p class="text-sm mt-4 mb-2 text-gray-500">
                    **#2 –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** –£ –≤–∞—Å –≤ –∫—ç—à–µ <span id="syncOfflineCount">0</span> –Ω–µ–æ—Ç–æ—Å–ª–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.
                </p>
                 <button id="syncButton" onclick="mockSyncData()" class="btn-primary w-full bg-green-500 border-green-700 disabled:opacity-50" disabled>
                    <i data-lucide="cloud-upload" class="w-4 h-4 mr-1 inline-block align-middle"></i>
                    –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –î–∞–Ω–Ω—ã–µ (–ò–º–∏—Ç–∞—Ü–∏—è)
                </button>
            </div>
        </section>


        <section id="reports" class="section hidden">
            <h1 class="text-2xl font-bold mb-4">–û—Ç—á–µ—Ç—ã</h1>

            <div id="admin-reports-content">

                <div class="card p-4 mb-4">
                    <h2 class="text-md font-semibold mb-3">–§–∏–ª—å—Ç—Ä –¥–∞–Ω–Ω—ã—Ö (–ò–º–∏—Ç–∞—Ü–∏—è)</h2>
                    <div class="flex space-x-2 mb-3">
                        <select id="dateRangeFilter" onchange="fetchAndRenderReports()" class="w-1/2 text-sm p-2 border border-gray-300 rounded-md">
                            <option value="30d" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                            <option value="7d">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                            <option value="all">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</option>
                        </select>
                        <select id="userFilter" onchange="fetchAndRenderReports()" class="w-1/2 text-sm p-2 border border-gray-300 rounded-md">
                            <option value="all" selected>–í—Å–µ –ê–≥–∏—Ç–∞—Ç–æ—Ä—ã</option>
                        </select>
                    </div>
                    <div class="text-xs text-gray-500" id="filterStatus">–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è **—Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ** –¥–∞–Ω–Ω—ã–µ.</div>
                </div>

                <div class="flex space-x-2 mb-4">
                    <button onclick="exportToXLSX()" class="btn-primary flex-1 flex items-center justify-center text-sm">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-1"></i>
                        <span>–≠–∫—Å–ø–æ—Ä—Ç XLSX (–ò–º–∏—Ç–∞—Ü–∏—è)</span>
                    </button>
                    <button onclick="fetchAndRenderReports()" class="btn-secondary flex-1 flex items-center justify-center text-sm">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-1"></i>
                        <span>–û–±–Ω–æ–≤–∏—Ç—å (–ò–º–∏—Ç–∞—Ü–∏—è)</span>
                    </button>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–°–≤–æ–¥–∫–∞</h2>
                    <div id="summary-metrics" class="grid grid-cols-2 gap-3">
                        </div>
                </div>

                 <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–†–µ–π—Ç–∏–Ω–≥ –ê–≥–∏—Ç–∞—Ç–æ—Ä–æ–≤ (Leaderboard)</h2>
                    <div class="overflow-x-auto">
                        <table id="leaderboardTbl" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <th class="px-2 py-2">–ê–≥–∏—Ç–∞—Ç–æ—Ä</th>
                                    <th class="px-2 py-2 text-center">–í—Å–µ–≥–æ –ó–∞–ø–∏—Å–µ–π</th>
                                    <th class="px-2 py-2 text-center">–õ–æ—è–ª—å–Ω—ã—Ö</th>
                                    <th class="px-2 py-2 text-center">Rate, %</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</h2>
                    <canvas id="loyaltyChart"></canvas>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–î–µ–π—Å—Ç–≤–∏—è</h2>
                    <canvas id="actionChart"></canvas>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–ö–∞—Ä—Ç–∞ –ì–µ–æ–ª–æ–∫–∞—Ü–∏–π (–¢–æ—á–∫–∏ –∏ –¢–µ–ø–ª–æ–≤–∞—è –ö–∞—Ä—Ç–∞)</h2>
                    <div class="mb-4 flex items-center">
                        <input type="radio" id="mapTypePoints" name="mapType" value="points" checked onchange="generateMap(dataCache)" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <label for="mapTypePoints" class="ml-2 mr-4 block text-sm font-medium text-gray-700">–¢–æ—á–∫–∏/–ö–ª–∞—Å—Ç–µ—Ä—ã</label>
                        <input type="radio" id="mapTypeHeat" name="mapType" value="heat" onchange="generateMap(dataCache)" class="h-4 w-4 text-red-600 border-gray-300 focus:ring-red-500">
                        <label for="mapTypeHeat" class="ml-2 block text-sm font-medium text-gray-700">–¢–µ–ø–ª–æ–≤–∞—è –ö–∞—Ä—Ç–∞</label>
                    </div>

                    <div id="map-container"></div>
                </div>

                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h2>
                     <div class="mb-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="followUpFilter" onchange="renderLatestData(dataCache)" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <label for="followUpFilter" class="ml-2 block text-sm font-medium text-red-600">
                                –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
                            </label>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="latestDataTbl" class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead>
                                <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <th class="px-2 py-2 cursor-pointer" onclick="sortTable(0)">–í—Ä–µ–º—è</th>
                                    <th class="px-2 py-2 cursor-pointer" onclick="sortTable(1)">–ê–¥—Ä–µ—Å</th>
                                    <th class="px-2 py-2 cursor-pointer" onclick="sortTable(2)">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</th>
                                    <th class="px-2 py-2 cursor-pointer" onclick="sortTable(3)">–ê–≥–∏—Ç–∞—Ç–æ—Ä</th>
                                    <th class="px-2 py-2">–ü–æ–≤—Ç–æ—Ä</th>
                                    <th class="px-2 py-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                </tr>
                            </thead>
                            <tbody id="latestDataBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                    <button onclick="showAlert('–§—É–Ω–∫—Ü–∏—è', '–ü–∞–≥–∏–Ω–∞—Ü–∏—è –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞. –≠–∫—Å–ø–æ—Ä—Ç XLSX –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ.')" class="btn-secondary w-full mt-4 text-xs">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ (–°–∫–æ—Ä–æ)</button>
                </div>

            </div>

            <div id="no-reports-data" class="card p-8 text-center hidden">
                <i data-lucide="frown" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                <h3 class="text-lg font-semibold text-gray-700">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</h3>
                <p class="text-sm text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –±—ã–ª–∏ –ª–∏ –≤–≤–µ–¥–µ–Ω—ã –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏.</p>
            </div>
        </section>

        <section id="admin" class="section hidden">
            <h1 class="text-2xl font-bold mb-4">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>

            <div id="admin-panel-content">
                 <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–ò–º–∏—Ç–∞—Ü–∏—è)</h2>
                    <p class="text-sm mb-4">–í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å –∞–≥–∏—Ç–∞—Ç–æ—Ä–æ–≤ –∏ –Ω–∞–∑–Ω–∞—á–∞—Ç—å –∏–º **#4 –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–µ –õ–∏—Å—Ç—ã**.</p>
                    <button onclick="showAlert('–ò–º–∏—Ç–∞—Ü–∏—è', '–§—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Ç—Ä–µ–±—É–µ—Ç –±—ç–∫–µ–Ω–¥–∞.')" class="btn-secondary w-full">
                        <i data-lucide="users" class="w-4 h-4 mr-1 inline-block align-middle"></i>
                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ò–º–∏—Ç–∞—Ü–∏—è)
                    </button>
                </div>
                <div class="card p-4">
                    <h2 class="text-lg font-semibold mb-2 text-red-600">–û–ø–∞—Å–Ω–∞—è –ó–æ–Ω–∞</h2>
                    <p class="text-sm mb-4">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ (–∏–º–∏—Ç–∞—Ü–∏—è).</p>
                    <button onclick="deleteCollection()" class="btn-secondary w-full bg-red-100 text-red-600 border border-red-400">
                        <i data-lucide="trash-2" class="w-4 h-4 mr-1 inline-block align-middle"></i>
                        –£–¥–∞–ª–∏—Ç—å –í—Å–µ –î–∞–Ω–Ω—ã–µ (–ò–º–∏—Ç–∞—Ü–∏—è)
                    </button>
                </div>
            </div>
        </section>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/sheetjs@0.19.0/dist/xlsx.full.min.js"></script>

    <script>
        // --- –ó–ê–ì–õ–£–®–ö–ò (MOCK DATA) ---
        const SETTLEMENTS = [
            '–≥.–ø. –ë–∞—Ä—Å–æ–≤–æ', '—Å.–ø. –°–æ–ª–Ω–µ—á–Ω—ã–π', '–≥.–ø. –õ—è–Ω—Ç–æ—Ä', '–≥.–ø. –§–µ–¥–æ—Ä–æ–≤—Å–∫–∏–π', '—Å.–ø. –õ–æ–∫–æ—Å–æ–≤–æ'
        ];
        
        // üí¨ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã (#5)
        const INTERACTIVE_SCRIPTS = {
            'loyal': "–ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç–µ. –£–∑–Ω–∞–π—Ç–µ, –≥–æ—Ç–æ–≤ –ª–∏ –ø–æ–º–æ—á—å (–ª–∏—Å—Ç–æ–≤–∫–∏, –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å).",
            'doubtful': "–°–ø—Ä–æ—Å–∏—Ç–µ –æ –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.",
            'not_loyal': "–°–ø–æ–∫–æ–π–Ω–æ –≤—ã—Å–ª—É—à–∞–π—Ç–µ –∫—Ä–∏—Ç–∏–∫—É. –ù–µ —Å–ø–æ—Ä—å—Ç–µ. –ó–∞–ø–∏—à–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏.",
            'not_opened': "–û—Å—Ç–∞–≤—å—Ç–µ –ª–∏—Å—Ç–æ–≤–∫—É. –ó–∞–ø–∏—à–∏—Ç–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π '–¢–∏—à–∏–Ω–∞' –∏–ª–∏ '–ù–µ—Ç –¥–æ–º–∞'.",
            'meeting': "–£—Ç–æ—á–Ω–∏—Ç–µ –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–π –≤—Å—Ç—Ä–µ—á–∏. –ù–∞–ø–æ–º–Ω–∏—Ç–µ –æ –∑–∞–ø–∏—Å–∏.",
            'call': "–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç–µ, —É–¥–æ–±–Ω–æ –ª–∏ –≥–æ–≤–æ—Ä–∏—Ç—å, –ø—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞—á–∏–Ω–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä.",
            'positive': "–°–ø—Ä–æ—Å–∏—Ç–µ, –ø–æ—á–µ–º—É –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç. –ó–∞–ø–∏—à–∏—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∞–≥–∏—Ç–∞—Ü–∏–∏."
        };

        // üìù –ú–æ–∫-–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–±—Ö–æ–¥–∞ (#4)
        const MOCK_WALK_LIST = [
            { id: 1, settlement: '–≥.–ø. –õ—è–Ω—Ç–æ—Ä', street: '–õ–µ–Ω–∏–Ω–∞', house: '15', apartment: '3', status: 'pending' },
            { id: 2, settlement: '–≥.–ø. –õ—è–Ω—Ç–æ—Ä', street: '–õ–µ–Ω–∏–Ω–∞', house: '15', apartment: '12', status: 'pending' },
            { id: 3, settlement: '–≥.–ø. –õ—è–Ω—Ç–æ—Ä', street: '–õ–µ–Ω–∏–Ω–∞', house: '15', apartment: '25', status: 'done' },
            { id: 4, settlement: '–≥.–ø. –õ—è–Ω—Ç–æ—Ä', street: '–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è', house: '5', apartment: '', status: 'pending' },
        ];


        const MOCK_REPORTS_DATA = [
            // –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            { timestamp: Date.now() - 3600000, user_id: 101, username: 'ivanov', full_name: '–ò–≤–∞–Ω–æ–≤ –ò.', settlement: '–≥.–ø. –õ—è–Ω—Ç–æ—Ä', street: '–õ–µ–Ω–∏–Ω–∞', house: '15', apartment: '3', action: 'canvassing', loyalty: 'loyal', comment: '–û—á–µ–Ω—å –ø–æ–∑–∏—Ç–∏–≤–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã, –æ–±–µ—â–∞–ª–∏ –ø—Ä–∏–π—Ç–∏.', location: { latitude: 61.6111, longitude: 73.1001 }, requires_followup: false },
            { timestamp: Date.now() - 7200000, user_id: 102, username: 'petrov', full_name: '–ü–µ—Ç—Ä–æ–≤ –ü.', settlement: '–≥.–ø. –õ—è–Ω—Ç–æ—Ä', street: '–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è', house: '5', apartment: '12', action: 'call', loyalty: 'not_loyal', comment: '–í—ã—Å–∫–∞–∑–∞–ª–∏ –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ.', location: { latitude: 61.6150, longitude: 73.0905 }, requires_followup: true },
            { timestamp: Date.now() - 10800000, user_id: 101, username: 'ivanov', full_name: '–ò–≤–∞–Ω–æ–≤ –ò.', settlement: '–≥.–ø. –ë–∞—Ä—Å–æ–≤–æ', street: '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è', house: '3', apartment: '7', action: 'leafleting', loyalty: 'doubtful', comment: '–ü–æ–∫–∞ —Å–æ–º–Ω–µ–≤–∞—é—Ç—Å—è, –¥–∞–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã.', location: { latitude: 61.6050, longitude: 73.1110 }, requires_followup: true },
            { timestamp: Date.now() - 86400000, user_id: 103, username: 'sidorov', full_name: '–°–∏–¥–æ—Ä–æ–≤ –°.', settlement: '–≥.–ø. –ë–∞—Ä—Å–æ–≤–æ', street: '–®–∫–æ–ª—å–Ω–∞—è', house: '8', apartment: '', action: 'not_opened', loyalty: 'not_opened', comment: '–î–≤–µ—Ä—å –Ω–µ –æ—Ç–∫—Ä—ã–ª–∏.', location: { latitude: 61.6080, longitude: 73.1080 }, requires_followup: false },
            // –î–æ–±–∞–≤–∏–º –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –∏ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
            ...Array(15).fill(null).map((_, i) => ({
                timestamp: Date.now() - (i + 1) * 86400000,
                user_id: 101 + (i % 3),
                username: ['ivanov', 'petrov', 'sidorov'][i % 3],
                full_name: ['–ò–≤–∞–Ω–æ–≤ –ò.', '–ü–µ—Ç—Ä–æ–≤ –ü.', '–°–∏–¥–æ—Ä–æ–≤ –°.'][i % 3],
                settlement: SETTLEMENTS[i % SETTLEMENTS.length],
                street: `–£–ª–∏—Ü–∞ ${i % 3 === 0 ? '–õ–µ–Ω–∏–Ω–∞' : '–ù–æ–≤–∞—è'}`, // –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —É–ª–∏—Ü—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏/—Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
                house: String(i % 5 + 1),
                apartment: i % 2 === 0 ? String(i * 2) : '',
                action: ['canvassing', 'call', 'leafleting', 'positive'][i % 4],
                loyalty: ['loyal', 'not_loyal', 'doubtful', 'not_opened'][i % 4],
                comment: `–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ${i + 1}.`,
                location: { latitude: 61.61 + (i * 0.003 * (i % 2 === 0 ? 1 : -1)), longitude: 73.10 + (i * 0.002) },
                requires_followup: i % 5 === 0,
            }))
        ];


        const isTMA = window.Telegram && window.Telegram.WebApp;
        let userTelegramId = isTMA && Telegram.WebApp.initDataUnsafe.user ? Telegram.WebApp.initDataUnsafe.user.id : (Math.floor(Math.random() * 1000000) + 1); // –§–µ–π–∫–æ–≤—ã–π ID
        let isAdmin = true;
        let userLocation = null;
        let isLocationPending = false;
        let dataCache = MOCK_REPORTS_DATA.sort((a, b) => b.timestamp - a.timestamp); // –û—Å–Ω–æ–≤–Ω–æ–π –∫–µ—à –¥–∞–Ω–Ω—ã—Ö
        let offlineCache = JSON.parse(localStorage.getItem('offlineCache') || '[]'); // üíæ –û—Ñ–ª–∞–π–Ω-–∫—ç—à (#2)


        // --- –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò –ò –£–¢–ò–õ–ò–¢–´ ---
        function showAlert(title, message) {
            if (isTMA) {
                Telegram.WebApp.showAlert(`${title}: ${message}`);
            } else {
                alert(`${title}: ${message}`);
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`a[onclick*="${sectionId}"]`).classList.add('active');

            if (sectionId === 'reports') {
                fetchAndRenderReports();
            } else if (sectionId === 'walklist') {
                renderWalkList();
            }

            lucide.createIcons();
            if (isTMA) Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }

        // --- –§–£–ù–ö–¶–ò–ò –§–û–†–ú–´ ---

        function populateSettlements() {
            const selectElement = document.getElementById('settlement');
            const lastSettlement = localStorage.getItem('lastSettlement');

            selectElement.innerHTML = '<option value="" disabled selected hidden>–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
            SETTLEMENTS.forEach(settlement => {
                const option = document.createElement('option');
                option.value = settlement;
                option.textContent = settlement;
                if (settlement === lastSettlement) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        // üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –õ–æ—è–ª—å–Ω–æ—Å—Ç–∏ (#1)
        window.setLoyalty = (value) => {
            const container = document.getElementById('loyaltyButtons');
            const input = document.getElementById('loyalty');
            input.value = value;
            container.querySelectorAll('.loyalty-btn').forEach(btn => {
                btn.classList.remove('active-loyal', 'active-not_loyal', 'active-doubtful', 'active-not_opened');
                if (btn.dataset.value === value) {
                    btn.classList.add(`active-${value}`);
                }
            });
            updateConversationScript(); // üí¨ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ (#5)
        };
        // üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –î–µ–π—Å—Ç–≤–∏—è (#1)
        window.setAction = (value) => {
            const container = document.getElementById('actionButtons');
            const input = document.getElementById('action');
            input.value = value;
            container.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.remove('active-action');
                if (btn.dataset.value === value) {
                    btn.classList.add('active-action');
                }
            });
            updateConversationScript(); // üí¨ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ (#5)
        };

        // üí¨ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ (#5)
        function updateConversationScript() {
            const loyalty = document.getElementById('loyalty').value;
            const action = document.getElementById('action').value;
            const scriptDiv = document.getElementById('conversationScript');
            const scriptText = document.getElementById('scriptText');
            
            let text = '';
            if (loyalty && loyalty !== 'not_opened') {
                text = INTERACTIVE_SCRIPTS[loyalty] || '';
            } else if (action) {
                text = INTERACTIVE_SCRIPTS[action] || '';
            }

            if (text) {
                scriptText.textContent = text;
                scriptDiv.classList.remove('hidden');
            } else {
                scriptDiv.classList.add('hidden');
            }
        }

        // ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ –∞–¥—Ä–µ—Å—É (#6)
        window.checkAddressHistory = () => {
            const street = document.getElementById('street').value.trim().toLowerCase();
            const house = document.getElementById('house').value.trim().toLowerCase();
            const historyDiv = document.getElementById('historyCheck');
            const historyText = document.getElementById('historyText');
            
            historyDiv.classList.add('hidden');

            if (street && house) {
                const recentVisit = dataCache.find(doc => 
                    (doc.street || '').toLowerCase() === street && 
                    (doc.house || '').toLowerCase() === house
                );

                if (recentVisit) {
                    const timeAgo = Math.floor((Date.now() - new Date(recentVisit.timestamp).getTime()) / (1000 * 60 * 60 * 24));
                    const loyaltyMap = { loyal: 'üü¢ –õ–æ—è–ª—å–Ω—ã–π', not_loyal: 'üî¥ –ù–µ –ª–æ—è–ª—å–Ω—ã–π', doubtful: 'üü° –°–æ–º–Ω–µ–≤–∞—é—â–∏–π—Å—è', not_opened: '‚ö´ –ù–µ –æ—Ç–∫—Ä—ã–ª–∏' };
                    
                    historyText.innerHTML = `
                        –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: **${timeAgo}** –¥–Ω. –Ω–∞–∑–∞–¥. <br>
                        –õ–æ—è–ª—å–Ω–æ—Å—Ç—å: **${loyaltyMap[recentVisit.loyalty] || 'N/A'}**. <br>
                        –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${recentVisit.comment || '–ù–µ—Ç.'}
                    `;
                    historyDiv.classList.remove('hidden');
                }
            }
        };

        // üó∫Ô∏è –ü–æ–ª—É—á–µ–Ω–∏–µ GPS —Å –∏–º–∏—Ç–∞—Ü–∏–µ–π –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è (#3)
        window.getLocation = () => {
            if (isLocationPending) return;

            const statusElement = document.getElementById('locationStatus');
            const btn = document.getElementById('getLocationBtn');
            const copyBtn = document.getElementById('copyLocationBtn');

            statusElement.textContent = '–ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...';
            btn.disabled = true;
            isLocationPending = true;
            userLocation = null;
            copyBtn.classList.add('hidden');

            if (!navigator.geolocation) {
                statusElement.textContent = '–û—à–∏–±–∫–∞: –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.';
                btn.disabled = false;
                isLocationPending = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };

                    // ‚ö†Ô∏è –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è (#3)
                    const mockStreet = `–¢–µ—Å—Ç–æ–≤–∞—è —É–ª. ${Math.floor(Math.random() * 10)}`;
                    const mockHouse = String(Math.floor(Math.random() * 50) + 1);
                    document.getElementById('street').value = mockStreet;
                    document.getElementById('house').value = mockHouse;

                    statusElement.textContent = `–£—Å–ø–µ—à–Ω–æ: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)} (–ê–¥—Ä–µ—Å –∑–∞–ø–æ–ª–Ω–µ–Ω –∏–º–∏—Ç–∞—Ü–∏–µ–π)`;
                    copyBtn.classList.remove('hidden');
                    btn.disabled = false;
                    isLocationPending = false;
                    checkAddressHistory(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å—Ä–∞–∑—É
                    if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                },
                (error) => {
                    let errorMessage = (error.code === error.PERMISSION_DENIED) ?
                        '–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ GPS.';
                    statusElement.textContent = `–û—à–∏–±–∫–∞: ${errorMessage}`;
                    showAlert('–û—à–∏–±–∫–∞ GPS', errorMessage);
                    btn.disabled = false;
                    isLocationPending = false;
                    if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        };

        window.copyLocation = () => {
            if (userLocation) {
                const coords = `${userLocation.latitude}, ${userLocation.longitude}`;
                navigator.clipboard.writeText(coords);
                showAlert('–£—Å–ø–µ—à–Ω–æ', `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã: ${coords}`);
                if (isTMA) Telegram.WebApp.HapticFeedback.impactOccurred('medium');
            }
        };

        // üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–≤ –æ—Ñ–ª–∞–π–Ω-–∫—ç—à) (#2)
        window.saveSurveyData = async (e) => {
            if (e) e.preventDefault();

            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            try {
                const data = {
                    settlement: document.getElementById('settlement').value,
                    street: document.getElementById('street').value,
                    house: document.getElementById('house').value,
                    apartment: document.getElementById('apartment').value || '',
                    action: document.getElementById('action').value,
                    loyalty: document.getElementById('loyalty').value,
                    comment: document.getElementById('comment').value || '',
                    requires_followup: document.getElementById('requires_followup').checked, // üî¥ –§–ª–∞–≥ (#10)
                    timestamp: new Date().toISOString(),
                    user_id: userTelegramId,
                    username: isTMA && Telegram.WebApp.initDataUnsafe.user ? (Telegram.WebApp.initDataUnsafe.user.username || 'n/a') : 'web-test',
                    full_name: isTMA && Telegram.WebApp.initDataUnsafe.user ? (Telegram.WebApp.initDataUnsafe.user.first_name + (Telegram.WebApp.initDataUnsafe.user.last_name ? ' ' + Telegram.WebApp.initDataUnsafe.user.last_name : '')) : 'Test User',
                    location: userLocation,
                };
                
                // üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Local Storage (–∏–º–∏—Ç–∞—Ü–∏—è –æ—Ñ–ª–∞–π–Ω-–∫—ç—à–∞)
                offlineCache.unshift(data); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
                localStorage.setItem('offlineCache', JSON.stringify(offlineCache));

                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                localStorage.setItem('lastSettlement', data.settlement);
                localStorage.setItem('lastStreet', data.street);

                // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                document.getElementById('surveyForm').reset();
                document.getElementById('locationStatus').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
                document.getElementById('copyLocationBtn').classList.add('hidden');
                document.getElementById('loyalty').value = '';
                document.getElementById('action').value = '';
                document.getElementById('historyCheck').classList.add('hidden');
                document.getElementById('conversationScript').classList.add('hidden');
                userLocation = null;
                // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫
                document.querySelectorAll('.loyalty-btn').forEach(btn => btn.classList.remove('active-loyal', 'active-not_loyal', 'active-doubtful', 'active-not_opened'));
                document.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('active-action'));
                
                populateSettlements();
                document.getElementById('street').value = localStorage.getItem('lastStreet') || '';

                updateOfflineStatus(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫—ç—à–∞
                showAlert('–£—Å–ø–µ—à–Ω–æ!', `–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –æ—Ñ–ª–∞–π–Ω-–∫—ç—à. ${offlineCache.length} –æ–∂–∏–¥–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.`);
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('success');

            } catch (error) {
                console.error("Error saving document: ", error);
                showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
                if (isTMA) Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        };
        
        // üíæ –ò–º–∏—Ç–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö (#2)
        window.mockSyncData = () => {
            if (offlineCache.length === 0) return;
            
            if (isTMA) Telegram.WebApp.MainButton.showProgress();
            
            setTimeout(() => {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏: –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä (Firebase/–¥—Ä—É–≥–æ–π –±—ç–∫–µ–Ω–¥)
                console.log(`üöÄ –ò–ú–ò–¢–ê–¶–ò–Ø: –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${offlineCache.length} –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä.`);
                
                // –í–Ω–∏–º–∞–Ω–∏–µ: –í –º–æ–∫-—Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–µ—à
                dataCache = offlineCache.concat(dataCache);
                dataCache.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                offlineCache = [];
                localStorage.setItem('offlineCache', '[]');
                
                updateOfflineStatus();
                showAlert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è', '–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ö—ç—à –æ—á–∏—â–µ–Ω.');
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
                if (document.querySelector('.nav-item.active span').textContent === '–û—Ç—á–µ—Ç—ã') {
                     fetchAndRenderReports();
                }
            }, 1500); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Å–µ—Ç–µ–≤–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
        };
        
        function updateOfflineStatus() {
            const count = offlineCache.length;
            document.getElementById('debugOfflineCount').textContent = count;
            document.getElementById('syncOfflineCount').textContent = count;
            document.getElementById('syncButton').disabled = (count === 0);
            
            if (count > 0) {
                document.getElementById('offlineStatus').classList.remove('hidden');
                document.getElementById('offlineStatus').classList.remove('bg-green-500');
                document.getElementById('offlineStatus').classList.add('bg-red-500');
            } else {
                 document.getElementById('offlineStatus').classList.add('hidden');
            }
        }


        // üìù –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ú–∞—Ä—à—Ä—É—Ç–Ω–æ–≥–æ –õ–∏—Å—Ç–∞ (#4)
        function renderWalkList() {
            const ul = document.getElementById('assignedAddresses');
            ul.innerHTML = '';

            if (MOCK_WALK_LIST.length === 0) {
                ul.innerHTML = '<li class="text-gray-500">–£ –≤–∞—Å –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤.</li>';
                return;
            }

            MOCK_WALK_LIST.forEach(item => {
                const li = document.createElement('li');
                const statusClass = item.status === 'done' ? 'text-green-600 line-through' : 'text-blue-700 cursor-pointer hover:underline';
                const statusIcon = item.status === 'done' ? '‚úÖ' : 'üëâ';
                const apartmentStr = item.apartment ? `, –∫–≤. ${item.apartment}` : '';
                li.className = statusClass;
                li.innerHTML = `${statusIcon} **${item.settlement}**, —É–ª. ${item.street}, –¥. ${item.house}${apartmentStr}`;
                
                if (item.status !== 'done') {
                    li.onclick = () => {
                        document.getElementById('settlement').value = item.settlement;
                        document.getElementById('street').value = item.street;
                        document.getElementById('house').value = item.house;
                        document.getElementById('apartment').value = item.apartment;
                        checkAddressHistory();
                        showSection('form');
                    };
                }

                ul.appendChild(li);
            });
            lucide.createIcons();
        }
        
        // ‚ùå –ò–º–∏—Ç–∞—Ü–∏—è: –§–£–ù–ö–¶–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø
        window.deleteCollection = () => {
            if (!isAdmin) return showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
            showAlert('–£—Å–ø–µ—à–Ω–æ (–ò–º–∏—Ç–∞—Ü–∏—è)', `–í—Å–µ –¥–∞–Ω–Ω—ã–µ (—Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ) –æ—á–∏—â–µ–Ω—ã –∏–∑ –∫–µ—à–∞.`);
            dataCache = []; // –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
            fetchAndRenderReports();
        };

        // --- –§–£–ù–ö–¶–ò–ò –û–¢–ß–ï–¢–û–í ---
        let mapInstance = null;
        let markerClusterGroup = null;
        let loyaltyChart = null;
        let actionChart = null;

        // üó∫Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ö–∞—Ä—Ç—ã (–¢–æ—á–∫–∏, –ö–ª–∞—Å—Ç–µ—Ä—ã –∏–ª–∏ –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞) (#8)
        function generateMap(data) {
            const container = document.getElementById('map-container');
            const mapType = document.querySelector('input[name="mapType"]:checked').value;
            
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
            container.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

            const locations = data
                .filter(doc => doc.location && doc.location.latitude && doc.location.longitude)
                .map(doc => ({
                    lat: doc.location.latitude,
                    lon: doc.location.longitude,
                    loyalty: doc.loyalty,
                    address: `${doc.settlement}, —É–ª. ${doc.street}, –¥. ${doc.house}`
                }));

            if (locations.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.</div>';
                return;
            }

            const avgLat = locations.reduce((sum, p) => sum + p.lat, 0) / locations.length;
            const avgLon = locations.reduce((sum, p) => sum + p.lon, 0) / locations.length;

            mapInstance = L.map(container).setView([avgLat, avgLon], 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);

            if (mapType === 'points') {
                markerClusterGroup = L.markerClusterGroup();
                locations.forEach(point => {
                    let color = (point.loyalty === 'loyal') ? '#10B981' : (point.loyalty === 'not_loyal') ? '#EF4444' : '#F59E0B';
                    const iconHtml = `<div style="background-color: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.4);"></div>`;
                    const customIcon = L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [20, 20], iconAnchor: [10, 10] });
                    const marker = L.marker([point.lat, point.lon], { icon: customIcon }).bindPopup(`<b>${point.address}</b><br>–õ–æ—è–ª—å–Ω–æ—Å—Ç—å: ${point.loyalty}`);
                    markerClusterGroup.addLayer(marker);
                });
                mapInstance.addLayer(markerClusterGroup);
                if (markerClusterGroup.getLayers().length > 0) {
                    mapInstance.fitBounds(markerClusterGroup.getBounds());
                }
            } else if (mapType === 'heat') {
                // üå°Ô∏è –¢–µ–ø–ª–æ–≤–∞—è –ö–∞—Ä—Ç–∞ (#8)
                const heatPoints = locations.map(p => {
                    let intensity = 0.5;
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Å –ª–æ—è–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫
                    if (p.loyalty === 'loyal') intensity = 1.0; 
                    else if (p.loyalty === 'not_loyal') intensity = 0.2; // –ú–µ–Ω—å—à–∏–π –≤–µ—Å –¥–ª—è "–Ω–µ –ª–æ—è–ª—å–Ω—ã—Ö", —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –±–æ–ª—å—à–µ "–∞–∫—Ç–∏–≤–Ω—ã—Ö" —Ç–æ—á–µ–∫
                    return [p.lat, p.lon, intensity];
                });
                L.heatLayer(heatPoints, { radius: 25, maxZoom: 14, gradient: { 0.2: 'blue', 0.5: 'lime', 1: 'red' } }).addTo(mapInstance);
            }

            mapInstance.invalidateSize();
        }

        // üèÜ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ Leaderboard (#7)
        function renderLeaderboard(userActivity) {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';
            
            const leaderboardData = Object.keys(userActivity).map(name => ({
                name: name,
                ...userActivity[name]
            })).sort((a, b) => b.count - a.count); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É

            leaderboardData.forEach((user, index) => {
                const totalReviewed = user.count - user.not_opened;
                const loyalRate = totalReviewed > 0 ? ((user.loyal / totalReviewed) * 100).toFixed(1) : 0;
                
                const row = tbody.insertRow();
                row.className = "bg-white dark:bg-gray-800 hover:bg-gray-50";

                let cell = row.insertCell();
                cell.className = "px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900";
                cell.textContent = `${index + 1}. ${user.name}`;

                cell = row.insertCell();
                cell.className = "px-2 py-2 whitespace-nowrap text-center";
                cell.textContent = user.count;

                cell = row.insertCell();
                cell.className = "px-2 py-2 whitespace-nowrap text-center text-green-600 font-medium";
                cell.textContent = user.loyal;

                cell = row.insertCell();
                cell.className = "px-2 py-2 whitespace-nowrap text-center font-bold";
                cell.textContent = `${loyalRate}%`;
            });
        }

        // üî¥ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã –¥–∞–Ω–Ω—ã—Ö —Å —Ñ–∏–ª—å—Ç—Ä–æ–º (#10)
        function renderLatestData(data) {
            const tbody = document.getElementById('latestDataBody');
            tbody.innerHTML = '';
            
            const showFollowUpOnly = document.getElementById('followUpFilter').checked;
            
            let filteredData = data;
            if (showFollowUpOnly) {
                filteredData = data.filter(doc => doc.requires_followup);
            }

            const latestData = filteredData.slice(0, 30);

            latestData.forEach(doc => {
                const row = tbody.insertRow();
                row.className = "bg-white dark:bg-gray-800 hover:bg-gray-50";

                const timeStr = new Date(doc.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                const address = `${doc.settlement || ''}, ${doc.street || ''}, ${doc.house || ''}`;
                const userName = doc.full_name || doc.username || 'n/a';

                let loyaltyColor = (doc.loyalty === 'loyal') ? 'text-green-600 font-medium' :
                                 (doc.loyalty === 'not_loyal') ? 'text-red-600 font-medium' :
                                 (doc.loyalty === 'doubtful') ? 'text-yellow-600' :
                                 'text-gray-500';

                // –í—Ä–µ–º—è
                let cell = row.insertCell();
                cell.className = "px-2 py-2 whitespace-nowrap text-xs";
                cell.textContent = timeStr;

                // –ê–¥—Ä–µ—Å
                cell = row.insertCell();
                cell.className = "px-2 py-2 whitespace-nowrap text-xs truncate max-w-xs";
                cell.textContent = address;

                // –õ–æ—è–ª—å–Ω–æ—Å—Ç—å
                cell = row.insertCell();
                cell.className = `px-2 py-2 whitespace-nowrap text-xs ${loyaltyColor}`;
                cell.textContent = doc.loyalty || 'N/A';

                // –ê–≥–∏—Ç–∞—Ç–æ—Ä
                cell = row.insertCell();
                cell.className = "px-2 py-2 whitespace-nowrap text-xs text-blue-500";
                cell.textContent = userName;
                
                // üî¥ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç (#10)
                cell = row.insertCell();
                cell.className = "px-2 py-2 whitespace-nowrap text-center text-red-600 font-bold";
                cell.textContent = doc.requires_followup ? '–î–ê' : '‚Äî';

                // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                cell = row.insertCell();
                cell.className = "px-2 py-2 text-xs text-gray-500 truncate max-w-sm";
                cell.textContent = doc.comment.length > 50 ? doc.comment.substring(0, 50) + '...' : doc.comment;
            });
        }
        
        // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ - populateUserFilter, renderChart, exportToXLSX –∏ fetchAndRenderReports) ...
        
        function populateUserFilter(users) { /* ... */ } // (–°—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏ —É–±—Ä–∞–Ω—ã –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏)
        function renderChart(canvasId, type, labels, data, colors, chartInstance, yLabel = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', xLabel = '') { /* ... */ } // (–°—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏ —É–±—Ä–∞–Ω—ã –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏)
        function exportToXLSX() { /* ... */ } // (–°—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏ —É–±—Ä–∞–Ω—ã –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏)

        window.fetchAndRenderReports = async () => {
             // ... (–ª–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é) ...
             
            if (isTMA) Telegram.WebApp.MainButton.showProgress();

            const contentDiv = document.getElementById('admin-reports-content');
            const noDataElement = document.getElementById('no-reports-data');
            contentDiv.style.display = 'none';

            try {
                const filterValue = document.getElementById('dateRangeFilter').value;
                const userFilterId = document.getElementById('userFilter').value;

                const rawDataUnfiltered = dataCache;
                
                const uniqueUsers = {};
                rawDataUnfiltered.forEach(doc => {
                    if (doc.user_id) {
                        uniqueUsers[doc.user_id] = doc.full_name || doc.username || `ID: ${doc.user_id}`;
                    }
                });
                
                const userOptions = Object.keys(uniqueUsers).map(id => ({ id: id, name: uniqueUsers[id] }));
                populateUserFilter(userOptions);


                let startDate = 0;
                const now = new Date();

                if (filterValue === '30d') startDate = new Date(now.setDate(now.getDate() - 30)).getTime();
                else if (filterValue === '7d') startDate = new Date(now.setDate(now.getDate() - 7)).getTime();
                else if (filterValue === 'today') startDate = new Date(now.setHours(0, 0, 0, 0)).getTime();

                const rawData = rawDataUnfiltered.filter(doc => {
                    const docTime = new Date(doc.timestamp).getTime();
                    const dateMatch = filterValue === 'all' || docTime >= startDate;
                    const userMatch = userFilterId === 'all' || doc.user_id == userFilterId;
                    return dateMatch && userMatch;
                });

                dataCache = rawData;
                const totalCount = rawData.length;

                if (totalCount === 0) {
                    contentDiv.style.display = 'none';
                    noDataElement.classList.remove('hidden');
                    if (isTMA) Telegram.WebApp.MainButton.hideProgress();
                    return;
                } else {
                    noDataElement.classList.add('hidden');
                    contentDiv.style.display = 'block';
                }

                const loyaltyCounts = {};
                const actionCounts = {};
                const userActivity = {}; // üèÜ –î–ª—è Leaderboard (#7)

                rawData.forEach(doc => {
                    loyaltyCounts[doc.loyalty] = (loyaltyCounts[doc.loyalty] || 0) + 1;
                    actionCounts[doc.action] = (actionCounts[doc.action] || 0) + 1;
                    
                    const userName = doc.full_name || doc.username || `ID: ${doc.user_id}`;
                    if (!userActivity[userName]) {
                        userActivity[userName] = { count: 0, loyal: 0, not_loyal: 0, not_opened: 0 };
                    }
                    userActivity[userName].count += 1;
                    if (doc.loyalty === 'loyal') userActivity[userName].loyal += 1;
                    if (doc.loyalty === 'not_loyal') userActivity[userName].not_loyal += 1;
                    if (doc.loyalty === 'not_opened') userActivity[userName].not_opened += 1;
                });

                // üèÜ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ Leaderboard (#7)
                renderLeaderboard(userActivity);
                
                // üöÄ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–≤–æ–¥–∫–∏
                const loyalCount = loyaltyCounts['loyal'] || 0;
                const notLoyalCount = loyaltyCounts['not_loyal'] || 0;
                const totalReviewed = totalCount - (loyaltyCounts['not_opened'] || 0);
                const loyalRate = totalReviewed > 0 ? ((loyalCount / totalReviewed) * 100).toFixed(1) : 0;

                const summaryHtml = `
                    <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg text-center border-l-4 border-gray-400">
                        <i data-lucide="hash" class="w-5 h-5 mx-auto mb-1 text-gray-500"></i>
                        <div class="text-sm text-gray-600">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                        <span class="text-xl font-extrabold text-gray-900">${totalCount}</span>
                    </div>
                    <div class="p-3 bg-blue-100 dark:bg-blue-700 rounded-lg text-center border-l-4 border-blue-500">
                        <i data-lucide="percent" class="w-5 h-5 mx-auto mb-1 text-blue-700"></i>
                        <div class="text-sm text-blue-800">–ü—Ä–æ—Ü–µ–Ω—Ç –õ–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
                        <span class="text-xl font-extrabold text-blue-900">${loyalRate}%</span>
                    </div>
                    <div class="p-3 bg-green-100 dark:bg-green-700 rounded-lg text-center border-l-4 border-green-500">
                        <i data-lucide="check-circle" class="w-5 h-5 mx-auto mb-1 text-green-700"></i>
                        <div class="text-sm text-green-800">–õ–æ—è–ª—å–Ω—ã—Ö</div>
                        <span class="text-xl font-extrabold text-green-900">${loyalCount}</span>
                    </div>
                    <div class="p-3 bg-red-100 dark:bg-red-700 rounded-lg text-center border-l-4 border-red-500">
                        <i data-lucide="x-circle" class="w-5 h-5 mx-auto mb-1 text-red-700"></i>
                        <div class="text-sm text-red-800">–ù–µ –ª–æ—è–ª—å–Ω—ã—Ö</div>
                        <span class="text-xl font-extrabold text-red-900">${notLoyalCount}</span>
                    </div>
                `;
                document.getElementById('summary-metrics').innerHTML = summaryHtml;
                lucide.createIcons();
                
                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≥—Ä–∞—Ñ–∏–∫–æ–≤ (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ)
                const loyaltyLabels = ['–õ–æ—è–ª—å–Ω—ã–π', '–ù–µ –ª–æ—è–ª—å–Ω—ã–π', '–°–æ–º–Ω–µ–≤–∞—é—â–∏–π—Å—è', '–ù–µ –æ—Ç–∫—Ä—ã–ª–∏'];
                const loyaltyData = [loyalCount, notLoyalCount, loyaltyCounts['doubtful'] || 0, loyaltyCounts['not_opened'] || 0];
                loyaltyChart = renderChart('loyaltyChart', 'doughnut', loyaltyLabels, loyaltyData, ['#10B981', '#EF4444', '#F59E0B', '#6B7280'], loyaltyChart);

                const actionLabels = Object.keys(actionCounts).map(key => {
                    const map = {'canvassing': '–û–±—Ö–æ–¥', 'leafleting': '–õ–∏—Å—Ç–æ–≤–∫–∏', 'meeting': '–í—Å—Ç—Ä–µ—á–∞', 'call': '–ó–≤–æ–Ω–æ–∫', 'positive': '–ü–æ–∑–∏—Ç–∏–≤', 'negative': '–ù–µ–≥–∞—Ç–∏–≤'};
                    return map[key] || key;
                });
                const actionData = Object.values(actionCounts);
                actionChart = renderChart('actionChart', 'bar', actionLabels, actionData, ['#007aff', '#ff3b30', '#FF9500', '#5AC8FA', '#4CD964', '#FF2D55'], actionChart, '–î–µ–π—Å—Ç–≤–∏—è, —à—Ç.');

                generateMap(rawData);

                renderLatestData(rawData);

            } catch (e) {
                console.error("Error fetching reports (Mock Data):", e);
                showAlert('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á–µ—Ç–æ–≤ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å).');
                noDataElement.classList.remove('hidden');
                contentDiv.style.display = 'none';
                dataCache = [];
            } finally {
                if (isTMA) Telegram.WebApp.MainButton.hideProgress();
            }
        };

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ---
        if (isTMA) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MainButton TMA –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            Telegram.WebApp.MainButton.setText('–°–û–•–†–ê–ù–ò–¢–¨ –ó–ê–ü–ò–°–¨').show();
            Telegram.WebApp.MainButton.onClick(saveSurveyData);
            document.getElementById('submitFormBtn').classList.add('hidden'); // –°–∫—Ä—ã—Ç—å HTML –∫–Ω–æ–ø–∫—É
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            populateSettlements();

            // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —É–ª–∏—Ü—ã
            document.getElementById('street').value = localStorage.getItem('lastStreet') || '';

            showSection('form');
            lucide.createIcons();
            updateOfflineStatus(); // üíæ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫—ç—à–∞

            // –û–¢–õ–ê–î–ö–ê: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π
            document.getElementById('debugUserId').textContent = userTelegramId || '–ù–µ—Ç ID';
            document.getElementById('debugAdminStatus').textContent = isAdmin ? '–î–ê (MOCK)' : '–ù–ï–¢ (MOCK)';
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã, –Ω–æ –Ω—É–∂–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã
            
            // üí° –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã:
             function populateUserFilter(users) {
                const selectElement = document.getElementById('userFilter');
                const currentValue = selectElement.value;
                selectElement.innerHTML = '<option value="all">–í—Å–µ –ê–≥–∏—Ç–∞—Ç–æ—Ä—ã</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    if (user.id == currentValue) { option.selected = true; }
                    selectElement.appendChild(option);
                });
            }

            function renderChart(canvasId, type, labels, data, colors, chartInstance, yLabel = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', xLabel = '') {
                const ctx = document.getElementById(canvasId).getContext('2d');
                if (chartInstance) { chartInstance.destroy(); }
                const chartOptions = { responsive: true, plugins: { legend: { position: type === 'doughnut' ? 'bottom' : 'top', labels: { color: '#1c1c1e', font: { size: 12, family: 'Jost' } } } }, scales: type === 'bar' ? { y: { beginAtZero: true, title: { display: true, text: yLabel, color: '#8e8e93', }, ticks: { color: '#8e8e93', callback: function(value) { if (value % 1 === 0) { return value; } } }, grid: { color: '#e5e5ea', } }, x: { ticks: { color: '#8e8e93', }, grid: { color: 'rgba(0,0,0,0)', } } } : {} };
                return new Chart(ctx, { type: type, data: { labels: labels, datasets: [{ label: yLabel, data: data, backgroundColor: colors, borderColor: '#ffffff', borderWidth: 1 }] }, options: chartOptions });
            }

            function exportToXLSX() {
                if (dataCache.length === 0) {
                    showAlert('–û—à–∏–±–∫–∞', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –æ—Ç—á–µ—Ç—ã.');
                    return;
                }
                const exportData = dataCache.map(doc => ({
                    '–í—Ä–µ–º—è': new Date(doc.timestamp).toLocaleString(), 'ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è': doc.user_id, '–ê–≥–∏—Ç–∞—Ç–æ—Ä (–§–ò–û)': doc.full_name || doc.username,
                    '–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç': doc.settlement, '–£–ª–∏—Ü–∞': doc.street, '–î–æ–º': doc.house, '–ö–≤–∞—Ä—Ç–∏—Ä–∞': doc.apartment, '–î–µ–π—Å—Ç–≤–∏–µ': doc.action,
                    '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å': doc.loyalty, '–¢—Ä–µ–±—É–µ—Ç—Å—è –ü–æ–≤—Ç–æ—Ä': doc.requires_followup ? '–î–ê' : '–ù–ï–¢', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': doc.comment,
                    '–®–∏—Ä–æ—Ç–∞': doc.location ? doc.location.latitude : 'N/A', '–î–æ–ª–≥–æ—Ç–∞': doc.location ? doc.location.longitude : 'N/A',
                }));
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "–î–∞–Ω–Ω—ã–µ");
                XLSX.writeFile(workbook, "agitator_data_MOCK_" + new Date().toISOString().slice(0, 10) + ".xlsx");
                showAlert('–£—Å–ø–µ—à–Ω–æ', `–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${exportData.length} –∑–∞–ø–∏—Å–µ–π –≤ XLSX (—Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ).`);
            }
        };
    </script>
</body>
</html>
